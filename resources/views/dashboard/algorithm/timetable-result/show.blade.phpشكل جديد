@extends('dashboard.layout')

@section('title', 'Timetable Result for Chromosome #' . $chromosome->chromosome_id)

@push('styles')
<style>
    /* --- تحسينات العرض وتثبيت الأعمدة --- */
    .timetable-container {
        width: 100%;
        overflow-x: auto;
        border: 1px solid #ddd;
        /* [جديد] تحديد ارتفاع لتفعيل التمرير العمودي إذا لزم الأمر */
        max-height: 80vh;
    }
    .timetable {
        border-collapse: collapse;
        width: max-content;
    }
    .timetable th, .timetable td {
        border: 1px solid #e0e0e0; /* لون أفتح للحدود الداخلية */
        padding: 4px;
        text-align: center;
        min-width: 120px;
        height: 65px; /* زيادة ارتفاع الخلية قليلاً */
        vertical-align: top;
        font-size: 12px;
    }

    /* --- [مهم] تعديلات التثبيت --- */
    .timetable thead th {
        position: -webkit-sticky;
        position: sticky;
        /* [الحل لمشكلة الناف بار] اضبط هذا الرقم ليناسب ارتفاع الناف بار عندك */
        top: 0;
        /* [جديد] تمييز لون الخلفية للهيدر */
        background-color: #e9ecef;
        color: #212529;
        font-weight: bold;
        z-index: 2;
    }
    .timetable tbody th {
        position: -webkit-sticky;
        position: sticky;
        left: 0;
        background-color: #f8f9fa;
        z-index: 1;
        min-width: 180px !important;
        max-width: 180px !important;
        white-space: normal;
        font-weight: bold;
    }
    /* الخلية العلوية اليسرى يجب أن تكون فوق كل شيء */
    .timetable thead th:first-child {
        left: 0;
        z-index: 3;
    }
    /* [جديد] تثبيت صف الأوقات أيضًا */
    .timetable thead tr:nth-child(2) th {
        top: 35px; /* اضبط هذا الرقم ليناسب ارتفاع صف الأيام */
    }

    /* [جديد] تمييز الفاصل بين الأيام */
    .day-end {
        border-right: 2px solid #adb5bd !important; /* خط أغمق وأكثر سماكة */
    }

    /* --- تصميم بطاقات المحاضرات والتعارضات --- */
    .lecture-card {
        background-color: #e7f3ff;
        border-left: 4px solid #0d6efd;
        border-radius: 4px;
        padding: 4px;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        cursor: grab;
        overflow: hidden;
        position: relative; /* مهم للـ tooltip */
    }
    .lecture-card.practical {
        background-color: #fffbe7;
        border-left-color: #ffc107;
    }
    .lecture-card strong {
        font-size: 13px;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .lecture-card span {
        font-size: 11px;
        color: #555;
    }
    .lecture-card.has-conflict-error {
        border-left-color: #dc3545 !important;
        background-color: #f8d7da !important;
        box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
    }
    .lecture-card.has-conflict-warning {
        border-left-color: #ffc107 !important;
        background-color: #fff3cd !important;
        box-shadow: 0 0 5px rgba(255, 193, 7, 0.5);
    }
    .conflict-tooltip {
        visibility: hidden;
        width: 240px;
        background-color: #333;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 10;
        bottom: 105%;
        left: 50%;
        margin-left: -120px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .conflict-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }
    .lecture-card.has-conflict:hover .conflict-tooltip {
        visibility: visible;
        opacity: 1;
    }
    .conflict-tooltip ul {
        margin: 0;
        padding-left: 15px;
    }
</style>
@endpush

@section('content')
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Timetable for Chromosome #{{ $chromosome->chromosome_id }}</h1>
        <span class="badge badge-info p-2" style="font-size: 1rem;">Penalty Score: {{ $chromosome->penalty_value }}</span>
    </div>

    <!-- [جديد] عرض ملخص التعارضات في الأعلى -->
    {{-- @if(!empty($conflicts))
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Conflict Summary ({{ count($conflictingGeneIds) }} blocks affected)</h6>
            </div>
            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                <ul class="list-group list-group-flush">
                    @foreach($conflicts as $geneId => $geneConflicts)
                        @foreach($geneConflicts as $conflict)
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    @if($conflict['type'])
                                        <span class="badge badge-danger mr-2">Hard</span>
                                    @else
                                        <span class="badge badge-warning mr-2">Soft</span>
                                    @endif
                                    {{ $conflict['message'] }}
                                </div>
                                <a href="#gene-{{ $geneId }}" class="btn btn-sm btn-outline-primary">Go to</a>
                            </li>
                        @endforeach
                    @endforeach
                </ul>
            </div>
        </div>
    @endif --}}

    <div class="timetable-container">
        <table class="timetable">
            <thead>
                <tr>
                    <!-- الخلية العلوية اليسرى الفارغة -->
                    <th style="min-width: 180px !important; max-width: 180px !important;">Group</th>
                    @foreach($timeslotsByDay as $day => $daySlots)
                        <th colspan="{{ $daySlots->count() }}"
                            class="{{ $loop->last ? '' : 'day-end' }}"> <!-- إضافة الكلاس للفاصل -->
                            {{ $day }}
                        </th>
                    @endforeach
                </tr>
                <tr>
                    <th></th>
                    @foreach($timeslotsByDay as $day => $daySlots)
                        @foreach($daySlots as $slot)
                            <th class="{{ $loop->last ? 'day-end' : '' }}"> <!-- إضافة الكلاس للفاصل -->
                                {{ \Carbon\Carbon::parse($slot->start_time)->format('H:i') }} - {{ \Carbon\Carbon::parse($slot->end_time)->format('H:i') }}
                            </th>
                        @endforeach
                    @endforeach
                </tr>
            </thead>
            <tbody>
                @php
                    $totalSlots = collect($timeslotsByDay)->flatten()->count();
                @endphp
                @foreach($scheduleByGroup as $groupId => $groupData)
                    <tr>
                        <th>{{ $groupData['name'] }}</th>
                        @for ($i = 0; $i < $totalSlots; $i++)
                            <td></td>
                        @endfor
                    </tr>
                @endforeach
            </tbody>
        </table>
    </div>
</div>
@endsection

@push('scripts')
<script>
document.addEventListener('DOMContentLoaded', function () {
    const scheduleByGroup = @json($scheduleByGroup);
    const timeslotsByDay = @json($timeslotsByDay);
    const conflicts = @json($conflicts);
    const conflictingGeneIds = @json($conflictingGeneIds);

    const tableBody = document.querySelector('.timetable tbody');
    const groupRows = {};
    tableBody.querySelectorAll('tr').forEach(tr => {
        const groupName = tr.querySelector('th').textContent;
        groupRows[groupName] = tr;
    });

    const slotPositions = {};
    let position = 1;
    for (const day in timeslotsByDay) {
        timeslotsByDay[day].forEach(slot => {
            slotPositions[slot.id] = position++;
        });
    }

    for (const groupId in scheduleByGroup) {
        const groupData = scheduleByGroup[groupId];
        const row = groupRows[groupData.name];
        if (!row) continue;

        groupData.blocks.forEach(gene => {
            if (!gene.timeslot_ids || gene.timeslot_ids.length === 0) return;

            const startSlotId = gene.timeslot_ids[0];
            const startPosition = slotPositions[startSlotId];
            const colspan = gene.timeslot_ids.length;

            if (!startPosition) return;

            const cell = row.cells[startPosition];
            cell.colSpan = colspan;

            // [جديد] إضافة id للخلية للقفز إليها
            cell.id = `gene-${gene.id}`;

            const isPractical = gene.section.plan_subject.subject.practical_hours > 0;
            const hasConflict = conflictingGeneIds.includes(gene.id);
            let conflictTypeClass = '';
            if(hasConflict) {
                const geneConflicts = conflicts[gene.id] || [];
                conflictTypeClass = geneConflicts.some(c => c.type === 'error') ? 'has-conflict-error' : 'has-conflict-warning';
            }

            let cardHtml = `<div class="lecture-card ${isPractical ? 'practical' : ''} ${hasConflict ? 'has-conflict ' + conflictTypeClass : ''}" data-gene-id="${gene.id}">
                <strong>${gene.section.plan_subject.subject.subject_name}</strong>
                <span>${gene.instructor.instructor_name}</span>
                <span>Room: ${gene.room.room_name}</span>`;

            if(hasConflict) {
                cardHtml += `<div class="conflict-tooltip"><strong>Conflicts:</strong><ul>`;
                (conflicts[gene.id] || []).forEach(c => {
                    cardHtml += `<li>${c.message}</li>`;
                });
                cardHtml += `</ul></div>`;
            }

            cardHtml += `</div>`;
            cell.innerHTML = cardHtml;

            for (let i = 1; i < colspan; i++) {
                if (row.cells[startPosition + 1]) {
                    row.cells[startPosition + 1].remove();
                }
            }
        });
    }
});
</script>
@endpush
