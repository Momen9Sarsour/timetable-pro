@extends('dashboard.layout')

@push('styles')
    <style>
        .timetable-container {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }

        .timetable {
            border-collapse: collapse;
            min-width: 3200px;
            table-layout: fixed;
        }

        .timetable th,
        .timetable td {
            border: 1px solid #e9ecef;
            text-align: center;
            padding: 0;
            height: 100px; /* زيادة ارتفاع الخلايا */
        }

        .timetable .group-header {
            width: 300px; /* زيادة عرض العمود */
            font-weight: 600;
            padding: 0.75rem;
            background-color: #f8f9fa;
            position: sticky;
            left: 0;
            z-index: 10;
            font-size: 1rem;
        }

        .timetable .day-header {
            padding: 0.5rem;
            font-size: 1.2rem;
            font-weight: 700;
            border-bottom: 2px solid #adb5bd;
        }

        .timetable .time-header {
            font-size: 0.8rem;
            color: #6c757d;
            padding: 0.5rem 0;
            width: 150px; /* زيادة عرض العمود */
        }

        .timetable .group-row {
            position: relative;
            height: 200px; /* زيادة ارتفاع الصفوف */
            background-color: #fff;
        }

        .grid-columns-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            pointer-events: none;
        }

        .grid-column {
            flex-grow: 1;
            border-right: 1px solid #f1f3f5;
        }

        .event-block {
            background-color: #ffffff;
            border: 1px solid #d0d7de;
            border-left: 5px solid #0d6efd;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            font-size: 0.85rem;
            text-align: left;
            padding: 10px 12px;
            cursor: grab;
            transition: all 0.2s ease-in-out;
            position: absolute;
            z-index: 5;
            overflow: hidden;
            color: #212529;
            height: 90px; /* ارتفاع الكارت */
            top: 15px;
            display: flex;
            flex-direction: column;
        }

        .event-block:hover {
            z-index: 6;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
        }

        .event-block.conflict {
            background-color: #fff0f1;
            border-left-color: #dc3545;
        }

        .event-subject {
            font-weight: 700;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-details {
            font-size: 0.8rem;
            color: #495057;
            line-height: 1.5;
            margin-top: 4px;
            flex-grow: 1;
        }

        .event-details i.fa-fw {
            color: #6c757d;
            margin-right: 4px;
        }
    </style>
@endpush

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="data-entry-header mb-0">Timetable Result</h1>
                <div class="text-end">
                    <p class="mb-0 small text-muted">Run ID: {{ $chromosome->population->population_id }} | Status:
                        {{ $chromosome->population->status }}</p>
                    <p class="mb-0 small text-muted">Best Fitness (Penalty): {{ $chromosome->penalty_value }}</p>
                    <div class="d-flex align-items-center">
                        <button id="saveChangesBtn" class="btn btn-primary me-2">
                            <i class="fas fa-save me-1"></i> Save Changes
                        </button>
                        <a href="{{ route('algorithm-control.timetable.results.index') }}"
                            class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Back to Timetables
                        </a>
                    </div>
                </div>
            </div>

            @include('dashboard.data-entry.partials._status_messages')

            @if (!empty($conflicts))
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>{{ count($conflicts) }} Conflicts
                            Found</h5>
                    </div>
                    <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                        <ul class="list-group list-group-flush">
                            @foreach ($conflicts as $conflict)
                                <li class="list-group-item list-group-item-danger small">
                                    <strong>{{ $conflict['type'] }}:</strong> {{ $conflict['description'] }}
                                </li>
                            @endforeach
                        </ul>
                    </div>
                </div>
            @else
                <div class="alert alert-success">
                    <strong><i class="fas fa-check-circle me-1"></i> Congratulations!</strong> No hard conflicts were found
                    in this schedule.
                </div>
            @endif

            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Generated Schedule (Resource View)</h5>
                </div>
                <div class="card-body">
                    <div class="timetable-container">
                        @php
                            $headerTimeslots = $timeslotsByDay->first() ?? collect();
                            $totalColumnsOverall = collect($timeslotsByDay)->flatten()->count();
                        @endphp

                        <table class="timetable">
                            <thead>
                                <tr>
                                    <th class="group-header">Student Group</th>
                                    @foreach ($timeslotsByDay as $day => $daySlots)
                                        <th class="day-header" colspan="{{ $daySlots->count() }}">{{ $day }}</th>
                                    @endforeach
                                </tr>
                                <tr>
                                    <th class="group-header"></th>
                                    @foreach (collect($timeslotsByDay)->flatten() as $timeslot)
                                        <th class="time-header">
                                            {{ \Carbon\Carbon::parse($timeslot->start_time)->format('H:i') }}</th>
                                    @endforeach
                                </tr>
                            </thead>
                            <tbody>
                                @foreach ($scheduleByGroup as $group)
                                    <tr>
                                        <th class="group-header">{{ $group['name'] }}</th>
                                        <td class="group-row" colspan="{{ $totalColumnsOverall }}">
                                            <div class="grid-columns-container">
                                                @for ($i = 0; $i < $totalColumnsOverall; $i++)
                                                    <div class="grid-column"></div>
                                                @endfor
                                            </div>

                                            @php $slotsForGroup = []; @endphp
                                            @foreach (collect($group['blocks'])->unique('gene_id') as $block)
                                                @php
                                                    $startSlotId = $block->timeslot_ids[0] ?? null;
                                                    if (!$startSlotId || !isset($slotPositions[$startSlotId])) {
                                                        continue;
                                                    }

                                                    $startColumn = $slotPositions[$startSlotId];
                                                    $span = count($block->timeslot_ids);

                                                    $stackLevel = 0;
                                                    while (true) {
                                                        $isOccupied = false;
                                                        if (isset($slotsForGroup[$stackLevel])) {
                                                            foreach ($slotsForGroup[$stackLevel] as $occupiedSlot) {
                                                                if (
                                                                    $startColumn <
                                                                        $occupiedSlot['start'] +
                                                                            $occupiedSlot['span'] &&
                                                                    $startColumn + $span > $occupiedSlot['start']
                                                                ) {
                                                                    $isOccupied = true;
                                                                    break;
                                                                }
                                                            }
                                                        }
                                                        if (!$isOccupied) {
                                                            $slotsForGroup[$stackLevel][] = [
                                                                'start' => $startColumn,
                                                                'span' => $span,
                                                            ];
                                                            break;
                                                        }
                                                        $stackLevel++;
                                                    }

                                                    $left = ($startColumn / $totalColumnsOverall) * 100;
                                                    $width = ($span / $totalColumnsOverall) * 100;

                                                    // تعديل حسابات الـ top والـ height
                                                    $height = 90; // الارتفاع المطلوب
                                                    $top = $stackLevel * ($height + 5); // 90px ارتفاع الكارت + 5px مسافة

                                                    $isConflict = in_array($block->gene_id, $conflictingGeneIds);
                                                    $conflictDetails = collect($conflicts)->firstWhere(
                                                        'gene_id',
                                                        $block->gene_id,
                                                    );
                                                    $conflictTitle = $isConflict
                                                        ? $conflictDetails['description'] ?? 'Conflict Detected'
                                                        : '';
                                                @endphp
                                                <div class="event-block {{ $isConflict ? 'conflict' : '' }}"
                                                    style="top: {{ $top }}px; left: {{ $left }}%; width: calc({{ $width }}% - 4px); height: {{ $height }}px;"
                                                    title="{{ $conflictTitle }}">
                                                    <div class="event-subject">
                                                        {{ optional($block->section->planSubject->subject)->subject_no }}
                                                        -
                                                        {{ optional($block->section->planSubject->subject)->subject_name }}
                                                        <span class="badge bg-info">{{ $block->block_duration }}h</span>
                                                        @if ($block->block_type == 'Practical' && !$block->is_continuous)
                                                            <span class="badge bg-danger">Split Practical</span>
                                                        @endif
                                                        @if ($block->block_type == 'Theory' && !$block->is_continuous)
                                                            <span class="badge bg-warning">Split Theory</span>
                                                        @endif
                                                    </div>
                                                    <div class="event-details">
                                                        {{ optional($block->instructor->user)->name }}<br>
                                                        Room: {{ optional($block->room)->room_name }} |
                                                        Group: {{ $block->student_group_id }}<br>
                                                        Type: {{ $block->block_type }}
                                                        @if ($block->is_continuous)
                                                            <span class="text-success">• Continuous</span>
                                                        @else
                                                            <span class="text-warning">• Split</span>
                                                        @endif
                                                    </div>
                                                </div>
                                            @endforeach
                                        </td>
                                    </tr>
                                @endforeach
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
@endsection
