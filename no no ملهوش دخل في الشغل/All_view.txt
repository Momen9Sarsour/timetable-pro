resources\views\dashboard\layout.blade.php
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@yield('title', 'TimeTable Pro')</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="{{ asset('dashboard_assets/style.css') }}">
    {{-- Push Styles Stack --}}
    <style>
        /* السايدبار مع التمرير */
        .sidebar {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 250px;
            background: #fff;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 999;
        }

        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
    </style>
    @stack('styles')

</head>

<body>
    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle btn btn-primary">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Header -->
    <div class="header">
        <div class="logo">TimeTable Pro</div>

        <div class="search-bar">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Search courses, instructors...">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <div class="header-controls">
            <div class="dropdown">
                <button class="notification-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <h6 class="dropdown-header">Notifications</h6>
                    </li>
                    <li><a class="dropdown-item" href="#">New schedule generated</a></li>
                    <li><a class="dropdown-item" href="#">Room conflict detected</a></li>
                    <li><a class="dropdown-item" href="#">New message from admin</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item" href="#">View all notifications</a></li>
                </ul>
            </div>

            <div class="dropdown">
                <button class="profile-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-user-circle"></i> John Doe
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i> Profile</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Settings</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-envelope me-2"></i> Messages</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <ul class="sidebar-menu">
            <li class="nav-item {{ request()->routeIs('dashboard.*') ? 'active' : '' }}">
                <a href="{{ route('dashboard.index') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            </li>
            <li>
                <a href="#"><i class="fas fa-graduation-cap"></i> Academic Programs</a>
            </li>

            {{-- <li class="nav-item {{ request()->routeIs('data-entry.plans.*') ? 'active' : '' }}">
                <a href="{{ route('data-entry.plans.index') }}">
                    <i class="fas fa-clipboard-list fa-fw me-2"></i>
                    Academic Plans</a>
            </li> --}}
            {{-- <li>
                <a href="{{ route('dashboard.dataEntry') }}"><i class="fas fa-database"></i> Data Entry</a>
            </li> --}}
            <!-- Data Management Dropdown -->
            {{-- // قائمة منسدلة لإدارة البيانات --}}
            @php
                $isActiveMenu = request()->routeIs('data-entry.*');
                $isActiveAlgorithm = request()->routeIs('algorithm-control*');
                $isViewTimetables = request()->routeIs('dashboard.timetables.*');
            @endphp

            <li class="nav-item">
                <a class="nav-link d-flex align-items-center py-1 small {{ $isActiveMenu ? '' : 'collapsed' }}"
                    data-bs-toggle="collapse" href="#dataManagementMenu" role="button"
                    aria-expanded="{{ $isActiveMenu ? 'true' : 'false' }}" aria-controls="dataManagementMenu">
                    <i class="fas fa-database me-2 fa-4xs"></i>
                    <span class="small">Data Management</span>
                    <i class="fas fa-chevron-down ms-auto fa-3xs"></i>
                </a>

                <div class="collapse {{ $isActiveMenu ? 'show' : '' }}" id="dataManagementMenu">
                    <ul class="nav flex-column">

                        <li class="nav-item {{ request()->routeIs('data-entry.departments.*') ? 'active' : '' }}">
                            <a href="{{ route('data-entry.departments.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.departments') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-building fa-fw me-2 fa-4xs"></i> Departments
                            </a>
                        </li>

                        {{-- @can('manage-users') --}}
                        <li class="nav-item {{ request()->routeIs('data-entry.roles.*') ? 'active' : '' }}">
                            <a href="{{ route('data-entry.roles.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.roles') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-user-shield fa-fw me-2 fa-4xs"></i> Roles
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('manage-users') --}}
                        <li class="nav-item {{ request()->routeIs('data-entry.users.*') ? 'active' : '' }}">
                            <a href="{{ route('data-entry.users.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.users') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-users-cog fa-fw me-2 fa-4xs"></i> Users
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('manage-subjects') --}}
                        <li class="nav-item {{ request()->routeIs('data-entry.room-types.*') ? 'active' : '' }}">

                            <a href="{{ route('data-entry.room-types.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.room-types') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-door-closed fa-fw me-2 fa-4xs"></i> Room Types
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('manage-rooms') --}}
                        <li class="nav-item {{ request()->routeIs('data-entry.rooms.*') ? 'active' : '' }}">
                            <a href="{{ route('data-entry.rooms.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.rooms') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-door-open fa-fw me-2 fa-4xs"></i> Rooms
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('manage-subjects') --}}
                        <li class="nav-item {{ request()->routeIs('data-entry.subject-types.*') ? 'active' : '' }}">

                            <a href="{{ route('data-entry.subject-types.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.subject-types') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-tags fa-fw me-2"></i>SubjectTypes
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('manage-subjects') --}}
                        <li
                            class="nav-item {{ request()->routeIs('data-entry.subject-categories.*') ? 'active' : '' }}">

                            <a href="{{ route('data-entry.subject-categories.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.subject-types') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-project-diagram fa-fw me-2"></i> Subject Categories
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('manage-subjects') --}}
                        <li class="nav-item {{ request()->routeIs('data-entry.subjects.*') ? 'active' : '' }}">
                            <a href="{{ route('data-entry.subjects.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.subjects') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-book fa-fw me-2 fa-4xs"></i> Subjects
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('manage-plans') --}}
                        <li class="nav-item {{ request()->routeIs('data-entry.plans.*') ? 'active' : '' }}">
                            <a href="{{ route('data-entry.plans.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.plans') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-clipboard-list fa-fw me-2 fa-4xs"></i> Academic Plans
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('plan-expected-counts') --}}
                        <li
                            class="nav-item {{ request()->routeIs('data-entry.plan-expected-counts.*') ? 'active' : '' }}">
                            <a href="{{ route('data-entry.plan-expected-counts.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.plan-expected-counts') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-users fa-fw me-2 fa-4xs"></i> Expected Counts
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('sections') --}}
                        <li class="nav-item {{ request()->routeIs('data-entry.sections.*') ? 'active' : '' }}">
                            <a href="{{ route('data-entry.sections.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.plan-expected-counts') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-users-class fa-fw me-2"></i> Sections
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('manage-instructors') --}}
                        <li class="nav-item {{ request()->routeIs('data-entry.instructors.*') ? 'active' : '' }}">
                            <a href="{{ route('data-entry.instructors.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.instructors') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-chalkboard-teacher fa-fw me-2 fa-4xs"></i> Instructors
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('sections') --}}
                        <li
                            class="nav-item {{ request()->routeIs('data-entry.instructor-section.*') ? 'active' : '' }}">
                            <a href="{{ route('data-entry.instructor-section.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.instructor-section') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-link fa-fw me-2"></i> Instructor Section
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('sections') --}}
                        <li
                            class="nav-item {{ request()->routeIs('data-entry.instructor-subjects.*') ? 'active' : '' }}">
                            <a href="{{ route('data-entry.instructor-subjects.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.instructor-subjects') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-link fa-fw me-2"></i> Instructor Subjects
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('manage-timeslots') --}}
                        <li class="nav-item {{ request()->routeIs('data-entry.timeslots.*') ? 'active' : '' }}">
                            <a href="{{ route('data-entry.timeslots.index') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.timeslots') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-clock fa-fw me-2 fa-4xs"></i> Timeslots
                            </a>
                        </li>
                        {{-- @endcan --}}

                        {{-- @can('manage-settings') --}}
                        <li class="nav-item">
                            <a href="{{ route('data-entry.settings') }}"
                                class="nav-link py-1 small d-flex align-items-center {{ request()->routeIs('data-entry.settings') ? 'active text-primary fw-semibold' : 'text-secondary' }}">
                                <i class="fas fa-cogs fa-fw me-2 fa-4xs"></i> Basic Settings
                            </a>
                        </li>
                        {{-- @endcan --}}

                    </ul>
                </div>
            </li>


            <li>
                <a href="#"><i class="fas fa-sliders-h"></i> Constraints</a>
            </li>
            {{-- <li>
                <a href="#"><i class="fas fa-cogs"></i> Algorithm Control</a>
            </li> --}}

            <li class="nav-item">
                <a class="nav-link d-flex align-items-center py-1 small {{ $isActiveAlgorithm ? '' : 'collapsed' }}"
                    data-bs-toggle="collapse" href="#dataAlgorithmMenu" role="button"
                    aria-expanded="{{ $isActiveAlgorithm ? 'true' : 'false' }}" aria-controls="dataAlgorithmMenu">
                    <i class="fas fa-database me-2 fa-4xs"></i>
                    <span class="small">Algorithm Control</span>
                    <i class="fas fa-chevron-down ms-auto fa-3xs"></i>
                </a>
                <div class="collapse {{ $isActiveAlgorithm ? 'show' : '' }}" id="dataAlgorithmMenu">
                    <ul class="nav flex-column">
                        <li class="{{ request()->routeIs('algorithm-control.crossover-types.*') ? 'active' : '' }}">
                            <a href="{{ route('algorithm-control.crossover-types.index') }}"><i
                                    class="fas fa-code-branch fa-fw me-2"></i> Crossover Methods</a>
                        </li>
                        <li class="{{ request()->routeIs('algorithm-control.selection-types.*') ? 'active' : '' }}">
                            <a href="{{ route('algorithm-control.selection-types.index') }}"><i
                                    class="fas fa-check-double fa-fw me-2"></i> Selection Methods</a>
                        </li>
                        {{-- رابط جديد لنتائج الخوارزمية --}}
                        <li
                            class="{{ request()->routeIs('algorithm-control.timetable.results.index') || request()->routeIs('algorithm-control.timetable.result.show') ? 'active' : '' }}">
                            <a href="{{ route('algorithm-control.timetable.results.index') }}">
                                <i class="fas fa-calendar-alt"></i> Generation Results
                            </a>
                        </li>

                    </ul>
                </div>
            </li>

            <li class="nav-item">
                <a class="nav-link d-flex align-items-center py-1 small {{ $isViewTimetables ? '' : 'collapsed' }}"
                    data-bs-toggle="collapse" href="#ViewTimetablesMenu" role="button"
                    aria-expanded="{{ $isViewTimetables ? 'true' : 'false' }}" aria-controls="ViewTimetablesMenu">
                    <i class="fas fa-database me-2 fa-4xs"></i>
                    <span class="small">View Timetables</span>
                    <i class="fas fa-chevron-down ms-auto fa-3xs"></i>
                </a>
                <div class="collapse {{ $isViewTimetables ? 'show' : '' }}" id="ViewTimetablesMenu">


                    {{-- <li class="has-submenu {{ request()->routeIs('dashboard.timetables.*') ? 'active open' : '' }}">
                <a href="#"><i class="fas fa-calendar-alt fa-fw me-2"></i> View Timetables</a> --}}
                    <ul class="nav flex-column">
                        <li class="{{ request()->routeIs('dashboard.timetables.sections') ? 'active' : '' }}">
                            <a href="{{ route('dashboard.timetables.sections') }}"><i
                                    class="fas fa-users-class fa-fw me-2"></i> Section Timetables</a>
                        </li>
                        <li class="{{ request()->routeIs('dashboard.timetables.instructors') ? 'active' : '' }}">
                            <a href="{{ route('dashboard.timetables.instructors') }}"><i
                                    class="fas fa-chalkboard-teacher fa-fw me-2"></i> Instructor Timetables</a>
                        </li>
                        <li class="{{ request()->routeIs('dashboard.timetables.rooms') ? 'active' : '' }}">
                            <a href="{{ route('dashboard.timetables.rooms') }}"><i
                                    class="fas fa-door-open fa-fw me-2"></i> Room Timetables</a>
                        </li>
                    </ul>
                </div>
            </li>

            <li>
                <a href="#"><i class="fas fa-chart-bar"></i> Reports & Analytics</a>
            </li>
        </ul>

        <div class="sidebar-footer">
            <button class="dark-mode-toggle">
                <i class="fas fa-moon"></i> Dark Mode
            </button>
            <button class="help-btn">
                <i class="fas fa-question-circle"></i> Help
            </button>
        </div>
    </div>

    <!-- Main Content -->
    @yield('content')

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ asset('dashboard_assets/script.js') }}"></script>
    <!-- Page-specific Scripts -->
    @stack('scripts')
</body>

</html>
------------------------------------------------------------------------------------------------------
resources\views\dashboard\index.blade.php
@extends('dashboard.layout')
@section('content')
    <div class="main-content">
        <!-- Stats Cards -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon text-primary">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">324</div>
                    <div class="stat-label">Total Courses</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon text-success">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">48</div>
                    <div class="stat-label">Active Instructors</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon text-info">
                    <i class="fas fa-door-open"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">12</div>
                    <div class="stat-label">Available Rooms</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon text-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">3</div>
                    <div class="stat-label">Current Conflicts</div>
                </div>
            </div>

        </div>

        @include('dashboard.data-entry.partials._status_messages')


        <!-- Generation Info and Controls -->
        <div class="generation-container">
            <div class="generation-header d-flex justify-content-between align-items-center w-100">
                <div class="generation-info">
                    <i class="fas fa-code-branch"></i> Generation #45 | Current fitness score: 0.89
                </div>

                <div class="control-buttons">
                    {{-- <button class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> Generate Schedule
                    </button> --}}
                    {{-- <div class="control-buttons"> --}}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateScheduleModal">
                        <i class="fas fa-sync-alt"></i> Generate Schedule
                    </button>

                    {{-- <button class="btn btn-outline-secondary">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button class="btn btn-outline-secondary">
                            <i class="fas fa-stop"></i> Stop
                        </button> --}}
                    {{-- أزرار Pause و Stop (تحتاج لـ JS متقدم) --}}
                    <button class="btn btn-outline-secondary" disabled> <i class="fas fa-pause"></i> Pause </button>
                    <button class="btn btn-outline-secondary" disabled> <i class="fas fa-stop"></i> Stop </button>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container w-100 mt-3">
                <div class="d-flex justify-content-between mb-1">
                    <small>Progress: 89%</small>
                    <small>Time remaining: 2m 15s</small>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" role="progressbar"
                        style="width: 89%" aria-valuenow="89" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
        <!-- Schedule Table -->
        <div class="schedule-container">
            <div class="schedule-header">Weekly Schedule</div>
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Monday</th>
                        <th>Tuesday</th>
                        <th>Wednesday</th>
                        <th>Thursday</th>
                        <th>Friday</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>8:00 AM</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>9:00 AM</td>
                        <td>
                            <div class="course-event">CS101</div>
                            <div class="course-event">Room 301</div>
                            <div class="course-event">Dr. Smith</div>
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>10:00 AM</td>
                        <td></td>
                        <td>
                            <div class="course-event">MATH201</div>
                            <div class="course-event">Room 205</div>
                            <div class="course-event">Dr. Johnson</div>
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>11:00 AM</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>12:00 PM</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>1:00 PM</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>2:00 PM</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>3:00 PM</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>4:00 PM</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>5:00 PM</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Conflicts Section -->
        <div class="conflicts-container">
            <div class="conflicts-header">
                <i class="fas fa-exclamation-triangle"></i> Current Conflicts
            </div>

            <div class="conflict-item">
                <div class="conflict-title">
                    <i class="fas fa-door-open"></i> Room Conflict
                </div>
                <div class="conflict-desc">CS101 and MATH201 scheduled in Room 301 at the same time</div>
            </div>

            <div class="conflict-item">
                <div class="conflict-title">
                    <i class="fas fa-user-tie"></i> Instructor Availability
                </div>
                <div class="conflict-desc">Dr. Smith is scheduled for two classes simultaneously</div>
            </div>

            <div class="conflict-item">
                <div class="conflict-title">
                    <i class="fas fa-clock"></i> Time Constraint
                </div>
                <div class="conflict-desc">DHYS101 scheduled outside of allowed time slot</div>
            </div>
        </div>
    </div>
@endsection


{{-- ===================================================== --}}
{{-- مودال بدء عملية الجدولة مع الإعدادات --}}
{{-- ===================================================== --}}
<div class="modal fade" id="generateScheduleModal" tabindex="-1" aria-labelledby="generateScheduleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateScheduleModalLabel"><i class="fas fa-cogs me-2"></i>Timetable
                    Generation Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            {{-- الفورم يرسل لدالة بدء التشغيل في الكنترولر --}}
            <form action="{{ route('algorithm-control.timetable.generate.start') }}" method="POST">
                {{-- <form action="#" method="POST"> --}}
                @csrf
                <div class="modal-body">
                    <p class="text-muted mb-4">Configure the parameters for this generation run. Different settings
                        can affect the speed and quality of the result.</p>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="academic_year" class="form-label">Academic Year <span
                                    class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('academic_year') is-invalid @enderror"
                                id="academic_year" name="academic_year" value="{{ old('academic_year', date('Y')) }}"
                                required placeholder="e.g., 2025">
                            @error('academic_year')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="col-md-6">
                            <label for="semester" class="form-label">Semester <span
                                    class="text-danger">*</span></label>
                            <select class="form-select @error('semester') is-invalid @enderror" id="semester"
                                name="semester" required>
                                <option value="" disabled>Select a semester...</option>
                                <option value="1" {{ old('semester') == 1 ? 'selected' : '' }}>First</option>
                                <option value="2" {{ old('semester') == 2 ? 'selected' : '' }}>Second</option>
                                <option value="3" {{ old('semester') == 3 ? 'selected' : '' }}>Summer</option>
                            </select>
                            @error('semester')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>
                    {{-- *********************************** --}}

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="setting_population_size" class="form-label">Population Size</label>
                            <input type="number" class="form-control" id="setting_population_size"
                                name="population_size" value="{{ config('algorithm.settings.population_size', 100) }}"
                                required min="10" step="10">
                            <small class="text-muted">No. of schedules per generation.</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="setting_max_generations" class="form-label">Max Generations</label>
                            <input type="number" class="form-control" id="setting_max_generations"
                                name="max_generations" value="{{ config('algorithm.settings.max_generations', 100) }}"
                                required min="10" step="10">
                            <small class="text-muted">When to stop if no solution is found.</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="setting_mutation_rate" class="form-label">Mutation Rate</label>
                            <input type="number" class="form-control" id="setting_mutation_rate"
                                name="mutation_rate" value="{{ config('algorithm.settings.mutation_rate', 0.5) }}"
                                required min="0" max="1" step="0.01">
                            <small class="text-muted">e.g., 0.01 for 1%.</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="setting_crossover_type_id" class="form-label">Crossover Method</label>
                            <select class="form-select" id="setting_crossover_type_id" name="crossover_type_id"
                                required>
                                {{-- جلب الخيارات من قاعدة البيانات --}}
                                @foreach (\App\Models\CrossoverType::where('is_active', true)->get() as $type)
                                    <option value="{{ $type->crossover_id }}" title="{{ $type->description }}"
                                        {{ config('algorithm.settings.crossover_type_id') == $type->crossover_id ? 'selected' : '' }}>
                                        {{ $type->name }}
                                    </option>
                                @endforeach
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="setting_selection_type_id" class="form-label">Selection Method</label>
                            <select class="form-select" id="setting_selection_type_id" name="selection_type_id"
                                required>
                                @foreach (\App\Models\SelectionType::where('is_active', true)->get() as $type)
                                    <option value="{{ $type->selection_type_id }}" title="{{ $type->description }}"
                                        {{ config('algorithm.settings.selection_type_id') == $type->selection_type_id ? 'selected' : '' }}>
                                        {{ $type->name }}
                                    </option>
                                @endforeach
                            </select>
                        </div>
                    </div>

                    <hr>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch"
                            id="setting_stop_at_first_valid" name="stop_at_first_valid" value="1"
                            {{ config('algorithm.settings.stop_at_first_valid', false) ? 'checked' : '' }}>
                        <label class="form-check-label" for="setting_stop_at_first_valid">Stop at First Valid
                            Solution</label>
                        <small class="text-muted d-block">Stops when it finds a schedule with zero hard-constraint
                            violations.</small>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-play me-1"></i> Start Generation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
---------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\departments.blade.php
@extends('dashboard.layout')

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="data-entry-header mb-0">Manage Departments</h1>
                <div class="d-flex">
                    <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addDepartmentModal">
                        <i class="fas fa-plus me-1"></i> Add New Department
                    </button>
                    {{-- *** الزر الجديد للرفع بالجملة *** --}}
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bulkUploadDepartmentsModal">
                        <i class="fas fa-file-excel me-1"></i> Bulk Upload Departments
                    </button>
                </div>
            </div>

            {{-- // رسائل النجاح أو الخطأ --}}
            {{-- @if (session('success'))
            <div class="alert alert-success">
                {{ session('success') }}
            </div>
            @endif
        @if ($errors->any())
            <div class="alert alert-danger">
                 Please check the form below for errors.
                </div>
                @endif --}}
            @include('dashboard.data-entry.partials._status_messages')

            @if (session('skipped_details'))
                <div class="alert alert-warning mt-3">
                    <h5>Skipped Rows Details:</h5>
                    <ul class="mb-0">
                        @foreach (session('skipped_details') as $detail)
                            <li>{{ $detail }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif

            {{-- // جدول لعرض الأقسام --}}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Department No</th>
                            <th>Department Name</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @forelse ($departments as $index => $department)
                            <tr>
                                <td>{{ $index + 1 }}</td>
                                <td>{{ $department->department_no }}</td>
                                <td>{{ $department->department_name }}</td>
                                <td>{{ $department->created_at->format('Y-m-d H:i') }}</td>
                                <td>

                                    <button class="btn btn-sm btn-info me-1" data-bs-toggle="modal"
                                        data-bs-target="#editDepartmentModal-{{ $department->id }}">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                        data-bs-target="#deleteDepartmentModal-{{ $department->id }}">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>

                                    {{-- // التعديل والحذف هنا لكل صف --}}
                                    @include('dashboard.data-entry.partials.departments_modals', [
                                        'department' => $department,
                                    ])

                                </td>
                            </tr>
                        @empty
                            <tr>
                                <td colspan="5" class="text-center">No departments found.</td>
                            </tr>
                        @endforelse
                    </tbody>
                </table>
            </div>

            <div class="mt-3 d-flex justify-content-center">
                {{-- // Pagination إذا لزم الأمر --}}
                {{ $departments->links('pagination::bootstrap-5') }}
                {{-- {{ $rooms->links() }} --}}
            </div>
            {{-- // لإضافة قسم جديد --}}
            @include('dashboard.data-entry.partials.departments_modals', ['department' => null])

        </div>
    </div>
@endsection

@push('scripts')
    {{-- // يمكن إضافة JavaScript خاص بهذه الصفحة هنا إذا لزم الأمر --}}
    <script>
        // Example: Handle modal events if needed
    </script>
@endpush
----------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_status_messages.blade.php
@if (session('success'))
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>{{ session('success') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
@endif

@if (session('error'))
     <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>{{ session('error') }}
         <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
@endif

{{-- // عرض أخطاء الـ Validation بشكل عام إذا لم يتم عرضها تحت كل حقل --}}
@if ($errors->any() && !isset($hideGeneralErrors)) {{-- // متغير للتحكم بإظهار الأخطاء العامة --}}
     <div class="alert alert-danger alert-dismissible fade show" role="alert">
         <i class="fas fa-exclamation-circle me-2"></i> Please check the form for errors.
         <ul>
             @foreach ($errors->all() as $error)
                 <li>{{ $error }}</li>
             @endforeach
         </ul>
         <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
@endif
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\departments_modals.blade.php
{{-- // Modal لإضافة قسم جديد --}}
@if (!$department)
<div class="modal fade" id="addDepartmentModal" tabindex="-1" aria-labelledby="addDepartmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDepartmentModalLabel">Add New Department</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.departments.store') }}" method="POST">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add_department_no" class="form-label">Department Number/Code</label>
                        <input type="text" class="form-control @error('department_no') is-invalid @enderror" id="add_department_no" name="department_no" value="{{ old('department_no') }}" required>
                        @error('department_no')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="mb-3">
                        <label for="add_department_name" class="form-label">Department Name</label>
                        <input type="text" class="form-control @error('department_name') is-invalid @enderror" id="add_department_name" name="department_name" value="{{ old('department_name') }}" required>
                         @error('department_name')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Department</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endif

{{-- // Modal لتعديل قسم موجود --}}
@if ($department)
<div class="modal fade" id="editDepartmentModal-{{ $department->id }}" tabindex="-1" aria-labelledby="editDepartmentModalLabel-{{ $department->id }}" aria-hidden="true">
     <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDepartmentModalLabel-{{ $department->id }}">Edit Department: {{ $department->department_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             <form action="{{ route('data-entry.departments.update', $department->id) }}" method="POST">
                @csrf
                @method('PUT')
                <div class="modal-body">
                     <div class="mb-3">
                        <label for="edit_department_no_{{ $department->id }}" class="form-label">Department Number/Code</label>
                        <input type="text" class="form-control @error('department_no', 'update_'.$department->id) is-invalid @enderror" id="edit_department_no_{{ $department->id }}" name="department_no" value="{{ old('department_no', $department->department_no) }}" required>
                        @error('department_no', 'update_'.$department->id)
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="mb-3">
                        <label for="edit_department_name_{{ $department->id }}" class="form-label">Department Name</label>
                        <input type="text" class="form-control @error('department_name', 'update_'.$department->id) is-invalid @enderror" id="edit_department_name_{{ $department->id }}" name="department_name" value="{{ old('department_name', $department->department_name) }}" required>
                         @error('department_name', 'update_'.$department->id)
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update Department</button>
                </div>
            </form>
        </div>
    </div>
</div>

{{-- // Modal لتأكيد الحذف --}}
<div class="modal fade" id="deleteDepartmentModal-{{ $department->id }}" tabindex="-1" aria-labelledby="deleteDepartmentModalLabel-{{ $department->id }}" aria-hidden="true">
     <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteDepartmentModalLabel-{{ $department->id }}">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             <form action="{{ route('data-entry.departments.destroy', $department->id) }}" method="POST">
                @csrf
                @method('DELETE')
                <div class="modal-body">
                    <p>Are you sure you want to delete the department: <strong>{{ $department->department_name }} ({{ $department->department_no }})</strong>?</p>
                    <p class="text-danger small">This action cannot be undone. Associated instructors, subjects, or plans might be affected depending on deletion constraints.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Yes, Delete Department</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endif


{{-- *** مودال الرفع بالأكسل (جديد) *** --}}
    <div class="modal fade" id="bulkUploadDepartmentsModal" tabindex="-1" aria-labelledby="bulkUploadDepartmentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkUploadDepartmentsModalLabel">Bulk Upload Departments from Excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ route('data-entry.departments.bulkUpload') }}" method="POST" enctype="multipart/form-data">
                    @csrf
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="department_excel_file" class="form-label">Select Excel File <span class="text-danger">*</span></label>
                            <input class="form-control @error('department_excel_file', 'bulkUploadDepartments') is-invalid @enderror" type="file" id="department_excel_file" name="department_excel_file" accept=".xlsx, .xls, .csv" required>
                            @error('department_excel_file', 'bulkUploadDepartments')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="alert alert-info small p-2">
                            <p class="mb-1"><strong>File Format Instructions:</strong></p>
                            <ul class="mb-0 ps-3">
                                <li>The first row should be headers (e.g., ID, department_no, department_name).</li>
                                <li>The system will use 'department_no' and 'department_name' columns.</li>
                                <li>If a department_no or department_name from the file already exists in the system, its data will be updated. Otherwise, a new department will be created.</li>
                                <li>Empty rows will be skipped.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload me-1"></i> Upload and Process
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {{-- *** نهاية مودال الرفع *** --}}

---------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\roles.blade.php
@extends('dashboard.layout')

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="data-entry-header mb-0">Manage Roles</h1>
                {{-- // زر لإظهار Modal الإضافة --}}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRoleModal">
                    <i class="fas fa-plus me-1"></i> Add New Role
                </button>
            </div>

            {{-- // عرض رسائل الحالة --}}
            @include('dashboard.data-entry.partials._status_messages')

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">System Name (Code)</th> {{-- // اسم النظام (name) --}}
                                    <th scope="col">Display Name</th> {{-- // الاسم المعروض --}}
                                    <th scope="col">Description</th>
                                    <th scope="col">User Count</th> {{-- // عدد المستخدمين بالدور --}}
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @forelse ($roles as $index => $role)
                                    @php $isCoreRole = in_array($role->name, ['admin', 'hod', 'instructor', 'student']); @endphp
                                    <tr>
                                        <td>{{ $index + 1 }}</td>
                                        <td><code>{{ $role->name }}</code></td>
                                        <td>{{ $role->display_name }}</td>
                                        <td>{{ $role->description ?? '-' }}</td>
                                        <td>{{ $role->users()->count() }}</td> {{-- // عرض عدد المستخدمين --}}
                                        <td>
                                            {{-- // زر التعديل (يمكن تعطيله للأدوار الأساسية) --}}
                                            <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal"
                                                data-bs-target="#editRoleModal-{{ $role->id }}" title="Edit"
                                                {{-- $isCoreRole ? 'disabled' : '' --}}>
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {{-- // زر الحذف (معطل للأدوار الأساسية أو إذا كان عدد المستخدمين > 0) --}}
                                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                                data-bs-target="#deleteRoleModal-{{ $role->id }}" title="Delete"
                                                {{-- {{ ($isCoreRole || $role->users()->count() > 0) ? 'disabled' : '' }} --}}>
                                                <i class="fas fa-trash"></i>
                                            </button>

                                            {{-- // تضمين Modals --}}
                                            @include('dashboard.data-entry.partials._role_modals', [
                                                'role' => $role,
                                            ])
                                        </td>
                                    </tr>
                                @empty
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">No roles found. Core roles are
                                            typically seeded.</td>
                                    </tr>
                                @endforelse
                            </tbody>
                        </table>
                    </div>
                    {{-- إضافة روابط الـ Pagination --}}
                    <div class="mt-3 d-flex justify-content-center">
                        {{-- {{ $roles->links() }} هذا يعرض روابط التنقل بين الصفحات --}}
                        {{ $roles->links('pagination::bootstrap-5') }}
                    </div>
                </div>
            </div>

            {{-- // Modal لإضافة دور جديد --}}
            @include('dashboard.data-entry.partials._role_modals', ['role' => null])

        </div>
    </div>
@endsection

@push('scripts')
    {{-- // يمكن إضافة JavaScript خاص بهذه الصفحة هنا --}}
@endpush
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_role_modals.blade.php
{{-- // Modal لإضافة دور جديد --}}
@if (!$role)
<div class="modal fade" id="addRoleModal" tabindex="-1" aria-labelledby="addRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRoleModalLabel">Add New Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.roles.store') }}" method="POST">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add_role_name" class="form-label">System Name (Code) <span class="text-danger">*</span></label>
                        <input type="text" class="form-control @error('name', 'store') is-invalid @enderror" id="add_role_name" name="name" value="{{ old('name') }}" required placeholder="e.g., supervisor, librarian (lowercase, no spaces)">
                        <small class="text-muted">Use lowercase letters, numbers, dashes, underscores only.</small>
                        @error('name', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                    </div>
                    <div class="mb-3">
                         <label for="add_role_display_name" class="form-label">Display Name <span class="text-danger">*</span></label>
                         <input type="text" class="form-control @error('display_name', 'store') is-invalid @enderror" id="add_role_display_name" name="display_name" value="{{ old('display_name') }}" required placeholder="e.g., Supervisor, Librarian">
                         @error('display_name', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                     </div>
                    <div class="mb-3">
                        <label for="add_role_description" class="form-label">Description (Optional)</label>
                        <textarea class="form-control @error('description', 'store') is-invalid @enderror" id="add_role_description" name="description" rows="3">{{ old('description') }}</textarea>
                        @error('description', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Role</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endif

{{-- // Modal لتعديل دور موجود --}}
@if ($role)
{{-- @php $isCoreRole = in_array($role->name, ['admin', 'hod', 'instructor', 'student']); @endphp --}}
<div class="modal fade" id="editRoleModal-{{ $role->id }}" tabindex="-1" aria-labelledby="editRoleModalLabel-{{ $role->id }}" aria-hidden="true">
     <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRoleModalLabel-{{ $role->id }}">Edit Role: {{ $role->display_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             {{-- // لا نسمح بتعديل الأدوار الأساسية --}}
             {{-- @if($isCoreRole) --}}
                 {{-- <div class="modal-body">
                     <div class="alert alert-warning">Core system roles cannot be modified.</div>
                 </div>
                  <div class="modal-footer">
                     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                 </div> --}}
             {{-- @else --}}
                 <form action="{{ route('data-entry.roles.update', $role->id) }}" method="POST">
                    @csrf
                    @method('PUT')
                    <div class="modal-body">
                         <div class="mb-3">
                            <label for="edit_role_name_{{ $role->id }}" class="form-label">System Name (Code) <span class="text-danger">*</span></label>
                            <input type="text" class="form-control @error('name', 'update_'.$role->id) is-invalid @enderror" id="edit_role_name_{{ $role->id }}" name="name" value="{{ old('name', $role->name) }}" required>
                            <small class="text-muted">Use lowercase letters, numbers, dashes, underscores only.</small>
                            @error('name', 'update_'.$role->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="mb-3">
                             <label for="edit_role_display_name_{{ $role->id }}" class="form-label">Display Name <span class="text-danger">*</span></label>
                             <input type="text" class="form-control @error('display_name', 'update_'.$role->id) is-invalid @enderror" id="edit_role_display_name_{{ $role->id }}" name="display_name" value="{{ old('display_name', $role->display_name) }}" required>
                             @error('display_name', 'update_'.$role->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                         </div>
                        <div class="mb-3">
                            <label for="edit_role_description_{{ $role->id }}" class="form-label">Description (Optional)</label>
                            <textarea class="form-control @error('description', 'update_'.$role->id) is-invalid @enderror" id="edit_role_description_{{ $role->id }}" name="description" rows="3">{{ old('description', $role->description) }}</textarea>
                            @error('description', 'update_'.$role->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Update Role</button>
                    </div>
                </form>
             {{-- @endif --}}
        </div>
    </div>
</div>

{{-- // Modal لتأكيد الحذف --}}
{{-- // لا نحتاج لعرضه إذا كان الزر معطلاً، ولكن نضيفه للكمال --}}
@if ((!$isCoreRole && $role->users()->count() == 0))
<div class="modal fade" id="deleteRoleModal-{{ $role->id }}" tabindex="-1" aria-labelledby="deleteRoleModalLabel-{{ $role->id }}" aria-hidden="true">
     <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteRoleModalLabel-{{ $role->id }}">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             <form action="{{ route('data-entry.roles.destroy', $role->id) }}" method="POST">
                @csrf
                @method('DELETE')
                <div class="modal-body">
                    <p>Are you sure you want to delete the role: <strong>{{ $role->display_name }} (<code>{{ $role->name }}</code>)</strong>?</p>
                    <p class="text-danger small">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Yes, Delete Role</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endif
@endif
---------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\users.blade.php
@extends('dashboard.layout')

@section('content')
<div class="main-content">
    <div class="data-entry-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
             <h1 class="data-entry-header mb-0">Manage Users & Roles</h1>
             {{-- // زر لإظهار Modal الإضافة --}}
             <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                 <i class="fas fa-user-plus me-1"></i> Add New User
             </button>
        </div>

        {{-- // عرض رسائل الحالة --}}
        @include('dashboard.data-entry.partials._status_messages')

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Name</th>
                                <th scope="col">Email</th>
                                <th scope="col">Role</th>
                                <th scope="col">Email Verified</th>
                                <th scope="col">Joined At</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @forelse ($users as $index => $user)
                            <tr>
                                <td>{{ $index + 1 }}</td>
                                <td>{{ $user->name }}</td>
                                <td>{{ $user->email }}</td>
                                {{-- // عرض اسم الدور من العلاقة --}}
                                <td>
                                    {{-- <span class="badge rounded-pill bg-{{ $user->role->name === 'admin' ? 'danger' : ($user->role->name === 'hod' ? 'warning text-dark' : ($user->role->name === 'instructor' ? 'info text-dark' : 'secondary')) }}">
                                        {{ $user->role->display_name ?? 'N/A' }}
                                    </span> --}}
                                    <span class="badge rounded-pill bg-{{ $user->role?->name === 'admin' ? 'danger' : ($user->role?->name === 'hod' ? 'warning text-dark' : ($user->role?->name === 'instructor' ? 'info text-dark' : 'secondary')) }}">
                                        {{ $user->role?->display_name ?? 'No Role' }} {{-- // عرض No Role إذا كان الدور null --}}
                                    </span>
                                </td>
                                <td>
                                    @if($user->email_verified_at)
                                        <i class="fas fa-check-circle text-success" title="{{ $user->email_verified_at->format('Y-m-d H:i') }}"></i> Yes
                                    @else
                                        <i class="fas fa-times-circle text-danger"></i> No
                                    @endif
                                </td>
                                <td>{{ $user->created_at }}</td>
                                {{-- <td>{{ $user->created_at->format('Y-m-d') }}</td> --}}
                                <td>
                                    {{-- // زر التعديل --}}
                                    <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#editUserModal-{{ $user->id }}" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {{-- // زر الحذف --}}
                                    {{-- // لا نحذف الأدمن الأول عادةً --}}
                                    @if($user->id !== 1) {{-- // افترض أن ID الأدمن الأول هو 1 --}}
                                        <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteUserModal-{{ $user->id }}" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    @else
                                         <button class="btn btn-sm btn-outline-secondary" disabled title="Cannot delete primary admin">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    @endif

                                    {{-- // تضمين Modals --}}
                                    @include('dashboard.data-entry.partials._user_modals', [
                                        'user' => $user,
                                        'roles' => $roles
                                    ])
                                </td>
                            </tr>
                            @empty
                            <tr>
                                <td colspan="7" class="text-center text-muted">No users found. Click 'Add New User' to create one.</td>
                            </tr>
                            @endforelse
                        </tbody>
                    </table>
                </div>
                 {{-- // Pagination إذا لزم الأمر --}}
                 <div class="mt-3 d-flex justify-content-center">
                  {{ $users->links('pagination::bootstrap-5') }}
                  {{-- // {{ $users->links() }} --}}
                </div>
            </div>
        </div>

         {{-- // Modal لإضافة مستخدم جديد --}}
         @include('dashboard.data-entry.partials._user_modals', [
             'user' => null,
             'roles' => $roles
         ])

    </div>
</div>
@endsection

@push('scripts')
{{-- // يمكن إضافة JavaScript خاص بهذه الصفحة هنا --}}
@endpush
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_user_modals.blade.php
{{-- // Modal لإضافة مستخدم جديد --}}
@if (!$user)
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            {{-- // تأكد من أن هذا الـ route معرف --}}
            <form action="{{ route('data-entry.users.store') }}" method="POST">
                @csrf
                <div class="modal-body">
                    {{-- // الاسم --}}
                    <div class="mb-3">
                        <label for="add_user_name" class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control @error('name', 'store') is-invalid @enderror" id="add_user_name" name="name" value="{{ old('name') }}" required>
                        @error('name', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                    </div>
                    {{-- // الإيميل --}}
                    <div class="mb-3">
                         <label for="add_user_email" class="form-label">Email Address <span class="text-danger">*</span></label>
                         <input type="email" class="form-control @error('email', 'store') is-invalid @enderror" id="add_user_email" name="email" value="{{ old('email') }}" required>
                         @error('email', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                     </div>
                    {{-- // كلمة المرور --}}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_user_password" class="form-label">Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control @error('password', 'store') is-invalid @enderror" id="add_user_password" name="password" required>
                            @error('password', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_user_password_confirmation" class="form-label">Confirm Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="add_user_password_confirmation" name="password_confirmation" required>
                        </div>
                    </div>
                    {{-- // الدور --}}
                    <div class="mb-3">
                         <label for="add_user_role_id" class="form-label">Assign Role <span class="text-danger">*</span></label>
                         <select class="form-select @error('role_id', 'store') is-invalid @enderror" id="add_user_role_id" name="role_id" required>
                             <option value="" selected disabled>Select role...</option>
                             {{-- // تأكد أن $roles تم تمريرها لهذا الـ include --}}
                             @if(isset($roles))
                                 @foreach ($roles as $role)
                                     <option value="{{ $role->id }}" {{ old('role_id') == $role->id ? 'selected' : '' }}>{{ $role->display_name }}</option>
                                 @endforeach
                             @endif
                         </select>
                         @error('role_id', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                     </div>
                    {{-- // تأكيد الإيميل --}}
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="add_user_verify_email" name="verify_email" value="1" {{ old('verify_email') ? 'checked' : '' }}>
                        <label class="form-check-label" for="add_user_verify_email">
                            Mark email as verified immediately
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endif


{{-- // Modals التعديل والحذف --}}
@if ($user)

{{-- // Modal لتعديل مستخدم موجود --}}
<div class="modal fade" id="editUserModal-{{ $user->id }}" tabindex="-1" aria-labelledby="editUserModalLabel-{{ $user->id }}" aria-hidden="true">
     <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel-{{ $user->id }}">Edit User: {{ $user->name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             {{-- // تأكد من أن هذا الـ route معرف --}}
             <form action="{{ route('data-entry.users.update', $user->id) }}" method="POST">
                @csrf
                @method('PUT')
                <div class="modal-body">
                    {{-- // الاسم --}}
                    <div class="mb-3">
                        <label for="edit_user_name_{{ $user->id }}" class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control @error('name', 'update_'.$user->id) is-invalid @enderror" id="edit_user_name_{{ $user->id }}" name="name" value="{{ old('name', $user->name) }}" required>
                        @error('name', 'update_'.$user->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                    </div>
                    {{-- // الإيميل --}}
                    <div class="mb-3">
                         <label for="edit_user_email_{{ $user->id }}" class="form-label">Email Address <span class="text-danger">*</span></label>
                         <input type="email" class="form-control @error('email', 'update_'.$user->id) is-invalid @enderror" id="edit_user_email_{{ $user->id }}" name="email" value="{{ old('email', $user->email) }}" required>
                         @error('email', 'update_'.$user->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                     </div>
                    {{-- // الدور --}}
                    <div class="mb-3">
                         <label for="edit_user_role_id_{{ $user->id }}" class="form-label">Assign Role <span class="text-danger">*</span></label>
                         <select class="form-select @error('role_id', 'update_'.$user->id) is-invalid @enderror" id="edit_user_role_id_{{ $user->id }}" name="role_id" required {{ $user->id === 1 ? 'disabled' : '' }}>
                             <option value="" disabled>Select role...</option>
                             {{-- // تأكد أن $roles تم تمريرها لهذا الـ include --}}
                              @if(isset($roles))
                                 @foreach ($roles as $role)
                                     {{-- // منع تغيير دور الأدمن الأول لدور آخر --}}
                                      @if($user->id === 1 && optional($user->role)->name === 'admin' && $role->name !== 'admin')
                                          @continue
                                      @endif
                                     <option value="{{ $role->id }}" {{ old('role_id', $user->role_id) == $role->id ? 'selected' : '' }}>{{ $role->display_name }}</option>
                                 @endforeach
                              @endif
                         </select>
                         @if($user->id === 1 && optional($user->role)->name === 'admin')
                            {{-- // إضافة حقل مخفي لإرسال دور الأدمن إذا كان معطلاً --}}
                            <input type="hidden" name="role_id" value="{{ $user->role_id }}">
                            <small class="text-muted d-block">Primary admin role cannot be changed.</small>
                         @endif
                         @error('role_id', 'update_'.$user->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                     </div>
                    {{-- // كلمة المرور --}}
                    <hr>
                     <p class="text-muted small">Leave password fields blank if you do not want to change the password.</p>
                     <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_user_password_{{ $user->id }}" class="form-label">New Password</label>
                            <input type="password" class="form-control @error('password', 'update_'.$user->id) is-invalid @enderror" id="edit_user_password_{{ $user->id }}" name="password">
                            @error('password', 'update_'.$user->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_user_password_confirmation_{{ $user->id }}" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="edit_user_password_confirmation_{{ $user->id }}" name="password_confirmation">
                        </div>
                    </div>
                    {{-- // تأكيد/إلغاء تأكيد الإيميل --}}
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="edit_user_verify_email_{{ $user->id }}" name="verify_email" value="1" {{ old('verify_email', $user->email_verified_at ? true : false) ? 'checked' : '' }}>
                        <label class="form-check-label" for="edit_user_verify_email_{{ $user->id }}">
                            Mark email as verified
                        </label>
                    </div>
                     <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="edit_user_unverify_email_{{ $user->id }}" name="unverify_email" value="1" {{ old('unverify_email') ? 'checked' : '' }}>
                        <label class="form-check-label" for="edit_user_unverify_email_{{ $user->id }}">
                            Mark email as unverified
                        </label>
                        <small class="text-muted d-block">(Overrides the checkbox above if selected)</small>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update User</button>
                </div>
            </form>
        </div>
    </div>
</div>

{{-- // Modal لتأكيد الحذف --}}
{{-- // هذا هو الجزء الذي كان يسبب الخطأ، الآن هو داخل الشرط @if ($user) --}}
@if ($user->id !== 1) {{-- // لا نظهر مودال الحذف للأدمن الأول --}}
<div class="modal fade" id="deleteUserModal-{{ $user->id }}" tabindex="-1" aria-labelledby="deleteUserModalLabel-{{ $user->id }}" aria-hidden="true">
     <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteUserModalLabel-{{ $user->id }}">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             {{-- // تأكد من أن هذا الـ route معرف --}}
             <form action="{{ route('data-entry.users.destroy', $user->id) }}" method="POST">
                @csrf
                @method('DELETE')
                <div class="modal-body">
                    <p>Are you sure you want to delete the user: <strong>{{ $user->name }} ({{ $user->email }})</strong>?</p>
                    {{-- // استخدام optional() أو ?-> للوصول للعلاقات بأمان --}}
                    @if($user->instructor)
                        <p class="text-warning small"><strong>Warning:</strong> This user is linked to an instructor record ({{ optional($user->instructor)->instructor_no ?? 'N/A' }}). Deleting the user will set the `user_id` in the instructor record to NULL.</p>
                    @endif
                    <p class="text-danger small">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Yes, Delete User</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endif {{-- // نهاية الشرط if ($user->id !== 1) --}}

@endif {{-- // نهاية الشرط if ($user) --}}
----------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\room-types.blade.php
@extends('dashboard.layout')

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                {{-- // تغيير العنوان --}}
                <h1 class="data-entry-header mb-0">Manage Room Types</h1>
                <div class="d-flex">
                    {{-- // تغيير الـ target للـ Modal --}}
                    <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addRoomTypeModal">
                        <i class="fas fa-plus me-1"></i> Add New Room Type
                    </button>
                    {{-- *** زر الرفع بالأكسل *** --}}
                    <button class="btn btn-outline-success me-2" data-bs-toggle="modal"
                        data-bs-target="#bulkUploadRoomTypesModal">
                        <i class="fas fa-file-excel me-2"></i> Bulk Upload Room Types
                    </button>
                </div>
            </div>

            @include('dashboard.data-entry.partials._status_messages')

            @if (session('skipped_details'))
                <div class="alert alert-warning mt-3">
                    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Skipped Rows During Upload:</h5>
                    <ul class="mb-0 small" style="max-height: 200px; overflow-y: auto;">
                        @foreach (session('skipped_details') as $detail)
                            <li>{{ $detail }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Type Name</th> {{-- // تغيير العمود --}}
                                    <th scope="col">Room Count</th> {{-- // عدد القاعات بالنوع --}}
                                    <th scope="col">Created At</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{-- // تغيير اسم المتغير إلى $roomTypes --}}
                                @forelse ($roomTypes as $index => $type)
                                    <tr>
                                        {{-- // تغيير المتغير --}}
                                        <td>{{ $roomTypes->firstItem() + $index }}</td>
                                        <td>{{ $type->room_type_name }}</td>
                                        <td>{{ $type->rooms()->count() }}</td> {{-- // عرض عدد القاعات --}}
                                        <td>{{ $type->created_at->format('Y-m-d') }}</td>
                                        <td>
                                            {{-- // تغيير الـ target والمتغير --}}
                                            <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal"
                                                data-bs-target="#editRoomTypeModal-{{ $type->id }}" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {{-- // تغيير الـ target والمتغير والشرط --}}
                                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                                data-bs-target="#deleteRoomTypeModal-{{ $type->id }}" title="Delete"
                                                {{ $type->rooms()->count() > 0 ? 'disabled' : '' }}>
                                                <i class="fas fa-trash"></i>
                                            </button>

                                            {{-- // تغيير اسم الـ partial والمتغير --}}
                                            @include('dashboard.data-entry.partials._room_type_modals', [
                                                'roomType' => $type,
                                            ])

                                        </td>
                                    </tr>
                                @empty
                                    <tr>
                                        {{-- // تغيير الرسالة --}}
                                        <td colspan="5" class="text-center text-muted">No room types found. Click 'Add
                                            New Room Type' to create one.</td>
                                    </tr>
                                @endforelse
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 d-flex justify-content-center">
                        {{-- // تغيير اسم المتغير --}}
                        {{ $roomTypes->links('pagination::bootstrap-5') }}
                    </div>
                </div>
            </div>

            {{-- // تغيير اسم الـ partial والمتغير --}}
            @include('dashboard.data-entry.partials._room_type_modals', ['roomType' => null])

        </div>
    </div>
@endsection

@push('scripts')
    {{-- JS خاص بالصفحة إذا لزم الأمر --}}
@endpush
-------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_room_type_modals.blade.php
{{-- // ========================= --}}
{{-- // Modal لإضافة نوع قاعة جديد --}}
{{-- // ========================= --}}
@if (!$roomType)
    <div class="modal fade" id="addRoomTypeModal" tabindex="-1" aria-labelledby="addRoomTypeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRoomTypeModalLabel">Add New Room Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                {{-- // تغيير الـ route --}}
                <form action="{{ route('data-entry.room-types.store') }}" method="POST">
                    @csrf
                    <div class="modal-body">
                        <div class="mb-3">
                            {{-- // تغيير الحقول --}}
                            <label for="add_room_type_name" class="form-label">Room Type Name <span
                                    class="text-danger">*</span></label>
                            <input type="text"
                                class="form-control @error('room_type_name', 'store') is-invalid @enderror"
                                id="add_room_type_name" name="room_type_name" value="{{ old('room_type_name') }}"
                                required>
                            @error('room_type_name', 'store')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Room Type</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
@endif

{{-- // ========================= --}}
{{-- // Modals التعديل والحذف --}}
{{-- // ========================= --}}
@if ($roomType)
    {{-- // Modal لتعديل نوع قاعة موجود --}}
    <div class="modal fade" id="editRoomTypeModal-{{ $roomType->id }}" tabindex="-1"
        aria-labelledby="editRoomTypeModalLabel-{{ $roomType->id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editRoomTypeModalLabel-{{ $roomType->id }}">Edit Room Type:
                        {{ $roomType->room_type_name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                {{-- // تغيير الـ route والمتغير --}}
                <form action="{{ route('data-entry.room-types.update', $roomType->id) }}" method="POST">
                    @csrf
                    @method('PUT')
                    <div class="modal-body">
                        <div class="mb-3">
                            {{-- // تغيير الحقول والمتغيرات --}}
                            <label for="edit_room_type_name_{{ $roomType->id }}" class="form-label">Room Type Name <span
                                    class="text-danger">*</span></label>
                            <input type="text"
                                class="form-control @error('room_type_name', 'update_' . $roomType->id) is-invalid @enderror"
                                id="edit_room_type_name_{{ $roomType->id }}" name="room_type_name"
                                value="{{ old('room_type_name', $roomType->room_type_name) }}" required>
                            @error('room_type_name', 'update_' . $roomType->id)
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Update Room Type</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {{-- // Modal لتأكيد الحذف --}}
    @if ($roomType->rooms()->count() == 0)
        <div class="modal fade" id="deleteRoomTypeModal-{{ $roomType->id }}" tabindex="-1"
            aria-labelledby="deleteRoomTypeModalLabel-{{ $roomType->id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteRoomTypeModalLabel-{{ $roomType->id }}">Confirm Deletion</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    {{-- // تغيير الـ route والمتغير --}}
                    <form action="{{ route('data-entry.room-types.destroy', $roomType->id) }}" method="POST">
                        @csrf
                        @method('DELETE')
                        <div class="modal-body">
                            {{-- // تغيير النص والمتغير --}}
                            <p>Are you sure you want to delete the room type:
                                <strong>{{ $roomType->room_type_name }}</strong>?
                            </p>
                            <p class="text-danger small">This action cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Yes, Delete Room Type</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    @endif
@endif


{{-- *** مودال الرفع بالأكسل (جديد) *** --}}
<div class="modal fade" id="bulkUploadRoomTypesModal" tabindex="-1" aria-labelledby="bulkUploadRoomTypesModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkUploadRoomTypesModalLabel">Bulk Upload Room Types from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.room-types.bulkUpload') }}" method="POST"
                enctype="multipart/form-data">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="room_type_excel_file" class="form-label">Select Excel File <span
                                class="text-danger">*</span></label>
                        <input
                            class="form-control @error('room_type_excel_file', 'bulkUploadRoomTypes') is-invalid @enderror"
                            type="file" id="room_type_excel_file" name="room_type_excel_file"
                            accept=".xlsx, .xls, .csv" required>
                        @error('room_type_excel_file', 'bulkUploadRoomTypes')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="alert alert-info small p-2">
                        <p class="mb-1"><strong>File Format Instructions:</strong></p>
                        <ul class="mb-0 ps-3">
                            <li>The first row should be headers (e.g., room_type_id, room_type_name).</li>
                            <li>The system will primarily use the 'room_type_name' column.</li>
                            <li>If a room_type_name from the file already exists, the row will be skipped.</li>
                            <li>Empty rows will be skipped.</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-1"></i> Upload and Process
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
---------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\rooms.blade.php
@extends('dashboard.layout')

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="data-entry-header mb-0">Manage Classrooms</h1>
                <div class="d-flex">
                    {{-- // زر لإظهار Modal الإضافة --}}
                    <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addRoomModal">
                        <i class="fas fa-plus me-1"></i> Add New Classroom
                    </button>
                    {{-- *** زر الرفع بالأكسل *** --}}
                    <button class="btn btn-outline-success me-2" data-bs-toggle="modal"
                        data-bs-target="#bulkUploadRoomsModal">
                        <i class="fas fa-file-excel me-1"></i> Bulk Upload Classrooms
                    </button>
                </div>
            </div>

            {{-- // عرض رسائل الحالة --}}
            @include('dashboard.data-entry.partials._status_messages')

            @if (session('skipped_details'))
                <div class="alert alert-warning mt-3">
                    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Skipped Rows During Upload:</h5>
                    <ul class="mb-0 small" style="max-height: 200px; overflow-y: auto;">
                        @foreach (session('skipped_details') as $detail)
                            <li>{{ $detail }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Room No</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Capacity</th>
                                    <th scope="col">Gender</th>
                                    <th scope="col">Branch</th>
                                    {{-- <th scope="col">Equipment</th> --}}
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @forelse ($rooms as $index => $room)
                                    <tr>
                                        <td>{{ $index + 1 }}</td>
                                        <td>{{ $room->room_no }}</td>
                                        <td>{{ $room->room_name ?? '-' }}</td> {{-- // عرض الاسم أو شرطة إذا كان فارغاً --}}
                                        <td>{{ $room->roomType->room_type_name ?? 'N/A' }}</td> {{-- // عرض اسم النوع من العلاقة --}}
                                        <td>{{ $room->room_size }}</td>
                                        <td>{{ $room->room_gender }}</td>
                                        <td>{{ $room->room_branch ?? '-' }}</td>
                                        {{-- <td> --}}
                                        {{-- // عرض المعدات (حقل JSON) --}}
                                        {{-- @if ($room->equipment && is_array($room->equipment))
                                        @foreach ($room->equipment as $item)
                                            <span class="badge bg-secondary me-1">{{ $item }}</span>
                                        @endforeach
                                    @else
                                        -
                                    @endif
                                </td> --}}
                                        <td>
                                            {{-- // زر التعديل --}}
                                            <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal"
                                                data-bs-target="#editRoomModal-{{ $room->id }}" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {{-- // زر الحذف --}}
                                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                                data-bs-target="#deleteRoomModal-{{ $room->id }}" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>

                                            {{-- // تضمين Modals التعديل والحذف الخاصة بهذه القاعة --}}
                                            @include('dashboard.data-entry.partials._room_modals', [
                                                'room' => $room,
                                                'roomTypes' => $roomTypes,
                                            ]) {{-- // نمرر أنواع القاعات أيضاً --}}

                                        </td>
                                    </tr>
                                @empty
                                    <tr>
                                        <td colspan="9" class="text-center text-muted">No classrooms found. Click 'Add
                                            New Classroom' to create one.</td>
                                    </tr>
                                @endforelse
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 d-flex justify-content-center">
                        {{-- // Pagination إذا لزم الأمر --}}
                        {{ $rooms->links('pagination::bootstrap-5') }}
                        {{-- {{ $rooms->links() }} --}}
                    </div>
                </div>
            </div>

            {{-- // Modal لإضافة قاعة جديدة --}}
            @include('dashboard.data-entry.partials._room_modals', [
                'room' => null,
                'roomTypes' => $roomTypes,
            ])

        </div>
    </div>
@endsection

@push('scripts')
    {{-- // يمكن إضافة JavaScript خاص بهذه الصفحة هنا --}}
@endpush
----------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_room_modals.blade.php
{{-- // Modal لإضافة قاعة جديدة --}}
@if (!$room)
<div class="modal fade" id="addRoomModal" tabindex="-1" aria-labelledby="addRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"> {{-- // جعل المودال أكبر قليلاً --}}
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRoomModalLabel">Add New Classroom</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.rooms.store') }}" method="POST">
                @csrf
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_room_no" class="form-label">Room Number/Code <span class="text-danger">*</span></label>
                            <input type="text" class="form-control @error('room_no') is-invalid @enderror" id="add_room_no" name="room_no" value="{{ old('room_no') }}" required>
                            @error('room_no') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_room_name" class="form-label">Room Name (Optional)</label>
                            <input type="text" class="form-control @error('room_name') is-invalid @enderror" id="add_room_name" name="room_name" value="{{ old('room_name') }}">
                            @error('room_name') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_room_type_id" class="form-label">Room Type <span class="text-danger">*</span></label>
                            <select class="form-select @error('room_type_id') is-invalid @enderror" id="add_room_type_id" name="room_type_id" required>
                                <option value="" selected disabled>Select type...</option>
                                @foreach ($roomTypes as $type)
                                    <option value="{{ $type->id }}" {{ old('room_type_id') == $type->id ? 'selected' : '' }}>{{ $type->room_type_name }}</option>
                                @endforeach
                            </select>
                            @error('room_type_id') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                         <div class="col-md-6 mb-3">
                            <label for="add_room_size" class="form-label">Capacity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('room_size') is-invalid @enderror" id="add_room_size" name="room_size" value="{{ old('room_size') }}" required min="1">
                            @error('room_size') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                     <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_room_gender" class="form-label">Gender Allocation <span class="text-danger">*</span></label>
                            <select class="form-select @error('room_gender') is-invalid @enderror" id="add_room_gender" name="room_gender" required>
                                <option value="Mixed" {{ old('room_gender', 'Mixed') == 'Mixed' ? 'selected' : '' }}>Mixed</option>
                                <option value="Male" {{ old('room_gender') == 'Male' ? 'selected' : '' }}>Male Only</option>
                                <option value="Female" {{ old('room_gender') == 'Female' ? 'selected' : '' }}>Female Only</option>
                            </select>
                            @error('room_gender') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                         <div class="col-md-6 mb-3">
                            <label for="add_room_branch" class="form-label">Branch (Optional)</label>
                            <input type="text" class="form-control @error('room_branch') is-invalid @enderror" id="add_room_branch" name="room_branch" value="{{ old('room_branch') }}">
                            @error('room_branch') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>

                    {{-- <div class="mb-3">
                         <label class="form-label">Available Equipment</label>
                         <div class="d-flex flex-wrap">
                             @php $allEquipment = ['projector', 'whiteboard', 'smart board', 'sound system', 'computers', 'lan network', 'lab tools']; @endphp
                             @foreach($allEquipment as $equip)
                                 <div class="form-check form-check-inline me-3 mb-2">
                                     <input class="form-check-input" type="checkbox" id="add_equip_{{ str_replace(' ', '_', $equip) }}" name="equipment[]" value="{{ $equip }}" {{ (is_array(old('equipment')) && in_array($equip, old('equipment'))) ? 'checked' : '' }}>
                                     <label class="form-check-label" for="add_equip_{{ str_replace(' ', '_', $equip) }}">{{ ucfirst($equip) }}</label>
                                 </div>
                             @endforeach
                         </div>
                          @error('equipment') <div class="text-danger small mt-1">{{ $message }}</div> @enderror
                          @error('equipment.*') <div class="text-danger small mt-1">{{ $message }}</div> @enderror {{-- // للتحقق من كل عنصر في المصفوفة --}}
                     {{-- </div> --}}

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Classroom</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endif

{{-- // Modal لتعديل قاعة موجودة --}}
@if ($room)
<div class="modal fade" id="editRoomModal-{{ $room->id }}" tabindex="-1" aria-labelledby="editRoomModalLabel-{{ $room->id }}" aria-hidden="true">
     <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRoomModalLabel-{{ $room->id }}">Edit Classroom: {{ $room->room_no }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             <form action="{{ route('data-entry.rooms.update', $room->id) }}" method="POST">
                @csrf
                @method('PUT')
                <div class="modal-body">
                     {{-- // نفس حقول نموذج الإضافة ولكن مع قيم الـ $room الحالية --}}
                     <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_room_no_{{ $room->id }}" class="form-label">Room Number/Code <span class="text-danger">*</span></label>
                            <input type="text" class="form-control @error('room_no', 'update_'.$room->id) is-invalid @enderror" id="edit_room_no_{{ $room->id }}" name="room_no" value="{{ old('room_no', $room->room_no) }}" required>
                            @error('room_no', 'update_'.$room->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_room_name_{{ $room->id }}" class="form-label">Room Name (Optional)</label>
                            <input type="text" class="form-control @error('room_name', 'update_'.$room->id) is-invalid @enderror" id="edit_room_name_{{ $room->id }}" name="room_name" value="{{ old('room_name', $room->room_name) }}">
                            @error('room_name', 'update_'.$room->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                     <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_room_type_id_{{ $room->id }}" class="form-label">Room Type <span class="text-danger">*</span></label>
                            <select class="form-select @error('room_type_id', 'update_'.$room->id) is-invalid @enderror" id="edit_room_type_id_{{ $room->id }}" name="room_type_id" required>
                                <option value="" disabled>Select type...</option>
                                @foreach ($roomTypes as $type)
                                    <option value="{{ $type->id }}" {{ old('room_type_id', $room->room_type_id) == $type->id ? 'selected' : '' }}>{{ $type->room_type_name }}</option>
                                @endforeach
                            </select>
                            @error('room_type_id', 'update_'.$room->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                         <div class="col-md-6 mb-3">
                            <label for="edit_room_size_{{ $room->id }}" class="form-label">Capacity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('room_size', 'update_'.$room->id) is-invalid @enderror" id="edit_room_size_{{ $room->id }}" name="room_size" value="{{ old('room_size', $room->room_size) }}" required min="1">
                            @error('room_size', 'update_'.$room->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                      <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_room_gender_{{ $room->id }}" class="form-label">Gender Allocation <span class="text-danger">*</span></label>
                            <select class="form-select @error('room_gender', 'update_'.$room->id) is-invalid @enderror" id="edit_room_gender_{{ $room->id }}" name="room_gender" required>
                                <option value="Mixed" {{ old('room_gender', $room->room_gender) == 'Mixed' ? 'selected' : '' }}>Mixed</option>
                                <option value="Male" {{ old('room_gender', $room->room_gender) == 'Male' ? 'selected' : '' }}>Male Only</option>
                                <option value="Female" {{ old('room_gender', $room->room_gender) == 'Female' ? 'selected' : '' }}>Female Only</option>
                            </select>
                            @error('room_gender', 'update_'.$room->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                         <div class="col-md-6 mb-3">
                            <label for="edit_room_branch_{{ $room->id }}" class="form-label">Branch (Optional)</label>
                            <input type="text" class="form-control @error('room_branch', 'update_'.$room->id) is-invalid @enderror" id="edit_room_branch_{{ $room->id }}" name="room_branch" value="{{ old('room_branch', $room->room_branch) }}">
                            @error('room_branch', 'update_'.$room->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                     {{-- <div class="mb-3">
                         <label class="form-label">Available Equipment</label>
                         <div class="d-flex flex-wrap">
                             @php
                                 $allEquipment = ['projector', 'whiteboard', 'smart board', 'sound system', 'computers', 'lan network', 'lab tools'];
                                 // جلب المعدات الحالية للقاعة (تأكد أنها مصفوفة)
                                 $currentEquipment = is_array($room->equipment) ? $room->equipment : [];
                                 // جلب المعدات القديمة إذا كان هناك خطأ في الـ validation
                                 $oldEquipment = old('equipment', $currentEquipment); // Use old input or current equipment
                                  // تأكد أن oldEquipment مصفوفة
                                 if (!is_array($oldEquipment)) { $oldEquipment = []; }
                             @endphp
                             @foreach($allEquipment as $equip)
                                 <div class="form-check form-check-inline me-3 mb-2">
                                     <input class="form-check-input" type="checkbox" id="edit_equip_{{ str_replace(' ', '_', $equip) }}_{{ $room->id }}" name="equipment[]" value="{{ $equip }}" {{ in_array($equip, $oldEquipment) ? 'checked' : '' }}>
                                     <label class="form-check-label" for="edit_equip_{{ str_replace(' ', '_', $equip) }}_{{ $room->id }}">{{ ucfirst($equip) }}</label>
                                 </div>
                             @endforeach
                         </div>
                          @error('equipment', 'update_'.$room->id) <div class="text-danger small mt-1">{{ $message }}</div> @enderror
                          @error('equipment.*', 'update_'.$room->id) <div class="text-danger small mt-1">{{ $message }}</div> @enderror
                     </div> --}}

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update Classroom</button>
                </div>
            </form>
        </div>
    </div>
</div>

{{-- // Modal لتأكيد الحذف --}}
<div class="modal fade" id="deleteRoomModal-{{ $room->id }}" tabindex="-1" aria-labelledby="deleteRoomModalLabel-{{ $room->id }}" aria-hidden="true">
     <div class="modal-dialog">
        {{-- // نفس تصميم مودال حذف القسم --}}
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteRoomModalLabel-{{ $room->id }}">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             <form action="{{ route('data-entry.rooms.destroy', $room->id) }}" method="POST">
                @csrf
                @method('DELETE')
                <div class="modal-body">
                    <p>Are you sure you want to delete the classroom: <strong>{{ $room->room_no }} ({{ $room->room_name ?? $room->roomType->room_type_name }})</strong>?</p>
                     <p class="text-danger small">This action cannot be undone. Any scheduled classes in this room might be affected.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Yes, Delete Classroom</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endif


{{-- *** مودال الرفع بالأكسل (جديد) ***
    <div class="modal fade" id="bulkUploadRoomsModal" tabindex="-1" aria-labelledby="bulkUploadRoomsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkUploadRoomsModalLabel">Bulk Upload Rooms from Excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ route('data-entry.rooms.bulkUpload') }}" method="POST" enctype="multipart/form-data">
                    @csrf
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="room_excel_file" class="form-label">Select Excel File <span class="text-danger">*</span></label>
                            <input class="form-control @error('room_excel_file', 'bulkUploadRooms') is-invalid @enderror" type="file" id="room_excel_file" name="room_excel_file" accept=".xlsx, .xls, .csv" required>
                            @error('room_excel_file', 'bulkUploadRooms')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="alert alert-info small p-2">
                            <p class="mb-1"><strong>File Format Instructions:</strong></p>
                            <ul class="mb-0 ps-3">
                                <li>The first row should be headers (e.g., room_type_id, room_type_name).</li>
                                <li>The system will primarily use the 'room_type_name' column.</li>
                                <li>If a room_type_name from the file already exists, the row will be skipped.</li>
                                <li>Empty rows will be skipped.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload me-1"></i> Upload and Process
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div> --}}
 {{-- *** مودال الرفع بالأكسل (جديد) *** --}}
    <div class="modal fade" id="bulkUploadRoomsModal" tabindex="-1" aria-labelledby="bulkUploadRoomsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkUploadRoomsModalLabel">Bulk Upload Classrooms from Excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ route('data-entry.rooms.bulkUpload') }}" method="POST" enctype="multipart/form-data">
                    @csrf
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="room_excel_file" class="form-label">Select Excel File <span class="text-danger">*</span></label>
                            <input class="form-control @error('room_excel_file', 'bulkUploadRooms') is-invalid @enderror" type="file" id="room_excel_file" name="room_excel_file" accept=".xlsx, .xls, .csv" required>
                            @error('room_excel_file', 'bulkUploadRooms')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="alert alert-info small p-2">
                            <p class="mb-1"><strong>File Format Instructions:</strong></p>
                            <ul class="mb-0 ps-3">
                                <li>First row should be headers: <code>room_no</code>, <code>room_name</code>, <code>room_size</code>, <code>room_gender</code>, <code>room_branch</code>, <code>room_type_id</code>.</li>
                                <li>Ensure 'room_type_id' corresponds to an existing ID in Room Types.</li>
                                <li>'room_gender' should be 'Male', 'Female', or 'Mixed'.</li>
                                <li>If 'room_no' exists, its data will be updated; otherwise, a new room is created.</li>
                                <li>Empty rows or rows with missing 'room_no' will be skipped.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload me-1"></i> Upload and Process
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
----------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\subject-types.blade.php
@extends('dashboard.layout')

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                {{-- // تغيير العنوان --}}
                <h1 class="data-entry-header mb-0">Manage Subject Types</h1>
                <div class="d-flex">
                    {{-- // زر لإظهار Modal الإضافة --}}
                    <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addSubjectTypeModal">
                        <i class="fas fa-plus me-1"></i> Add New Subject Type
                    </button>
                    {{-- *** زر الرفع بالأكسل *** --}}
                    <button class="btn btn-outline-success me-2" data-bs-toggle="modal"
                        data-bs-target="#bulkUploadSubjectTypesModal">
                        <i class="fas fa-file-excel me-1"></i> Bulk Upload Subject Types
                    </button>
                </div>
            </div>

            {{-- // عرض رسائل الحالة --}}
            @include('dashboard.data-entry.partials._status_messages')
            @if (session('skipped_details'))
                <div class="alert alert-warning mt-3">
                    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Skipped Rows During Upload:</h5>
                    <ul class="mb-0 small" style="max-height: 200px; overflow-y: auto;">
                        @foreach (session('skipped_details') as $detail)
                            <li>{{ $detail }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Type Name</th> {{-- // تغيير العمود --}}
                                    <th scope="col">Subject Count</th> {{-- // عدد المواد بالنوع --}}
                                    <th scope="col">Created At</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{-- // تغيير اسم المتغير إلى $subjectTypes --}}
                                @forelse ($subjectTypes as $index => $type)
                                    <tr>
                                        {{-- // عرض رقم الصف بناءً على الـ pagination --}}
                                        <td>{{ $subjectTypes->firstItem() + $index }}</td>
                                        <td>{{ $type->subject_type_name }}</td>
                                        <td>{{ $type->subjects()->count() }}</td> {{-- // عرض عدد المواد --}}
                                        <td>{{ $type->created_at->format('Y-m-d') }}</td>
                                        <td>
                                            {{-- // زر التعديل --}}
                                            <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal"
                                                data-bs-target="#editSubjectTypeModal-{{ $type->id }}" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {{-- // زر الحذف (معطل إذا كان عدد المواد > 0) --}}
                                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                                data-bs-target="#deleteSubjectTypeModal-{{ $type->id }}" title="Delete"
                                                {{ $type->subjects()->count() > 0 ? 'disabled' : '' }}>
                                                <i class="fas fa-trash"></i>
                                            </button>

                                            {{-- // تضمين Modals --}}
                                            {{-- // تغيير اسم الـ partial واسم المتغير --}}
                                            @include('dashboard.data-entry.partials._subject_type_modals', [
                                                'subjectType' => $type,
                                            ])

                                        </td>
                                    </tr>
                                @empty
                                    <tr>
                                        {{-- // تعديل الرسالة --}}
                                        <td colspan="5" class="text-center text-muted">No subject types found. Click 'Add
                                            New Subject Type' to create one.</td>
                                    </tr>
                                @endforelse
                            </tbody>
                        </table>
                    </div>
                    {{-- // إضافة روابط الـ Pagination --}}
                    <div class="mt-3 d-flex justify-content-center">
                        {{-- // تغيير اسم المتغير --}}
                        {{ $subjectTypes->links() }}
                    </div>
                </div>
            </div>

            {{-- // Modal لإضافة نوع جديد --}}
            {{-- // تغيير اسم الـ partial واسم المتغير --}}
            @include('dashboard.data-entry.partials._subject_type_modals', ['subjectType' => null])

        </div>
    </div>
@endsection

@push('scripts')
    {{-- // يمكن إضافة JavaScript خاص بهذه الصفحة هنا --}}
@endpush
----------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_subject_type_modals.blade.php
{{-- // ============================ --}}
{{-- // Modal لإضافة نوع مادة جديد --}}
{{-- // ============================ --}}
{{-- // تغيير المتغير الشرطي إلى !$subjectType --}}
@if (!$subjectType)
    <div class="modal fade" id="addSubjectTypeModal" tabindex="-1" aria-labelledby="addSubjectTypeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    {{-- // تغيير العنوان --}}
                    <h5 class="modal-title" id="addSubjectTypeModalLabel">Add New Subject Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                {{-- // تغيير الـ route --}}
                <form action="{{ route('data-entry.subject-types.store') }}" method="POST">
                    @csrf
                    <div class="modal-body">
                        <div class="mb-3">
                            {{-- // تغيير الحقول --}}
                            <label for="add_subject_type_name" class="form-label">Subject Type Name <span
                                    class="text-danger">*</span></label>
                            <input type="text"
                                class="form-control @error('subject_type_name', 'store') is-invalid @enderror"
                                id="add_subject_type_name" name="subject_type_name"
                                value="{{ old('subject_type_name') }}" required>
                            @error('subject_type_name', 'store')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        {{-- // لا يوجد حقول أخرى لهذا الموديل --}}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Subject Type</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
@endif

{{-- // ============================ --}}
{{-- // Modals التعديل والحذف --}}
{{-- // ============================ --}}
{{-- // تغيير المتغير الشرطي إلى $subjectType --}}
@if ($subjectType)
    {{-- // Modal لتعديل نوع مادة موجود --}}
    <div class="modal fade" id="editSubjectTypeModal-{{ $subjectType->id }}" tabindex="-1"
        aria-labelledby="editSubjectTypeModalLabel-{{ $subjectType->id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    {{-- // تغيير العناوين والمتغيرات --}}
                    <h5 class="modal-title" id="editSubjectTypeModalLabel-{{ $subjectType->id }}">Edit Subject Type:
                        {{ $subjectType->subject_type_name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                {{-- // تغيير الـ route والمتغير --}}
                <form action="{{ route('data-entry.subject-types.update', $subjectType->id) }}" method="POST">
                    @csrf
                    @method('PUT')
                    <div class="modal-body">
                        <div class="mb-3">
                            {{-- // تغيير الحقول والمتغيرات --}}
                            <label for="edit_subject_type_name_{{ $subjectType->id }}" class="form-label">Subject Type
                                Name <span class="text-danger">*</span></label>
                            <input type="text"
                                class="form-control @error('subject_type_name', 'update_' . $subjectType->id) is-invalid @enderror"
                                id="edit_subject_type_name_{{ $subjectType->id }}" name="subject_type_name"
                                value="{{ old('subject_type_name', $subjectType->subject_type_name) }}" required>
                            @error('subject_type_name', 'update_' . $subjectType->id)
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Update Subject Type</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {{-- // Modal لتأكيد الحذف --}}
    {{-- // تغيير الشرط ليعكس التحقق من وجود مواد مرتبطة --}}
    @if ($subjectType->subjects()->count() == 0)
        <div class="modal fade" id="deleteSubjectTypeModal-{{ $subjectType->id }}" tabindex="-1"
            aria-labelledby="deleteSubjectTypeModalLabel-{{ $subjectType->id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteSubjectTypeModalLabel-{{ $subjectType->id }}">Confirm
                            Deletion</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    {{-- // تغيير الـ route والمتغير --}}
                    <form action="{{ route('data-entry.subject-types.destroy', $subjectType->id) }}" method="POST">
                        @csrf
                        @method('DELETE')
                        <div class="modal-body">
                            {{-- // تغيير النص والمتغير --}}
                            <p>Are you sure you want to delete the subject type:
                                <strong>{{ $subjectType->subject_type_name }}</strong>?
                            </p>
                            <p class="text-danger small">This action cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Yes, Delete Subject Type</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    @endif {{-- // نهاية شرط عدم وجود مواد مرتبطة --}}
@endif {{-- // نهاية الشرط if ($subjectType) --}}

{{-- *** مودال الرفع بالأكسل (جديد) *** --}}
<div class="modal fade" id="bulkUploadSubjectTypesModal" tabindex="-1"
    aria-labelledby="bulkUploadSubjectTypesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkUploadSubjectTypesModalLabel">Bulk Upload Subject Types from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.subject-types.bulkUpload') }}" method="POST"
                enctype="multipart/form-data">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="subject_type_excel_file" class="form-label">Select Excel File <span
                                class="text-danger">*</span></label>
                        <input
                            class="form-control @error('subject_type_excel_file', 'bulkUploadSubjectTypes') is-invalid @enderror"
                            type="file" id="subject_type_excel_file" name="subject_type_excel_file"
                            accept=".xlsx, .xls, .csv" required>
                        @error('subject_type_excel_file', 'bulkUploadSubjectTypes')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="alert alert-info small p-2">
                        <p class="mb-1"><strong>File Format Instructions:</strong></p>
                        <ul class="mb-0 ps-3">
                            <li>First row should be headers (e.g., subject_type_id, subject_type_name).</li>
                            <li>The system will use the 'subject_type_name' column.</li>
                            <li>If a name already exists, the row will be skipped (no updates).</li>
                            <li>Empty rows will be skipped.</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-1"></i> Upload and Process
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{{-- *** نهاية مودال الرفع *** --}}
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\subject-categories.blade.php
@extends('dashboard.layout')

@section('content')
<div class="main-content">
    <div class="data-entry-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
             {{-- // تغيير العنوان --}}
             <h1 class="data-entry-header mb-0">Manage Subject Categories</h1>
             <div class="d-flex">
                {{-- // تغيير الـ target للـ Modal --}}
             <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addSubjectCategoryModal">
                 <i class="fas fa-plus me-1"></i> Add New Subject Category
             </button>
             {{-- *** زر الرفع بالأكسل *** --}}
             <button class="btn btn-outline-success me-2" data-bs-toggle="modal" data-bs-target="#bulkUploadSubjectCategoriesModal">
                 <i class="fas fa-file-excel me-1"></i> Bulk Upload Categories
             </button>
             </div>

        </div>

        @include('dashboard.data-entry.partials._status_messages')
        @if (session('skipped_details'))
                <div class="alert alert-warning mt-3">
                    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Skipped Rows During Upload:</h5>
                    <ul class="mb-0 small" style="max-height: 200px; overflow-y: auto;">
                        @foreach (session('skipped_details') as $detail)
                            <li>{{ $detail }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Category Name</th> {{-- // تغيير العمود --}}
                                <th scope="col">Subject Count</th>
                                <th scope="col">Created At</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{-- // تغيير اسم المتغير إلى $subjectCategories --}}
                            @forelse ($subjectCategories as $index => $category)
                            <tr>
                                {{-- // تغيير المتغير --}}
                                <td>{{ $subjectCategories->firstItem() + $index }}</td>
                                <td>{{ $category->subject_category_name }}</td>
                                <td>{{ $category->subjects()->count() }}</td>
                                <td>{{ $category->created_at->format('Y-m-d') }}</td>
                                <td>
                                    {{-- // تغيير الـ target والمتغير --}}
                                    <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#editSubjectCategoryModal-{{ $category->id }}" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {{-- // تغيير الـ target والمتغير والشرط --}}
                                    <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteSubjectCategoryModal-{{ $category->id }}" title="Delete" {{ $category->subjects()->count() > 0 ? 'disabled' : '' }}>
                                        <i class="fas fa-trash"></i>
                                    </button>

                                    {{-- // تغيير اسم الـ partial والمتغير --}}
                                    @include('dashboard.data-entry.partials._subject_category_modals', ['subjectCategory' => $category])

                                </td>
                            </tr>
                            @empty
                            <tr>
                                 {{-- // تغيير الرسالة --}}
                                <td colspan="5" class="text-center text-muted">No subject categories found. Click 'Add New Subject Category' to create one.</td>
                            </tr>
                            @endforelse
                        </tbody>
                    </table>
                </div>
                 <div class="mt-3 d-flex justify-content-center">
                     {{-- // تغيير اسم المتغير --}}
                     {{ $subjectCategories->links() }}
                 </div>
            </div>
        </div>

         {{-- // تغيير اسم الـ partial والمتغير --}}
         @include('dashboard.data-entry.partials._subject_category_modals', ['subjectCategory' => null])

    </div>
</div>
@endsection

@push('scripts')
{{-- JS خاص بالصفحة إذا لزم الأمر --}}
@endpush
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_subject_category_modals.blade.php
{{-- // =============================== --}}
{{-- // Modal لإضافة فئة مادة جديدة --}}
{{-- // =============================== --}}
@if (!$subjectCategory)
    <div class="modal fade" id="addSubjectCategoryModal" tabindex="-1" aria-labelledby="addSubjectCategoryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSubjectCategoryModalLabel">Add New Subject Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                {{-- // تغيير الـ route --}}
                <form action="{{ route('data-entry.subject-categories.store') }}" method="POST">
                    @csrf
                    <div class="modal-body">
                        <div class="mb-3">
                            {{-- // تغيير الحقول --}}
                            <label for="add_subject_category_name" class="form-label">Category Name <span
                                    class="text-danger">*</span></label>
                            <input type="text"
                                class="form-control @error('subject_category_name', 'store') is-invalid @enderror"
                                id="add_subject_category_name" name="subject_category_name"
                                value="{{ old('subject_category_name') }}" required>
                            @error('subject_category_name', 'store')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Subject Category</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
@endif

{{-- // =============================== --}}
{{-- // Modals التعديل والحذف --}}
{{-- // =============================== --}}
@if ($subjectCategory)
    {{-- // Modal لتعديل فئة مادة موجودة --}}
    <div class="modal fade" id="editSubjectCategoryModal-{{ $subjectCategory->id }}" tabindex="-1"
        aria-labelledby="editSubjectCategoryModalLabel-{{ $subjectCategory->id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSubjectCategoryModalLabel-{{ $subjectCategory->id }}">Edit Subject
                        Category: {{ $subjectCategory->subject_category_name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                {{-- // تغيير الـ route والمتغير --}}
                <form action="{{ route('data-entry.subject-categories.update', $subjectCategory->id) }}" method="POST">
                    @csrf
                    @method('PUT')
                    <div class="modal-body">
                        <div class="mb-3">
                            {{-- // تغيير الحقول والمتغيرات --}}
                            <label for="edit_subject_category_name_{{ $subjectCategory->id }}"
                                class="form-label">Category Name <span class="text-danger">*</span></label>
                            <input type="text"
                                class="form-control @error('subject_category_name', 'update_' . $subjectCategory->id) is-invalid @enderror"
                                id="edit_subject_category_name_{{ $subjectCategory->id }}" name="subject_category_name"
                                value="{{ old('subject_category_name', $subjectCategory->subject_category_name) }}"
                                required>
                            @error('subject_category_name', 'update_' . $subjectCategory->id)
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Update Subject Category</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {{-- // Modal لتأكيد الحذف --}}
    @if ($subjectCategory->subjects()->count() == 0)
        <div class="modal fade" id="deleteSubjectCategoryModal-{{ $subjectCategory->id }}" tabindex="-1"
            aria-labelledby="deleteSubjectCategoryModalLabel-{{ $subjectCategory->id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteSubjectCategoryModalLabel-{{ $subjectCategory->id }}">Confirm
                            Deletion</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    {{-- // تغيير الـ route والمتغير --}}
                    <form action="{{ route('data-entry.subject-categories.destroy', $subjectCategory->id) }}"
                        method="POST">
                        @csrf
                        @method('DELETE')
                        <div class="modal-body">
                            {{-- // تغيير النص والمتغير --}}
                            <p>Are you sure you want to delete the subject category:
                                <strong>{{ $subjectCategory->subject_category_name }}</strong>?
                            </p>
                            <p class="text-danger small">This action cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Yes, Delete Subject Category</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    @endif
@endif

{{-- *** مودال الرفع بالأكسل (جديد) *** --}}
<div class="modal fade" id="bulkUploadSubjectCategoriesModal" tabindex="-1"
    aria-labelledby="bulkUploadSubjectCategoriesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkUploadSubjectCategoriesModalLabel">Bulk Upload Subject Categories</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.subject-categories.bulkUpload') }}" method="POST"
                enctype="multipart/form-data">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="subject_category_excel_file" class="form-label">Select Excel File <span
                                class="text-danger">*</span></label>
                        <input
                            class="form-control @error('subject_category_excel_file', 'bulkUploadSubjectCategories') is-invalid @enderror"
                            type="file" id="subject_category_excel_file" name="subject_category_excel_file"
                            accept=".xlsx, .xls, .csv" required>
                        @error('subject_category_excel_file', 'bulkUploadSubjectCategories')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="alert alert-info small p-2">
                        <p class="mb-1"><strong>File Format Instructions:</strong></p>
                        <ul class="mb-0 ps-3">
                            <li>First row should be headers (e.g., subject_category_id, subject_category_name).</li>
                            <li>The system will use 'subject_category_name'.</li>
                            <li>If a name exists, the row is skipped.</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success"> <i class="fas fa-upload me-1"></i> Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{{-- *** نهاية مودال الرفع *** --}}
---------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\subjects.blade.php
@extends('dashboard.layout')

@section('content')
    <div class="main-content">
        <div class="data-entry-container">

            {{-- داخل resources/views/dashboard/data-entry/subjects.blade.php --}}
            {{-- ضع هذا الكود بعد @include('dashboard.partials._status_messages') --}}

            @if (session('import_errors'))
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <h5 class="alert-heading">Import Validation Errors!</h5>
                    <p>The following errors were found in the uploaded file. Please correct them and try again.</p>
                    <ul class="mb-0 small">
                        @foreach (session('import_errors') as $error)
                            <li>{{ $error }}</li>
                        @endforeach
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            @endif

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="data-entry-header mb-0">Manage Subjects</h1>
                <div class="d-flex">
                    {{-- // زر لإظهار Modal الإضافة الفردية --}}
                    <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addSubjectModal">
                        <i class="fas fa-plus me-1"></i> Add New Subject
                    </button>
                    {{-- *** زر الرفع بالأكسل للمواد *** --}}
                    <button class="btn btn-outline-success me-2" data-bs-toggle="modal"
                        data-bs-target="#bulkUploadSubjectsModal">
                        <i class="fas fa-file-excel me-1"></i> Bulk Upload Subjects
                    </button>
                    {{-- <button class="btn btn-outline-success me-2" data-bs-toggle="modal"
                        data-bs-target="#bulkUploadSubjectModal">
                        <i class="fas fa-file-excel me-1"></i> Bulk Upload
                    </button> --}}
                </div>
            </div>

            {{-- // عرض رسائل الحالة --}}
            @include('dashboard.data-entry.partials._status_messages')
            @if (session('skipped_details'))
                <div class="alert alert-warning mt-3">
                    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Skipped Rows During Upload:</h5>
                    <ul class="mb-0 small" style="max-height: 200px; overflow-y: auto;">
                        @foreach (session('skipped_details') as $detail)
                            <li>{{ $detail }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Code</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Load</th>
                                    <th scope="col">Theo (h)</th> {{-- // ساعات نظري --}}
                                    <th scope="col">Prac (h)</th> {{-- // ساعات عملي --}}
                                    <th>Theory Sec. Capacity</th>
                                    <th>Practical Sec. Capacity</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Category</th>
                                    <th scope="col">Department</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @forelse ($subjects as $index => $subject)
                                    <tr>
                                        <td>{{ $index + 1 }}</td>
                                        <td>{{ $subject->subject_no }}</td>
                                        <td>{{ $subject->subject_name }}</td>
                                        <td>{{ $subject->subject_load }}</td>
                                        <td>{{ $subject->theoretical_hours }}</td>
                                        <td>{{ $subject->practical_hours }}</td>
                                        <td>{{ $subject->load_theoretical_section ?? '-' }}</td>
                                        <td>{{ $subject->load_practical_section ?? '-' }}</td>
                                        {{-- // عرض البيانات من العلاقات --}}
                                        <td>{{ $subject->subjectType->subject_type_name ?? 'N/A' }}</td>
                                        <td>{{ $subject->subjectCategory->subject_category_name ?? 'N/A' }}</td>
                                        <td>{{ $subject->department->department_name ?? 'N/A' }}</td>
                                        <td>
                                            <div class="d-flex">
                                                {{-- // زر التعديل --}}
                                                <button class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal"
                                                    data-bs-target="#editSubjectModal-{{ $subject->id }}" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                {{-- // زر الحذف --}}
                                                <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                                    data-bs-target="#deleteSubjectModal-{{ $subject->id }}"
                                                    title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>


                                            {{-- // تضمين Modals --}}
                                            @include('dashboard.data-entry.partials._subject_modals', [
                                                'subject' => $subject,
                                                'subjectTypes' => $subjectTypes,
                                                'subjectCategories' => $subjectCategories,
                                                'departments' => $departments,
                                            ])
                                        </td>
                                    </tr>
                                @empty
                                    <tr>
                                        <td colspan="10" class="text-center text-muted">No subjects found. Click 'Add New
                                            Subject' or 'Bulk Upload' to create some.</td>
                                    </tr>
                                @endforelse
                            </tbody>
                        </table>
                    </div>
                    {{-- // Pagination إذا لزم الأمر --}}
                    <div class="mt-3 d-flex justify-content-center">
                        {{-- // {{ $subjects->links() }} --}}
                        {{ $subjects->links('pagination::bootstrap-5') }}
                    </div>
                </div>
            </div>

            {{-- // Modal لإضافة مادة جديدة --}}
            @include('dashboard.data-entry.partials._subject_modals', [
                'subject' => null,
                'subjectTypes' => $subjectTypes,
                'subjectCategories' => $subjectCategories,
                'departments' => $departments,
            ])

            {{-- // Modal للرفع بالجملة --}}
            @include('dashboard.data-entry.partials._subject_bulk_upload_modal')

        </div>
    </div>
@endsection

@push('scripts')
    {{-- // JavaScript للتحكم بمنطقة الرفع بالجملة (Drag and Drop) --}}
    <script>
        // Add JS code here later to handle drag & drop for bulk upload if needed
        // Or just use a simple file input inside the modal
    </script>
@endpush
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_subject_modals.blade.php
{{-- // Modal لإضافة مادة جديدة --}}
@if (!$subject)
    <div class="modal fade" id="addSubjectModal" tabindex="-1" aria-labelledby="addSubjectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSubjectModalLabel">Add New Subject</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ route('data-entry.subjects.store') }}" method="POST">
                    @csrf
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="add_subject_no" class="form-label">Subject Code <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control @error('subject_no') is-invalid @enderror"
                                    id="add_subject_no" name="subject_no" value="{{ old('subject_no') }}" required>
                                @error('subject_no')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="add_subject_name" class="form-label">Subject Name <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control @error('subject_name') is-invalid @enderror"
                                    id="add_subject_name" name="subject_name" value="{{ old('subject_name') }}"
                                    required>
                                @error('subject_name')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="add_subject_load" class="form-label">Credit Hours <span
                                        class="text-danger">*</span></label>
                                <input type="number" class="form-control @error('subject_load') is-invalid @enderror"
                                    id="add_subject_load" name="subject_load" value="{{ old('subject_load') }}" required
                                    min="0">
                                @error('subject_load')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="add_theoretical_hours" class="form-label">Weekly Theoretical Hours <span
                                        class="text-danger">*</span></label>
                                <input type="number"
                                    class="form-control @error('theoretical_hours') is-invalid @enderror"
                                    id="add_theoretical_hours" name="theoretical_hours"
                                    value="{{ old('theoretical_hours', 0) }}" required min="0">
                                @error('theoretical_hours')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="add_practical_hours" class="form-label">Weekly Practical Hours <span
                                        class="text-danger">*</span></label>
                                <input type="number"
                                    class="form-control @error('practical_hours') is-invalid @enderror"
                                    id="add_practical_hours" name="practical_hours"
                                    value="{{ old('practical_hours', 0) }}" required min="0">
                                @error('practical_hours')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="add_load_theoretical_section" class="form-label">Theoretical Section
                                    Capacity</label>
                                <input type="number"
                                    class="form-control @error('load_theoretical_section', 'store') is-invalid @enderror"
                                    id="add_load_theoretical_section" name="load_theoretical_section"
                                    value="{{ old('load_theoretical_section', 50) }}" min="1"
                                    placeholder="Default: 50">
                                <small class="text-muted">Max students per theory section. Leave blank for default
                                    (50).</small>
                                @error('load_theoretical_section', 'store')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="add_load_practical_section" class="form-label">Practical Section
                                    Capacity</label>
                                <input type="number"
                                    class="form-control @error('load_practical_section', 'store') is-invalid @enderror"
                                    id="add_load_practical_section" name="load_practical_section"
                                    value="{{ old('load_practical_section', 25) }}" min="1"
                                    placeholder="Default: 25">
                                <small class="text-muted">Max students per lab section. Leave blank for default
                                    (25).</small>
                                @error('load_practical_section', 'store')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="add_subject_type_id" class="form-label">Subject Type <span
                                        class="text-danger">*</span></label>
                                <select class="form-select @error('subject_type_id') is-invalid @enderror"
                                    id="add_subject_type_id" name="subject_type_id" required>
                                    <option value="" selected disabled>Select type...</option>
                                    @foreach ($subjectTypes as $type)
                                        <option value="{{ $type->id }}"
                                            {{ old('subject_type_id') == $type->id ? 'selected' : '' }}>
                                            {{ $type->subject_type_name }}</option>
                                    @endforeach
                                </select>
                                @error('subject_type_id')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="add_subject_category_id" class="form-label">Subject Category <span
                                        class="text-danger">*</span></label>
                                <select class="form-select @error('subject_category_id') is-invalid @enderror"
                                    id="add_subject_category_id" name="subject_category_id" required>
                                    <option value="" selected disabled>Select category...</option>
                                    @foreach ($subjectCategories as $category)
                                        <option value="{{ $category->id }}"
                                            {{ old('subject_category_id') == $category->id ? 'selected' : '' }}>
                                            {{ $category->subject_category_name }}</option>
                                    @endforeach
                                </select>
                                @error('subject_category_id')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="add_department_id" class="form-label">Primary Department <span
                                    class="text-danger">*</span></label>
                            <select class="form-select @error('department_id') is-invalid @enderror"
                                id="add_department_id" name="department_id" required>
                                <option value="" selected disabled>Select department...</option>
                                @foreach ($departments as $dept)
                                    <option value="{{ $dept->id }}"
                                        {{ old('department_id') == $dept->id ? 'selected' : '' }}>
                                        {{ $dept->department_name }}</option>
                                @endforeach
                            </select>
                            @error('department_id')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Subject</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
@endif

{{-- // Modal لتعديل مادة موجودة --}}
@if ($subject)
    <div class="modal fade" id="editSubjectModal-{{ $subject->id }}" tabindex="-1"
        aria-labelledby="editSubjectModalLabel-{{ $subject->id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSubjectModalLabel-{{ $subject->id }}">Edit Subject:
                        {{ $subject->subject_name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ route('data-entry.subjects.update', $subject->id) }}" method="POST">
                    @csrf
                    @method('PUT')
                    <div class="modal-body">
                        {{-- // نفس حقول نموذج الإضافة ولكن مع قيم المادة الحالية --}}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit_subject_no_{{ $subject->id }}" class="form-label">Subject Code
                                    <span class="text-danger">*</span></label>
                                <input type="text"
                                    class="form-control @error('subject_no', 'update_' . $subject->id) is-invalid @enderror"
                                    id="edit_subject_no_{{ $subject->id }}" name="subject_no"
                                    value="{{ old('subject_no', $subject->subject_no) }}" required>
                                @error('subject_no', 'update_' . $subject->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_subject_name_{{ $subject->id }}" class="form-label">Subject Name
                                    <span class="text-danger">*</span></label>
                                <input type="text"
                                    class="form-control @error('subject_name', 'update_' . $subject->id) is-invalid @enderror"
                                    id="edit_subject_name_{{ $subject->id }}" name="subject_name"
                                    value="{{ old('subject_name', $subject->subject_name) }}" required>
                                @error('subject_name', 'update_' . $subject->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="edit_subject_load_{{ $subject->id }}" class="form-label">Credit Hours
                                    <span class="text-danger">*</span></label>
                                <input type="number"
                                    class="form-control @error('subject_load', 'update_' . $subject->id) is-invalid @enderror"
                                    id="edit_subject_load_{{ $subject->id }}" name="subject_load"
                                    value="{{ old('subject_load', $subject->subject_load) }}" required
                                    min="0">
                                @error('subject_load', 'update_' . $subject->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit_theoretical_hours_{{ $subject->id }}" class="form-label">Weekly
                                    Theoretical Hours <span class="text-danger">*</span></label>
                                <input type="number"
                                    class="form-control @error('theoretical_hours', 'update_' . $subject->id) is-invalid @enderror"
                                    id="edit_theoretical_hours_{{ $subject->id }}" name="theoretical_hours"
                                    value="{{ old('theoretical_hours', $subject->theoretical_hours) }}" required
                                    min="0">
                                @error('theoretical_hours', 'update_' . $subject->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit_practical_hours_{{ $subject->id }}" class="form-label">Weekly
                                    Practical Hours <span class="text-danger">*</span></label>
                                <input type="number"
                                    class="form-control @error('practical_hours', 'update_' . $subject->id) is-invalid @enderror"
                                    id="edit_practical_hours_{{ $subject->id }}" name="practical_hours"
                                    value="{{ old('practical_hours', $subject->practical_hours) }}" required
                                    min="0">
                                @error('practical_hours', 'update_' . $subject->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit_load_theoretical_section_{{ $subject->id }}"
                                    class="form-label">Theoretical Section Capacity</label>
                                <input type="number"
                                    class="form-control @error('load_theoretical_section', 'update_' . $subject->id) is-invalid @enderror"
                                    id="edit_load_theoretical_section_{{ $subject->id }}"
                                    name="load_theoretical_section"
                                    value="{{ old('load_theoretical_section', $subject->load_theoretical_section) }}"
                                    min="1" placeholder="Default: 50">
                                @error('load_theoretical_section', 'update_' . $subject->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_load_practical_section_{{ $subject->id }}"
                                    class="form-label">Practical Section Capacity</label>
                                <input type="number"
                                    class="form-control @error('load_practical_section', 'update_' . $subject->id) is-invalid @enderror"
                                    id="edit_load_practical_section_{{ $subject->id }}"
                                    name="load_practical_section"
                                    value="{{ old('load_practical_section', $subject->load_practical_section) }}"
                                    min="1" placeholder="Default: 25">
                                @error('load_practical_section', 'update_' . $subject->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit_subject_type_id_{{ $subject->id }}" class="form-label">Subject Type
                                    <span class="text-danger">*</span></label>
                                <select
                                    class="form-select @error('subject_type_id', 'update_' . $subject->id) is-invalid @enderror"
                                    id="edit_subject_type_id_{{ $subject->id }}" name="subject_type_id" required>
                                    <option value="" disabled>Select type...</option>
                                    @foreach ($subjectTypes as $type)
                                        <option value="{{ $type->id }}"
                                            {{ old('subject_type_id', $subject->subject_type_id) == $type->id ? 'selected' : '' }}>
                                            {{ $type->subject_type_name }}</option>
                                    @endforeach
                                </select>
                                @error('subject_type_id', 'update_' . $subject->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_subject_category_id_{{ $subject->id }}" class="form-label">Subject
                                    Category <span class="text-danger">*</span></label>
                                <select
                                    class="form-select @error('subject_category_id', 'update_' . $subject->id) is-invalid @enderror"
                                    id="edit_subject_category_id_{{ $subject->id }}" name="subject_category_id"
                                    required>
                                    <option value="" disabled>Select category...</option>
                                    @foreach ($subjectCategories as $category)
                                        <option value="{{ $category->id }}"
                                            {{ old('subject_category_id', $subject->subject_category_id) == $category->id ? 'selected' : '' }}>
                                            {{ $category->subject_category_name }}</option>
                                    @endforeach
                                </select>
                                @error('subject_category_id', 'update_' . $subject->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="edit_department_id_{{ $subject->id }}" class="form-label">Primary Department
                                <span class="text-danger">*</span></label>
                            <select
                                class="form-select @error('department_id', 'update_' . $subject->id) is-invalid @enderror"
                                id="edit_department_id_{{ $subject->id }}" name="department_id" required>
                                <option value="" disabled>Select department...</option>
                                @foreach ($departments as $dept)
                                    <option value="{{ $dept->id }}"
                                        {{ old('department_id', $subject->department_id) == $dept->id ? 'selected' : '' }}>
                                        {{ $dept->department_name }}</option>
                                @endforeach
                            </select>
                            @error('department_id', 'update_' . $subject->id)
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Update Subject</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {{-- // Modal لتأكيد الحذف --}}
    <div class="modal fade" id="deleteSubjectModal-{{ $subject->id }}" tabindex="-1"
        aria-labelledby="deleteSubjectModalLabel-{{ $subject->id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteSubjectModalLabel-{{ $subject->id }}">Confirm Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form action="{{ route('data-entry.subjects.destroy', $subject->id) }}" method="POST">
                    @csrf
                    @method('DELETE')
                    <div class="modal-body">
                        <p>Are you sure you want to delete the subject: <strong>{{ $subject->subject_name }}
                                ({{ $subject->subject_no }})</strong>?</p>
                        <p class="text-danger small">This action cannot be undone. It might affect academic plans and
                            generated schedules.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Yes, Delete Subject</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
@endif


{{-- *** مودال الرفع بالأكسل للمواد (جديد) *** --}}
<div class="modal fade" id="bulkUploadSubjectsModal" tabindex="-1" aria-labelledby="bulkUploadSubjectsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> {{-- modal-lg ليكون أعرض --}}
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkUploadSubjectsModalLabel">Bulk Upload Subjects from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.subjects.bulkUpload') }}" method="POST"
                enctype="multipart/form-data">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="subject_excel_file" class="form-label">Select Excel File <span
                                class="text-danger">*</span></label>
                        <input
                            class="form-control @error('subject_excel_file', 'bulkUploadSubjects') is-invalid @enderror"
                            type="file" id="subject_excel_file" name="subject_excel_file"
                            accept=".xlsx, .xls, .csv" required>
                        @error('subject_excel_file', 'bulkUploadSubjects')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="alert alert-info small p-2">
                        <p class="mb-1"><strong>File Format Instructions:</strong></p>
                        <ul class="mb-0 ps-3">
                            <li>First row must be headers: <code>subject_no</code>, <code>subject_name</code>,
                                <code>subject_load</code>, <code>theoretical_hours</code>, <code>practical_hours</code>,
                                <code>subject_type_id</code> (or name), <code>subject_category_id</code> (or name),
                                <code>department_id</code> (or name/code), <code>capacity_theoretical_section</code>
                                (optional), <code>capacity_practical_section</code> (optional).</li>
                            <li>For type, category, and department: you can use existing IDs OR exact names
                                (case-insensitive, Arabic hamzas normalized).</li>
                            <li>If 'subject_no' exists, its data will be updated; otherwise, a new subject is created.
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-1"></i> Upload and Process
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_subject_bulk_upload_modal.blade.php
<div class="modal fade" id="bulkUploadSubjectModal" tabindex="-1" aria-labelledby="bulkUploadSubjectModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkUploadSubjectModalLabel">Bulk Upload Subjects</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            {{-- // تأكد من إضافة enctype="multipart/form-data" للنموذج --}}
            <form action="{{ route('data-entry.subjects.bulkUpload') }}" method="POST" enctype="multipart/form-data">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="subject_file" class="form-label">Select Excel File (.xlsx, .xls, .csv)</label>
                        {{-- // حقل رفع الملف --}}
                        <input class="form-control @error('subject_file') is-invalid @enderror" type="file"
                            id="subject_file" name="subject_file" accept=".xlsx, .xls, .csv" required>
                        @error('subject_file')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="mb-3">
                        <p class="small text-muted">
                            The Excel file should contain columns matching the subject data fields:
                            <br>
                            `subject_no`, `subject_name`, `subject_load`, `theoretical_hours`, `practical_hours`,
                            `subject_type_name` (Exact name from types), `subject_category_name` (Exact name from
                            categories), `department_no` (Code of the primary department).
                        </p>
                        // داخل _subject_bulk_upload_modal.blade.php
                        <p class="small text-muted">
                            The Excel file should contain columns matching the subject data fields:
                            <br>
                            `subject_no`, `subject_name`, `subject_load`, `theoretical_hours`, `practical_hours`,
                            `subject_type_id` (ID of the type), `subject_category_id` (ID of the category),
                            `department_id` (ID of the primary department).
                            <br>
                            <strong class="text-danger">Note: You need to provide the exact IDs for type, category, and
                                department.</strong>
                        </p>

                        {{-- // يمكنك إضافة رابط لتنزيل ملف قالب هنا --}}
                        {{-- <a href="/path/to/template.xlsx" download>Download Template</a> --}}
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-1"></i> Upload and Process
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
---------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\plans.blade.php
@extends('dashboard.layout')

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="data-entry-header mb-0">Manage Academic Plans</h1>
                <div class="d-flex">
                    <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addPlanModal">
                        <i class="fas fa-plus me-1"></i> Add New Plan
                    </button>
                    {{-- *** زر الرفع بالأكسل للخطط *** --}}
                    <button class="btn btn-outline-success me-2" data-bs-toggle="modal"
                        data-bs-target="#bulkUploadPlansModal">
                        <i class="fas fa-file-excel me-1"></i> Bulk Upload Plans
                    </button>
                </div>
            </div>

            @include('dashboard.data-entry.partials._status_messages')
            @if (session('skipped_details'))
                <div class="alert alert-warning mt-3">
                    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Skipped Rows During Upload:</h5>
                    <ul class="mb-0 small" style="max-height: 200px; overflow-y: auto;">
                        @foreach (session('skipped_details') as $detail)
                            <li>{{ $detail }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Plan Code</th>
                                    <th scope="col" class="w-15 col-3">Plan Name</th>
                                    <th scope="col" class="w-20 col-1">Year</th>
                                    <th scope="col" class="w-5 col-3">Department</th>
                                    <th scope="col" class="w-5 col-1">Total Hours</th>
                                    <th scope="col" class="w-5 col-1">Total Subject</th>
                                    <th scope="col" class="w-5 col-1">Status</th>
                                    <th scope="col" class="w-5 col-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @forelse ($plans as $index => $plan)
                                    <tr>
                                        <td>{{ $plans->firstItem() + $index }}</td>
                                        <td>{{ $plan->plan_no }}</td>
                                        <td>{{ $plan->plan_name }}</td>
                                        <td>{{ $plan->year }}</td>
                                        <td>{{ $plan->department->department_name ?? 'N/A' }}</td>
                                        <td>{{ $plan->plan_hours }}</td>
                                        <td>{{ $plan->planSubjectEntries()->count() }}</td>
                                        <td>
                                            @if ($plan->is_active)
                                                <span class="badge bg-success">Active</span>
                                            @else
                                                <span class="badge bg-secondary">Inactive</span>
                                            @endif
                                        </td>
                                        <td>
                                            {{-- // زر إدارة المواد --}}
                                            <a href="{{ route('data-entry.plans.manageSubjects', $plan->id) }}"
                                                class="btn btn-sm btn-outline-info me-1" title="Manage Subjects">
                                                <i class="fas fa-tasks"></i> Subjects
                                            </a>
                                            {{-- // زر التعديل --}}
                                            <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal"
                                                data-bs-target="#editPlanModal-{{ $plan->id }}"
                                                title="Edit Plan Details">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {{-- // زر الحذف --}}
                                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                                data-bs-target="#deletePlanModal-{{ $plan->id }}" title="Delete Plan"
                                                {{ $plan->planSubjectEntries()->count() > 0 ? '' : '' }}>
                                                <i class="fas fa-trash"></i>
                                            </button>

                                            {{-- // تضمين Modals (للتعديل والحذف فقط) --}}
                                            @include('dashboard.data-entry.partials._plan_modals', [
                                                'plan' => $plan,
                                                'departments' => $departments,
                                            ])

                                        </td>
                                    </tr>
                                @empty
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">No academic plans found. Click
                                            'Add New Plan' to create one.</td>
                                    </tr>
                                @endforelse
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 d-flex justify-content-center">
                        {{ $plans->links() }}
                    </div>
                </div>
            </div>

            {{-- // Modal لإضافة خطة جديدة --}}
            @include('dashboard.data-entry.partials._plan_modals', [
                'plan' => null,
                'departments' => $departments,
            ])

        </div>
    </div>
@endsection

@push('scripts')
    {{-- JS خاص بالصفحة إذا لزم الأمر --}}
@endpush
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_plan_modals.blade.php
{{-- // ====================== --}}
{{-- // Modal لإضافة خطة جديدة --}}
{{-- // ====================== --}}
@if (!$plan)
    <div class="modal fade" id="addPlanModal" tabindex="-1" aria-labelledby="addPlanModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPlanModalLabel">Add New Academic Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ route('data-entry.plans.store') }}" method="POST">
                    @csrf
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="add_plan_no" class="form-label">Plan Code <span
                                        class="text-danger">*</span></label>
                                <input type="text"
                                    class="form-control @error('plan_no', 'store') is-invalid @enderror"
                                    id="add_plan_no" name="plan_no" value="{{ old('plan_no') }}" required>
                                @error('plan_no', 'store')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="add_plan_name" class="form-label">Plan Name <span
                                        class="text-danger">*</span></label>
                                <input type="text"
                                    class="form-control @error('plan_name', 'store') is-invalid @enderror"
                                    id="add_plan_name" name="plan_name" value="{{ old('plan_name') }}" required>
                                @error('plan_name', 'store')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="add_year" class="form-label">Adoption Year <span
                                        class="text-danger">*</span></label>
                                <input type="number" class="form-control @error('year', 'store') is-invalid @enderror"
                                    id="add_year" name="year" value="{{ old('year', date('Y')) }}" required
                                    placeholder="YYYY" min="2000" max="{{ date('Y') + 5 }}">
                                @error('year', 'store')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="add_plan_hours" class="form-label">Total Credit Hours <span
                                        class="text-danger">*</span></label>
                                <input type="number"
                                    class="form-control @error('plan_hours', 'store') is-invalid @enderror"
                                    id="add_plan_hours" name="plan_hours" value="{{ old('plan_hours') }}" required
                                    min="1">
                                @error('plan_hours', 'store')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="add_department_id" class="form-label">Associated Department <span
                                    class="text-danger">*</span></label>
                            <select class="form-select @error('department_id', 'store') is-invalid @enderror"
                                id="add_department_id" name="department_id" required>
                                <option value="" selected disabled>Select department...</option>
                                @if (isset($departments))
                                    @foreach ($departments as $dept)
                                        <option value="{{ $dept->id }}"
                                            {{ old('department_id') == $dept->id ? 'selected' : '' }}>
                                            {{ $dept->department_name }}</option>
                                    @endforeach
                                @endif
                            </select>
                            @error('department_id', 'store')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="add_is_active" name="is_active"
                                value="1" {{ old('is_active', true) ? 'checked' : '' }}>
                            <label class="form-check-label" for="add_is_active">
                                Mark plan as active
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Plan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
@endif

{{-- // ========================= --}}
{{-- // Modals التعديل والحذف --}}
{{-- // ========================= --}}
@if ($plan)

    {{-- // Modal لتعديل خطة موجودة --}}
    <div class="modal fade" id="editPlanModal-{{ $plan->id }}" tabindex="-1"
        aria-labelledby="editPlanModalLabel-{{ $plan->id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPlanModalLabel-{{ $plan->id }}">Edit Academic Plan:
                        {{ $plan->plan_name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ route('data-entry.plans.update', $plan->id) }}" method="POST">
                    @csrf
                    @method('PUT')
                    <div class="modal-body">
                        {{-- // نفس حقول الإضافة مع القيم الحالية --}}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit_plan_no_{{ $plan->id }}" class="form-label">Plan Code <span
                                        class="text-danger">*</span></label>
                                <input type="text"
                                    class="form-control @error('plan_no', 'update_' . $plan->id) is-invalid @enderror"
                                    id="edit_plan_no_{{ $plan->id }}" name="plan_no"
                                    value="{{ old('plan_no', $plan->plan_no) }}" required>
                                @error('plan_no', 'update_' . $plan->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_plan_name_{{ $plan->id }}" class="form-label">Plan Name <span
                                        class="text-danger">*</span></label>
                                <input type="text"
                                    class="form-control @error('plan_name', 'update_' . $plan->id) is-invalid @enderror"
                                    id="edit_plan_name_{{ $plan->id }}" name="plan_name"
                                    value="{{ old('plan_name', $plan->plan_name) }}" required>
                                @error('plan_name', 'update_' . $plan->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>
                        {{-- ... باقي الحقول بنفس الطريقة ... --}}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit_year_{{ $plan->id }}" class="form-label">Adoption Year <span
                                        class="text-danger">*</span></label>
                                <input type="number"
                                    class="form-control @error('year', 'update_' . $plan->id) is-invalid @enderror"
                                    id="edit_year_{{ $plan->id }}" name="year"
                                    value="{{ old('year', $plan->year) }}" required placeholder="YYYY"
                                    min="2000" max="{{ date('Y') + 5 }}">
                                @error('year', 'update_' . $plan->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_plan_hours_{{ $plan->id }}" class="form-label">Total Credit
                                    Hours <span class="text-danger">*</span></label>
                                <input type="number"
                                    class="form-control @error('plan_hours', 'update_' . $plan->id) is-invalid @enderror"
                                    id="edit_plan_hours_{{ $plan->id }}" name="plan_hours"
                                    value="{{ old('plan_hours', $plan->plan_hours) }}" required min="1">
                                @error('plan_hours', 'update_' . $plan->id)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="edit_department_id_{{ $plan->id }}" class="form-label">Associated
                                Department <span class="text-danger">*</span></label>
                            <select
                                class="form-select @error('department_id', 'update_' . $plan->id) is-invalid @enderror"
                                id="edit_department_id_{{ $plan->id }}" name="department_id" required>
                                <option value="" disabled>Select department...</option>
                                @if (isset($departments))
                                    @foreach ($departments as $dept)
                                        <option value="{{ $dept->id }}"
                                            {{ old('department_id', $plan->department_id) == $dept->id ? 'selected' : '' }}>
                                            {{ $dept->department_name }}</option>
                                    @endforeach
                                @endif
                            </select>
                            @error('department_id', 'update_' . $plan->id)
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="form-check mb-3">
                            {{-- // استخدام is_active من الموديل (تذكر إضافة cast لـ boolean) --}}
                            <input class="form-check-input" type="checkbox" id="edit_is_active_{{ $plan->id }}"
                                name="is_active" value="1"
                                {{ old('is_active', $plan->is_active) ? 'checked' : '' }}>
                            <label class="form-check-label" for="edit_is_active_{{ $plan->id }}">
                                Mark plan as active
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Update Plan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {{-- // Modal لتأكيد الحذف --}}
    @if ($plan->planSubjectEntries()->count() == 0 || $plan->planSubjectEntries()->count() != 0)
        <div class="modal fade" id="deletePlanModal-{{ $plan->id }}" tabindex="-1"
            aria-labelledby="deletePlanModalLabel-{{ $plan->id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deletePlanModalLabel-{{ $plan->id }}">Confirm Deletion</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <form action="{{ route('data-entry.plans.destroy', $plan->id) }}" method="POST">
                        @csrf
                        @method('DELETE')
                        <div class="modal-body">

                            @if ($plan->planSubjectEntries()->count())
                                <p>Are you sure you want to delete the academic plan: <strong>{{ $plan->plan_name }}
                                        ({{ $plan->plan_no }})</strong>?</p>
                                <p>This academic plan (<strong
                                        id="planNameToForceDelete">{{ $plan->plan_name }}</strong>) has
                                    associated subjects.</p>
                                <p><strong>Are you absolutely sure you want to delete this plan AND all its associated
                                        subject entries?</strong></p>
                                <h3>The count Subject of plan :{{ $plan->planSubjectEntries()->count() }}</h3>
                                <p class="text-danger">This will remove the subjects from this specific plan structure
                                    but will NOT delete the subjects themselves from the system.</p>
                                <p class="text-danger fw-bold">This action cannot be undone.</p>
                            @else
                                <p>Are you sure you want to delete the academic plan: <strong>{{ $plan->plan_name }}
                                        ({{ $plan->plan_no }})</strong>?</p>
                                <p class="text-danger small">This action cannot be undone. Ensure no subjects are
                                    linked to
                                    this plan before deleting (though the button should be disabled if subjects exist).
                                </p>
                            @endif
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Yes, Delete Plan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    @endif

@endif




{{-- *** مودال الرفع بالأكسل للخطط (جديد) *** --}}
<div class="modal fade" id="bulkUploadPlansModal" tabindex="-1" aria-labelledby="bulkUploadPlansModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkUploadPlansModalLabel">Bulk Upload Academic Plans from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.plans.bulkUpload') }}" method="POST" enctype="multipart/form-data">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="plan_excel_file" class="form-label">Select Excel File <span
                                class="text-danger">*</span></label>
                        <input class="form-control @error('plan_excel_file', 'bulkUploadPlans') is-invalid @enderror"
                            type="file" id="plan_excel_file" name="plan_excel_file" accept=".xlsx, .xls, .csv"
                            required>
                        @error('plan_excel_file', 'bulkUploadPlans')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="alert alert-info small p-2">
                        <p class="mb-1"><strong>File Format Instructions:</strong></p>
                        <ul class="mb-0 ps-3">
                            <li>First row headers: <code>plan_no</code>, <code>plan_name</code>, <code>year</code>,
                                <code>plan_hours</code>, <code>department_id</code> (can be ID, Name, or Dept. No.),
                                <code>is_active</code> (1 for active, 0 for inactive).</li>
                            <li>If 'plan_no' exists, its data will be updated. Otherwise, a new plan is created.</li>
                            <li>Empty rows or rows missing 'plan_no'/'plan_name' will be skipped.</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-1"></i> Upload and Process
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{{-- *** نهاية مودال الرفع *** --}}
----------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\plan-subjects-manage.blade.php
@extends('dashboard.layout')

{{-- Styles for Select2 --}}
@push('styles')
@endpush

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            {{-- Header and Back Button --}}
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="data-entry-header mb-0">Manage Subjects for Plan: <span
                        class="text-primary">{{ $plan->plan_name }}</span> ({{ $plan->plan_no }})</h1>

                <div class="mb-3 text-end d-flex">
                    <a href="{{ route('data-entry.plans.index') }}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i> Back to Plans List
                    </a>
                    {{-- *** زر رفع ملف الإكسل الجديد *** --}}
                    <button class="btn btn-success btn-sm me-2" data-bs-toggle="modal"
                        data-bs-target="#importPlanSubjectsModal">
                        <i class="fas fa-file-excel me-1"></i> Import Subjects to This Plan
                    </button>
                    {{-- <button class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#bulkUploadPlanSubjectsModal">
                        <i class="fas fa-file-excel me-2"></i> Bulk Upload Subjects to This Plan
                    </button> --}}
                </div>
            </div>

            {{-- Status Messages --}}
            @include('dashboard.data-entry.partials._status_messages')
            @if (session('skipped_details'))
                <div class="alert alert-warning mt-3">
                    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Skipped Rows During Upload:</h5>
                    <ul class="mb-0 small" style="max-height: 200px; overflow-y: auto;">
                        @foreach (session('skipped_details') as $detail)
                            <li>{{ $detail }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif

            @php
                // Prepare Data
                $planSubjectsGrouped = $plan
                    ->planSubjectEntries()
                    ->with('subject:id,subject_no,subject_name')
                    ->get()
                    ->groupBy(['plan_level', 'plan_semester']);
                $addedSubjectIds = $plan->planSubjectEntries()->pluck('subject_id')->toArray();
                $allSubjects =
                    $allSubjects ??
                    \App\Models\Subject::orderBy('subject_name')->get(['id', 'subject_no', 'subject_name']);
                $maxLevelToDisplay = max(4, $planSubjectsGrouped->keys()->max() ?: 1);
                $maxSemesterToDisplay = max(
                    2,
                    $planSubjectsGrouped->map(fn($level) => is_iterable($level) ? $level->keys()->max() : 0)->max() ?:
                    1,
                );
            @endphp

            {{-- Accordion for Levels --}}
            <div class="accordion" id="planLevelsAccordion">
                @for ($level = 1; $level <= $maxLevelToDisplay; $level++)
                    <div class="accordion-item mb-3 shadow-sm">
                        <h2 class="accordion-header" id="headingLevel{{ $level }}">
                            <button class="accordion-button {{ $level > 1 ? 'collapsed' : '' }}" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapseLevel{{ $level }}"
                                aria-expanded="{{ $level == 1 ? 'true' : 'false' }}"
                                aria-controls="collapseLevel{{ $level }}">
                                Level {{ $level }}
                            </button>
                        </h2>
                        <div id="collapseLevel{{ $level }}"
                            class="accordion-collapse collapse {{ $level == 1 ? 'show' : '' }}"
                            aria-labelledby="headingLevel{{ $level }}" data-bs-parent="#planLevelsAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    @for ($semester = 1; $semester <= $maxSemesterToDisplay; $semester++)
                                        <div class="col-lg-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-header">
                                                    <h6 class="mb-0">Semester {{ $semester }}</h6>
                                                </div>
                                                <div class="card-body p-3">
                                                    {{-- Display Added Subjects --}}
                                                    <ul class="list-group list-group-flush mb-3">
                                                        @forelse($planSubjectsGrouped[$level][$semester] ?? [] as $planSubject)
                                                            <li
                                                                class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                                                <span class="small"
                                                                    title="{{ optional($planSubject->subject)->subject_name ?? 'N/A' }}">
                                                                    <strong
                                                                        class="text-muted">{{ optional($planSubject->subject)->subject_no ?? '???' }}</strong>
                                                                    -
                                                                    {{ Str::limit(optional($planSubject->subject)->subject_name ?? 'N/A', 40) }}
                                                                </span>
                                                                {{-- *** فورم الحذف المباشر *** --}}
                                                                <form
                                                                    action="{{ route('data-entry.plans.removeSubject', ['plan' => $plan->id, 'planSubject' => $planSubject->id]) }}"
                                                                    method="POST"
                                                                    onsubmit="return confirm('Are you sure you want to remove this subject?');"
                                                                    style="display: inline;">
                                                                    @csrf
                                                                    @method('DELETE')
                                                                    <button type="submit"
                                                                        class="btn btn-sm btn-outline-danger border-0 p-0 px-1"
                                                                        title="Remove Subject">
                                                                        <i class="fas fa-times fa-xs"></i>
                                                                    </button>
                                                                </form>
                                                                {{-- *** نهاية فورم الحذف المباشر *** --}}
                                                            </li>
                                                        @empty
                                                            <li
                                                                class="list-group-item text-center text-muted small py-1 px-0 empty-list">
                                                                No subjects added yet.</li>
                                                        @endforelse
                                                    </ul>

                                                    {{-- زر إظهار/إخفاء فورم الإضافة --}}
                                                    <button
                                                        class="btn btn-sm btn-outline-primary w-100 toggle-add-form-btn mb-2">
                                                        <i class="fas fa-plus"></i> Add Subject
                                                    </button>

                                                    {{-- فورم الإضافة الخاص بهذا الفصل/المستوى --}}
                                                    <form
                                                        action="{{ route('data-entry.plans.addSubject', ['plan' => $plan->id, 'level' => $level, 'semester' => $semester]) }}"
                                                        method="POST" class="add-subject-form border p-3 rounded bg-light">
                                                        @csrf
                                                        {{-- <div class="mb-2">
                                                            <label
                                                                for="subject_id_{{ $level }}_{{ $semester }}"
                                                                class="form-label visually-hidden">Select Subject</label>
                                                            <select
                                                                class="form-select form-select-sm @error('subject_id') is-invalid @enderror"
                                                                id="subject_id_{{ $level }}_{{ $semester }}"
                                                                name="subject_id" required>
                                                                <option value="" selected hidden>-- Select Subject --</option>
                                                                @foreach ($allSubjects as $subject)
                                                                    @if (!in_array($subject->id, $addedSubjectIds ?? []))
                                                                        <option value="{{ $subject->id }}">
                                                                            {{ $subject->subject_no }} -
                                                                            {{ $subject->subject_name }}
                                                                        </option>
                                                                    @endif
                                                                @endforeach
                                                            </select>

                                                            @error('subject_id')
                                                                <div class="invalid-feedback d-block">{{ $message }}</div>
                                                            @enderror
                                                            @if ($errors->any() && !$errors->has('subject_id'))
                                                                <div class="text-danger small mt-1">Could not add subject.
                                                                    Please try again.</div>
                                                            @endif
                                                        </div> --}}

                                                        <div class="mb-2">
                                                            <label
                                                                for="subject_id_{{ $level }}_{{ $semester }}"
                                                                class="form-label visually-hidden">Select Subject</label>

                                                            <!-- Dropdown Component -->
                                                            <div class="dropdown filterable-select">
                                                                <button
                                                                    class="form-select form-select-sm @error('subject_id') is-invalid @enderror w-100 text-start"
                                                                    type="button"
                                                                    id="subject_id_{{ $level }}_{{ $semester }}"
                                                                    data-bs-toggle="dropdown" aria-expanded="false">
                                                                    <span
                                                                        id="selectedOptionText_{{ $level }}_{{ $semester }}">--
                                                                        Select Subject --</span>
                                                                </button>

                                                                <ul class="dropdown-menu w-100"
                                                                    aria-labelledby="subject_id_{{ $level }}_{{ $semester }}">
                                                                    <li class="px-2 pt-2">
                                                                        <input type="search"
                                                                            class="form-control form-control-sm"
                                                                            id="selectSearchInput_{{ $level }}_{{ $semester }}"
                                                                            placeholder="Search ..." autocomplete="off">
                                                                    </li>
                                                                    <li>
                                                                        <hr class="dropdown-divider">
                                                                    </li>

                                                                    <div id="optionsListContainer_{{ $level }}_{{ $semester }}"
                                                                        style="max-height: 200px; overflow-y: auto;">
                                                                        @foreach ($allSubjects as $subject)
                                                                            @if (!in_array($subject->id, $addedSubjectIds ?? []))
                                                                                <li><a href="#"
                                                                                        class="text-decoration-none">
                                                                                        <span
                                                                                            class="dropdown-item filterable-option"
                                                                                            data-value="{{ $subject->id }}">
                                                                                            {{ $subject->subject_no }} -
                                                                                            {{ $subject->subject_name }}
                                                                                        </span>
                                                                                    </a>
                                                                                </li>
                                                                            @endif
                                                                        @endforeach
                                                                    </div>

                                                                    <li><span class="dropdown-item text-muted d-none"
                                                                            id="noResultsMessage_{{ $level }}_{{ $semester }}">No
                                                                            subject </span></li>
                                                                </ul>

                                                                <!-- Hidden input to send value -->
                                                                <input type="hidden" name="subject_id"
                                                                    id="selectedValueInput_{{ $level }}_{{ $semester }}">
                                                            </div>

                                                            @error('subject_id')
                                                                <div class="invalid-feedback d-block">{{ $message }}</div>
                                                            @enderror
                                                            @if ($errors->any() && !$errors->has('subject_id'))
                                                                <div class="text-danger small mt-1">Could not add subject.
                                                                    Please try again.</div>
                                                            @endif
                                                        </div>
                                                        <script>
                                                            document.addEventListener('DOMContentLoaded', () => {
                                                                const level = "{{ $level }}",
                                                                    semester = "{{ $semester }}";
                                                                const elements = {
                                                                    searchInput: document.getElementById(`selectSearchInput_${level}_${semester}`),
                                                                    optionsContainer: document.getElementById(`optionsListContainer_${level}_${semester}`),
                                                                    selectedText: document.getElementById(`selectedOptionText_${level}_${semester}`),
                                                                    selectedValue: document.getElementById(`selectedValueInput_${level}_${semester}`),
                                                                    dropdownButton: document.getElementById(`subject_id_${level}_${semester}`)
                                                                };

                                                                let currentFocus = -1,
                                                                    visibleOptions = [];

                                                                // الأحداث الرئيسية
                                                                elements.dropdownButton.addEventListener('shown.bs.dropdown', () => {
                                                                    elements.searchInput.focus();
                                                                    currentFocus = -1;
                                                                    updateOptions();
                                                                });

                                                                elements.searchInput.addEventListener('input', e => {
                                                                    updateOptions(e.target.value.toLowerCase());
                                                                    currentFocus = visibleOptions.length ? 0 : -1;
                                                                    highlightOption();
                                                                });

                                                                elements.searchInput.addEventListener('keydown', e => {
                                                                    const actions = {
                                                                        'ArrowDown': () => move(1),
                                                                        'ArrowUp': () => move(-1),
                                                                        'Enter': () => selectItem(),
                                                                        'Escape': () => bootstrap.Dropdown.getInstance(elements.dropdownButton).hide()
                                                                    };
                                                                    if (actions[e.key]) {
                                                                        e.preventDefault();
                                                                        actions[e.key]()
                                                                    }
                                                                });

                                                                elements.optionsContainer.addEventListener('click', e => {
                                                                    if (e.target.classList.contains('filterable-option')) selectItem(e.target);
                                                                });

                                                                // الدوال المساعدة
                                                                function updateOptions(filter = '') {
                                                                    visibleOptions = [];
                                                                    elements.optionsContainer.querySelectorAll('.filterable-option').forEach(option => {
                                                                        const show = option.textContent.toLowerCase().includes(filter);
                                                                        option.closest('li').classList.toggle('d-none', !show);
                                                                        if (show) visibleOptions.push(option);
                                                                    });
                                                                }

                                                                function move(direction) {
                                                                    if (!visibleOptions.length) return;
                                                                    currentFocus = Math.max(0, Math.min(visibleOptions.length - 1, currentFocus + direction));
                                                                    highlightOption();
                                                                }

                                                                function highlightOption() {
                                                                    visibleOptions.forEach(o => o.classList.remove('active'));
                                                                    if (currentFocus > -1) {
                                                                        visibleOptions[currentFocus].classList.add('active');
                                                                        visibleOptions[currentFocus].scrollIntoView({
                                                                            block: 'nearest'
                                                                        });
                                                                    }
                                                                }

                                                                function selectItem(element = visibleOptions[currentFocus]) {
                                                                    if (!element) return;
                                                                    elements.selectedText.textContent = element.textContent;
                                                                    elements.selectedValue.value = element.dataset.value;
                                                                    elements.searchInput.value = '';
                                                                    bootstrap.Dropdown.getInstance(elements.dropdownButton).hide();
                                                                }
                                                            });
                                                        </script>
                                                        {{-- <script>
                                                            document.addEventListener('DOMContentLoaded', function() {
                                                                const level = "{{ $level }}";
                                                                const semester = "{{ $semester }}";
                                                                const searchInput = document.getElementById(`selectSearchInput_${level}_${semester}`);
                                                                const optionsContainer = document.getElementById(`optionsListContainer_${level}_${semester}`);
                                                                const selectedText = document.getElementById(`selectedOptionText_${level}_${semester}`);
                                                                const selectedValue = document.getElementById(`selectedValueInput_${level}_${semester}`);
                                                                const noResultsMessage = document.getElementById(`noResultsMessage_${level}_${semester}`);
                                                                const dropdownButton = document.getElementById(`subject_id_${level}_${semester}`);

                                                                dropdownButton.addEventListener('shown.bs.dropdown', function() {
                                                                    setTimeout(() => {
                                                                        searchInput.focus();
                                                                    }, 10);
                                                                });

                                                                searchInput.addEventListener('keyup', function() {
                                                                    const filter = searchInput.value.toLowerCase();
                                                                    let found = false;
                                                                    const options = optionsContainer.querySelectorAll('.filterable-option');

                                                                    options.forEach(option => {
                                                                        const text = option.textContent.toLowerCase();
                                                                        const li = option.closest('li');
                                                                        if (text.includes(filter)) {
                                                                            li.classList.remove('d-none');
                                                                            found = true;
                                                                        } else {
                                                                            li.classList.add('d-none');
                                                                        }
                                                                    });

                                                                    noResultsMessage.classList.toggle('d-none', found);
                                                                });

                                                                optionsContainer.addEventListener('click', function(event) {
                                                                    if (event.target.classList.contains('filterable-option')) {
                                                                        event.preventDefault();
                                                                        selectedText.textContent = event.target.textContent;
                                                                        selectedValue.value = event.target.getAttribute('data-value');
                                                                        const dropdownInstance = bootstrap.Dropdown.getInstance(dropdownButton);
                                                                        if (dropdownInstance) dropdownInstance.hide();
                                                                        searchInput.value = '';
                                                                        searchInput.dispatchEvent(new Event('keyup'));
                                                                    }
                                                                });

                                                                searchInput.addEventListener('click', e => e.stopPropagation());
                                                            });
                                                        </script> --}}


                                                        <div class="d-flex justify-content-end">
                                                            <button type="button"
                                                                class="btn btn-sm btn-secondary me-2 cancel-add-btn">Cancel</button>
                                                            <button type="submit" class="btn btn-sm btn-success"><i
                                                                    class="fas fa-check"></i> Save</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    @endfor
                                </div>
                            </div>
                        </div>
                    </div>
                @endfor
            </div>
        </div>
    </div>
@endsection

@push('scripts')
@endpush


{{-- *** مودال الرفع بالأكسل لمواد الخطة (جديد في نهاية الملف) *** --}}
{{-- <div class="modal fade" id="bulkUploadPlanSubjectsModal" tabindex="-1"
    aria-labelledby="bulkUploadPlanSubjectsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkUploadPlanSubjectsModalLabel">Bulk Upload Subjects for Plan:
                    {{ $plan->plan_no }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.plans.bulkUploadSubjects', $plan->id) }}" method="POST"
                enctype="multipart/form-data">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="plan_subjects_excel_file" class="form-label">Select Excel File <span
                                class="text-danger">*</span></label>
                        <input
                            class="form-control @error('plan_subjects_excel_file', 'bulkUploadPlanSubjects') is-invalid @enderror"
                            type="file" id="plan_subjects_excel_file" name="plan_subjects_excel_file"
                            accept=".xlsx, .xls, .csv" required>
                        @error('plan_subjects_excel_file', 'bulkUploadPlanSubjects')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="alert alert-info small p-2">
                        <p class="mb-1"><strong>File Format Instructions:</strong></p>
                        <ul class="mb-0 ps-3">
                            <li>First row headers, e.g.: <code>subject_identifier</code> (ID, No, or Name),
                                <code>plan_level</code>, <code>plan_semester</code>.</li>
                            <li>The <code>plan_identifier</code> is taken from the current plan page.</li>
                            <li>System will attempt to find subject by ID, then No, then Name.</li>
                            <li>If a subject entry (for this plan, level, semester) exists, it will be skipped (no
                                updates).</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-1"></i> Upload and Process
                    </button>
                </div>
            </form>
        </div>
    </div>
</div> --}}


{{-- *** مودال رفع ملف الإكسل لمواد الخطة (في نهاية الملف) *** --}}
<div class="modal fade" id="importPlanSubjectsModal" tabindex="-1" aria-labelledby="importPlanSubjectsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importPlanSubjectsModalLabel">Import Subjects for Plan: {{ $plan->plan_no }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.plans.importSubjectsExcel', $plan->id) }}" method="POST" enctype="multipart/form-data">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="plan_subjects_excel_file_input" class="form-label">Select Excel File <span class="text-danger">*</span></label>
                        <input class="form-control @error('plan_subjects_excel_file') is-invalid @enderror" type="file" id="plan_subjects_excel_file_input" name="plan_subjects_excel_file" accept=".xlsx, .xls, .csv" required>
                        @error('plan_subjects_excel_file')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="alert alert-info small p-2">
                        <strong>File Format Instructions:</strong><br>
                        - First row should be headers: <code>plan_id</code> (or plan_name), <code>plan_level</code>, <code>plan_semester</code>, <code>subject_id</code> (or subject_no/subject_name).<br>
                        - Rows not matching the current plan ({{ $plan->plan_no }}) will be skipped.<br>
                        - Levels/Semesters like "First", "1", "سنة أولى" will be converted to numbers.<br>
                        - Subjects will be matched by ID, Code, or Name (case-insensitive, ignoring Hamza variants).<br>
                        - Empty rows or rows with missing required data will be skipped.<br>
                        - Duplicate entries (same subject in same plan/level/semester) within the file or already in DB will be skipped.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-1"></i> Upload and Process
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{{-- *** نهاية مودال رفع الإكسل *** --}}

------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_plan_subject_modals.blade.php
@extends('dashboard.layout')

{{-- لا نحتاج ستايلات Select2 الآن --}}
@push('styles')
<style>
    /* فقط الستايلات الأساسية */
    .list-group-item.empty-list { background-color: #f8f9fa; }
    .modal-dialog { display: flex; align-items: center; min-height: calc(100% - 1rem); }
    @media (min-width: 576px) { .modal-dialog { min-height: calc(100% - 3.5rem); } }
</style>
@endpush

@section('content')
<div class="main-content">
    <div class="data-entry-container">
        {{-- Header and Back Button --}}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="data-entry-header mb-0">Manage Subjects for Plan: <span class="text-primary">{{ $plan->plan_name }}</span> ({{ $plan->plan_no }})</h1>
            <a href="{{ route('data-entry.plans.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Plans List
            </a>
        </div>

        {{-- Status Messages --}}
        @include('dashboard.partials._status_messages')

        @php
            // Prepare Data
            $planSubjectsGrouped = $plan->planSubjectEntries()->with('subject:id,subject_no,subject_name')->get()->groupBy(['plan_level', 'plan_semester']);
            $addedSubjectIds = $plan->planSubjectEntries()->pluck('subject_id')->toArray();
            $allSubjects = $allSubjects ?? \App\Models\Subject::orderBy('subject_name')->get(['id', 'subject_no', 'subject_name']);
            $maxLevelToDisplay = max(4, $planSubjectsGrouped->keys()->max() ?: 1);
            $maxSemesterToDisplay = max(2, $planSubjectsGrouped->map(fn($level) => is_iterable($level) ? $level->keys()->max() : 0)->max() ?: 1);
        @endphp

        {{-- Accordion for Levels --}}
        <div class="accordion" id="planLevelsAccordion">
            @for ($level = 1; $level <= $maxLevelToDisplay; $level++)
                <div class="accordion-item mb-3 shadow-sm">
                    <h2 class="accordion-header" id="headingLevel{{ $level }}">
                        <button class="accordion-button {{ $level > 1 ? 'collapsed' : '' }}" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLevel{{ $level }}" aria-expanded="{{ $level == 1 ? 'true' : 'false' }}" aria-controls="collapseLevel{{ $level }}">
                            Level {{ $level }}
                        </button>
                    </h2>
                    <div id="collapseLevel{{ $level }}" class="accordion-collapse collapse {{ $level == 1 ? 'show' : '' }}" aria-labelledby="headingLevel{{ $level }}" data-bs-parent="#planLevelsAccordion">
                        <div class="accordion-body">
                            <div class="row">
                                @for ($semester = 1; $semester <= $maxSemesterToDisplay; $semester++)
                                    <div class="col-lg-6 mb-3">
                                        <div class="card h-100">
                                            <div class="card-header d-flex justify-content-between align-items-center"> {{-- إعادة الـ d-flex --}}
                                                <h6 class="mb-0">Semester {{ $semester }}</h6>
                                                {{-- *** زر فتح مودال الإضافة *** --}}
                                                <button type="button" class="btn btn-sm btn-outline-primary open-add-subject-modal-btn"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#addSubjectToPlanModal"
                                                        data-level="{{ $level }}"
                                                        data-semester="{{ $semester }}">
                                                    <i class="fas fa-plus"></i> Add Subject
                                                </button>
                                            </div>
                                            <div class="card-body p-3">
                                                {{-- Display Added Subjects --}}
                                                <ul class="list-group list-group-flush">
                                                    @forelse($planSubjectsGrouped[$level][$semester] ?? [] as $planSubject)
                                                        <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                                            <span class="small" title="{{ optional($planSubject->subject)->subject_name ?? 'N/A' }}">
                                                                <strong class="text-muted">{{ optional($planSubject->subject)->subject_no ?? '???' }}</strong> - {{ Str::limit(optional($planSubject->subject)->subject_name ?? 'N/A', 40) }}
                                                            </span>
                                                            {{-- زر فتح مودال الحذف --}}
                                                            <button type="button" class="btn btn-sm btn-outline-danger border-0 p-0 px-1 open-delete-modal-btn"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#deletePlanSubjectModal"
                                                                    data-form-action="{{ route('data-entry.plans.removeSubject', ['plan' => $plan->id, 'planSubject' => $planSubject->id]) }}"
                                                                    data-subject-name="{{ optional($planSubject->subject)->subject_name ?? 'this subject' }}"
                                                                    title="Remove Subject">
                                                                <i class="fas fa-times fa-xs"></i>
                                                            </button>
                                                        </li>
                                                    @empty
                                                        <li class="list-group-item text-center text-muted small py-1 px-0 empty-list">No subjects added yet.</li>
                                                    @endforelse
                                                </ul>
                                                 {{-- تم إزالة فورم الإضافة المباشر من هنا --}}
                                            </div>
                                        </div>
                                    </div>
                                @endfor
                            </div>
                        </div>
                    </div>
                </div>
            @endfor
        </div> {{-- نهاية الأكورديون --}}


        {{-- ================================= --}}
        {{-- *** المودالات مدمجة هنا *** --}}
        {{-- ================================= --}}

        {{-- 1. Modal لإضافة مادة للخطة --}}
        <div class="modal fade" id="addSubjectToPlanModal" tabindex="-1" aria-labelledby="addSubjectToPlanModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered"> {{-- توسيط --}}
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addSubjectToPlanModalLabel">Add Subject to Plan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="addSubjectToPlanForm" action="{{ route('data-entry.plans.addSubject', $plan->id) }}" method="POST">
                        @csrf
                        {{-- الحقول المخفية --}}
                        <input type="hidden" name="plan_level" id="modal_plan_level" value="">
                        <input type="hidden" name="plan_semester" id="modal_plan_semester" value="">

                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="modal_subject_id" class="form-label">Select Subject <span class="text-danger">*</span></label>
                                {{-- استخدام select عادي الآن --}}
                                <select class="form-select @error('subject_id', 'addSubject') is-invalid @enderror" id="modal_subject_id" name="subject_id" required>
                                    <option value="" selected disabled>-- Select Subject --</option>
                                    @isset($allSubjects)
                                        @foreach ($allSubjects as $subject)
                                            {{-- إخفاء المواد المضافة بالفعل في كل الخطة --}}
                                            @if(!in_array($subject->id, $addedSubjectIds ?? []))
                                                <option value="{{ $subject->id }}" {{ old('subject_id') == $subject->id ? 'selected' : '' }}>
                                                    {{ $subject->subject_no }} - {{ $subject->subject_name }}
                                                </option>
                                            @endif
                                        @endforeach
                                    @endisset
                                </select>
                                {{-- عرض الأخطاء الخاصة بمودال الإضافة --}}
                                @error('subject_id', 'addSubject') <div class="invalid-feedback d-block">{{ $message }}</div> @enderror
                                @error('plan_level', 'addSubject') <div class="text-danger small mt-1">{{ $message }}</div> @enderror
                                @error('plan_semester', 'addSubject') <div class="text-danger small mt-1">{{ $message }}</div> @enderror
                                @if($errors->hasBag('addSubject') && !$errors->getBag('addSubject')->has('subject_id') && !$errors->getBag('addSubject')->has('plan_level') && !$errors->getBag('addSubject')->has('plan_semester'))
                                    <div class="text-danger small mt-1">{{ $errors->getBag('addSubject')->first('msg') ?? 'Could not add subject.' }}</div>
                                @endif
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Add Subject to Plan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {{-- نهاية مودال الإضافة --}}


        {{-- 2. Modal لتأكيد حذف مادة من الخطة --}}
        <div class="modal fade" id="deletePlanSubjectModal" tabindex="-1" aria-labelledby="deletePlanSubjectModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
               <div class="modal-content">
                   <div class="modal-header bg-danger text-white">
                       <h5 class="modal-title" id="deletePlanSubjectModalLabel">Confirm Subject Removal</h5>
                       <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                   </div>
                    <form id="deletePlanSubjectForm" action="#" method="POST"> {{-- Action يتحدث بـ JS --}}
                       @csrf
                       @method('DELETE')
                       <div class="modal-body">
                           <p>Are you sure you want to remove the subject <strong id="subjectNameToDelete">this subject</strong> from the plan?</p>
                           <p class="text-danger small">This action cannot be undone.</p>
                       </div>
                       <div class="modal-footer">
                           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                           <button type="submit" class="btn btn-danger">Yes, Remove Subject</button>
                       </div>
                   </form>
               </div>
           </div>
        </div>
        {{-- نهاية مودال الحذف --}}


    </div> {{-- نهاية data-entry-container --}}
</div> {{-- نهاية main-content --}}
@endsection

{{-- *** الكود JavaScript النهائي للتعامل مع المودالات *** --}}
@push('scripts')
{{-- لا نحتاج jQuery أو Select2 الآن --}}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded. Initializing modal listeners...');

        // --- التعامل مع مودال الإضافة ---
        const addSubjectModalEl = document.getElementById('addSubjectToPlanModal');
        if (addSubjectModalEl) {
            const modalLevelInput = addSubjectModalEl.querySelector('#modal_plan_level');
            const modalSemesterInput = addSubjectModalEl.querySelector('#modal_plan_semester');
            const modalTitle = addSubjectModalEl.querySelector('.modal-title');
            const subjectSelect = addSubjectModalEl.querySelector('#modal_subject_id'); // Select العادي

            addSubjectModalEl.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; // الزر الذي فتح المودال

                if (button && button.hasAttribute('data-level') && button.hasAttribute('data-semester')) {
                    const level = button.getAttribute('data-level');
                    const semester = button.getAttribute('data-semester');

                    // تعيين القيم للحقول المخفية - تأكد من وجود العناصر
                    if(modalLevelInput) modalLevelInput.value = level; else console.error('#modal_plan_level missing!');
                    if(modalSemesterInput) modalSemesterInput.value = semester; else console.error('#modal_plan_semester missing!');
                    if(modalTitle) modalTitle.textContent = `Add Subject to Level ${level}, Semester ${semester}`;

                    // إعادة تعيين قيمة الـ select
                    if(subjectSelect) subjectSelect.value = '';

                    console.log(`Add modal opened for L${level} S${semester}. Hidden fields set.`);

                } else {
                     console.error("Add modal trigger button or data attributes missing!", button);
                     // يمكنك منع فتح المودال هنا إذا أردت
                     // event.preventDefault();
                }
            });
             console.log('Add modal listener attached.');
        } else {
            console.error('#addSubjectToPlanModal not found.');
        }


        // --- التعامل مع مودال الحذف ---
        const deleteModalEl = document.getElementById('deletePlanSubjectModal');
        if (deleteModalEl) {
            const deleteForm = deleteModalEl.querySelector('#deletePlanSubjectForm'); // الفورم
            const subjectNameSpan = deleteModalEl.querySelector('#subjectNameToDelete'); // الـ span

             if(!deleteForm) console.error('#deletePlanSubjectForm missing!');
             if(!subjectNameSpan) console.error('#subjectNameToDelete missing!');

            deleteModalEl.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;

                if (button && deleteForm && subjectNameSpan) {
                    const formAction = button.getAttribute('data-form-action');
                    const subjectName = button.getAttribute('data-subject-name');

                    console.log('[Delete Modal] Opening. Action:', formAction, 'Subject:', subjectName);

                    // **تحديث الـ action واسم المادة**
                    if (formAction) {
                        deleteForm.action = formAction;
                        console.log('Delete form action updated to:', deleteForm.action);
                    } else {
                         console.error("Action URL is missing from data-form-action!");
                         // منع الإرسال إذا لم يوجد رابط
                         $(deleteForm).find('button[type="submit"]').prop('disabled', true);
                    }

                    subjectNameSpan.textContent = subjectName || 'this subject';
                     $(deleteForm).find('button[type="submit"]').prop('disabled', false); // تفعيل الزر

                } else {
                    console.error('Delete modal trigger button or essential modal elements missing.');
                     if(deleteForm) $(deleteForm).find('button[type="submit"]').prop('disabled', true); // تعطيل زر الحذف كإجراء وقائي
                }
            });
             console.log('Delete modal listener attached.');
        } else {
            console.error('#deletePlanSubjectModal not found.');
        }

    }); // نهاية DOMContentLoaded
</script>
@endpush
-------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\plan-expected-counts.blade.php
@extends('dashboard.layout')

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="data-entry-header mb-0">Manage Expected Student Counts</h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCountModal">
                    <i class="fas fa-plus me-1"></i> Add Expected Count
                </button>
            </div>

            @include('dashboard.data-entry.partials._status_messages')

            {{-- TODO: Add Filters (by Academic Year, Plan, Department?) --}}
            {{-- <div class="card shadow-sm mb-3"> <div class="card-body"> ... Filters ... </div> </div> --}}


            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Academic Year</th>
                                    <th scope="col">Plan</th>
                                    <th scope="col">Level</th>
                                    <th scope="col">Semester</th>
                                    <th scope="col">Branch</th>
                                    <th scope="col">Male Count</th>
                                    <th scope="col">Female Count</th>
                                    <th scope="col">Total</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @forelse ($expectedCounts as $index => $count)
                                    <tr>
                                        <td>{{ $expectedCounts->firstItem() + $index }}</td>
                                        <td>{{ $count->academic_year }}</td>
                                        <td>
                                            <span title="{{ optional($count->plan)->plan_name }}">
                                                {{ optional($count->plan)->plan_no ?? 'N/A' }}
                                            </span>
                                        </td>
                                        <td>{{ $count->plan_level }}</td>
                                        <td>{{ $count->plan_semester }}</td>
                                        <td>{{ $count->branch ?? '-' }}</td>
                                        <td>{{ $count->male_count }}</td>
                                        <td>{{ $count->female_count }}</td>
                                        <td>{{ $count->male_count + $count->female_count }}</td>
                                        <td>
                                            {{-- زر التعديل --}}
                                            <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal"
                                                data-bs-target="#editCountModal-{{ $count->id }}" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {{-- زر الحذف --}}
                                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                                data-bs-target="#deleteCountModal-{{ $count->id }}" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>

                                            {{-- *** الزر الجديد لإدارة شعب هذا العدد المتوقع *** --}}
                                            <a href="{{ route('data-entry.sections.manageContext', $count->id) }}"
                                                {{-- روت جديد --}} class="btn btn-sm btn-info"
                                                title="Manage Sections for this Entry">
                                                <i class="fas fa-users-cog"></i> Sections
                                            </a>
                                            {{-- *** نهاية الزر الجديد *** --}}

                                            {{-- تضمين Modals --}}
                                            @include(
                                                'dashboard.data-entry.partials._plan_expected_count_modals',
                                                ['count' => $count, 'plans' => $plans]
                                            )

                                        </td>
                                    </tr>
                                @empty
                                    <tr>
                                        <td colspan="10" class="text-center text-muted">No expected counts found. Click
                                            'Add Expected Count' to create one.</td>
                                    </tr>
                                @endforelse
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 d-flex justify-content-center">
                        {{ $expectedCounts->links('pagination::bootstrap-5') }}
                    </div>
                </div>
            </div>

            {{-- مودال الإضافة --}}
            @include('dashboard.data-entry.partials._plan_expected_count_modals', [
                'count' => null,
                'plans' => $plans,
            ])

        </div>
    </div>
@endsection

@push('scripts')
    {{-- JS خاص بالصفحة إذا لزم الأمر (مثلاً للـ Filters) --}}
@endpush
---------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_plan_expected_count_modals.blade.php
{{-- ======================================= --}}
{{-- Modal لإضافة عدد متوقع جديد --}}
{{-- ======================================= --}}
@if (!$count)
<div class="modal fade" id="addCountModal" tabindex="-1" aria-labelledby="addCountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCountModalLabel">Add New Expected Count</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.plan-expected-counts.store') }}" method="POST">
                @csrf
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_academic_year" class="form-label">Academic Year <span class="text-danger">*</span></label>
                            {{-- يمكنك استخدام select أو input type number --}}
                            <input type="number" class="form-control @error('academic_year', 'store') is-invalid @enderror" id="add_academic_year" name="academic_year" value="{{ old('academic_year', date('Y')) }}" required placeholder="YYYY" min="2020" max="{{ date('Y') + 5 }}">
                            @error('academic_year', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_plan_id" class="form-label">Academic Plan <span class="text-danger">*</span></label>
                            <select class="form-select @error('plan_id', 'store') is-invalid @enderror" id="add_plan_id" name="plan_id" required>
                                <option value="" selected disabled>Select plan...</option>
                                @if(isset($plans))
                                    @foreach ($plans as $plan)
                                        <option value="{{ $plan->id }}" {{ old('plan_id') == $plan->id ? 'selected' : '' }}>{{ $plan->plan_name }} ({{ $plan->plan_no }})</option>
                                    @endforeach
                                @endif
                            </select>
                            @error('plan_id', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                             <label for="add_plan_level" class="form-label">Level <span class="text-danger">*</span></label>
                             {{-- تحديد أقصى مستوى بناءً على الخطة المختارة قد يكون أفضل، لكن للتبسيط الآن نضع حقل رقمي --}}
                             <input type="number" class="form-control @error('plan_level', 'store') is-invalid @enderror" id="add_plan_level" name="plan_level" value="{{ old('plan_level') }}" required min="1" max="6"> {{-- افترض 6 مستويات كحد أقصى --}}
                             @error('plan_level', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                             <label for="add_plan_semester" class="form-label">Semester <span class="text-danger">*</span></label>
                             <input type="number" class="form-control @error('plan_semester', 'store') is-invalid @enderror" id="add_plan_semester" name="plan_semester" value="{{ old('plan_semester') }}" required min="1" max="3"> {{-- افترض 3 فصول كحد أقصى (مع الصيفي) --}}
                             @error('plan_semester', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                    <div class="row">
                         <div class="col-md-4 mb-3">
                            <label for="add_male_count" class="form-label">Male Count <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('male_count', 'store') is-invalid @enderror" id="add_male_count" name="male_count" value="{{ old('male_count', 0) }}" required min="0">
                            @error('male_count', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                         <div class="col-md-4 mb-3">
                            <label for="add_female_count" class="form-label">Female Count <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('female_count', 'store') is-invalid @enderror" id="add_female_count" name="female_count" value="{{ old('female_count', 0) }}" required min="0">
                            @error('female_count', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                         <div class="col-md-4 mb-3">
                            <label for="add_branch" class="form-label">Branch (Optional)</label>
                            <input type="text" class="form-control @error('branch', 'store') is-invalid @enderror" id="add_branch" name="branch" value="{{ old('branch') }}" placeholder="e.g., Main, North">
                            @error('branch', 'store') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                    {{-- عرض خطأ التفرد --}}
                    @error('count_unique', 'store') <div class="alert alert-danger small p-2">{{ $message }}</div> @enderror
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Count</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endif

{{-- ========================== --}}
{{-- Modals التعديل والحذف --}}
{{-- ========================== --}}
@if ($count)

{{-- Modal لتعديل عدد متوقع --}}
<div class="modal fade" id="editCountModal-{{ $count->id }}" tabindex="-1" aria-labelledby="editCountModalLabel-{{ $count->id }}" aria-hidden="true">
     <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCountModalLabel-{{ $count->id }}">Edit Expected Count</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             <form action="{{ route('data-entry.plan-expected-counts.update', $count->id) }}" method="POST">
                @csrf
                @method('PUT')
                <div class="modal-body">
                    {{-- نفس حقول الإضافة مع القيم الحالية --}}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_academic_year_{{ $count->id }}" class="form-label">Academic Year <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('academic_year', 'update_'.$count->id) is-invalid @enderror" id="edit_academic_year_{{ $count->id }}" name="academic_year" value="{{ old('academic_year', $count->academic_year) }}" required placeholder="YYYY" min="2020" max="{{ date('Y') + 5 }}">
                            @error('academic_year', 'update_'.$count->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_plan_id_{{ $count->id }}" class="form-label">Academic Plan <span class="text-danger">*</span></label>
                            <select class="form-select @error('plan_id', 'update_'.$count->id) is-invalid @enderror" id="edit_plan_id_{{ $count->id }}" name="plan_id" required>
                                <option value="" disabled>Select plan...</option>
                                @if(isset($plans))
                                    @foreach ($plans as $plan)
                                        <option value="{{ $plan->id }}" {{ old('plan_id', $count->plan_id) == $plan->id ? 'selected' : '' }}>{{ $plan->plan_name }} ({{ $plan->plan_no }})</option>
                                    @endforeach
                                @endif
                            </select>
                            @error('plan_id', 'update_'.$count->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                    {{-- ... باقي الحقول بنفس الطريقة ... --}}
                     <div class="row">
                        <div class="col-md-6 mb-3">
                             <label for="edit_plan_level_{{ $count->id }}" class="form-label">Level <span class="text-danger">*</span></label>
                             <input type="number" class="form-control @error('plan_level', 'update_'.$count->id) is-invalid @enderror" id="edit_plan_level_{{ $count->id }}" name="plan_level" value="{{ old('plan_level', $count->plan_level) }}" required min="1" max="6">
                             @error('plan_level', 'update_'.$count->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                             <label for="edit_plan_semester_{{ $count->id }}" class="form-label">Semester <span class="text-danger">*</span></label>
                             <input type="number" class="form-control @error('plan_semester', 'update_'.$count->id) is-invalid @enderror" id="edit_plan_semester_{{ $count->id }}" name="plan_semester" value="{{ old('plan_semester', $count->plan_semester) }}" required min="1" max="3">
                             @error('plan_semester', 'update_'.$count->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                     <div class="row">
                         <div class="col-md-4 mb-3">
                            <label for="edit_male_count_{{ $count->id }}" class="form-label">Male Count <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('male_count', 'update_'.$count->id) is-invalid @enderror" id="edit_male_count_{{ $count->id }}" name="male_count" value="{{ old('male_count', $count->male_count) }}" required min="0">
                            @error('male_count', 'update_'.$count->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                         <div class="col-md-4 mb-3">
                            <label for="edit_female_count_{{ $count->id }}" class="form-label">Female Count <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('female_count', 'update_'.$count->id) is-invalid @enderror" id="edit_female_count_{{ $count->id }}" name="female_count" value="{{ old('female_count', $count->female_count) }}" required min="0">
                            @error('female_count', 'update_'.$count->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                         <div class="col-md-4 mb-3">
                            <label for="edit_branch_{{ $count->id }}" class="form-label">Branch (Optional)</label>
                            <input type="text" class="form-control @error('branch', 'update_'.$count->id) is-invalid @enderror" id="edit_branch_{{ $count->id }}" name="branch" value="{{ old('branch', $count->branch) }}" placeholder="e.g., Main, North">
                            @error('branch', 'update_'.$count->id) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                    {{-- عرض خطأ التفرد للتحديث --}}
                    @error('count_unique', 'update_'.$count->id) <div class="alert alert-danger small p-2">{{ $message }}</div> @enderror
                     {{-- عرض خطأ الكنترولر العام إذا وجد --}}
                     @error('update_error', 'update_'.$count->id) <div class="alert alert-danger small p-2">{{ $message }}</div> @enderror
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update Count</button>
                </div>
            </form>
        </div>
    </div>
</div>

{{-- Modal لتأكيد الحذف --}}
<div class="modal fade" id="deleteCountModal-{{ $count->id }}" tabindex="-1" aria-labelledby="deleteCountModalLabel-{{ $count->id }}" aria-hidden="true">
     <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteCountModalLabel-{{ $count->id }}">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             <form action="{{ route('data-entry.plan-expected-counts.destroy', $count->id) }}" method="POST">
                @csrf
                @method('DELETE')
                <div class="modal-body">
                    <p>Are you sure you want to delete the expected count record for:</p>
                    <p><strong>Plan:</strong> {{ optional($count->plan)->plan_name ?? 'N/A' }}<br>
                       <strong>Year:</strong> {{ $count->academic_year }}<br>
                       <strong>Level:</strong> {{ $count->plan_level }}, <strong>Semester:</strong> {{ $count->plan_semester }}<br>
                       <strong>Branch:</strong> {{ $count->branch ?? 'Default' }}
                    </p>
                    <p class="text-danger small">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Yes, Delete Count</button>
                </div>
            </form>
        </div>
    </div>
</div>

@endif
---------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\sections\index.blade.php
@extends('dashboard.layout')

@push('styles')
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<style>
    .select2-container--bootstrap-5 .select2-selection--single { height: calc(1.5em + .75rem + 2px); padding: .375rem .75rem; font-size: 0.875rem; }
    .table th, .table td { vertical-align: middle; font-size: 0.85rem; }
</style>
@endpush

@section('content')
<div class="main-content">
    <div class="data-entry-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
             <h1 class="data-entry-header mb-0">View All Academic Sections</h1>
             {{-- لا زر إضافة عام هنا، الإضافة ستكون من صفحة التحكم التفصيلي --}}
        </div>

        @include('dashboard.data-entry.partials._status_messages') {{-- تأكد أن هذا الـ partial موجود ويعمل --}}

        {{-- قسم الفلاتر --}}
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="fas fa-filter me-2"></i>Filter Sections</h5>
                <form action="{{ route('data-entry.sections.index') }}" method="GET">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-2">
                            <label for="filter_academic_year" class="form-label form-label-sm">Academic Year</label>
                            <select class="form-select form-select-sm" id="filter_academic_year" name="academic_year">
                                <option value="">All</option>
                                @foreach($academicYears as $year) {{-- $academicYears من الكنترولر --}}
                                    <option value="{{ $year }}" {{ $request->academic_year == $year ? 'selected' : '' }}>{{ $year }}</option>
                                @endforeach
                            </select>
                        </div>
                         <div class="col-md-2">
                             <label for="filter_semester" class="form-label form-label-sm">Term</label>
                             <select class="form-select form-select-sm" id="filter_semester" name="semester">
                                 <option value="">All</option>
                                  @foreach($semesters as $key => $value) {{-- $semesters من الكنترولر --}}
                                     <option value="{{ $key }}" {{ $request->semester == $key ? 'selected' : '' }}>{{ $value }}</option>
                                 @endforeach
                             </select>
                         </div>
                        <div class="col-md-3">
                             <label for="filter_department_id" class="form-label form-label-sm">Department</label>
                             <select class="form-select form-select-sm select2-filter" id="filter_department_id" name="department_id" data-placeholder="All Departments">
                                 <option value=""></option>
                                 @foreach($departments as $department) {{-- $departments من الكنترولر --}}
                                     <option value="{{ $department->id }}" {{ $request->department_id == $department->id ? 'selected' : '' }}>{{ $department->department_name }}</option>
                                 @endforeach
                             </select>
                        </div>
                        <div class="col-md-3">
                             <label for="filter_plan_id" class="form-label form-label-sm">Academic Plan</label>
                             <select class="form-select form-select-sm select2-filter" id="filter_plan_id" name="plan_id" data-placeholder="All Plans">
                                  <option value=""></option>
                                  @foreach($plans as $plan) {{-- $plans من الكنترولر --}}
                                     <option value="{{ $plan->id }}" {{ $request->plan_id == $plan->id ? 'selected' : '' }}>{{ $plan->plan_no }} - {{ $plan->plan_name }}</option>
                                  @endforeach
                             </select>
                         </div>
                         <div class="col-md-2">
                              <label for="filter_plan_level" class="form-label form-label-sm">Level</label>
                              <select class="form-select form-select-sm" id="filter_plan_level" name="plan_level">
                                  <option value="">All</option>
                                   @foreach($levels as $level_option) {{-- $levels من الكنترولر --}}
                                      <option value="{{ $level_option }}" {{ $request->plan_level == $level_option ? 'selected' : '' }}>{{ $level_option }}</option>
                                  @endforeach
                              </select>
                          </div>
                    </div>
                    <div class="row g-3 mt-1 align-items-end">
                         <div class="col-md-4">
                              <label for="filter_subject_id" class="form-label form-label-sm">Subject</label>
                              <select class="form-select form-select-sm select2-filter" id="filter_subject_id" name="subject_id" data-placeholder="All Subjects">
                                   <option value=""></option>
                                   @foreach($subjectsForFilter as $subject_filter) {{-- $subjectsForFilter من الكنترولر --}}
                                      <option value="{{ $subject_filter->id }}" {{ $request->subject_id == $subject_filter->id ? 'selected' : '' }}>{{ $subject_filter->subject_no }} - {{ $subject_filter->subject_name }}</option>
                                   @endforeach
                              </select>
                          </div>
                          <div class="col-md-3">
                              <label for="filter_branch" class="form-label form-label-sm">Branch</label>
                              <input type="text" class="form-control form-control-sm" id="filter_branch" name="branch" value="{{ $request->branch }}" placeholder="e.g., Main or type 'none'">
                              {{-- <small class="text-muted">Type 'none' for default/no branch.</small> --}}
                          </div>
                          <div class="col-md-auto ms-auto d-flex gap-2">
                              <a href="{{ route('data-entry.sections.index') }}" class="btn btn-sm btn-outline-secondary">Reset</a>
                              <button type="submit" class="btn btn-sm btn-primary ms-2">Filter</button>
                          </div>
                    </div>
                </form>
            </div>
        </div>

        {{-- جدول عرض الشعب --}}
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Year</th><th>Term</th><th>Plan</th><th>Lvl</th><th>Subject</th>
                                <th>Activity</th><th>Sec#</th><th>Gender</th><th>Branch</th><th>Count</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @forelse ($sections as $index => $section)
                            <tr>
                                <td>{{ $sections->firstItem() + $index }}</td>
                                <td>{{ $section->academic_year }}</td>
                                <td>{{ $section->semester }}</td>
                                <td title="{{ optional(optional($section->planSubject)->plan)->plan_name ?? '' }}">
                                    {{ optional(optional($section->planSubject)->plan)->plan_no ?? 'N/A' }}
                                </td>
                                <td>{{ optional($section->planSubject)->plan_level ?? 'N/A' }}</td>
                                <td title="{{ optional(optional($section->planSubject)->subject)->subject_name ?? '' }}">
                                     {{ Str::limit(optional(optional($section->planSubject)->subject)->subject_no ?? 'N/A', 10) }}
                                     - {{ Str::limit(optional(optional($section->planSubject)->subject)->subject_name ?? 'N/A', 20) }}
                                </td>
                                <td>
                                    <span class="badge bg-{{ $section->activity_type == 'Theory' ? 'primary' : 'success' }}">
                                        {{ $section->activity_type }}
                                    </span>
                                </td>
                                <td>{{ $section->section_number }}</td>
                                <td>{{ $section->section_gender }}</td>
                                <td>{{ $section->branch ?? '-' }}</td>
                                <td>{{ $section->student_count }}</td>
                                <td>
                                    {{-- زر الانتقال لصفحة التحكم التفصيلي --}}
                                    <a href="{{ route('data-entry.sections.manageSubjectContext', [
                                                'plan_subject_id' => $section->plan_subject_id,
                                                'academic_year' => $section->academic_year,
                                                'semester_of_sections' => $section->semester, // ** تأكد من اسم البارامتر **
                                                'branch' => $section->branch,
                                            ]) }}"
                                       class="btn btn-sm btn-outline-primary"
                                       title="Manage Sections for: {{ optional(optional($section->planSubject)->subject)->subject_no }}">
                                        <i class="fas fa-edit"></i> Manage
                                    </a>
                                </td>
                            </tr>
                            @empty
                            <tr><td colspan="12" class="text-center text-muted">No sections found matching your criteria.</td></tr>
                            @endforelse
                        </tbody>
                    </table>
                </div>
                 <div class="mt-3 d-flex justify-content-center">
                     {{ $sections->appends(request()->query())->links('pagination::bootstrap-5') }}
                 </div>
            </div>
        </div>
    </div>
</div>
@endsection

@push('scripts')
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        $('.select2-filter').select2({
            theme: 'bootstrap-5',
            allowClear: true,
            placeholder: $(this).data('placeholder')
        });
    });
</script>
@endpush
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\sections\partials\_sections_modals.blade.php
{{-- ===================================================== --}}
{{-- مودال إضافة شعبة (واحد مشترك) --}}
{{-- ===================================================== --}}
<div class="modal fade" id="addSectionModal" tabindex="-1" aria-labelledby="addSectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSectionModalLabel">Add New Section</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addSectionForm" action="{{ route('data-entry.sections.store') }}" method="POST">
                @csrf
                {{-- حقول السياق المخفية (يتم تعبئتها بـ JS) --}}
                <input type="hidden" name="plan_subject_id" value="{{ old('plan_subject_id') }}">
                <input type="hidden" name="activity_type" value="{{ old('activity_type') }}">
                <input type="hidden" name="academic_year" value="{{ old('academic_year') }}">
                <input type="hidden" name="semester" value="{{ old('semester') }}">
                <input type="hidden" name="branch" value="{{ old('branch') }}">

                <div class="modal-body">
                     {{-- عرض أخطاء الـ validation العامة من هذا الفورم --}}
                     @if ($errors->hasBag('addSectionModal'))
                        <div class="alert alert-danger small p-2 mb-3 validation-errors">
                            <strong>Please correct the errors:</strong>
                            <ul class="mb-0 ps-3">
                                @foreach ($errors->getBag('addSectionModal')->all() as $error)
                                    <li>{{ $error }}</li>
                                @endforeach
                            </ul>
                        </div>
                     @endif

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_section_number" class="form-label">Section Number <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('section_number', 'addSectionModal') is-invalid @enderror" id="add_section_number" name="section_number" value="{{ old('section_number', 1) }}" required min="1">
                            @error('section_number', 'addSectionModal') <div class="invalid-feedback">{{ $message }}</div> @enderror
                            {{-- خطأ التفرد من الكنترولر (إذا استخدم نفس الـ bag) --}}
                            @error('section_unique', 'addSectionModal') <div class="text-danger small mt-1">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_student_count" class="form-label">Student Count <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('student_count', 'addSectionModal') is-invalid @enderror" id="add_student_count" name="student_count" value="{{ old('student_count', 0) }}" required min="0">
                            @error('student_count', 'addSectionModal') <div class="invalid-feedback">{{ $message }}</div> @enderror
                            {{-- خطأ تجاوز العدد الإجمالي --}}
                            @error('student_count_total', 'addSectionModal') <div class="text-danger small mt-1">{{ $message }}</div> @enderror
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_section_gender" class="form-label">Section Gender <span class="text-danger">*</span></label>
                            <select class="form-select @error('section_gender', 'addSectionModal') is-invalid @enderror" id="add_section_gender" name="section_gender" required>
                                <option value="Mixed" {{ old('section_gender', 'Mixed') == 'Mixed' ? 'selected' : '' }}>Mixed</option>
                                <option value="Male" {{ old('section_gender') == 'Male' ? 'selected' : '' }}>Male Only</option>
                                <option value="Female" {{ old('section_gender') == 'Female' ? 'selected' : '' }}>Female Only</option>
                            </select>
                            @error('section_gender', 'addSectionModal') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                         <div class="col-md-6 mb-3">
                            <label for="add_branch_display" class="form-label">Branch (from context)</label>
                            <input type="text" class="form-control" id="add_branch_display" readonly>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Section</button>
                </div>
            </form>
        </div>
    </div>
</div>

{{-- مودال التعديل (واحد مشترك) --}}
{{-- مودال التعديل (واحد مشترك) --}}
<div class="modal fade" id="editSectionModal" tabindex="-1" aria-labelledby="editSectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSectionModalLabel">Edit Section</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editSectionForm" action="#" method="POST">
                @csrf
                @method('PUT')
                <div class="modal-body">
                    <div class="alert alert-secondary small p-2 mb-3" id="edit_context_info_text">
                        <strong>Context:</strong> <span>Loading...</span>
                    </div>

                    {{-- عرض أخطاء التحقق --}}
                    @php
                        $editErrorBagName = null;
                        $sectionIdForModal = session('editSectionId') ?? null;
                        if ($sectionIdForModal && $errors->hasBag('editSectionModal_'.$sectionIdForModal)) {
                            $editErrorBagName = 'editSectionModal_'.$sectionIdForModal;
                        }
                    @endphp

                    @if($editErrorBagName && $errors->$editErrorBagName->any())
                        <div class="alert alert-danger small p-2 validation-errors">
                            <strong>Please correct the errors:</strong>
                            <ul class="mb-0 ps-3">
                                @foreach ($errors->$editErrorBagName->all() as $error)
                                    <li>{{ $error }}</li>
                                @endforeach
                            </ul>
                        </div>
                    @endif

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_section_number" class="form-label">Section Number <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @if($editErrorBagName) @error('section_number', $editErrorBagName) is-invalid @enderror @endif"
                                   id="edit_section_number" name="section_number"
                                   value="{{ old('section_number', $sectionForModal->section_number ?? '') }}" required min="1">
                            @if($editErrorBagName)
                                @error('section_number', $editErrorBagName)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                                @error('section_unique', $editErrorBagName)
                                    <div class="text-danger small mt-1">{{ $message }}</div>
                                @enderror
                            @endif
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_student_count" class="form-label">Student Count <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @if($editErrorBagName) @error('student_count', $editErrorBagName) is-invalid @enderror @endif"
                                   id="edit_student_count" name="student_count"
                                   value="{{ old('student_count', $sectionForModal->student_count ?? '') }}" required min="0">
                            @if($editErrorBagName)
                                @error('student_count', $editErrorBagName)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                                @error('student_count_total', $editErrorBagName)
                                    <div class="text-danger small mt-1">{{ $message }}</div>
                                @enderror
                            @endif
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_section_gender" class="form-label">Section Gender <span class="text-danger">*</span></label>
                            <select class="form-select @if($editErrorBagName) @error('section_gender', $editErrorBagName) is-invalid @enderror @endif"
                                    id="edit_section_gender" name="section_gender" required>
                                <option value="Mixed" @if(old('section_gender', $sectionForModal->section_gender ?? '') == 'Mixed') selected @endif>Mixed</option>
                                <option value="Male" @if(old('section_gender', $sectionForModal->section_gender ?? '') == 'Male') selected @endif>Male Only</option>
                                <option value="Female" @if(old('section_gender', $sectionForModal->section_gender ?? '') == 'Female') selected @endif>Female Only</option>
                            </select>
                            @if($editErrorBagName)
                                @error('section_gender', $editErrorBagName)
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            @endif
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_branch_display" class="form-label">Branch (from context)</label>
                            <input type="text" class="form-control" id="edit_branch_display" readonly>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Section</button>
                </div>
            </form>
        </div>
    </div>
</div>

{{-- مودال الحذف (واحد مشترك) --}}
<div class="modal fade" id="deleteSectionModal" tabindex="-1" aria-labelledby="deleteSectionModalLabel" aria-hidden="true">
     <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteSectionModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             <form id="deleteSectionForm" action="#" method="POST">
                @csrf
                @method('DELETE')
                <div class="modal-body">
                     <p>Are you sure you want to delete <strong id="deleteSectionInfoText">this section</strong>?</p>
                    <p class="text-danger small">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Yes, Delete Section</button>
                </div>
            </form>
        </div>
    </div>
</div>
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\sections\manage.blade.php
@extends('dashboard.layout')

@push('styles')
    <style>
        .table th,
        .table td {
            vertical-align: middle;
            font-size: 0.85rem;
            padding: 0.5rem;
        }

        .modal-dialog-centered {
            display: flex;
            align-items: center;
            min-height: calc(100% - 1rem);
        }

        @media (min-width: 576px) {
            .modal-dialog-centered {
                min-height: calc(100% - 3.5rem);
            }
        }

        .card-body .table-responsive {
            margin-bottom: 0;
        }

        .card-header h5.mb-0,
        .card-header h6.mb-0 {
            font-size: 1rem;
        }
    </style>
@endpush

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            {{-- 1. عرض معلومات السياق --}}
            <div class="mb-4 p-3 border rounded bg-light shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <h4 class="data-entry-header mb-1">Manage Sections for Subject</h4>
                        <p class="mb-1 text-muted small">
                            Plan: <strong>{{ optional($planSubject->plan)->plan_no }}</strong>
                            ({{ optional($planSubject->plan)->plan_name }}) <br>
                            Subject: <strong>{{ optional($planSubject->subject)->subject_no }} -
                                {{ optional($planSubject->subject)->subject_name }}</strong>
                            <span
                                class="badge bg-secondary fw-normal">{{ optional(optional($planSubject->subject)->subjectCategory)->subject_category_name }}</span>
                        </p>
                    </div>
                    <a href="{{ route('data-entry.sections.index', $request->query()) }}"
                        class="btn btn-sm btn-outline-secondary align-self-start">
                        <i class="fas fa-arrow-left me-1"></i> Back to All Sections
                    </a>
                </div>
                <hr>
                <div class="row small">
                    <div class="col-md-4">
                        <p class="mb-1"><strong>Academic Year:</strong> {{ $academicYear }}</p>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1"><strong>Term (Sections):</strong>
                            {{ $semesterOfSections == 1 ? 'First' : ($semesterOfSections == 2 ? 'Second' : 'Summer') }}</p>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-0"><strong>Branch:</strong> {{ $branch ?? 'Default' }}</p>
                    </div>
                </div>
                @if ($expectedCount)
                    <div class="mt-2">
                        <p class="mb-0"><strong>Total Expected Students for Context:</strong> <span
                                class="fw-bold fs-5">{{ $expectedCount->male_count + $expectedCount->female_count }}</span>
                        </p>
                    </div>
                @else
                    <div class="alert alert-warning small mt-2 p-2">Expected student count not found. <a
                            href="{{ route('data-entry.plan-expected-counts.index') }}" class="alert-link">Add it here.</a>
                    </div>
                @endif
            </div>

            @include('dashboard.data-entry.partials._status_messages')

            {{-- 2. زر إنشاء/تحديث الشعب لهذه المادة فقط --}}
            <div class="mb-3 text-end">
                @if ($expectedCount)
                    <form action="{{ route('data-entry.sections.generateForSubject') }}" method="POST" class="d-inline">
                        @csrf
                        <input type="hidden" name="plan_subject_id" value="{{ $planSubject->id }}">
                        <input type="hidden" name="expected_count_id" value="{{ $expectedCount->id }}">
                        <button type="submit" class="btn btn-warning"
                            onclick="return confirm('ATTENTION: This will DELETE existing sections for THIS SUBJECT ONLY and REGENERATE them. Manual adjustments will be lost. Are you sure?');">
                            <i class="fas fa-cogs me-1"></i> Regenerate Sections for This Subject
                        </button>
                    </form>
                @endif
            </div>

            {{-- 3. عرض الشعب الحالية لهذه المادة --}}
            @php
                $subject = $planSubject->subject;
                if ($subject && $subject->subjectCategory) {
                    $subjectCategoryName = strtolower($subject->subjectCategory->subject_category_name);
                    $theorySections = $currentSections->where('activity_type', 'Theory');
                    $practicalSections = $currentSections->where('activity_type', 'Practical');
                } else {
                    $subjectCategoryName = '';
                    $theorySections = collect();
                    $practicalSections = collect();
                }
            @endphp

            {{-- الجزء النظري --}}
            @if (
                ($subject->theoretical_hours ?? 0) > 0 &&
                    Str::contains($subjectCategoryName, ['theory', 'نظري', 'combined', 'مشترك']))
                <div class="card shadow-sm mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center"
                        style="background-color: #e9ecef;">
                        <h6 class="mb-0 text-dark"><i class="fas fa-chalkboard me-2"></i>Theory Sections</h6>
                        <button class="btn btn-outline-success btn-sm open-add-section-modal" data-bs-toggle="modal"
                            data-bs-target="#addSectionModal" data-plan-subject-id="{{ $planSubject->id }}"
                            data-activity-type="Theory" data-subject-name-modal="{{ $subject->subject_name }} (Theory)"
                            data-academic-year="{{ $academicYear }}" data-semester="{{ $semesterOfSections }}"
                            data-branch="{{ $branch ?? '' }}">
                            <i class="fas fa-plus me-1"></i> Add Theory Section
                        </button>
                    </div>
                    <div class="card-body p-0">
                        @if ($theorySections->isNotEmpty())
                            {{-- *** جدول الشعب النظرية مدمج هنا *** --}}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Sec.No.</th>
                                            <th>Gender</th>
                                            <th>Branch</th>
                                            <th>Students</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach ($theorySections as $index => $section)
                                            <tr>
                                                <td>{{ $index + 1 }}</td>
                                                <td>{{ $section->section_number }}</td>
                                                <td>{{ $section->section_gender }}</td>
                                                <td>{{ $section->branch ?? '-' }}</td>
                                                <td>{{ $section->student_count }}</td>
                                                <td>
                                                    <button
                                                        class="btn btn-sm btn-outline-primary py-0 px-1 me-1 open-edit-section-modal"
                                                        data-bs-toggle="modal" data-bs-target="#editSectionModal"
                                                        data-form-action="{{ route('data-entry.sections.update', $section->id) }}"
                                                        data-section-number="{{ $section->section_number }}"
                                                        data-student-count="{{ $section->student_count }}"
                                                        data-section-gender="{{ $section->section_gender }}"
                                                        data-branch="{{ $section->branch ?? '' }}"
                                                        data-activity-type="{{ $section->activity_type }}"
                                                        data-context-info="Sec #{{ $section->section_number }} for {{ optional($planSubject->subject)->subject_no }} (Theory)">Edit</button>

                                                    <button
                                                        class="btn btn-sm btn-outline-danger py-0 px-1 open-delete-section-modal"
                                                        data-bs-toggle="modal" data-bs-target="#deleteSectionModal"
                                                        data-form-action="{{ route('data-entry.sections.destroy', $section->id) }}"
                                                        data-section-info="Section #{{ $section->section_number }} (Theory) for {{ optional($planSubject->subject)->subject_no }}">Delete</button>
                                                </td>
                                            </tr>
                                        @endforeach
                                    </tbody>
                                </table>
                            </div>
                            {{-- *** نهاية الجدول المدمج *** --}}
                        @else
                            <p class="text-muted text-center p-3 mb-0">No theory sections defined.</p>
                        @endif
                    </div>
                </div>
            @endif

            {{-- الجزء العملي --}}
            @if (
                ($subject->practical_hours ?? 0) > 0 &&
                    Str::contains($subjectCategoryName, ['practical', 'عملي', 'combined', 'مشترك']))
                @if (
                    $subjectCategoryName == 'theory' ||
                        Str::contains($subjectCategoryName, 'نظري') ||
                        (Str::contains($subjectCategoryName, 'combined') || Str::contains($subjectCategoryName, 'مشترك')))
                    <div class="card shadow-sm mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center"
                            style="background-color: #f8f9fa;">
                            <h6 class="mb-0 text-dark"><i class="fas fa-flask me-2"></i>Practical Sections</h6>
                            <button class="btn btn-outline-success btn-sm open-add-section-modal" data-bs-toggle="modal"
                                data-bs-target="#addSectionModal" data-plan-subject-id="{{ $planSubject->id }}"
                                data-activity-type="Practical"
                                data-subject-name-modal="{{ $subject->subject_name }} (Practical)"
                                data-academic-year="{{ $academicYear }}" data-semester="{{ $semesterOfSections }}"
                                data-branch="{{ $branch ?? '' }}">
                                <i class="fas fa-plus me-1"></i> Add Practical Section
                            </button>
                        </div>
                        <div class="card-body p-0">
                            @if ($practicalSections->isNotEmpty())
                                {{-- *** جدول الشعب العملية مدمج هنا *** --}}
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>#</th>
                                                <th>Sec.No.</th>
                                                <th>Gender</th>
                                                <th>Branch</th>
                                                <th>Students</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach ($practicalSections as $index => $section)
                                                <tr>
                                                    <td>{{ $index + 1 }}</td>
                                                    <td>{{ $section->section_number }}</td>
                                                    <td>{{ $section->section_gender }}</td>
                                                    <td>{{ $section->branch ?? '-' }}</td>
                                                    <td>{{ $section->student_count }}</td>
                                                    <td>
                                                        <button
                                                            class="btn btn-sm btn-outline-primary ... open-edit-section-modal"
                                                            data-bs-toggle="modal" data-bs-target="#editSectionModal"
                                                            {{-- **ID المودال العام** --}}
                                                            data-form-action="{{ route('data-entry.sections.update', $section->id) }}"
                                                            data-section-number="{{ $section->section_number }}"
                                                            data-student-count="{{ $section->student_count }}"
                                                            data-section-gender="{{ $section->section_gender }}"
                                                            data-branch="{{ $section->branch ?? '' }}"
                                                            data-context-info="Sec #{{ $section->section_number }} for {{ optional($planSubject->subject)->subject_no }} ({{ $section->activity_type }})">Edit</button>
                                                        {{-- <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1 open-edit-section-modal"
                                                            data-bs-toggle="modal" data-bs-target="#editSectionModal"
                                                            data-form-action="{{ route('data-entry.sections.update', $section->id) }}"
                                                            data-section-number="{{ $section->section_number }}"
                                                            data-student-count="{{ $section->student_count }}"
                                                            data-section-gender="{{ $section->section_gender }}"
                                                            data-branch="{{ $section->branch ?? '' }}"
                                                            data-activity-type="{{ $section->activity_type }}"
                                                            data-context-info="Sec #{{$section->section_number}} for {{ $subject->subject_no }} (Practical)">Edit</button> --}}

                                                        <button
                                                            class="btn btn-sm btn-outline-danger py-0 px-1 open-delete-section-modal"
                                                            data-bs-toggle="modal" data-bs-target="#deleteSectionModal"
                                                            data-form-action="{{ route('data-entry.sections.destroy', $section->id) }}"
                                                            data-section-info="Section #{{ $section->section_number }} (Practical) for {{ $subject->subject_no }}">Delete</button>
                                                    </td>
                                                </tr>
                                            @endforeach
                                        </tbody>
                                    </table>
                                </div>
                                {{-- *** نهاية الجدول المدمج *** --}}
                            @else
                                <p class="text-muted text-center p-3 mb-0">No practical sections defined.</p>
                            @endif
                        </div>
                    </div>
                @endif
            @endif

            {{-- تضمين ملف المودالات الموحد (ملف واحد للمودالات) --}}
            @include('dashboard.data-entry.sections.partials._sections_modals')

        </div>
    </div>
@endsection

@push('scripts')
    {{-- نفس كود JavaScript من الردود السابقة للتعامل مع المودالات الثلاثة الموحدة --}}
    {{-- مع التأكيد على استهداف الـ IDs الصحيحة للمودالات والفورمات --}}
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            console.log('Manage Sections Page: Scripts Ready.');

            const addModal = $('#addSectionModal'); // ID مودال الإضافة من الـ partial
            const editModal = $('#editSectionModal'); // ID مودال التعديل من الـ partial
            const deleteModal = $('#deleteSectionModal'); // ID مودال الحذف من الـ partial

            // --- Add Modal ---
            $(document).on('click', '.open-add-section-modal', function() {
                const button = $(this);
                addModal.find('.modal-title').text('Add ' + button.data('activity-type') +
                    ' Section for: ' + button.data('subject-name-modal'));
                addModal.find('form').attr('action', "{{ route('data-entry.sections.store') }}");

                addModal.find('input[name="plan_subject_id"]').val(button.data('plan-subject-id'));
                addModal.find('input[name="activity_type"]').val(button.data('activity-type'));
                addModal.find('input[name="academic_year"]').val(button.data('academic-year'));
                addModal.find('input[name="semester"]').val(button.data('semester'));
                addModal.find('input[name="branch"]').val(button.data('branch') || '');
                addModal.find('#add_branch_display').val(button.data('branch') || 'Default');


                addModal.find('#add_section_number_input').val('1'); // استخدام ID الحقل من المودال
                addModal.find('#add_student_count_input').val('0'); // استخدام ID الحقل من المودال
                addModal.find('#add_section_gender_select').val('Mixed'); // استخدام ID الحقل من المودال
                addModal.find('.is-invalid').removeClass('is-invalid');
                addModal.find('.invalid-feedback').text('');
                addModal.find('.alert-danger.validation-errors').remove();
                // تأكد من أن Bootstrap Modal مهيأ بشكل صحيح قبل استدعاء show
                var modalInstance = bootstrap.Modal.getInstance(addModal[0]);
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(addModal[0]);
                }
                modalInstance.show();
            });

            // --- Edit Modal ---
            // $(document).on('click', '.open-edit-section-modal', function() {
            //     const button = $(this);
            //     editModal.find('.modal-title').text('Edit Section (' + button.data('context-info') + ')');
            //     editModal.find('form').attr('action', button.data('form-action'));
            //     editModal.find('#edit_context_info_display span').text(button.data('context-info')); // استخدام ID الـ span

            //     editModal.find('#edit_section_number_input').val(button.data('section-number'));
            //     editModal.find('#edit_student_count_input').val(button.data('student-count'));
            //     editModal.find('#edit_section_gender_select').val(button.data('section-gender'));
            //     editModal.find('#edit_branch_display_input').val(button.data('branch') || 'Default');


            //     editModal.find('.is-invalid').removeClass('is-invalid');
            //     editModal.find('.invalid-feedback').text('');
            //     editModal.find('.alert-danger.validation-errors').remove();
            //     var modalInstance = bootstrap.Modal.getInstance(editModal[0]);
            //     if (!modalInstance) { modalInstance = new bootstrap.Modal(editModal[0]); }
            //     modalInstance.show();
            // });
            // --- Edit Modal ---
            // --- Edit Modal ---
            $(document).on('click', '.open-edit-section-modal', function() {
                const button = $(this);
                const editModal = $('#editSectionModal');

                // تعبئة بيانات النموذج
                editModal.find('.modal-title').text('Edit Section (' + button.data('context-info') + ')');
                editModal.find('form').attr('action', button.data('form-action'));
                editModal.find('#edit_context_info_text span').text(button.data('context-info'));

                // تعبئة الحقول من data attributes
                editModal.find('#edit_section_number').val(button.data('section-number'));
                editModal.find('#edit_student_count').val(button.data('student-count'));
                editModal.find('#edit_section_gender').val(button.data('section-gender'));
                editModal.find('#edit_branch_display').val(button.data('branch') || 'Default');

                // مسح الأخطاء السابقة
                editModal.find('.is-invalid').removeClass('is-invalid');
                editModal.find('.invalid-feedback').text('');
                editModal.find('.validation-errors').remove();

                editModal.modal('show');
            });

            // إعادة فتح المودال عند وجود أخطاء
            @if (session('editSectionId') && ($errors->hasBag('editSectionModal_' . session('editSectionId')) || $errors->any()))
                $(document).ready(function() {
                    const editModal = $('#editSectionModal');
                    const sectionId = "{{ session('editSectionId') }}";

                    // الحصول على زر التعديل المناسب
                    const editButton = $(`.open-edit-section-modal[data-form-action*="/${sectionId}"]`);

                    if (editButton.length) {
                        // تعبئة البيانات من الزر
                        editModal.find('.modal-title').text('Edit Section (' + editButton.data(
                            'context-info') + ')');
                        editModal.find('form').attr('action', editButton.data('form-action'));
                        editModal.find('#edit_context_info_text span').text(editButton.data(
                        'context-info'));

                        // تعبئة الحقول من old() أو من البيانات الأصلية
                        editModal.find('#edit_section_number').val(
                            "{{ old('section_number', session('sectionForModal')->section_number ?? '') }}"
                            );
                        editModal.find('#edit_student_count').val(
                            "{{ old('student_count', session('sectionForModal')->student_count ?? '') }}"
                            );
                        editModal.find('#edit_section_gender').val(
                            "{{ old('section_gender', session('sectionForModal')->section_gender ?? '') }}"
                            );
                        editModal.find('#edit_branch_display').val(editButton.data('branch') || 'Default');

                        editModal.modal('show');
                    }
                });
            @endif

            // --- Delete Modal ---
            $(document).on('click', '.open-delete-section-modal', function() {
                const button = $(this);
                deleteModal.find('#delete_section_info_text').text(button.data(
                    'section-info')); // استخدام ID الـ strong
                deleteModal.find('form').attr('action', button.data('form-action'));
                var modalInstance = bootstrap.Modal.getInstance(deleteModal[0]);
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(deleteModal[0]);
                }
                modalInstance.show();
            });

            // لإعادة فتح المودال عند وجود أخطاء validation
            @if ($errors->any())
                @if ($errors->hasBag('addSectionModal'))
                    console.log("Reopening Add Modal due to validation errors (Bag: addSectionModal).");
                    var addModalInstance = bootstrap.Modal.getInstance(document.getElementById('addSectionModal'));
                    if (!addModalInstance) {
                        addModalInstance = new bootstrap.Modal(document.getElementById('addSectionModal'));
                    }
                    addModalInstance.show();
                @endif
                {{-- هذا الجزء يحتاج لتحديد دقيق لمودال التعديل إذا كان هناك أخطاء --}}
                @php
                    $editErrorBagName = null;
                    foreach ($errors->getBags() as $bagNameKey => $bagErrors) {
                        if (Str::startsWith($bagNameKey, 'editSectionModal_')) {
                            // اسم الـ error bag من الكنترولر
                            $editErrorBagName = $bagNameKey;
                            break;
                        }
                    }
                @endphp
                @if ($editErrorBagName)
                    console.warn(
                        "Validation errors on update modal. ErrorBag: {{ $editErrorBagName }}. Reopening generic edit modal."
                    );
                    var editModalInstance = bootstrap.Modal.getInstance(document.getElementById(
                        'editSectionModal'));
                    if (!editModalInstance) {
                        editModalInstance = new bootstrap.Modal(document.getElementById('editSectionModal'));
                    }
                    editModalInstance.show();
                    // قد تحتاج لإعادة ملء حقول مودال التعديل بالـ old() input هنا
                    $('#editSectionModal').find('#edit_section_number_input').val("{{ old('section_number') }}");
                    $('#editSectionModal').find('#edit_student_count_input').val("{{ old('student_count') }}");
                    // ...
                @endif
            @endif
        });
    </script>
@endpush
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\instructors.blade.php
@extends('dashboard.layout')
{{-- ... (push styles if needed) ... --}}
@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="data-entry-header mb-0">Manage Instructors</h1>
                <div class="d-flex">
                    <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addInstructorModal">
                        <i class="fas fa-plus me-1"></i> Add New Instructor
                    </button>
                    {{-- *** زر رفع ملف الإكسل الجديد *** --}}
                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#importInstructorsModal">
                        <i class="fas fa-file-excel me-1"></i> Import from Excel
                    </button>
                </div>
            </div>
            @include('dashboard.data-entry.partials._status_messages')
            @if (session('skipped_details') && count(session('skipped_details')) > 0)
                <div class="alert alert-warning mt-3">
                    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Import Process: Skipped Rows Details
                    </h5>
                    <ul class="mb-0 small"
                        style="max-height: 200px; overflow-y: auto; list-style-type: none; padding-left:0;">
                        @foreach (session('skipped_details') as $detail)
                            <li><i class="fas fa-times-circle text-danger me-1"></i> {{ $detail }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Emp. No</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Degree</th>
                                    <th>Department</th>
                                    <th>Max Hours</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @forelse ($instructors as $index => $instructor)
                                    <tr>
                                        <td>{{ $instructors->firstItem() + $index }}</td>
                                        <td>{{ $instructor->instructor_no }}</td>
                                        <td>{{ $instructor->instructor_name ?? optional($instructor->user)->name }}</td>
                                        <td>{{ optional($instructor->user)->email ?? 'N/A' }}</td>
                                        <td>{{ $instructor->academic_degree ?? '-' }}</td>
                                        <td>{{ optional($instructor->department)->department_name ?? 'N/A' }}</td>
                                        <td>{{ $instructor->max_weekly_hours ?? '-' }}</td>
                                        <td>
                                            <button
                                                class="btn btn-sm btn-outline-primary py-0 px-1 me-1 open-edit-instructor-modal"
                                                data-bs-toggle="modal" data-bs-target="#editInstructorModal"
                                                data-instructor-id="{{ $instructor->id }}"
                                                data-action="{{ route('data-entry.instructors.update', $instructor->id) }}"
                                                data-instructor='@json($instructor->load('user'))' {{-- تمرير بيانات المدرس واليوزر كـ JSON --}}
                                                data-departments='@json($departments)'
                                                data-roles='@json($instructorRoles)'>
                                                Edit
                                            </button>
                                            <button
                                                class="btn btn-sm btn-outline-danger py-0 px-1 open-delete-instructor-modal"
                                                data-bs-toggle="modal" data-bs-target="#deleteInstructorModal"
                                                data-action="{{ route('data-entry.instructors.destroy', $instructor->id) }}"
                                                data-instructor-name="{{ $instructor->instructor_name ?? optional($instructor->user)->name }}">
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                @empty
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">No instructors found.</td>
                                    </tr>
                                @endforelse
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 d-flex justify-content-center"> {{ $instructors->links('pagination::bootstrap-5') }} </div>
                </div>
            </div>

            {{-- تضمين ملف المودالات --}}
            @include('dashboard.data-entry.partials._instructor_modals', [
                'instructor_for_edit' => null, // لا نحتاجه للمودال العام
                'departments' => $departments, // تمرير الأقسام لمودال الإضافة/التعديل
                'instructorRoles' => $instructorRoles, // تمرير الأدوار لمودال الإضافة/التعديل
            ])
        </div>
    </div>
@endsection

@push('scripts')
    {{-- JavaScript لتعبئة مودال التعديل وإعادة الفتح عند الخطأ --}}
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            // --- Add Modal ---
            $('#addInstructorModal').on('show.bs.modal', function() {
                // مسح الأخطاء والقيم القديمة
                $(this).find('form')[0].reset(); // إعادة تعيين الفورم
                $(this).find('.is-invalid').removeClass('is-invalid');
                $(this).find('.invalid-feedback').text('');
                $(this).find('.alert-danger.validation-errors-container').html('');
            });

            // --- Edit Modal ---
            const editModal = $('#editInstructorModal');
            $(document).on('click', '.open-edit-instructor-modal', function() {
                const button = $(this);
                const instructorData = button.data('instructor'); // بيانات المدرس واليوزر
                const departmentsData = button.data('departments');
                const rolesData = button.data('roles');

                editModal.find('form').attr('action', button.data('action'));
                editModal.find('.modal-title').text('Edit Instructor: ' + (instructorData.instructor_name ||
                    instructorData.user.name));

                // تعبئة حقول اليوزر
                editModal.find('input[name="name"]').val(instructorData.user.name);
                editModal.find('input[name="email"]').val(instructorData.user.email);
                // Role (تحديد الخيار الصحيح)
                const roleSelectEdit = editModal.find('select[name="role_id_for_instructor"]');
                roleSelectEdit.empty().append($('<option>', {
                    value: '',
                    text: 'Select role...',
                    disabled: true
                }));
                $.each(rolesData, function(key, role) {
                    roleSelectEdit.append($('<option>', {
                        value: role.id,
                        text: role.display_name,
                        selected: role.id == instructorData.user.role_id
                    }));
                });


                // تعبئة حقول المدرس
                editModal.find('input[name="instructor_no"]').val(instructorData.instructor_no);
                editModal.find('input[name="academic_degree"]').val(instructorData.academic_degree || '');
                // Department (تحديد الخيار الصحيح)
                const deptSelectEdit = editModal.find('select[name="department_id"]');
                deptSelectEdit.empty().append($('<option>', {
                    value: '',
                    text: 'Select department...',
                    disabled: true
                }));
                $.each(departmentsData, function(key, dept) {
                    deptSelectEdit.append($('<option>', {
                        value: dept.id,
                        text: dept.department_name,
                        selected: dept.id == instructorData.department_id
                    }));
                });

                editModal.find('input[name="max_weekly_hours"]').val(instructorData.max_weekly_hours || '');
                editModal.find('input[name="office_location"]').val(instructorData.office_location || '');
                editModal.find('input[name="office_hours"]').val(instructorData.office_hours || '');
                editModal.find('textarea[name="availability_preferences"]').val(instructorData
                    .availability_preferences || '');

                editModal.find('.is-invalid').removeClass('is-invalid');
                editModal.find('.invalid-feedback').text('');
                editModal.find('.alert-danger.validation-errors-container').html('');
                editModal.modal('show');
            });

            // --- Delete Modal ---
            const deleteModal = $('#deleteInstructorModal');
            $(document).on('click', '.open-delete-instructor-modal', function() {
                const button = $(this);
                deleteModal.find('form').attr('action', button.data('action'));
                deleteModal.find('#deleteInstructorName').text(button.data('instructor-name'));
                deleteModal.modal('show');
            });

            // --- لإعادة فتح المودال عند وجود أخطاء validation ---
            @if ($errors->any())
                @if ($errors->hasBag('addInstructorModal'))
                    $('#addInstructorModal').modal('show');
                @endif
                @php
                    $editErrorBagName = null;
                    $editingInstructorIdOnError = session('error_instructor_id_on_edit'); // ID من الكنترولر
                    if ($editingInstructorIdOnError) {
                        $editErrorBagName = 'editInstructorModal_' . $editingInstructorIdOnError;
                    }
                @endphp
                @if ($editErrorBagName && $errors->hasBag($editErrorBagName))
                    console.warn(
                        "Reopening edit modal for instructor due to validation errors. Bag: {{ $editErrorBagName }}"
                    );
                    // هنا نحتاج لإعادة فتح المودال مع البيانات القديمة.
                    // الـ JavaScript الحالي سيعبئ بالبيانات من الزر، ليس بالـ old()
                    // هذا يتطلب إما:
                    // 1. أن يقوم الـ Blade في المودال بعرض old() إذا كان الخطأ من هذا المودال.
                    // 2. أو أن الـ JS يجلب بيانات الـ old() ويعبئها.
                    // للتبسيط، سنفتح المودال فقط، والمستخدم قد يحتاج لإعادة إدخال بعض البيانات.
                    $('#editInstructorModal').modal('show');
                    // ملء حقول مودال التعديل بالـ old() input
                    $('#editInstructorModal').find('input[name="name"]').val("{{ old('name') }}");
                    $('#editInstructorModal').find('input[name="email"]').val("{{ old('email') }}");
                    $('#editInstructorModal').find('select[name="role_id_for_instructor"]').val(
                        "{{ old('role_id_for_instructor') }}");
                    $('#editInstructorModal').find('input[name="instructor_no"]').val(
                        "{{ old('instructor_no') }}");
                    // ... أكمل باقي الحقول
                @endif
            @endif
        });
    </script>
@endpush
----------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_instructor_modals.blade.php
{{-- ======================================= --}}
{{-- مودال إضافة مدرس جديد --}}
{{-- ======================================= --}}
<div class="modal fade" id="addInstructorModal" tabindex="-1" aria-labelledby="addInstructorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addInstructorModalLabel">Add New Instructor & User Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addInstructorForm" action="{{ route('data-entry.instructors.store') }}" method="POST">
                @csrf
                <div class="modal-body">
                    {{-- عرض أخطاء الـ validation --}}
                    @if ($errors->hasBag('addInstructorModal'))
                        <div class="alert alert-danger small p-2 mb-3 validation-errors-container">
                            <strong>Please correct the errors:</strong>
                            <ul class="mb-0 ps-3">
                                @foreach ($errors->getBag('addInstructorModal')->all() as $error)
                                    <li>{{ $error }}</li>
                                @endforeach
                            </ul>
                        </div>
                    @endif

                    <h6>User Account Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-1">
                            <label for="add_user_name" class="form-label">Full Name <span
                                    class="text-danger">*</span></label>
                            <input type="text"
                                class="form-control @error('name', 'addInstructorModal') is-invalid @enderror"
                                id="add_user_name" name="name" value="{{ old('name') }}" required>
                            @error('name', 'addInstructorModal')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="col-md-6 mb-1">
                            <label for="add_user_email" class="form-label">Email Address <span
                                    class="text-danger">*</span></label>
                            <input type="email"
                                class="form-control @error('email', 'addInstructorModal') is-invalid @enderror"
                                id="add_user_email" name="email" value="{{ old('email') }}" required>
                            @error('email', 'addInstructorModal')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-1">
                            <label for="add_user_password" class="form-label">Password <span
                                    class="text-danger">*</span></label>
                            <input type="password"
                                class="form-control @error('password', 'addInstructorModal') is-invalid @enderror"
                                id="add_user_password" name="password" required>
                            @error('password', 'addInstructorModal')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="col-md-6 mb-1">
                            <label for="add_user_password_confirmation" class="form-label">Confirm Password <span
                                    class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="add_user_password_confirmation"
                                name="password_confirmation" required>
                        </div>
                    </div>
                    <div class="mb-1">
                        <label for="add_role_id_for_instructor" class="form-label">Assign Role <span
                                class="text-danger">*</span></label>
                        <select
                            class="form-select @error('role_id_for_instructor', 'addInstructorModal') is-invalid @enderror"
                            id="add_role_id_for_instructor" name="role_id_for_instructor" required>
                            <option value="" selected disabled>Select role...</option>
                            @foreach ($instructorRoles as $role)
                                {{-- $instructorRoles من الكنترولر --}}
                                <option value="{{ $role->id }}"
                                    {{ old('role_id_for_instructor') == $role->id ? 'selected' : '' }}>
                                    {{ $role->display_name }}</option>
                            @endforeach
                        </select>
                        @error('role_id_for_instructor', 'addInstructorModal')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>

                    <hr class="my-4">
                    <h6>Instructor Specific Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-1">
                            <label for="add_instructor_no" class="form-label">Employee Number <span
                                    class="text-danger">*</span></label>
                            <input type="text"
                                class="form-control @error('instructor_no', 'addInstructorModal') is-invalid @enderror"
                                id="add_instructor_no" name="instructor_no" value="{{ old('instructor_no') }}"
                                required>
                            @error('instructor_no', 'addInstructorModal')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="col-md-6 mb-1">
                            <label for="add_academic_degree" class="form-label">Academic Degree</label>
                            <input type="text"
                                class="form-control @error('academic_degree', 'addInstructorModal') is-invalid @enderror"
                                id="add_academic_degree" name="academic_degree" value="{{ old('academic_degree') }}">
                            @error('academic_degree', 'addInstructorModal')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-1">
                            <label for="add_department_id_instructor" class="form-label">Department <span
                                    class="text-danger">*</span></label>
                            <select
                                class="form-select @error('department_id', 'addInstructorModal') is-invalid @enderror"
                                id="add_department_id_instructor" name="department_id" required>
                                <option value="" selected disabled>Select department...</option>
                                @foreach ($departments as $dept)
                                    {{-- $departments من الكنترولر --}}
                                    <option value="{{ $dept->id }}"
                                        {{ old('department_id') == $dept->id ? 'selected' : '' }}>
                                        {{ $dept->department_name }}</option>
                                @endforeach
                            </select>
                            @error('department_id', 'addInstructorModal')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="col-md-6 mb-1">
                            <label for="add_max_weekly_hours" class="form-label">Max Weekly Hours</label>
                            <input type="number"
                                class="form-control @error('max_weekly_hours', 'addInstructorModal') is-invalid @enderror"
                                id="add_max_weekly_hours" name="max_weekly_hours"
                                value="{{ old('max_weekly_hours') }}" min="0">
                            @error('max_weekly_hours', 'addInstructorModal')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>
                    {{-- <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_office_location" class="form-label">Office Location</label>
                            <input type="text" class="form-control @error('office_location', 'addInstructorModal') is-invalid @enderror" id="add_office_location" name="office_location" value="{{ old('office_location') }}">
                            @error('office_location', 'addInstructorModal') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_office_hours" class="form-label">Office Hours</label>
                            <input type="text" class="form-control @error('office_hours', 'addInstructorModal') is-invalid @enderror" id="add_office_hours" name="office_hours" value="{{ old('office_hours') }}">
                            @error('office_hours', 'addInstructorModal') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div> --}}
                    <div class="mb-3">
                        <label for="add_availability_preferences" class="form-label">Availability Preferences</label>
                        <textarea class="form-control @error('availability_preferences', 'addInstructorModal') is-invalid @enderror"
                            id="add_availability_preferences" name="availability_preferences" rows="2">{{ old('availability_preferences') }}</textarea>
                        @error('availability_preferences', 'addInstructorModal')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Instructor</button>
                </div>
            </form>
        </div>
    </div>
</div>


{{-- ======================================= --}}
{{-- مودال تعديل مدرس --}}
{{-- ======================================= --}}
<div class="modal fade" id="editInstructorModal" tabindex="-1" aria-labelledby="editInstructorModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editInstructorModalLabel">Edit Instructor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editInstructorForm" action="#" method="POST"> {{-- Action يتغير بـ JS --}}
                @csrf
                @method('PUT')
                <div class="modal-body">
                    {{-- لعرض أخطاء الـ validation --}}
                    @if ($errors->any() && session('error_instructor_id_on_edit'))
                        @php $currentErrorBagName = 'editInstructorModal_' . session('error_instructor_id_on_edit'); @endphp
                        @if ($errors->hasBag($currentErrorBagName))
                            <div class="alert alert-danger small p-2 mb-3 validation-errors-container">
                                <strong>Please correct the errors:</strong>
                                <ul class="mb-0 ps-3">
                                    @foreach ($errors->getBag($currentErrorBagName)->all() as $error)
                                        <li>{{ $error }}</li>
                                    @endforeach
                                </ul>
                            </div>
                        @endif
                    @endif

                    <h6>User Account Information</h6>
                    {{-- حقول اليوزر (مع old() input) --}}
                    <div class="row">
                        <div class="col-md-6 mb-1">
                            <label for="edit_user_name" class="form-label">Full Name <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_user_name" name="name"
                                value="{{ old('name') }}" required>
                        </div>
                        <div class="col-md-6 mb-1">
                            <label for="edit_user_email" class="form-label">Email Address <span
                                    class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="edit_user_email" name="email"
                                value="{{ old('email') }}" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-1">
                            <label for="edit_user_password" class="form-label">New Password (leave blank to keep
                                current)</label>
                            <input type="password" class="form-control" id="edit_user_password" name="password"
                                value="">
                        </div>
                        <div class="col-md-6 mb-1">
                            <label for="edit_user_password_confirmation" class="form-label">Confirm New
                                Password</label>
                            <input type="password" class="form-control" id="edit_user_password_confirmation"
                                name="password_confirmation">
                        </div>
                    </div>
                    <div class="mb-1">
                        <label for="edit_role_id_for_instructor" class="form-label">Assign Role <span
                                class="text-danger">*</span></label>
                        <select class="form-select" id="edit_role_id_for_instructor" name="role_id_for_instructor"
                            required>
                            <option value="" disabled>Select role...</option>
                            {{-- $instructorRoles يتم تمريرها من الكنترولر --}}
                            @foreach ($instructorRoles as $role)
                                <option value="{{ $role->id }}">{{ $role->display_name }}</option>
                            @endforeach
                        </select>
                    </div>

                    <hr class="my-4">
                    <h6>Instructor Specific Information</h6>
                    {{-- حقول المدرس (مع old() input) --}}
                    <div class="row">
                        <div class="col-md-6 mb-1">
                            <label for="edit_instructor_no" class="form-label">Employee Number <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_instructor_no" name="instructor_no"
                                value="{{ old('instructor_no') }}" required>
                        </div>
                        <div class="col-md-6 mb-1">
                            <label for="edit_academic_degree" class="form-label">Academic Degree</label>
                            <input type="text" class="form-control" id="edit_academic_degree"
                                name="academic_degree" value="{{ old('academic_degree') }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-1">
                            <label for="edit_department_id_instructor" class="form-label">Department <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="edit_department_id_instructor" name="department_id"
                                required>
                                <option value="" disabled>Select department...</option>
                                {{-- $departments يتم تمريرها من الكنترولر --}}
                                @foreach ($departments as $dept)
                                    <option value="{{ $dept->id }}">{{ $dept->department_name }}</option>
                                @endforeach
                            </select>
                        </div>
                        <div class="col-md-6 mb-1">
                            <label for="edit_max_weekly_hours" class="form-label">Max Weekly Hours</label>
                            <input type="number" class="form-control" id="edit_max_weekly_hours"
                                name="max_weekly_hours" value="{{ old('max_weekly_hours') }}" min="0">
                        </div>
                    </div>
                    <div class="mb-1">
                        <label for="add_availability_preferences" class="form-label">Availability Preferences</label>
                        <textarea class="form-control @error('availability_preferences', 'addInstructorModal') is-invalid @enderror"
                            id="add_availability_preferences" name="availability_preferences" rows="2">{{ old('availability_preferences') }}</textarea>
                        @error('availability_preferences', 'addInstructorModal')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    {{-- ... باقي حقول المدرس (office_location, office_hours, availability_preferences) بنفس الطريقة ... --}}

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Instructor</button>
                </div>
            </form>
        </div>
    </div>
</div>


{{-- ======================================= --}}
{{-- مودال حذف مدرس --}}
{{-- ======================================= --}}
<div class="modal fade" id="deleteInstructorModal" tabindex="-1" aria-labelledby="deleteInstructorModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteInstructorModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form id="deleteInstructorForm" action="#" method="POST"> {{-- Action يتغير بـ JS --}}
                @csrf
                @method('DELETE')
                <div class="modal-body">
                    <p>Are you sure you want to delete the instructor <strong id="deleteInstructorName">this
                            instructor</strong> and their associated user account?</p>
                    <p class="text-danger small">This action cannot be undone and will also delete the user login.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Yes, Delete Instructor & User</button>
                </div>
            </form>
        </div>
    </div>
</div>


{{-- *** مودال رفع ملف الإكسل للمدرسين *** --}}
<div class="modal fade" id="importInstructorsModal" tabindex="-1" aria-labelledby="importInstructorsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importInstructorsModalLabel">Import Instructors from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.instructors.importExcel') }}" method="POST"
                enctype="multipart/form-data">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="instructor_excel_file_input" class="form-label">Select Excel File <span
                                class="text-danger">*</span></label>
                        <input class="form-control @error('instructor_excel_file') is-invalid @enderror"
                            type="file" id="instructor_excel_file_input" name="instructor_excel_file"
                            accept=".xlsx, .xls, .csv" required>
                        @error('instructor_excel_file')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="alert alert-info small p-2">
                        <strong>File Format Instructions:</strong><br>
                        - First row should be headers (e.g., <code>instructor_no</code>, <code>instructor_name</code>,
                        <code>department_id</code>, <code>email</code>, <code>academic_degree</code>,
                        <code>max_weekly_hours</code>).<br>
                        - <code>instructor_no</code>, <code>instructor_name</code>, <code>department_id</code> are
                        highly recommended.<br>
                        - <code>email</code> is optional (will be generated if missing). <code>academic_degree</code>
                        can be in name or its column.<br>
                        - For <code>department_id</code>, you can use Department ID, Name, or Code.<br>
                        - If <code>instructor_no</code> exists, record will be updated. Otherwise, a new instructor and
                        user will be created.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-1"></i> Upload and Process File
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\instructor-section.blade.php
@extends('dashboard.layout')

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="data-entry-header mb-0">Instructor Subject Assignments</h1>
                {{-- يمكن إضافة زر لإضافة مدرس جديد إذا أردت --}}
                <div class="d-flex">
                    {{-- *** زر توليد الشعب الناقصة *** --}}
                    <form action="{{ route('data-entry.instructor-load.generateMissingSections') }}" method="POST"
                        class="d-inline me-2">
                        @csrf
                        {{-- يمكنك إضافة فلاتر هنا إذا أردت تحديد سنة وفصل معين للتوليد --}}
                        <button type="submit" class="btn btn-info btn-sm"
                            onclick="return confirm('This will generate sections for any plan context that has expected students but no sections yet. Continue?');">
                            <i class="fas fa-magic me-1"></i> Generate Missing Sections
                        </button>
                    </form>

                    {{-- *** زر رفع ملف الإكسل لتوزيع الأحمال *** --}}
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal"
                        data-bs-target="#importInstructorLoadsModal">
                        <i class="fas fa-file-excel me-1"></i> Import Instructor Loads
                    </button>
                </div>
                {{-- <a href="{{ route('data-entry.instructors.index') }}" class="btn btn-outline-primary">Manage Instructors</a> --}}
            </div>

            @include('dashboard.data-entry.partials._status_messages')
            @if (session('skipped_details') && count(session('skipped_details')) > 0)
                <div class="alert alert-warning mt-3">
                    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Import Skipped Rows:</h5>
                    <ul class="mb-0 small" style="max-height: 200px; overflow-y: auto;">
                        @foreach (session('skipped_details') as $detail)
                            <li>{{ $detail }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif

            {{-- TODO: Add Filters (by Department) --}}

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Instructor No</th>
                                    <th scope="col">Instructor Name</th>
                                    <th scope="col">Department</th>
                                    <th scope="col">Assigned Subjects Count</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @forelse ($instructors as $index => $instructor)
                                    <tr>
                                        <td>{{ $instructors->firstItem() + $index }}</td>
                                        <td>{{ $instructor->instructor_no }}</td>
                                        <td>{{ $instructor->instructor_name ?? optional($instructor->user)->name }}</td>
                                        <td>{{ optional($instructor->department)->department_name ?? 'N/A' }}</td>
                                        <td>
                                            {{-- عرض عدد المواد المعينة --}}
                                            <span class="badge bg-info">{{ $instructor->sections_count }}</span>
                                            {{-- يمكنك إضافة tooltip لعرض أسماء المواد إذا كان العدد قليلاً --}}
                                        </td>
                                        <td>
                                            {{-- زر للانتقال لصفحة تعديل التعيينات --}}
                                            <a href="{{ route('data-entry.instructor-section.edit', $instructor->id) }}"
                                                class="btn btn-sm btn-outline-primary" title="Edit Section Assignments">
                                                <i class="fas fa-edit me-1"></i> Edit Assignments
                                            </a>
                                        </td>
                                    </tr>
                                @empty
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">No instructors found.</td>
                                    </tr>
                                @endforelse
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 d-flex justify-content-center">
                        {{ $instructors->links('pagination::bootstrap-5') }}
                    </div>
                </div>
            </div>

        </div>
    </div>
@endsection


{{-- *** مودال رفع ملف الإكسل لتوزيع الأحمال *** --}}
<div class="modal fade" id="importInstructorLoadsModal" tabindex="-1" aria-labelledby="importInstructorLoadsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importInstructorLoadsModalLabel">Import Instructor Loads from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.instructor-load.importExcel') }}" method="POST"
                enctype="multipart/form-data">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="target_semester_import" class="form-label">Target Semester <span
                                class="text-danger">*</span></label>
                        <select class="form-select @error('target_semester') is-invalid @enderror"
                            id="target_semester_import" name="target_semester" required>
                            <option value="" selected disabled>Select semester...</option>
                            <option value="1" {{ old('target_semester') == '1' ? 'selected' : '' }}>First Semester
                            </option>
                            <option value="2" {{ old('target_semester') == '2' ? 'selected' : '' }}>Second
                                Semester</option>
                            <option value="3" {{ old('target_semester') == '3' ? 'selected' : '' }}>Summer
                                Semester</option>
                        </select>
                        @error('target_semester')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>

                    {{-- <div class="mb-3">
                        <label for="target_academic_year_import" class="form-label">Target academic year<span
                                class="text-danger">*</span></label>
                        <select class="form-select @error('target_academic_year') is-invalid @enderror"
                            id="target_academic_year_import" name="target_academic_year" required>
                            <option value="" selected disabled>Select semester...</option>
                            <option value="2025" {{ old('target_academic_year') == '2025' ? 'selected' : '' }}>First Semester
                            </option>
                            <option value="2" {{ old('target_academic_year') == '2' ? 'selected' : '' }}>Second
                                Semester</option>
                            <option value="3" {{ old('target_academic_year') == '3' ? 'selected' : '' }}>Summer
                                Semester</option>
                        </select>
                        @error('target_academic_year')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div> --}}
                    {{-- (اختياري) يمكنك إضافة حقل لاختيار السنة الأكاديمية المستهدفة هنا --}}
                    {{-- <input type="number" name="target_academic_year" placeholder="YYYY"> --}}

                    <div class="mb-3">
                        <label for="instructor_loads_excel_file_input" class="form-label">Select Excel File <span
                                class="text-danger">*</span></label>
                        <input class="form-control @error('instructor_loads_excel_file') is-invalid @enderror"
                            type="file" id="instructor_loads_excel_file_input" name="instructor_loads_excel_file"
                            accept=".xlsx, .xls, .csv" required>
                        @error('instructor_loads_excel_file')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="alert alert-info small p-2">
                        <strong>File Format Instructions:</strong><br>
                        - Headers: اسم المدرس, اسم المساق, التخصص والمستوى, عدد الشعب نظري, عدد الشعب عملي, الفرع.<br>
                        - Ensure "التخصص والمستوى" is like "CSE2" (Code + Level Number).<br>
                        - The system will assign available sections to the instructor based on counts, branch, and the
                        selected Target Semester.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-1"></i> Upload and Assign Loads
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
-------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\instructor-section-edit.blade.php
@extends('dashboard.layout')

@push('styles')
    <style>
        .subject-assignment-container {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: .25rem;
            background-color: #f9f9f9;
        }

        .subject-assignment-container h5 {
            border-bottom: 1px solid #ddd;
            padding-bottom: .5rem;
            margin-bottom: .75rem;
            font-size: 1.1rem;
        }

        .section-list {
            list-style: none;
            padding-left: 0;
        }

        .section-list li {
            margin-bottom: .25rem;
            display: flex;
            align-items: center;
        }

        .section-list .form-check-input {
            margin-top: .1em;
            margin-right: .5em;
        }

        /* RTL: margin-left */
        .section-info {
            font-size: 0.85rem;
            color: #6c757d;
            margin-left: auto;
            /* Push to the right */
        }

        .section-list .form-check-label {
            cursor: pointer;
        }

        #subjectSearch {
            margin-bottom: 1rem;
        }
    </style>
@endpush

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="data-entry-header mb-1">Assign Sections to Instructor</h1>
                    <h2 class="h5 text-muted">Instructor: <span
                            class="text-primary">{{ $instructor->instructor_name ?? optional($instructor->user)->name }}</span>
                        ({{ $instructor->instructor_no }})</h2>
                    <p class="mb-0 text-secondary small">Department:
                        {{ optional($instructor->department)->department_name ?? 'N/A' }}</p>
                </div>
                <a href="{{ route('data-entry.instructor-section.index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Back to Instructors List
                </a>
            </div>

            @include('dashboard.data-entry.partials._status_messages')

            <form action="{{ route('data-entry.instructor-section.sync', $instructor->id) }}" method="POST">
                @csrf
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Select Subjects and Their Sections</h5>
                    </div>
                    <div class="card-body">
                        {{-- حقل البحث عن المواد --}}
                        <div class="mb-3">
                            <input type="text" id="subjectSearch" class="form-control form-control-sm"
                                placeholder="Search subjects by name or code...">
                        </div>

                        {{-- <div id="subjectsListContainer" style="max-height: 70vh; overflow-y: auto; padding-right: 5px;">
                        @php $displayedSubjectsCount = 0; @endphp
                        @forelse ($allSubjectsWithSections as $subject)
                            @php
                                // فلترة الشعب المتاحة (التي لم يأخذها مدرس آخر أو أخذها المدرس الحالي)
                                $availableSectionsForThisSubject = collect();
                                if ($subject->planSubjectEntries->isNotEmpty()) {
                                    foreach($subject->planSubjectEntries as $planSubEntry) {
                                        foreach($planSubEntry->sections as $section) {
                                            // اعرض الشعبة إذا:
                                            // 1. لم يتم تعيينها لأي مدرس بعد (instructors->isEmpty())
                                            // 2. أو تم تعيينها لهذا المدرس المحدد (isAssignedToThisInstructor)
                                            $isAssignedToThisInstructor = in_array($section->id, $assignedSectionIds);
                                            $assignedToOtherInstructor = !$section->instructors->isEmpty() && !$isAssignedToThisInstructor;

                                            if (!$assignedToOtherInstructor) {
                                                $section->is_assigned_to_current = $isAssignedToThisInstructor;
                                                $section->subject_name_display = $subject->subject_name; // إضافة اسم المادة للشعبة
                                                $section->subject_no_display = $subject->subject_no;
                                                $availableSectionsForThisSubject->push($section);
                                            }
                                        }
                                    }
                                }
                            @endphp

                            {{-- إذا لم تكن هناك أي شعب متاحة لهذه المادة، لا تعرض المادة أصلاً --}}
                        {{-- @if ($availableSectionsForThisSubject->isNotEmpty())
                                @php $displayedSubjectsCount++; @endphp
                                <div class="subject-assignment-container mb-3" data-subject-name="{{ strtolower($subject->subject_name) }}" data-subject-code="{{ strtolower($subject->subject_no) }}">
                                    <h5>
                                        <div class="form-check">
                                            <input class="form-check-input subject-master-checkbox" type="checkbox" value="{{ $subject->id }}" id="subject_{{ $subject->id }}_master_checkbox">
                                            <label class="form-check-label" for="subject_{{ $subject->id }}_master_checkbox">
                                                {{ $subject->subject_no }} - {{ $subject->subject_name }}
                                                <small class="text-muted">({{ optional($subject->subjectCategory)->subject_category_name }})</small>
                                            </label>
                                        </div>
                                    </h5>
                                    <ul class="section-list ps-4"> {{-- padding start لمسافة بادئة --}}
                        {{--   @foreach ($availableSectionsForThisSubject as $section)
                                            <li>
                                                <div class="form-check">
                                                    <input class="form-check-input section-checkbox" type="checkbox"
                                                           name="section_ids[]"
                                                           value="{{ $section->id }}"
                                                           id="section_{{ $section->id }}"
                                                           data-subject-master-id="{{ $subject->id }}"
                                                           {{ $section->is_assigned_to_current ? 'checked' : '' }}>
                                                    <label class="form-check-label" for="section_{{ $section->id }}">
                                                        Section #{{ $section->section_number }} ({{ $section->activity_type }})
                                                        <span class="section-info ms-2">
                                                            - {{ $section->student_count }} students
                                                            @if ($section->instructors->isNotEmpty() && !$section->is_assigned_to_current)
                                                                {{-- هذا الشرط لن يتحقق بسبب الفلترة أعلاه، لكن نتركه للحماية --}}
                        {{--                         <span class="badge bg-warning text-dark">Assigned to: {{ $section->instructors->first()->instructor_name ?? 'Other' }}</span>
                                                            @endif
                                                        </span>
                                                    </label>
                                                </div>
                                            </li>
                                        @endforeach
                                    </ul>
                                </div>
                            @endif
                        @empty
                            <p class="text-muted">No subjects available in the system.</p>
                        @endforelse

                        @if ($displayedSubjectsCount === 0 && $allSubjectsWithSections->isNotEmpty())
                             <p class="text-muted text-center" id="noAvailableSubjectsMessage">All subjects/sections are either fully assigned or have no available sections for this instructor.</p>
                        @elseif(!$allSubjectsWithSections->isNotEmpty())
                             <p class="text-muted text-center" id="noSubjectsSystemMessage">No subjects found in the system to assign.</p>
                        @endif
                         <p class="text-muted text-center mt-2" id="noAssignmentResultsFilter" style="display: none;">No subjects/sections match your search criteria.</p>
                    </div> --}}
                        <div id="subjectsListContainer" style="max-height: 50vh; overflow-y: auto; padding-right: 5px;">
                            @php $displayedSubjectsCount = 0; @endphp
                            @forelse ($allSubjectsWithSections as $subject)
                                @php
                                    $sectionsForThisSubject = collect(); // كل شعب المادة
                                    $allSectionsAreTakenByOthers = true; // افتراض أن كل الشعب مأخوذة من آخرين
                                    $atLeastOneSectionIsAvailableOrAssignedToCurrent = false; // لتتبع إذا كانت هناك شعبة يمكن للمدرس الحالي التفاعل معها

                                    if ($subject->planSubjectEntries->isNotEmpty()) {
                                        foreach ($subject->planSubjectEntries as $planSubEntry) {
                                            foreach ($planSubEntry->sections as $section) {
                                                $isAssignedToCurrentInstructor = in_array(
                                                    $section->id,
                                                    $assignedSectionIds ?? [],
                                                );
                                                $assignedToOtherInstructor = false;
                                                $assignedInstructorName = null;

                                                if (!$section->instructors->isEmpty()) {
                                                    // إذا كانت الشعبة معينة لمدرس ما
                                                    if (!$isAssignedToCurrentInstructor) {
                                                        // معينة لمدرس آخر
                                                        $assignedToOtherInstructor = true;
                                                        $assignedInstructorName =
                                                            optional($section->instructors->first())->instructor_name ??
                                                            optional(optional($section->instructors->first())->user)
                                                                ->name;
                                                    }
                                                    // إذا كانت معينة للمدرس الحالي، isAssignedToCurrentInstructor ستكون true
                                                }

                                                // إضافة معلومات إضافية للشعبة للعرض
                                                $section->is_assigned_to_current_instructor = $isAssignedToCurrentInstructor;
                                                $section->assigned_instructor_name_for_display = $assignedToOtherInstructor
                                                    ? $assignedInstructorName
                                                    : null;
                                                $section->is_disabled_for_current_instructor = $assignedToOtherInstructor;

                                                $sectionsForThisSubject->push($section); // أضف كل شعب المادة

                                                // التحقق إذا كانت هناك شعبة واحدة على الأقل متاحة أو معينة للمدرس الحالي
                                                if (!$section->is_disabled_for_current_instructor) {
                                                    $atLeastOneSectionIsAvailableOrAssignedToCurrent = true;
                                                }
                                            }
                                        }
                                    }

                                    // **الشرط الجديد: لا تعرض المادة إذا لم يكن هناك أي شعبة متاحة أو معينة للمدرس الحالي**
                                    if (
                                        !$atLeastOneSectionIsAvailableOrAssignedToCurrent &&
                                        $sectionsForThisSubject->isNotEmpty()
                                    ) {
                                        // إذا كانت كل الشعب مأخوذة من قبل مدرسين آخرين، تخطى عرض هذه المادة
                                        continue;
                                    }
                                @endphp

                                {{-- اعرض المادة فقط إذا كان لها شعب أصلاً أو إذا كانت هناك شعب متاحة/معينة للمدرس الحالي --}}
                                @if ($sectionsForThisSubject->isNotEmpty())
                                    @php $displayedSubjectsCount++; @endphp
                                    <div class="subject-assignment-container mb-3"
                                        data-subject-name="{{ strtolower($subject->subject_name) }}"
                                        data-subject-code="{{ strtolower($subject->subject_no) }}">
                                        <h5>
                                            <div class="form-check">
                                                <input class="form-check-input subject-master-checkbox" type="checkbox"
                                                    value="{{ $subject->id }}"
                                                    id="subject_{{ $subject->id }}_master_checkbox" {{-- تعطيل الماستر إذا لم تكن هناك شعب متاحة --}}
                                                    {{ !$sectionsForThisSubject->contains(fn($sec) => !$sec->is_disabled_for_current_instructor) ? 'disabled' : '' }}>
                                                <label class="form-check-label"
                                                    for="subject_{{ $subject->id }}_master_checkbox">
                                                    {{ $subject->subject_no }} - {{ $subject->subject_name }}
                                                    <small
                                                        class="text-muted">({{ optional($subject->subjectCategory)->subject_category_name }})</small>
                                                </label>
                                            </div>
                                        </h5>
                                        <ul class="section-list ps-4">
                                            @foreach ($sectionsForThisSubject->sortBy(['activity_type', 'section_number']) as $section)
                                                <li>
                                                    <div class="form-check">
                                                        <input class="form-check-input section-checkbox" type="checkbox"
                                                            name="section_ids[]" value="{{ $section->id }}"
                                                            id="section_{{ $section->id }}"
                                                            data-subject-master-id="{{ $subject->id }}"
                                                            {{ $section->is_assigned_to_current_instructor ? 'checked' : '' }}
                                                            {{ $section->is_disabled_for_current_instructor ? 'disabled' : '' }}>
                                                        <label class="form-check-label" for="section_{{ $section->id }}"
                                                            title="{{ $section->is_disabled_for_current_instructor ? 'Assigned to: ' . $section->assigned_instructor_name_for_display : '' }}">
                                                            Section #{{ $section->section_number }}
                                                            ({{ $section->activity_type }})
                                                            <span class="section-info ms-2">
                                                                - {{ $section->student_count }} students
                                                                @if ($section->assigned_instructor_name_for_display)
                                                                    <span class="badge bg-warning text-dark ms-1">Assigned:
                                                                        {{ Str::limit($section->assigned_instructor_name_for_display, 15) }}</span>
                                                                @endif
                                                            </span>
                                                        </label>
                                                    </div>
                                                </li>
                                            @endforeach
                                            @if ($sectionsForThisSubject->isEmpty())
                                                {{-- هذا الشرط لن يتحقق الآن بسبب الفلترة أعلاه --}}
                                                <li><small class="text-muted">No sections found for this subject.</small>
                                                </li>
                                            @endif
                                        </ul>
                                    </div>
                                @endif
                            @empty
                                <p class="text-muted">No subjects available in the system.</p>
                            @endforelse

                            @if ($displayedSubjectsCount === 0 && $allSubjectsWithSections->isNotEmpty())
                                <p class="text-muted text-center" id="noAvailableSubjectsMessage">All subjects/sections are
                                    either fully assigned or have no available sections for this instructor.</p>
                            @elseif(!$allSubjectsWithSections->isNotEmpty())
                                <p class="text-muted text-center" id="noSubjectsSystemMessage">No subjects found in the
                                    system to assign.</p>
                            @endif
                            <p class="text-muted text-center mt-2" id="noAssignmentResultsFilter" style="display: none;">No
                                subjects/sections match your search criteria.</p>
                        </div>
                        @error('section_ids')
                            <div class="text-danger small mt-2">{{ $message }}</div>
                        @enderror
                    </div>
                    <div class="card-footer text-end">
                        <a href="{{ route('data-entry.instructor-section.index') }}"
                            class="btn btn-secondary me-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Save Assignments
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
@endsection

@push('scripts')
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            // --- التركيز التلقائي على حقل البحث ---
            $('#subjectSearch').focus();

            // --- البحث في قائمة المواد ---
            $('#subjectSearch').on('keyup', function() {
                const searchTerm = $(this).val().toLowerCase();
                let resultsFoundOverall = false;
                $('#subjectsListContainer .subject-assignment-container').each(function() {
                    const subjectContainer = $(this);
                    const subjectName = subjectContainer.data('subject-name');
                    const subjectCode = subjectContainer.data('subject-code');
                    let subjectMatches = false;

                    if (subjectName.includes(searchTerm) || subjectCode.includes(searchTerm)) {
                        subjectMatches = true;
                        subjectContainer.show();
                        resultsFoundOverall = true;
                    } else {
                        subjectContainer.hide();
                    }
                });
                $('#noAssignmentResultsFilter').toggle(!resultsFoundOverall);
            });

            // --- تحديد/إلغاء تحديد كل شعب المادة ---
            $(document).on('change', '.subject-master-checkbox', function() {
                const subjectId = $(this).val();
                const isChecked = $(this).is(':checked');
                // حدد فقط الـ checkboxes التابعة لهذه المادة والتي ليست disabled
                $('.section-checkbox[data-subject-master-id="' + subjectId + '"]:not(:disabled)').prop(
                    'checked', isChecked);
            });

            // --- تحديث الـ checkbox الرئيسي للمادة عند تغيير الشعب الفرعية ---
            $(document).on('change', '.section-checkbox', function() {
                const subjectId = $(this).data('subject-master-id');
                const allSectionsForSubject = $('.section-checkbox[data-subject-master-id="' + subjectId +
                    '"]:not(:disabled)');
                const checkedSectionsForSubject = $('.section-checkbox[data-subject-master-id="' +
                    subjectId + '"]:not(:disabled):checked');
                const masterCheckbox = $('#subject_' + subjectId + '_master_checkbox');

                if (checkedSectionsForSubject.length === allSectionsForSubject.length &&
                    allSectionsForSubject.length > 0) {
                    masterCheckbox.prop('checked', true);
                    masterCheckbox.prop('indeterminate', false);
                } else if (checkedSectionsForSubject.length > 0) {
                    masterCheckbox.prop('checked', false);
                    masterCheckbox.prop('indeterminate', true);
                } else {
                    masterCheckbox.prop('checked', false);
                    masterCheckbox.prop('indeterminate', false);
                }
            });

            // --- تهيئة حالة الـ checkbox الرئيسي للمادة عند تحميل الصفحة ---
            $('.subject-master-checkbox').each(function() {
                const subjectId = $(this).val();
                const allSectionsForSubject = $('.section-checkbox[data-subject-master-id="' + subjectId +
                    '"]:not(:disabled)');
                const checkedSectionsForSubject = $('.section-checkbox[data-subject-master-id="' +
                    subjectId + '"]:not(:disabled):checked');

                if (allSectionsForSubject.length > 0) { // فقط إذا كان هناك شعب متاحة
                    if (checkedSectionsForSubject.length === allSectionsForSubject.length) {
                        $(this).prop('checked', true);
                    } else if (checkedSectionsForSubject.length > 0) {
                        $(this).prop('indeterminate', true);
                    }
                } else {
                    // إذا لم تكن هناك شعب متاحة، عطل الـ checkbox الرئيسي
                    $(this).prop('disabled', true);
                }
            });

        });
    </script>
@endpush
---------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\instructor-subjects.blade.php
@extends('dashboard.layout')

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="data-entry-header mb-0">Instructor Subject Assignments</h1>
                {{-- يمكنك إضافة زر لإدارة المدرسين من هنا --}}
                <div class="d-flex">
                    <a href="{{ route('data-entry.instructors.index') }}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-user-tie me-1"></i> Manage Instructors
                    </a>
                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#importAssignmentsModal">
                        <i class="fas fa-file-excel me-1"></i> Import Assignments
                    </button>
                </div>
            </div>

            @include('dashboard.data-entry.partials._status_messages')
            @if (session('skipped_details') && count(session('skipped_details')) > 0)
                <div class="alert alert-warning mt-3">
                    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Skipped Entries Details:</h5>
                    <ul class="mb-0 small" style="max-height: 200px; overflow-y: auto;">
                        @foreach (session('skipped_details') as $detail)
                            <li>{{ $detail }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 5%;">#</th>
                                    <th style="width: 25%;">Instructor</th>
                                    <th style="width: 25%;">Department</th>
                                    <th style="width: 35%;">Assigned Subjects ({{-- $instructor->subjects_count --}})</th>
                                    <th style="width: 10%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @forelse ($instructors as $index => $instructor)
                                    <tr>
                                        <td>{{ $instructors->firstItem() + $index }}</td>
                                        <td>
                                            <div>{{ $instructor->instructor_name ?? optional($instructor->user)->name }}
                                            </div>
                                            <small class="text-muted">{{ $instructor->instructor_no }}</small>
                                        </td>
                                        <td>{{ optional($instructor->department)->department_name ?? 'N/A' }}</td>
                                        <td>
                                            @forelse ($instructor->subjects as $subject)
                                                {{-- <span class="badge bg-light text-dark border me-1 mb-1">{{ $subject->subject_no }}</span> --}}
                                                <span
                                                    class="badge bg-light text-dark border me-1 mb-1">{{ $subject->subject_no }}
                                                    - {{ $subject->subject_name }}</span>
                                                {{-- <span class="badge bg-light text-dark border me-1 mb-1">{{ $subject->subject_name }}</span> --}}
                                            @empty
                                                <span class="badge bg-secondary">None</span>
                                            @endforelse
                                        </td>
                                        <td>
                                            <a href="{{ route('data-entry.instructor-subjects.edit', $instructor->id) }}"
                                                class="btn btn-sm btn-outline-primary" title="Edit Subject Assignments">
                                                <i class="fas fa-edit me-1"></i> Edit
                                            </a>
                                        </td>
                                    </tr>
                                @empty
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No instructors found.</td>
                                    </tr>
                                @endforelse
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 d-flex justify-content-center">
                        {{ $instructors->links('pagination::bootstrap-5') }}
                    </div>
                </div>
            </div>

        </div>
    </div>
@endsection


{{-- *** مودال رفع ملف الإكسل للتعيينات *** --}}
<div class="modal fade" id="importAssignmentsModal" tabindex="-1" aria-labelledby="importAssignmentsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importAssignmentsModalLabel">Import Instructor-Subject Assignments</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.instructor-subject.importExcel') }}" method="POST"
                enctype="multipart/form-data">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="assignments_excel_file_input" class="form-label">Select Excel File <span
                                class="text-danger">*</span></label>
                        <input class="form-control" type="file" id="assignments_excel_file_input"
                            name="assignments_excel_file" accept=".xlsx, .xls, .csv" required>
                    </div>
                    <div class="alert alert-info small p-2">
                        <strong>Instructions:</strong><br>
                        - File must contain headers like: <code>instructor_name</code> (or ID), <code>subject_no</code>
                        (or ID/Name).<br>
                        - The 'subject' column can contain multiple subject codes/names separated by a comma
                        (<code>,</code>).<br>
                        - Existing assignments will not be removed. This process only adds new assignments.<br>
                        - Rows with missing instructor or subject data will be skipped.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-1"></i> Upload and Process
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\instructor-subject-edit.blade.php
@extends('dashboard.layout')

@push('styles')
<style>
    .subject-list-container { max-height: 60vh; overflow-y: auto; border: 1px solid #dee2e6; padding: 1rem; border-radius: .375rem; background-color: #f8f9fa; }
    .subject-list .form-check { margin-bottom: .5rem; }
    .subject-list .form-check-label { font-size: 0.9rem; cursor: pointer; }
    .subject-search-input { margin-bottom: 1rem; }
</style>
@endpush

@section('content')
<div class="main-content">
    <div class="data-entry-container">
        {{-- Header and Back Button --}}
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="data-entry-header mb-1">Assign Subjects</h1>
                    <h2 class="h5 text-muted">For Instructor: <span class="text-primary">{{ $instructor->instructor_name ?? optional($instructor->user)->name }}</span> ({{ $instructor->instructor_no }})</h2>
                </div>
                 <a href="{{ route('data-entry.instructor-subjects.index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Back to Assignments List
                </a>
            </div>
             <p class="mb-0 text-secondary small">Department: {{ optional($instructor->department)->department_name ?? 'N/A' }}</p>
        </div>

         @include('dashboard.data-entry.partials._status_messages')

        <form action="{{ route('data-entry.instructor-subjects.sync', $instructor->id) }}" method="POST">
            @csrf
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Select Assignable Subjects</h5>
                </div>
                <div class="card-body">
                    {{-- حقل البحث --}}
                    <div class="subject-search-input">
                        <input type="text" id="subjectAssignmentSearch" class="form-control" placeholder="Search subjects by name or code..." autofocus>
                    </div>

                     {{-- قائمة المواد مع Checkboxes --}}
                    <div class="subject-list-container">
                        <div class="subject-list row">
                             @if(isset($allSubjects) && $allSubjects->count() > 0)
                                 @foreach ($allSubjects as $subject)
                                 <div class="col-md-6 subject-assignment-item">
                                     <div class="form-check">
                                         <input class="form-check-input" type="checkbox"
                                                name="subject_ids[]"
                                                value="{{ $subject->id }}"
                                                id="subject_assign_{{ $subject->id }}"
                                                {{-- التحقق إذا كانت المادة معينة حالياً لهذا المدرس --}}
                                                {{ in_array($subject->id, $assignedSubjectIds ?? []) ? 'checked' : '' }}>
                                         <label class="form-check-label" for="subject_assign_{{ $subject->id }}">
                                             <strong>{{ $subject->subject_no }}</strong> - {{ $subject->subject_name }}
                                             {{-- استخدام optional() للحماية --}}
                                             <span class="text-muted small">({{ optional($subject->department)->department_name ?? 'N/A' }})</span>
                                         </label>
                                     </div>
                                 </div>
                                 @endforeach
                             @else
                                 <p class="text-muted text-center m-0">No subjects available in the system.</p>
                             @endif
                             <p class="text-muted text-center mt-2 col-12" id="noAssignmentResults" style="display: none;">No subjects match your search.</p>
                         </div>
                    </div>
                    @error('subject_ids') <div class="text-danger small mt-2">{{ $message }}</div> @enderror
                     @error('subject_ids.*') <div class="text-danger small mt-1">{{ $message }}</div> @enderror

                </div>
                 <div class="card-footer text-end">
                     <a href="{{ route('data-entry.instructor-subjects.index') }}" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Save Assignments
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
@endsection

@push('scripts')
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script>
$(document).ready(function() {
    $('#subjectAssignmentSearch').on('keyup', function() {
         const searchTerm = $(this).val().toLowerCase();
         let resultsFound = false;
         $('.subject-assignment-item').each(function() {
             const labelText = $(this).find('.form-check-label').text().toLowerCase();
             if (labelText.includes(searchTerm)) {
                 $(this).show();
                 resultsFound = true;
             } else {
                 $(this).hide();
             }
         });
         $('#noAssignmentResults').toggle(!resultsFound);
     });
});
</script>
@endpush
--------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\timeslots.blade.php
@extends('dashboard.layout')

@section('content')
<div class="main-content">
    <div class="data-entry-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
             <h1 class="data-entry-header mb-0">Manage Weekly Timeslots</h1>
             <div class="d-flex">
                {{-- زر توليد الفترات القياسية --}}
                <button class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#generateStandardTimeslotsModal">
                    <i class="fas fa-cogs me-1"></i> Generate Standard Timeslots
                </button>
                {{-- زر إضافة فترة فردية --}}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTimeslotModal">
                    <i class="fas fa-plus me-1"></i> Add New Timeslot
                </button>
             </div>
        </div>

        @include('dashboard.data-entry.partials._status_messages')

        <div class="card shadow-sm"> <div class="card-body"> <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-light">
                    <tr><th>#</th><th>Day</th><th>Start Time</th><th>End Time</th><th>Duration</th><th>Scheduled Classes</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    @forelse ($timeslots as $index => $timeslot)
                    @php
                        $startTime = \Carbon\Carbon::parse($timeslot->start_time);
                        $endTime = \Carbon\Carbon::parse($timeslot->end_time);
                        $duration = $startTime->diffInMinutes($endTime);
                    @endphp
                    <tr>
                        <td>{{ $timeslots->firstItem() + $index }}</td>
                        <td>{{ $timeslot->day }}</td>
                        <td>{{ $startTime->format('h:i A') }}</td>
                        <td>{{ $endTime->format('h:i A') }}</td>
                        <td>{{ $duration }} min</td>
                        <td><span class="badge bg-secondary">{{ $timeslot->schedule_entries_count }}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" data-bs-toggle="modal" data-bs-target="#editTimeslotModal-{{ $timeslot->id }}">Edit</button>
                            <button class="btn btn-sm btn-outline-danger py-0 px-1" data-bs-toggle="modal" data-bs-target="#deleteTimeslotModal-{{ $timeslot->id }}" {{ $timeslot->schedule_entries_count > 0 ? 'disabled' : '' }}>Delete</button>
                        </td>
                    </tr>
                    @empty
                    <tr><td colspan="7" class="text-center text-muted">No timeslots defined. You can generate standard timeslots or add them manually.</td></tr>
                    @endforelse
                </tbody>
            </table>
        </div> <div class="mt-3 d-flex justify-content-center"> {{ $timeslots->links('pagination::bootstrap-5') }} </div> </div> </div>

        {{-- *** تضمين المودالات من الـ partial *** --}}
        @include('dashboard.data-entry.partials._timeslot_modals')
        {{-- المودالات الفردية (إذا لم تكن في الـ partial) --}}
        @foreach($timeslots as $timeslot)
            @include('dashboard.data-entry.partials._timeslot_modals', ['timeslot_to_edit' => $timeslot])
        @endforeach
    </div>
</div>
@endsection

@push('scripts')
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script>
$(document).ready(function() {
    // لإعادة فتح المودال عند وجود أخطاء validation
    @if($errors->any())
        @if(session('open_generate_modal') && $errors->hasBag('generateStandardModal'))
            $('#generateStandardTimeslotsModal').modal('show');
        @elseif(session('open_modal_on_error') == 'addTimeslotModal' && $errors->hasBag('addTimeslotModal'))
            $('#addTimeslotModal').modal('show');
        @elseif(Str::startsWith(session('open_modal_on_error'), 'editTimeslotModal_') && $errors->hasBag(session('open_modal_on_error')))
            $('#{{ session('open_modal_on_error') }}').modal('show'); // فتح مودال التعديل المحدد
        @endif
    @endif
});
</script>
@endpush
-----------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_timeslot_modals.blade.php
@php
    $daysOfWeek = \App\Http\Controllers\DataEntry\TimeslotController::DAYS_OF_WEEK; // جلب الأيام
@endphp

{{-- =============================================== --}}
{{-- 1. Modal لتوليد الفترات الزمنية القياسية --}}
{{-- =============================================== --}}
<div class="modal fade" id="generateStandardTimeslotsModal" tabindex="-1" aria-labelledby="generateStandardTimeslotsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateStandardTimeslotsModalLabel">Generate Standard Weekly Timeslots</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.timeslots.generateStandard') }}" method="POST">
                @csrf
                <div class="modal-body">
                    <div class="alert alert-warning small">
                        <i class="fas fa-exclamation-triangle me-1"></i><strong>Warning:</strong> This will delete all existing timeslots and generate new ones based on your settings. This action cannot be undone.
                    </div>

                    @if ($errors->hasBag('generateStandardModal'))
                        <div class="alert alert-danger small p-2 mb-3">
                            <strong>Please correct the errors:</strong>
                            <ul class="mb-0 ps-3">
                                @foreach ($errors->getBag('generateStandardModal')->all() as $error)
                                    <li>{{ $error }}</li>
                                @endforeach
                            </ul>
                        </div>
                     @endif

                    <div class="mb-3">
                        <label class="form-label">Select Working Days <span class="text-danger">*</span></label>
                        <div class="row">
                            @foreach($daysOfWeek as $day)
                                <div class="col-md-3 col-sm-4 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input @error('working_days.'.$loop->index, 'generateStandardModal') is-invalid @enderror" type="checkbox" name="working_days[]" value="{{ $day }}" id="day_{{ $loop->index }}" {{ is_array(old('working_days')) && in_array($day, old('working_days', ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday'])) ? 'checked' : (!is_array(old('working_days')) && in_array($day, ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday']) && !old('_token') ? 'checked' : '') }}>
                                        <label class="form-check-label" for="day_{{ $loop->index }}">{{ $day }}</label>
                                    </div>
                                </div>
                            @endforeach
                        </div>
                        @error('working_days', 'generateStandardModal') <div class="text-danger small mt-1">{{ $message }}</div> @enderror
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="gen_overall_start_time" class="form-label">Overall Start Time <span class="text-danger">*</span></label>
                            <input type="time" class="form-control @error('overall_start_time', 'generateStandardModal') is-invalid @enderror" id="gen_overall_start_time" name="overall_start_time" value="{{ old('overall_start_time', '08:00') }}" required>
                            @error('overall_start_time', 'generateStandardModal') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="gen_overall_end_time" class="form-label">Overall End Time <span class="text-danger">*</span></label>
                            <input type="time" class="form-control @error('overall_end_time', 'generateStandardModal') is-invalid @enderror" id="gen_overall_end_time" name="overall_end_time" value="{{ old('overall_end_time', '16:00') }}" required>
                            @error('overall_end_time', 'generateStandardModal') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                     <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="gen_lecture_duration" class="form-label">Lecture Duration (minutes) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('lecture_duration', 'generateStandardModal') is-invalid @enderror" id="gen_lecture_duration" name="lecture_duration" value="{{ old('lecture_duration', 50) }}" required min="15">
                            @error('lecture_duration', 'generateStandardModal') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="gen_break_duration" class="form-label">Break Duration (minutes) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('break_duration', 'generateStandardModal') is-invalid @enderror" id="gen_break_duration" name="break_duration" value="{{ old('break_duration', 10) }}" required min="0">
                            @error('break_duration', 'generateStandardModal') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Generate Timeslots</button>
                </div>
            </form>
        </div>
    </div>
</div>


{{-- ======================================= --}}
{{-- 2. Modal لإضافة فترة زمنية فردية --}}
{{-- ======================================= --}}
{{-- هذا المودال يُستخدم عندما لا يكون هناك $timeslot_to_edit (أي للإضافة) --}}
@if (!isset($timeslot_to_edit))
<div class="modal fade" id="addTimeslotModal" tabindex="-1" aria-labelledby="addTimeslotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTimeslotModalLabel">Add New Timeslot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ route('data-entry.timeslots.store') }}" method="POST">
                @csrf
                <div class="modal-body">
                    @if ($errors->hasBag('addTimeslotModal'))
                        <div class="alert alert-danger small p-2 mb-3">
                            <ul class="mb-0 ps-3">@foreach ($errors->getBag('addTimeslotModal')->all() as $error) <li>{{ $error }}</li> @endforeach</ul>
                        </div>
                    @endif
                    <div class="mb-3">
                        <label for="add_day" class="form-label">Day <span class="text-danger">*</span></label>
                        <select class="form-select @error('day', 'addTimeslotModal') is-invalid @enderror" id="add_day" name="day" required>
                            <option value="" selected disabled>Select day...</option>
                            @foreach ($daysOfWeek as $day)
                                <option value="{{ $day }}" {{ old('day') == $day ? 'selected' : '' }}>{{ $day }}</option>
                            @endforeach
                        </select>
                        @error('day', 'addTimeslotModal') <div class="invalid-feedback">{{ $message }}</div> @enderror
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_start_time" class="form-label">Start Time <span class="text-danger">*</span></label>
                            <input type="time" class="form-control @error('start_time', 'addTimeslotModal') is-invalid @enderror" id="add_start_time" name="start_time" value="{{ old('start_time') }}" required>
                            @error('start_time', 'addTimeslotModal') <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_end_time" class="form-label">End Time <span class="text-danger">*</span></label>
                            <input type="time" class="form-control @error('end_time', 'addTimeslotModal') is-invalid @enderror" id="add_end_time" name="end_time" value="{{ old('end_time') }}" required>
                            @error('end_time', 'addTimeslotModal') <div class="invalid-feedback">{{ $message }}</div> @enderror
                            @error('time_unique', 'addTimeslotModal') <div class="text-danger small mt-1">{{ $message }}</div> @enderror
                            @error('time_overlap', 'addTimeslotModal') <div class="text-danger small mt-1">{{ $message }}</div> @enderror
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Timeslot</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endif


{{-- ======================================= --}}
{{-- 3. Modals التعديل والحذف (لكل فترة) --}}
{{-- ======================================= --}}
@if (isset($timeslot_to_edit))
@php $timeslot = $timeslot_to_edit; @endphp {{-- لتسهيل الاستخدام --}}
{{-- Modal لتعديل فترة زمنية --}}
<div class="modal fade" id="editTimeslotModal-{{ $timeslot->id }}" tabindex="-1" aria-labelledby="editTimeslotModalLabel-{{ $timeslot->id }}" aria-hidden="true">
     <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTimeslotModalLabel-{{ $timeslot->id }}">Edit Timeslot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             <form action="{{ route('data-entry.timeslots.update', $timeslot->id) }}" method="POST">
                @csrf
                @method('PUT')
                <div class="modal-body">
                    @php $editErrorBag = 'editTimeslotModal_'.$timeslot->id; @endphp
                    @if ($errors->hasBag($editErrorBag))
                        <div class="alert alert-danger small p-2 mb-3">
                            <ul class="mb-0 ps-3">@foreach ($errors->getBag($editErrorBag)->all() as $error) <li>{{ $error }}</li> @endforeach</ul>
                        </div>
                    @endif
                    <div class="mb-3">
                        <label for="edit_day_{{ $timeslot->id }}" class="form-label">Day <span class="text-danger">*</span></label>
                        <select class="form-select @error('day', $editErrorBag) is-invalid @enderror" id="edit_day_{{ $timeslot->id }}" name="day" required>
                            @foreach ($daysOfWeek as $day)
                                <option value="{{ $day }}" {{ old('day', $timeslot->day) == $day ? 'selected' : '' }}>{{ $day }}</option>
                            @endforeach
                        </select>
                        @error('day', $editErrorBag) <div class="invalid-feedback">{{ $message }}</div> @enderror
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_start_time_{{ $timeslot->id }}" class="form-label">Start Time <span class="text-danger">*</span></label>
                            <input type="time" class="form-control @error('start_time', $editErrorBag) is-invalid @enderror" id="edit_start_time_{{ $timeslot->id }}" name="start_time" value="{{ old('start_time', \Carbon\Carbon::parse($timeslot->start_time)->format('H:i')) }}" required>
                            @error('start_time', $editErrorBag) <div class="invalid-feedback">{{ $message }}</div> @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_end_time_{{ $timeslot->id }}" class="form-label">End Time <span class="text-danger">*</span></label>
                            <input type="time" class="form-control @error('end_time', $editErrorBag) is-invalid @enderror" id="edit_end_time_{{ $timeslot->id }}" name="end_time" value="{{ old('end_time', \Carbon\Carbon::parse($timeslot->end_time)->format('H:i')) }}" required>
                            @error('end_time', $editErrorBag) <div class="invalid-feedback">{{ $message }}</div> @enderror
                            @error('time_unique', $editErrorBag) <div class="text-danger small mt-1">{{ $message }}</div> @enderror
                            @error('time_overlap', $editErrorBag) <div class="text-danger small mt-1">{{ $message }}</div> @enderror
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Timeslot</button>
                </div>
            </form>
        </div>
    </div>
</div>

{{-- Modal لتأكيد الحذف --}}
<div class="modal fade" id="deleteTimeslotModal-{{ $timeslot->id }}" tabindex="-1" aria-labelledby="deleteTimeslotModalLabel-{{ $timeslot->id }}" aria-hidden="true">
     <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTimeslotModalLabel-{{ $timeslot->id }}">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             <form action="{{ route('data-entry.timeslots.destroy', $timeslot->id) }}" method="POST">
                @csrf
                @method('DELETE')
                <div class="modal-body">
                    <p>Are you sure you want to delete: <strong>{{ $timeslot->day }} {{ \Carbon\Carbon::parse($timeslot->start_time)->format('h:i A') }} - {{ \Carbon\Carbon::parse($timeslot->end_time)->format('h:i A') }}</strong>?</p>
                    @if($timeslot->schedule_entries_count > 0)
                        <p class="text-warning small"><i class="fas fa-exclamation-triangle"></i> This timeslot is used by {{ $timeslot->schedule_entries_count }} scheduled classes and cannot be deleted.</p>
                    @else
                        <p class="text-danger small">This action cannot be undone.</p>
                    @endif
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" {{ $timeslot->schedule_entries_count > 0 ? 'disabled' : '' }}>Yes, Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>
@endif
---------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\manage-sections-for-context.blade.php
@extends('dashboard.layout')

@push('styles')
    <style>
        .table th,
        .table td {
            vertical-align: middle;
            font-size: 0.85rem;
        }

        .modal-dialog-centered {
            display: flex;
            align-items: center;
            min-height: calc(100% - 1rem);
        }

        @media (min-width: 576px) {
            .modal-dialog-centered {
                min-height: calc(100% - 3.5rem);
            }
        }

        .card-body .table-responsive {
            margin-bottom: 0;
        }

        .card-header h5.mb-0 {
            font-size: 1.1rem;
        }
    </style>
@endpush

@section('content')
    <div class="main-content">
        <div class="data-entry-container">
            {{-- 1. عرض معلومات السياق (نفس الكود السابق) --}}
            <div class="mb-4 p-3 border rounded bg-light shadow-sm">
                {{-- ... Header, Back Button, Context Info ... --}}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <h4 class="data-entry-header mb-1">Manage Sections for Context</h4>
                        <p class="mb-1 text-muted small">Modifying sections for Plan:
                            <strong>{{ optional($expectedCount->plan)->plan_no }}</strong>
                        </p>
                    </div>
                    <a href="{{ route('data-entry.plan-expected-counts.index') }}"
                        class="btn btn-sm btn-outline-secondary align-self-start">
                        <i class="fas fa-arrow-left me-1"></i> Back to Expected Counts
                    </a>
                </div>
                <hr>
                <div class="row small">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Plan Name:</strong> {{ optional($expectedCount->plan)->plan_name }}</p>
                        <p class="mb-1"><strong>Department:</strong>
                            {{ optional(optional($expectedCount->plan)->department)->department_name }}</p>
                        <p class="mb-0"><strong>Academic Year:</strong> {{ $expectedCount->academic_year }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Level:</strong> {{ $expectedCount->plan_level }}</p>
                        <p class="mb-1"><strong>Semester (Plan):</strong> {{ $expectedCount->plan_semester }}</p>
                        <p class="mb-0"><strong>Branch:</strong> {{ $expectedCount->branch ?? 'Default' }}</p>
                    </div>
                </div>
                <div class="mt-2">
                    <p class="mb-0"><strong>Total Expected:</strong> <span
                            class="fw-bold fs-5">{{ $expectedCount->male_count + $expectedCount->female_count }}</span>
                        <small>({{ $expectedCount->male_count }} M, {{ $expectedCount->female_count }} F)</small>
                    </p>
                </div>
            </div>

            @include('dashboard.data-entry.partials._status_messages')

            {{-- 2. زر إنشاء/تحديث الشعب تلقائياً (نفس الكود السابق) --}}
            <div class="mb-3 text-end">
                @if ($expectedCount)
                    <form action="{{ route('data-entry.sections.generateForContext', $expectedCount->id) }}" method="POST"
                        class="d-inline">
                        @csrf
                        <button type="submit" class="btn btn-warning"
                            onclick="return confirm('ATTENTION: This will DELETE existing sections for ALL subjects in this context and REGENERATE them. Manual adjustments will be lost. Are you sure?');">
                            <i class="fas fa-cogs me-1"></i> Regenerate All Sections
                        </button>
                    </form>
                @endif
            </div>

            {{-- 3. عرض الشعب لكل مادة --}}
            @if (!isset($planSubjectsForContext) || $planSubjectsForContext->isEmpty())
                <div class="alert alert-info">No subjects found in this plan/level/semester.</div>
            @else
                @foreach ($planSubjectsForContext as $ps)
                    @php
                        $subject = $ps->subject;
                        if (!$subject || !$subject->subjectCategory) {
                            continue;
                        }
                        $subjectCategoryName = strtolower($subject->subjectCategory->subject_category_name);
                        $sectionsForThisSubject = $currentSectionsBySubjectAndActivity[$subject->id] ?? collect();
                        $theorySections = $sectionsForThisSubject->get('Theory', collect());
                        $practicalSections = $sectionsForThisSubject->get('Practical', collect());
                    @endphp

                    <h5 class="mt-4 mb-2 pb-2 border-bottom">
                        Subject: <span class="text-primary">{{ $subject->subject_no }} -
                            {{ $subject->subject_name }}</span>
                        <small class="badge bg-secondary fw-normal">{{ $subjectCategoryName }}</small>
                    </h5>

                    {{-- الجزء النظري --}}
                    @if (
                        ($subject->theoretical_hours ?? 0) > 0 &&
                            Str::contains($subjectCategoryName, ['theory', 'نظري', 'combined', 'مشترك']))
                        <div class="card shadow-sm mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center"
                                style="background-color: #e9ecef;">
                                <h6 class="mb-0 text-dark"><i class="fas fa-chalkboard me-2"></i>Theory Sections</h6>
                                {{-- <button class="btn btn-outline-success btn-sm open-add-section-modal" data-bs-toggle="modal"
                                    data-bs-target="#addSectionModal" data-plan-subject-id="{{ $ps->id }}"
                                    data-activity-type="Theory"
                                    data-subject-name-modal="{{ $subject->subject_name }} (Theory)">
                                    <i class="fas fa-plus me-1"></i> Add Theory Section
                                </button> --}}
                                <button class="btn btn-outline-success btn-sm open-add-section-modal" data-bs-toggle="modal"
                                    data-bs-target="#addSectionModal" data-plan-subject-id="{{ $ps->id }}"
                                    data-activity-type="Theory"
                                    data-subject-name-modal="{{ $subject->subject_name }} (Theory)"
                                    data-expected-count-id="{{ $expectedCount->id }}"
                                    data-academic-year="{{ $expectedCount->academic_year }}"
                                    data-semester="{{ $expectedCount->plan_semester }}"
                                    data-branch="{{ $expectedCount->branch ?? '' }}"
                                    data-form-action="{{ route('data-entry.sections.storeInContext', $expectedCount->id) }}">
                                    <i class="fas fa-plus me-1"></i> Add Theory Section
                                </button>
                            </div>
                            <div class="card-body p-0">
                                @if ($theorySections->isNotEmpty())
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Sec.No.</th>
                                                    <th>Gender</th>
                                                    <th>Branch</th>
                                                    <th>Students</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach ($theorySections as $index => $section)
                                                    <tr>
                                                        <td>{{ $index + 1 }}</td>
                                                        <td>{{ $section->section_number }}</td>
                                                        <td>{{ $section->section_gender }}</td>
                                                        <td>{{ $section->branch ?? '-' }}</td>
                                                        <td>{{ $section->student_count }}</td>
                                                        <td>
                                                            <button
                                                                class="btn btn-sm btn-outline-primary py-0 px-1 me-1 open-edit-section-modal"
                                                                data-bs-toggle="modal" data-bs-target="#editSectionModal"
                                                                data-section-id="{{ $section->id }}"
                                                                data-section-number="{{ $section->section_number }}"
                                                                data-student-count="{{ $section->student_count }}"
                                                                data-section-gender="{{ $section->section_gender }}"
                                                                data-branch="{{ $section->branch }}"
                                                                data-activity-type="{{ $section->activity_type }}"
                                                                data-form-action="{{ route('data-entry.sections.updateInContext', $section->id) }}"
                                                                data-context-info="Sec #{{ $section->section_number }} for {{ $subject->subject_no }} (Theory)">Edit</button>
                                                            <button
                                                                class="btn btn-sm btn-outline-danger py-0 px-1 open-delete-section-modal"
                                                                data-bs-toggle="modal" data-bs-target="#deleteSectionModal"
                                                                data-form-action="{{ route('data-entry.sections.destroyInContext', $section->id) }}"
                                                                data-section-info="Section #{{ $section->section_number }} (Theory) for {{ $subject->subject_no }}">Delete</button>
                                                        </td>
                                                    </tr>
                                                @endforeach
                                            </tbody>
                                        </table>
                                    </div>
                                @else
                                    <p class="text-muted text-center p-3 mb-0">No theory sections defined.</p>
                                @endif
                            </div>
                        </div>
                    @endif

                    {{-- الجزء العملي --}}
                    @if (
                        ($subject->practical_hours ?? 0) > 0 &&
                            Str::contains($subjectCategoryName, ['practical', 'عملي', 'combined', 'مشترك']))
                        <div class="card shadow-sm mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center"
                                style="background-color: #f8f9fa;">
                                <h6 class="mb-0 text-dark"><i class="fas fa-flask me-2"></i>Practical Sections</h6>
                                {{-- <button class="btn btn-outline-success btn-sm open-add-section-modal" data-bs-toggle="modal"
                                    data-bs-target="#addSectionModal" data-plan-subject-id="{{ $ps->id }}"
                                    data-activity-type="Practical"
                                    data-subject-name-modal="{{ $subject->subject_name }} (Practical)"
                                    data-expected-count-id="{{ $expectedCount->id }}">
                                    <i class="fas fa-plus me-1"></i> Add Practical Section
                                </button> --}}
                                <button class="btn btn-outline-success btn-sm open-add-section-modal" data-bs-toggle="modal"
                                    data-bs-target="#addSectionModal"
                                    data-plan-subject-id="{{ $ps->id }}"
                                    data-activity-type="Practical"
                                    data-expected-count-id="{{ $expectedCount->id }}"
                                    data-academic-year="{{ $expectedCount->academic_year }}"
                                    data-semester="{{ $expectedCount->plan_semester }}"
                                    data-branch="{{ $expectedCount->branch ?? '' }}"
                                    data-subject-name-modal="{{ $subject->subject_name }} (Practical)"
                                    data-form-action="{{ route('data-entry.sections.storeInContext', $expectedCount->id) }}">
                                    <i class="fas fa-plus me-1"></i> Add Practical Section
                                </button>
                            </div>
                            <div class="card-body p-0">
                                @if ($practicalSections->isNotEmpty())
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Sec.No.</th>
                                                    <th>Gender</th>
                                                    <th>Branch</th>
                                                    <th>Students</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach ($practicalSections as $index => $section)
                                                    <tr>
                                                        <td>{{ $index + 1 }}</td>
                                                        <td>{{ $section->section_number }}</td>
                                                        <td>{{ $section->section_gender }}</td>
                                                        <td>{{ $section->branch ?? '-' }}</td>
                                                        <td>{{ $section->student_count }}</td>
                                                        <td>
                                                            <button
                                                                class="btn btn-sm btn-outline-primary py-0 px-1 me-1 open-edit-section-modal"
                                                                data-bs-toggle="modal" data-bs-target="#editSectionModal"
                                                                data-section-id="{{ $section->id }}"
                                                                data-section-number="{{ $section->section_number }}"
                                                                data-student-count="{{ $section->student_count }}"
                                                                data-section-gender="{{ $section->section_gender }}"
                                                                data-branch="{{ $section->branch }}"
                                                                data-activity-type="{{ $section->activity_type }}"
                                                                data-form-action="{{ route('data-entry.sections.updateInContext', $section->id) }}"
                                                                data-context-info="Sec #{{ $section->section_number }} for {{ $subject->subject_no }} (Practical)">Edit</button>
                                                            <button
                                                                class="btn btn-sm btn-outline-danger py-0 px-1 open-delete-section-modal"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#deleteSectionModal"
                                                                data-form-action="{{ route('data-entry.sections.destroyInContext', $section->id) }}"
                                                                data-section-info="Section #{{ $section->section_number }} (Practical) for {{ $subject->subject_no }}">Delete</button>
                                                        </td>
                                                    </tr>
                                                @endforeach
                                            </tbody>
                                        </table>
                                    </div>
                                @else
                                    <p class="text-muted text-center p-3 mb-0">No practical sections defined.</p>
                                @endif
                            </div>
                        </div>
                    @endif
                @endforeach
            @endif
            {{-- *** تضمين ملف المودالات الموحد *** --}}
            @include('dashboard.data-entry.partials._manage_section_modals', [
                'section' => null, // للإضافة (سيتم ملء التفاصيل بـ JS)
                'expectedCountId_for_add' => $expectedCount->id, // لتمريرها لمودال الإضافة إذا احتجت
            ])
        </div>
    </div>
@endsection

@push('scripts')
    {{-- JavaScript (الكود من الرد السابق للتعامل مع المودالات الثلاثة يجب أن يعمل) --}}
    {{-- تأكد أن الـ JS يستخدم IDs المودالات الجديدة والفورمات إذا غيرتها --}}
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            console.log('Manage Sections for Context: Scripts Ready.');

            // --- مودال الإضافة ---
            // const addModalEl = $('#addSectionModal'); // ID المودال العام للإضافة
            // const addFormEl = $('#addSectionForm'); // ID الفورم داخل مودال الإضافة
            // const addModalTitleEl = $('#addSectionModalLabel');

            // $(document).on('click', '.open-add-section-modal', function() {
            //     const button = $(this);
            //     const planSubjectId = button.data('plan-subject-id');
            //     const activityType = button.data('activity-type');
            //     const subjectName = button.data('subject-name-modal');
            //     const expectedCountId = button.data('expected-count-id');
            //     const branchFromContext = button.data('branch') !== undefined ? button.data('branch') :
            //         ''; // جلب الفرع من الزر

            //     addModalTitleEl.text('Add ' + activityType + ' Section for: ' + subjectName);
            //     const formAction = "{{ url('dashboard/data-entry/sections/store-in-context') }}/" +
            //         expectedCountId;
            //     addFormEl.attr('action', formAction);

            //     addFormEl.find('input[name="plan_subject_id_from_modal"]').val(planSubjectId);
            //     addFormEl.find('input[name="activity_type_from_modal"]').val(activityType);
            //     addFormEl.find('#add_branch_display_modal').val(branchFromContext); // عرض الفرع للقراءة

            //     // إعادة تعيين باقي الحقول
            //     addFormEl.find('input[name="section_number"]').val('1');
            //     addFormEl.find('input[name="student_count"]').val('0');
            //     addFormEl.find('select[name="section_gender"]').val('Mixed');
            //     addFormEl.find('.is-invalid').removeClass('is-invalid');
            //     addFormEl.find('.invalid-feedback, .text-danger.small, .alert-danger').remove();
            //     console.log("Add Modal opened. Action:", formAction, "PS_ID:", planSubjectId, "Activity:",
            //         activityType);
            // });

            // --- مودال الإضافة ---
            const addModalEl = $('#addSectionModal');
            const addFormEl = $('#addSectionForm');
            const addModalTitleEl = $('#addSectionModalLabel');

            $(document).on('click', '.open-add-section-modal', function() {
                const button = $(this);

                // الحصول على البيانات من الزر
                const formAction = button.data('form-action');
                const planSubjectId = button.data('plan-subject-id');
                const activityType = button.data('activity-type');
                const subjectName = button.data('subject-name-modal');
                const branchFromContext = button.data('branch') || '';

                const expectedCountId = button.data('expected-count-id');
                const academicYear = button.data('academic-year') || '{{ $expectedCount->academic_year }}';
                const semester = button.data('semester') || '{{ $expectedCount->plan_semester }}';


                // التحقق من وجود البيانات الأساسية
                if (!formAction || !planSubjectId) {
                    console.error("Missing required data attributes!");
                    return;
                }

                // تعيين القيم للنموذج
                addModalTitleEl.text('Add ' + activityType + ' Section for: ' + subjectName);
                addFormEl.attr('action', formAction);
                addFormEl.attr('method', 'POST');

                // تعبئة الحقول المخفية
                addFormEl.find('input[name="academic_year"]').val(academicYear);
                addFormEl.find('input[name="semester"]').val(semester);
                addFormEl.find('input[name="plan_subject_id_from_modal"]').val(planSubjectId);
                addFormEl.find('input[name="activity_type_from_modal"]').val(activityType);
                addFormEl.find('input[name="branch"]').val(branchFromContext);
                addFormEl.find('#add_branch_display_modal').val(branchFromContext || 'Default');

                // إعادة تعيين باقي الحقول
                addFormEl.find('input[name="section_number"]').val('1');
                addFormEl.find('input[name="student_count"]').val('0');
                addFormEl.find('select[name="section_gender"]').val('Mixed');

                // مسح الأخطاء السابقة
                addFormEl.find('.is-invalid').removeClass('is-invalid');
                addFormEl.find('.invalid-feedback, .text-danger.small, .alert-danger').remove();

                console.log("Add Modal configured. Action:", formAction, "PS_ID:", planSubjectId,
                    "Activity:", activityType);
            });



            // ***********************************************************************************************************************
            // --- مودال التعديل ---
            const editModalEl = $('#editSectionModal');
            const editFormEl = $('#editSectionForm');
            const editModalTitleEl = $('#editSectionModalLabel');
            const editContextInfoSpanEl = $('#edit_context_info_modal_text span');

            $(document).on('click', '.open-edit-section-modal', function() {
                const button = $(this);
                const formAction = button.data('form-action');
                const sectionNumber = button.data('section-number');
                const studentCount = button.data('student-count');
                const sectionGender = button.data('section-gender');
                const branch = button.data('branch') !== undefined ? button.data('branch') : '';
                const contextInfo = button.data('context-info');

                editModalTitleEl.text('Edit Section #' + sectionNumber);
                editFormEl.attr('action', formAction);
                if (editContextInfoSpanEl.length) editContextInfoSpanEl.text(contextInfo);

                editFormEl.find('input[name="section_number"]').val(sectionNumber);
                editFormEl.find('input[name="student_count"]').val(studentCount);
                editFormEl.find('select[name="section_gender"]').val(sectionGender);
                editFormEl.find('#edit_modal_branch_display').val(branch);

                editFormEl.find('.is-invalid').removeClass('is-invalid');
                editFormEl.find('.invalid-feedback, .text-danger.small, .alert-danger').remove();
                editFormEl.find('#edit_form_errors_placeholder').empty(); // مسح أخطاء سابقة
                console.log("Edit Modal configured. Action:", formAction);
            });


            // --- مودال الحذف ---
            const deleteModalEl = $('#deleteSectionModal');
            const deleteFormEl = $('#deleteSectionForm');
            const deleteSectionInfoSpanEl = $('#deleteSectionInfoText');

            $(document).on('click', '.open-delete-section-modal', function() {
                const button = $(this);
                const formAction = button.data('form-action');
                const sectionInfo = button.data('section-info');

                if (deleteFormEl.length && formAction) {
                    deleteFormEl.attr('action', formAction);
                } else {
                    console.error("Delete form or action missing!");
                }
                if (deleteSectionInfoSpanEl.length) {
                    deleteSectionInfoSpanEl.text(sectionInfo);
                } else {
                    console.error("Delete info span missing!");
                }
                console.log("Delete Modal configured. Action:", formAction);
            });

            // --- عرض أخطاء الـ Validation في المودال الصحيح بعد إعادة التحميل ---
            @if ($errors->hasBag('storeSectionModal'))
                var addModalInstance = new bootstrap.Modal(document.getElementById('addSectionModal'));
                addModalInstance.show();
                // يمكنك إضافة كود هنا لملء حقول مودال الإضافة بالـ old input إذا أردت
                // وعرض الأخطاء داخل المودال (تم إضافته في HTML المودال)
                console.log("Errors found for Add Section Modal, showing modal.");
            @endif

            @foreach ($errors->getBags() as $bagName => $bagErrors)
                @if (Str::startsWith($bagName, 'updateSectionModal_'))
                    @php $sectionIdForError = Str::after($bagName, 'updateSectionModal_'); @endphp
                    var editModalInstance_{{ $sectionIdForError }} = new bootstrap.Modal(document.getElementById(
                        'editSectionModal')); // نفترض ID واحد للمودال
                    // قد تحتاج لتمرير بيانات الشعبة مرة أخرى للمودال أو استخدام old()
                    // ولإظهار المودال الصحيح، ستحتاج لتحديد أي مودال تعديل يجب فتحه
                    // هذا الجزء قد يكون معقداً إذا كان لديك مودالات تعديل كثيرة بنفس الـ ID.
                    // الأسهل أن يتم إعادة فتح المودال الذي كان مفتوحاً، أو عرض الأخطاء في _status_messages.
                    // للتبسيط الآن، سنركز على عرض الأخطاء في _status_messages إذا لم يكن المودال مفتوحاً.
                    console.log("Errors found for Edit Section Modal ({{ $bagName }}), consider showing it.");
                    //$('#editSectionModal').modal('show'); // هذا سيفتح دائماً أول مودال
                @endif
            @endforeach


        });
    </script>
@endpush
------------------------------------------------------------------------------------------------------
resources\views\dashboard\data-entry\partials\_manage_section_modals.blade.php
{{-- ===================================================== --}}
{{-- مودال إضافة شعبة جديدة (في سياق محدد) --}}
{{-- ===================================================== --}}
<div class="modal fade" id="addSectionModal" tabindex="-1" aria-labelledby="addSectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSectionModalLabel">Add New Section</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addSectionForm" action="#" method="POST"> {{-- Action يتغير بـ JS --}}
                @csrf
                <input type="hidden" name="plan_subject_id_from_modal" id="add_modal_plan_subject_id"
                    value="{{ old('plan_subject_id_from_modal') }}">
                <input type="hidden" name="activity_type_from_modal" id="add_modal_activity_type"
                    value="{{ old('activity_type_from_modal') }}">

                <input type="hidden" name="academic_year" id="add_modal_academic_year" value="{{ old('academic_year') }}">
                <input type="hidden" name="semester" id="add_modal_semester" value="{{ old('semester') }}">
                <input type="hidden" name="branch" id="add_modal_branch" value="{{ old('branch') }}">

                {{-- expectedCountId يستخدم فقط لتحديث الـ action في JS --}}

                <div class="modal-body">
                    {{-- عرض أخطاء الـ validation المحددة للحقول --}}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_section_number" class="form-label">Section Number <span
                                    class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('section_number') is-invalid @enderror"
                                id="add_section_number" name="section_number" value="{{ old('section_number', 1) }}"
                                required min="1">
                            @error('section_number')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            @error('section_unique')
                                <div class="text-danger small mt-1">{{ $message }}</div>
                            @enderror {{-- لخطأ التفرد --}}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_student_count" class="form-label">Student Count <span
                                    class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('student_count') is-invalid @enderror"
                                id="add_student_count" name="student_count" value="{{ old('student_count', 0) }}"
                                required min="0">
                            @error('student_count')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_section_gender" class="form-label">Section Gender <span
                                    class="text-danger">*</span></label>
                            <select class="form-select @error('section_gender') is-invalid @enderror"
                                id="add_section_gender" name="section_gender" required>
                                <option value="Mixed"
                                    {{ old('section_gender', 'Mixed') == 'Mixed' ? 'selected' : '' }}>Mixed</option>
                                <option value="Male" {{ old('section_gender') == 'Male' ? 'selected' : '' }}>Male Only
                                </option>
                                <option value="Female" {{ old('section_gender') == 'Female' ? 'selected' : '' }}>Female
                                    Only</option>
                            </select>
                            @error('section_gender')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_branch_display_modal" class="form-label">Branch (from context)</label>
                            <input type="text" class="form-control" id="add_branch_display_modal" readonly>
                            {{-- القيمة الفعلية للفرع ستؤخذ من $expectedCount في الكنترولر --}}
                        </div>
                    </div>
                    {{-- عرض الأخطاء التي ليست مرتبطة بحقل معين --}}
                    @if (
                        $errors->any() &&
                            !$errors->has('section_number') &&
                            !$errors->has('student_count') &&
                            !$errors->has('section_gender') &&
                            !$errors->has('plan_subject_id_from_modal') &&
                            !$errors->has('activity_type_from_modal'))
                        <div class="alert alert-danger small p-2">
                            Please review the following errors:
                            <ul>
                                @foreach ($errors->all() as $error)
                                    <li>{{ $error }}</li>
                                @endforeach
                            </ul>
                        </div>
                    @endif
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Section</button>
                </div>
            </form>
        </div>
    </div>
</div>

{{-- ===================================================== --}}
{{-- مودال تعديل شعبة (واحد مشترك) --}}
{{-- ===================================================== --}}
<div class="modal fade" id="editSectionModal" tabindex="-1" aria-labelledby="editSectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSectionModalLabel">Edit Section</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editSectionForm" action="#" method="POST">
                @csrf
                @method('PUT')
                <div class="modal-body">
                    <div class="alert alert-secondary small p-2 mb-3" id="edit_context_info_modal_text">
                        <strong>Context:</strong> <span>Loading...</span>
                    </div>
                    {{-- عرض أخطاء الـ validation المحددة للحقول --}}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_modal_section_number" class="form-label">Section Number <span
                                    class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('section_number') is-invalid @enderror"
                                id="edit_modal_section_number" name="section_number" value="" required
                                min="1">
                            @error('section_number')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            @error('section_unique')
                                <div class="text-danger small mt-1">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_modal_student_count" class="form-label">Student Count <span
                                    class="text-danger">*</span></label>
                            <input type="number" class="form-control @error('student_count') is-invalid @enderror"
                                id="edit_modal_student_count" name="student_count" value="" required
                                min="0">
                            @error('student_count')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_modal_section_gender" class="form-label">Section Gender <span
                                    class="text-danger">*</span></label>
                            <select class="form-select @error('section_gender') is-invalid @enderror"
                                id="edit_modal_section_gender" name="section_gender" required>
                                <option value="Mixed">Mixed</option>
                                <option value="Male">Male Only</option>
                                <option value="Female">Female Only</option>
                            </select>
                            @error('section_gender')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_modal_branch_display" class="form-label">Branch (from context)</label>
                            <input type="text" class="form-control" id="edit_modal_branch_display" readonly>
                        </div>
                    </div>
                    {{-- عرض الأخطاء العامة --}}
                    @if (
                        $errors->any() &&
                            !$errors->has('section_number') &&
                            !$errors->has('student_count') &&
                            !$errors->has('section_gender'))
                        <div class="alert alert-danger small p-2">
                            Please review the following errors:
                            <ul>
                                @foreach ($errors->all() as $error)
                                    <li>{{ $error }}</li>
                                @endforeach
                            </ul>
                        </div>
                    @endif
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update Section</button>
                </div>
            </form>
        </div>
    </div>
</div>

{{-- ===================================================== --}}
{{-- مودال تأكيد الحذف (واحد مشترك) --}}
{{-- ===================================================== --}}
<div class="modal fade" id="deleteSectionModal" tabindex="-1" aria-labelledby="deleteSectionModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteSectionModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form id="deleteSectionForm" action="#" method="POST">
                @csrf
                @method('DELETE')
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong id="deleteSectionInfoText">this section</strong>?</p>
                    <p class="text-danger small">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Yes, Delete Section</button>
                </div>
            </form>
        </div>
    </div>
</div>
------------------------------------------------------------------------------------------------------
