app\Http\Controllers\DashboardController.php
<?php

namespace App\Http\Controllers;

use App\Models\Timeslot;
use App\Models\Chromosome;
use App\Models\Population;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use App\Services\ConflictCheckerService;

class DashboardController extends Controller
{
    public function index()
    {
        // return view('dashboard.index');
        // جلب آخر عملية تشغيل مكتملة
        $lastSuccessfulRun = Population::where('status', 'completed')
            ->orderBy('end_time', 'desc')
            ->first();

        $bestChromosome = null;
        $scheduleData = [];
        $conflicts = [];
        $conflictingGeneIds = [];
        $timeslots = collect();

        if ($lastSuccessfulRun && $lastSuccessfulRun->best_chromosome_id) {
            // جلب أفضل جدول من هذه العملية
            $bestChromosome = Chromosome::find($lastSuccessfulRun->best_chromosome_id);

            if ($bestChromosome) {
                // جلب بيانات هذا الجدول للعرض
                $genes = $bestChromosome->genes()->with([
                    'section.planSubject.subject',
                    'instructor.user',
                    'room',
                    'timeslot'
                ])->get();

                // فحص التعارضات
                $conflictChecker = new ConflictCheckerService($genes);
                $conflicts = $conflictChecker->getConflicts();
                $conflictingGeneIds = $conflictChecker->getConflictingGeneIds();

                // تحضير بيانات الجدول للعرض
                foreach ($genes as $gene) {
                    if ($gene->timeslot) { // تحقق من وجود الفترة الزمنية
                        $scheduleData[$gene->timeslot->day][$gene->timeslot->start_time][] = $gene;
                    }
                }
            }
        }

        // جلب كل الفترات الزمنية المتاحة لعرض هيكل الجدول
        $timeslots = Timeslot::orderBy('start_time')->get()->groupBy('day');


        // تمرير البيانات للـ view
        return view('dashboard.index', compact(
            'lastSuccessfulRun',
            'bestChromosome',
            'scheduleData',
            'timeslots',
            'conflicts',
            'conflictingGeneIds'
            // ... يمكنك تمرير إحصائيات أخرى هنا (Total Courses, Instructors, etc.)
        ));
    }

    public function dataEntry()
    {
        return view('dashboard.data-entry');
    }

    public function store(Request $request)
    {
        return redirect()->back()->with('success', 'Lecture saved!');
    }
}

--------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\RoleController.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Models\Role;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log; // اختياري لكن مفيد للـ debugging
use Illuminate\Validation\Rule; // لاستخدام Rule::unique
use Exception;

class RoleController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================

    /**
     * Display a listing of the roles (Web View) with Pagination.
     */
    public function index()
    {
        // $roles = Role::orderBy('display_name')->paginate(5); // استخدام paginate هنا
        $roles = Role::latest()->paginate(6); // استخدام paginate هنا
        return view('dashboard.data-entry.roles', compact('roles'));
    }

    /**
     * Store a newly created role from web request.
     * تخزين دور جديد قادم من طلب ويب
     */
    public function store(Request $request)
    {
        // 1. Validation
        $request->validate([
            'name' => 'required|string|max:50|unique:roles,name|alpha_dash',
            'display_name' => 'required|string|max:100',
            'description' => 'nullable|string|max:255',
        ]);

        // 2. Prepare Data
        $data = $request->only(['name', 'display_name', 'description']);
        $data['name'] = strtolower($data['name']);

        // 3. Add to Database
        try {
            Role::create($data);
            // 4. Redirect with Success Message
            return redirect()->route('data-entry.roles.index') // تأكد من اسم الروت
                ->with('success', 'Role created successfully.');
        } catch (Exception $e) {
            Log::error('Role Creation Failed (Web): ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to create role.')
                ->withInput();
        }
    }

    /**
     * Update the specified role from web request.
     * تحديث دور محدد قادم من طلب ويب
     */
    public function update(Request $request, Role $role)
    {
        // 1. Validation
        $request->validate([
            'name' => [
                'required',
                'string',
                'max:50',
                'alpha_dash',
                Rule::unique('roles')->ignore($role->id), // تجاهل الدور الحالي
            ],
            'display_name' => 'required|string|max:100',
            'description' => 'nullable|string|max:255',
        ]);

        // 2. Prepare Data
        $data = $request->only(['name', 'display_name', 'description']);
        $data['name'] = strtolower($data['name']);

        // (اختياري) منع تعديل اسم النظام للأدوار الأساسية
        // $coreRoles = ['admin', 'hod', 'instructor', 'student'];
        // if (in_array($role->name, $coreRoles) && $role->name !== $data['name']) {
        //     return redirect()->back()
        //                      ->with('error', 'Cannot change the system name of core roles.')
        //                      ->withInput();
        // }


        // 3. Update Database
        try {
            $role->update($data);
            // 4. Redirect
            return redirect()->route('data-entry.roles.index') // تأكد من اسم الروت
                ->with('success', 'Role updated successfully.');
        } catch (Exception $e) {
            Log::error('Role Update Failed (Web): ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to update role.')
                ->withInput();
        }
    }

    /**
     * Remove the specified role from web request.
     * حذف دور محدد قادم من طلب ويب
     */
    public function destroy(Role $role)
    {
        // التحقق إذا كان هناك مستخدمون مرتبطون بهذا الدور
        if ($role->users()->exists()) {
            return redirect()->route('data-entry.roles.index') // تأكد من اسم الروت
                ->with('error', 'Cannot delete role. Users are assigned to this role.');
        }

        // (اختياري) منع حذف الأدوار الأساسية
        // $coreRoles = ['admin', 'hod', 'instructor', 'student'];
        // if (in_array($role->name, $coreRoles)) {
        //     return redirect()->route('data-entry.roles.index')
        //                      ->with('error', 'Cannot delete core system roles.');
        // }

        // 1. Delete from Database
        try {
            $role->delete();
            // 2. Redirect
            return redirect()->route('data-entry.roles.index') // تأكد من اسم الروت
                ->with('success', 'Role deleted successfully.');
        } catch (Exception $e) {
            Log::error('Role Deletion Failed (Web): ' . $e->getMessage());
            return redirect()->route('data-entry.roles.index') // تأكد من اسم الروت
                ->with('error', 'Failed to delete role.');
        }
    }

    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * Display a listing of the roles (API).
     * عرض قائمة الأدوار للـ API
     */
    public function apiIndex(Request $request) // إضافة Request للتحكم بالـ Pagination
    {
        try {
            $roles = Role::latest('id')->get();

            return response()->json([
                'success' => true,
                'data' => $roles
            ], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching roles: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }

    /**
     * Store a newly created role from API request.
     */
    public function apiStore(Request $request)
    {
        // 1. Validation
        $validatedData = $request->validate([
            'name' => 'required|string|max:50|unique:roles,name|alpha_dash',
            'display_name' => 'required|string|max:100',
            'description' => 'nullable|string|max:255',
        ]);
        // $validatedData['name'] = strtolower($validatedData['name']);

        // 2. Add to Database
        try {
            $role = Role::create($validatedData);
            // 3. Return Success JSON Response
            return response()->json([
                'success' => true,
                'data' => $role,
                'message' => 'Role created successfully.'
            ], 201); // 201 Created
        } catch (Exception $e) {
            Log::error('API Role Creation Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to create role.'], 500);
        }
    }

    /**
     * Display the specified role (API).
     */
    public function apiShow(Role $role)
    {
        // dd($role->name);
        return response()->json([
            'success' => true,
            'data' => $role,
        ], 200);
    }
    // Route::get('/role/{id}', [RoomController::class, 'apiShow']);
    // public function apiShow($id) // <-- تستقبل الـ ID فقط (كـ string أو int)
    // {
    //     // تحتاج للبحث عن الموديل يدوياً
    //     $role = Role::find($id); // أو findOrFail($id)

    //     if (!$role) {
    //         return response()->json(['success' => false, 'message' => 'Role not found.'], 404);
    //     }

    //     return response()->json(['success' => true, 'data' => $role], 200);
    // }


    /**
     * Update the specified role from API request.
     */
    public function apiUpdate(Request $request, Role $role)
    {
        // 1. Validation
        $validatedData = $request->validate([
            'name' => [
                'sometimes', // فقط تحقق إذا تم إرسال الحقل
                'required',
                'string',
                'max:50',
                'alpha_dash',
                Rule::unique('roles')->ignore($role->id),
            ],
            'display_name' => 'sometimes|required|string|max:100',
            'description' => 'sometimes|nullable|string|max:255',
        ]);

        // if (isset($validatedData['name'])) {
        //     $validatedData['name'] = strtolower($validatedData['name']);
        // }

        // 2. Update Database
        try {
            $role->update($validatedData);
            // 3. Return Success JSON Response
            return response()->json([
                'success' => true,
                'data' => $role, // إرجاع الدور المحدث
                'message' => 'Role updated successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API Role Update Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to update role.'], 500);
        }
    }

    /**
     * Remove the specified role from API request.
     */
    public function apiDestroy(Role $role)
    {
        // التحقق من المستخدمين المرتبطين
        if ($role->users()->exists()) {
            return response()->json([
                'success' => false,
                'message' => 'Cannot delete role. Users are assigned.'
            ], 409); // 409 Conflict
        }

        // 1. Delete from Database
        try {
            $role->delete();
            // 2. Return Success JSON Response
            return response()->json([
                'success' => true,
                'message' => 'Role deleted successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API Role Deletion Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to delete role.'], 500);
        }
    }
}
-------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\UserController.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Models\Role;
use App\Models\User;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Log; // اختياري
use Illuminate\Validation\Rules\Password; // للتحقق المعقد (اختياري)
use Illuminate\Validation\Rule;
use Exception;

class UserController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================

    /**
     * Display a listing of the users (Web View) with Pagination.
     */
    public function index()
    {
        try {
            // جلب المستخدمين مرتبين بالأحدث مع الدور وتقسيم الصفحات
            $users = User::with('role')->latest()->paginate(15);

            $roles = Role::orderBy('display_name')->get();

            return view('dashboard.data-entry.users', compact('users', 'roles'));
        } catch (Exception $e) {
            Log::error('Error fetching users for web view: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load users.');
        }
    }

    /**
     * Store a newly created user from web request.
     */
    public function store(Request $request)
    {
        // 1. Validation
        $validatedData = $request->validate([
            'name' => 'required|string|max:255',
            'email' => 'required|string|email|max:255|unique:users,email',
            'password' => 'required|string|min:8|confirmed', // أبسط قاعدة
            // 'password' => ['required', 'confirmed', Password::min(8)], // قاعدة أبسط باستخدام Rule
            'role_id' => 'required|integer|exists:roles,id',
            'verify_email' => 'sometimes|boolean', // استخدام sometimes
        ]);

        // 2. Prepare Data
        $data = [
            'name' => $validatedData['name'],
            'email' => $validatedData['email'],
            'password' => Hash::make($validatedData['password']),
            'role_id' => $validatedData['role_id'],
            'email_verified_at' => isset($validatedData['verify_email']) && $validatedData['verify_email'] ? now() : null,
        ];

        // 3. Add to Database
        try {
            User::create($data);
            // 4. Redirect
            return redirect()->route('data-entry.users.index')
                ->with('success', 'User created successfully.');
        } catch (Exception $e) {
            Log::error('User Creation Failed (Web): ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to create user.')
                ->withInput();
        }
    }

    /**
     * Update the specified user from web request.
     */
    public function update(Request $request, User $user)
    {
        // منع تعديل الأدمن الأول
        if ($user->id === 1 && auth()->id() !== 1) {
            return redirect()->route('data-entry.users.index')
                ->with('error', 'Unauthorized action.');
        }

        // 1. Validation
        $validatedData = $request->validate([
            'name' => 'required|string|max:255',
            'email' => 'required|string|email|max:255|unique:users,email,' . $user->id,
            'password' => 'nullable|string|min:8|confirmed', // كلمة المرور اختيارية عند التحديث
            // 'password' => ['nullable', 'confirmed', Password::min(8)],
            'role_id' => [
                'required',
                'integer',
                'exists:roles,id',
                // دالة التحقق لمنع تغيير دور الأدمن الأول
                function ($attribute, $value, $fail) use ($user) {
                    if ($user->id === 1 && Role::find($value)?->name !== 'admin') {
                        $fail('The primary admin role cannot be changed.');
                    }
                },
            ],
            'verify_email' => 'sometimes|boolean',
            'unverify_email' => 'sometimes|boolean',
        ]);

        // 2. Prepare Data for Update
        $data = [
            'name' => $validatedData['name'],
            'email' => $validatedData['email'],
        ];

        // إضافة الدور فقط إذا لم يكن الأدمن الأول أو لم يتغير دوره
        if ($user->id !== 1 || $validatedData['role_id'] == $user->role_id) {
            $data['role_id'] = $validatedData['role_id'];
        } else {
            // تجاهل تغيير الدور للأدمن الأول (يمكن إضافة رسالة تحذير)
            session()->flash('warning', 'Primary admin role cannot be changed.');
        }

        // إضافة كلمة المرور فقط إذا تم إدخالها
        if (!empty($validatedData['password'])) {
            $data['password'] = Hash::make($validatedData['password']);
        }

        // تحديث حالة تأكيد الإيميل
        if (isset($validatedData['unverify_email']) && $validatedData['unverify_email']) {
            $data['email_verified_at'] = null;
        } elseif (isset($validatedData['verify_email']) && $validatedData['verify_email']) {
            $data['email_verified_at'] = now();
        }

        // 3. Update Database
        try {
            $user->update($data);
            // 4. Redirect
            return redirect()->route('data-entry.users.index') // تأكد من اسم الروت
                ->with('success', 'User updated successfully.');
        } catch (Exception $e) {
            Log::error('User Update Failed (Web): ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to update user.')
                ->withInput();
        }
    }

    /**
     * Remove the specified user from web request.
     */
    public function destroy(User $user)
    {
        // منع حذف الأدمن الأول أو المستخدم الحالي
        if ($user->id === 1) {
            return redirect()->route('data-entry.users.index')
                ->with('error', 'The primary admin user cannot be deleted.');
        }
        if ($user->id === auth()->id()) {
            return redirect()->route('data-entry.users.index')
                ->with('error', 'You cannot delete your own account.');
        }

        // 1. Delete from Database
        try {
            $user->delete(); // هذا سيضبط user_id في instructors إلى null بسبب onDelete('set null')
            // 2. Redirect
            return redirect()->route('data-entry.users.index')
                ->with('success', 'User deleted successfully.');
        } catch (Exception $e) {
            Log::error('User Deletion Failed (Web): ' . $e->getMessage());
            return redirect()->route('data-entry.users.index')
                ->with('error', 'Failed to delete user.');
        }
    }


    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * Display a listing of the users (API).
     * عرض قائمة المستخدمين للـ API (بدون Pagination حالياً)
     */
    public function apiIndex(Request $request)
    {
        try {
            $query = User::with('role:id,name,display_name'); // تحميل الدور مع حقول محددة

            // (اختياري) فلترة
            if ($request->has('role_id')) {
                $query->where('role_id', $request->role_id);
            }
            // if ($request->has('q')) { // بحث بالاسم أو الإيميل
            //     $searchTerm = $request->q;
            //     $query->where(function ($q) use ($searchTerm) {
            //         $q->where('name', 'like', "%{$searchTerm}%")
            //           ->orWhere('email', 'like', "%{$searchTerm}%");
            //     });
            // }

            // --- الخيار 1: جلب كل المستخدمين (الحالة الحالية) ---
            $users = $query->latest('id') // الترتيب بالأحدث
                ->get(['id', 'name', 'email', 'role_id', 'email_verified_at', 'created_at']); // تحديد الحقول

            // --- الخيار 2: كود الـ Pagination للـ API (معطل حالياً) ---
            /*
            $perPage = $request->query('per_page', 15);
            $usersPaginated = $query->latest('id')
                                    ->paginate($perPage, ['id', 'name', 'email', 'role_id', 'email_verified_at', 'created_at']);

            // نحتاج لتحميل الدور يدوياً بعد الـ pagination
            // $usersPaginated->load('role:id,name,display_name');

            return response()->json([
                'success' => true,
                'data' => $usersPaginated->items(),
                'pagination' => [
                    'total' => $usersPaginated->total(),
                    'per_page' => $usersPaginated->perPage(),
                    'current_page' => $usersPaginated->currentPage(),
                    'last_page' => $usersPaginated->lastPage(),
                ]
            ], 200);
            */
            // --- نهاية كود الـ Pagination المعطل ---


            return response()->json(['success' => true, 'data' => $users], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching users: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }

    /**
     * Store a newly created user from API request.
     * تخزين مستخدم جديد قادم من طلب API
     */
    public function apiStore(Request $request)
    {
        // 1. Validation
        $validatedData = $request->validate([
            'name' => 'required|string|max:255',
            'email' => 'required|string|email|max:255|unique:users,email',
            'password' => 'required|string|min:8', // لا نحتاج confirmed في الـ API عادةً
            'role_id' => 'required|integer|exists:roles,id',
            'verify_email' => 'sometimes|boolean',
        ]);

        // 2. Prepare Data
        $data = [
            'name' => $validatedData['name'],
            'email' => $validatedData['email'],
            'password' => Hash::make($validatedData['password']),
            'role_id' => $validatedData['role_id'],
            'email_verified_at' => isset($validatedData['verify_email']) && $validatedData['verify_email'] ? now() : null,
        ];

        // 3. Add to Database
        try {
            $user = User::create($data);
            $user->load('role:id,name,display_name'); // تحميل الدور لعرضه
            // 4. Return Success JSON Response
            return response()->json([
                'success' => true,
                'data' => $user,
                'message' => 'User created successfully.'
            ], 201);
        } catch (Exception $e) {
            Log::error('API User Creation Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to create user.'], 500);
        }
    }

    /**
     * Display the specified user (API).
     */
    public function apiShow(User $user)
    {
        $user->load('role:id,name,display_name'); // تحميل الدور
        // $user->load('instructor:id,instructor_no');
        return response()->json([
            'success' => true,
            'data' => $user,
        ], 200);
    }

    /**
     * Update the specified user from API request.
     */
    public function apiUpdate(Request $request, User $user)
    {
        // منع تعديل الأدمن الأول (حماية بسيطة)
        if ($user->id === 1 && auth()->id() !== 1) { // افترض أن المصادقة تعمل
            return response()->json(['success' => false, 'message' => 'Unauthorized action.'], 403); // 403 Forbidden
        }

        // 1. Validation
        $validatedData = $request->validate([
            'name' => 'sometimes|required|string|max:255',
            'email' => [
                'sometimes',
                'required',
                'string',
                'email',
                'max:255',
                'unique:users,email,' . $user->id,
            ],
            'password' => 'sometimes|nullable|string|min:8', // كلمة المرور اختيارية
            'role_id' => [
                'sometimes',
                'required',
                'integer',
                'exists:roles,id',
                function ($attribute, $value, $fail) use ($user) {
                    if ($user->id === 1 && Role::find($value)?->name !== 'admin') {
                        $fail('The primary admin role cannot be changed.');
                    }
                },
            ],
            'verify_email' => 'sometimes|boolean',
            'unverify_email' => 'sometimes|boolean',
        ]);

        // 2. Prepare Data for Update
        $data = [];
        if (isset($validatedData['name'])) $data['name'] = $validatedData['name'];
        if (isset($validatedData['email'])) $data['email'] = $validatedData['email'];
        if (isset($validatedData['role_id']) && ($user->id !== 1 || $validatedData['role_id'] == $user->role_id)) {
            $data['role_id'] = $validatedData['role_id'];
        }
        if (!empty($validatedData['password'])) {
            $data['password'] = Hash::make($validatedData['password']);
        }
        if (isset($validatedData['unverify_email']) && $validatedData['unverify_email']) {
            $data['email_verified_at'] = null;
        } elseif (isset($validatedData['verify_email']) && $validatedData['verify_email']) {
            $data['email_verified_at'] = now();
        }


        // 3. Update Database
        try {
            // فقط قم بالتحديث إذا كان هناك بيانات للتحديث
            if (!empty($data)) {
                $user->update($data);
            }
            $user->load('role:id,name,display_name'); // تحميل الدور بعد التحديث
            // 4. Return Success JSON Response
            return response()->json([
                'success' => true,
                'data' => $user,
                'message' => 'User updated successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API User Update Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to update user.'], 500);
        }
    }

    /**
     * Remove the specified user from API request.
     */
    public function apiDestroy(User $user)
    {
        // منع حذف الأدمن الأول أو المستخدم الحالي (إذا كانت المصادقة مفعلة)
        if ($user->id === 1) {
            return response()->json(['success' => false, 'message' => 'Primary admin cannot be deleted.'], 403);
        }
        if ($user->id === auth()->id()) { // افترض أن المصادقة تعمل
            return response()->json(['success' => false, 'message' => 'You cannot delete your own account.'], 403);
        }

        // 1. Delete from Database
        try {
            $user->delete();
            // 2. Return Success JSON Response
            return response()->json([
                'success' => true,
                'message' => 'User deleted successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API User Deletion Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to delete user.'], 500);
        }
    }
}
----------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\DepartmentController.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Models\Department;
use Illuminate\Http\Request; // استيراد Request
use Illuminate\Support\Facades\Log; // لاستخدام اللوغ (اختياري لكن مفيد)
use Exception; // لاستخدام Exception في الـ catch
use Maatwebsite\Excel\Facades\Excel; // *** استيراد Excel Facade ***
use Illuminate\Support\Collection;   // *** استيراد Collection ***
use Illuminate\Support\Facades\Validator; // لاستخدام Validator يدوياً

class DepartmentController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================

    /**
     * Display a listing of the departments (Web View).
     */
    public function index()
    {
        // جلب كل الأقسام مرتبة بالاسم
        // $departments = Department::orderBy('department_name')->get();
        $departments = Department::latest()->paginate(10);
        // إرسال البيانات إلى الـ view
        return view('dashboard.data-entry.departments', compact('departments'));
    }

    /**
     * Store a newly created department from web request.
     */
    public function store(Request $request)
    {
        // 1. التحقق من البيانات (Validation) - بسيط ومباشر
        $request->validate([
            'department_no' => 'required|string|max:20|unique:departments,department_no',
            'department_name' => 'required|string|max:255',
        ]);

        // 2. تجهيز البيانات (لا حاجة لمعالجة خاصة هنا)
        $data = $request->only(['department_no', 'department_name']);

        // 3. إضافة للـ Database باستخدام ::create
        try {
            Department::create($data);
            // 4. إعادة التوجيه لصفحة العرض مع رسالة نجاح
            return redirect()->route('data-entry.departments.index') // تأكد أن اسم الروت صحيح
                ->with('success', 'Department created successfully.');
        } catch (Exception $e) {
            // تسجيل الخطأ للمطور (اختياري)
            Log::error('Department Creation Failed (Web): ' . $e->getMessage());
            // 4. إعادة التوجيه للصفحة السابقة مع رسالة خطأ وإرجاع المدخلات
            return redirect()->back()
                ->with('error', 'Failed to create department.')
                ->withInput();
        }
    }

    /**
     * Update the specified department from web request.
     * (نستخدم Route Model Binding هنا لجلب $department تلقائياً)
     */
    public function update(Request $request, Department $department)
    {
        // 1. التحقق من البيانات (Validation) - مع تجاهل الصف الحالي لـ unique
        $request->validate([
            'department_no' => 'required|string|max:20|unique:departments,department_no,' . $department->id,
            'department_name' => 'required|string|max:255',
        ]);

        // 2. تجهيز البيانات
        $data = $request->only(['department_no', 'department_name']);

        // 3. تحديث في الـ Database باستخدام ->update()
        try {
            $department->update($data);
            // 4. إعادة التوجيه لصفحة العرض مع رسالة نجاح
            return redirect()->route('data-entry.departments.index') // تأكد أن اسم الروت صحيح
                ->with('success', 'Department updated successfully.');
        } catch (Exception $e) {
            // تسجيل الخطأ (اختياري)
            Log::error('Department Update Failed (Web): ' . $e->getMessage());
            // 4. إعادة التوجيه للصفحة السابقة مع رسالة خطأ وإرجاع المدخلات
            return redirect()->back()
                ->with('error', 'Failed to update department.')
                ->withInput();
        }
    }

    /**
     * Remove the specified department from web request.
     */
    public function destroy(Department $department)
    {
        // (اختياري) التحقق من السجلات المرتبطة قبل الحذف
        if ($department->instructors()->exists() || $department->subjects()->exists() || $department->plans()->exists()) {
            return redirect()->route('data-entry.departments.index') // تأكد أن اسم الروت صحيح
                ->with('error', 'Cannot delete department. It has associated records.');
        }

        // 1. حذف من الـ Database باستخدام ->delete()
        try {
            $department->delete();
            // 2. إعادة التوجيه لصفحة العرض مع رسالة نجاح
            return redirect()->route('data-entry.departments.index') // تأكد أن اسم الروت صحيح
                ->with('success', 'Department deleted successfully.');
        } catch (Exception $e) {
            // تسجيل الخطأ (اختياري)
            Log::error('Department Deletion Failed (Web): ' . $e->getMessage());
            // 2. إعادة التوجيه لصفحة العرض مع رسالة خطأ
            return redirect()->route('data-entry.departments.index') // تأكد أن اسم الروت صحيح
                ->with('error', 'Failed to delete department.');
        }
    }


    /**
     * Handle bulk upload of departments from Excel file.
     */
    public function bulkUpload(Request $request)
    {
        // 1. التحقق من الملف المرفوع
        $request->validate([
            'department_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:2048', // 2MB max
        ], [], ['department_excel_file' => 'Excel file']); // اسم مخصص للحقل في رسائل الخطأ

        try {
            // 2. قراءة البيانات من ملف الإكسل
            // withHeadingRow: يفترض أن الصف الأول هو العناوين
            // mapInto: يحاول تحويل كل صف لمصفوفة (يمكن استخدام ToCollection أيضاً)
            $rows = Excel::toCollection(collect(), $request->file('department_excel_file'))->first();

            if ($rows->isEmpty()) {
                return redirect()->route('data-entry.departments.index')
                    ->with('error', 'The uploaded Excel file is empty or has no data rows.');
            }

            $createdCount = 0;
            $updatedCount = 0;
            $skippedRows = 0;
            $processedRows = collect(); // لتتبع الأرقام والأسماء التي تمت معالجتها من الملف لتجنب التكرار داخل الملف
            $skippedDetails = [];

            // الحصول على الصف الأول كعناوين (بتحويلها لـ snake_case ومتوافقة مع DB)
            $header = $rows->first()->map(function ($item) {
                return strtolower(str_replace(' ', '_', $item));
            });

            // إزالة صف العناوين من البيانات
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                // تحويل الصف الحالي لمصفوفة باستخدام العناوين كمفاتيح
                $row = $header->combine($rowArray);

                $departmentNo = trim($row->get('department_no', '')); // القيمة من عمود B
                $departmentName = trim($row->get('department_name', '')); // القيمة من عمود C

                // 1. تجاهل الأسطر الفارغة تماماً (إذا كان الرقم والاسم فارغين)
                if (empty($departmentNo) && empty($departmentName)) {
                    $skippedRows++;
                    $skippedDetails[] = "Row " . ($rowKey + 2) . ": Skipped because both department_no and department_name are empty.";
                    continue;
                }

                // 2. تجاهل الأسطر التي قد تكون مدمجة أو لا تحتوي على البيانات المطلوبة
                // (نفترض أن department_no أو department_name يجب أن يكون موجوداً)
                if (empty($departmentNo) || empty($departmentName)) {
                    Log::warning("Skipping row " . ($rowKey + 1) . " due to missing department_no or department_name.", $row->toArray());
                    $skippedRows++;
                    $skippedDetails[] = "Row " . ($rowKey + 2) . ": Missing department_no or department_name.";
                    continue;
                }


                // 4. فحص التكرار داخل الملف نفسه (بناءً على department_no)
                if ($processedRows->contains('department_no', $departmentNo)) {
                    Log::info("Skipping duplicate department_no '{$departmentNo}' from Excel file (already processed).");
                    $skippedRows++;
                    $skippedDetails[] = "Row " . ($rowKey + 2) . ": Duplicate department_no '{$departmentNo}' in file.";
                    continue;
                }
                // أو بناءً على department_name إذا كان يجب أن يكون فريداً أيضاً
                if ($processedRows->contains('department_name', $departmentName)) {
                    Log::info("Skipping duplicate department_name '{$departmentName}' from Excel file (already processed).");
                    $skippedRows++;
                    $skippedDetails[] = "Row " . ($rowKey + 2) . ": Duplicate department_name '{$departmentName}' in file.";
                    continue;
                }


                // 3. البحث عن القسم في قاعدة البيانات وتحديثه أو إنشاؤه
                // البحث برقم القسم أولاً (لأنه يفترض أن يكون فريداً وأساسياً)
                $department = Department::where('department_no', $departmentNo)->first();

                if ($department) {
                    // القسم موجود، قم بالتحديث (فقط إذا كان الاسم مختلفاً)
                    if ($department->department_name !== $departmentName) {
                        $department->department_name = $departmentName;
                        $department->save();
                        $updatedCount++;
                    }
                } else {
                    // القسم غير موجود برقم القسم، ابحث بالاسم (احتياطي)
                    $departmentByName = Department::where('department_name', $departmentName)->first();
                    if ($departmentByName) {
                        // وجد بالاسم، قم بتحديث رقمه إذا كان مختلفاً
                        if ($departmentByName->department_no !== $departmentNo) {
                            $departmentByName->department_no = $departmentNo; // تحديث الرقم
                            $departmentByName->save();
                        }
                        $updatedCount++;
                        $department = $departmentByName; // استخدم هذا القسم لتتبع المعالج
                    } else {
                        // القسم غير موجود لا بالرقم ولا بالاسم، قم بإنشاء جديد
                        Department::create([
                            'department_no' => $departmentNo,
                            'department_name' => $departmentName,
                        ]);
                        $createdCount++;
                    }
                }
                // إضافة للبيانات التي تمت معالجتها من الملف
                $processedRows->push(['department_no' => $departmentNo, 'department_name' => $departmentName]);
            }

            $message = "Bulk upload completed. ";
            if ($createdCount > 0) $message .= "{$createdCount} new departments created. ";
            if ($updatedCount > 0) $message .= "{$updatedCount} departments updated. ";
            if ($skippedRows > 0) $message .= "{$skippedRows} rows skipped (empty or duplicate within file).";

            return redirect()->route('data-entry.departments.index')
                ->with('success', $message)
                ->with('skipped_details', $skippedDetails);
        } catch (Exception $e) {
            Log::error('Department Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return redirect()->route('data-entry.departments.index')
                ->with('error', 'An error occurred during bulk upload: ' . $e->getMessage());
        }
    }


    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * Display a listing of the departments (API).
     */
    public function apiIndex()
    {
        try {
            $departments = Department::orderBy('department_name')->get(['id', 'department_no', 'department_name']); // جلب حقول محددة
            // إرجاع استجابة JSON ناجحة
            return response()->json([
                'success' => true,
                'data' => $departments,
            ], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching departments: ' . $e->getMessage());
            // إرجاع استجابة JSON للخطأ
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }

    /**
     * Store a newly created department from API request.
     */
    public function apiStore(Request $request)
    {
        // 1. Validation (Laravel يعيد 422 JSON تلقائياً عند الفشل)
        $validatedData = $request->validate([
            'department_no' => 'required|string|max:20|unique:departments,department_no',
            'department_name' => 'required|string|max:255',
        ]);

        // 2. Add to Database
        try {
            // استخدام create وإرجاع الموديل المنشأ مباشرة
            $department = Department::create($validatedData);
            // 3. Return Success JSON Response (201 Created)
            return response()->json([
                'success' => true,
                'data' => $department, // إرجاع القسم المنشأ
                'message' => 'Department created successfully.'
            ], 201);
        } catch (Exception $e) {
            Log::error('API Department Creation Failed: ' . $e->getMessage());
            // 3. Return Error JSON Response
            return response()->json(['success' => false, 'message' => 'Failed to create department.'], 500);
        }
    }

    /**
     * Display the specified department (API).
     * (نستخدم Route Model Binding هنا أيضاً)
     */
    public function apiShow(Department $department)
    {
        // إرجاع القسم مباشرة
        return response()->json([
            'success' => true,
            'data' => $department,
        ], 200);
    }

    /**
     * Update the specified department from API request.
     * تحديث قسم محدد قادم من طلب API
     */
    public function apiUpdate(Request $request, Department $department)
    {
        // 1. Validation (استخدام sometimes لأن API قد يرسل جزءاً من البيانات)
        $validatedData = $request->validate([
            'department_no' => [
                'sometimes', // فقط تحقق إذا كان الحقل موجوداً في الطلب
                'required',
                'string',
                'max:20',
                'unique:departments,department_no,' . $department->id, // تجاهل الصف الحالي
            ],
            'department_name' => 'sometimes|required|string|max:255',
        ]);

        // 2. Update Database
        try {
            // تحديث القسم بالبيانات التي تم التحقق منها فقط
            $department->update($validatedData);
            // 3. Return Success JSON Response
            return response()->json([
                'success' => true,
                'data' => $department, // إرجاع القسم المحدث
                'message' => 'Department updated successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API Department Update Failed: ' . $e->getMessage());
            // 3. Return Error JSON Response
            return response()->json(['success' => false, 'message' => 'Failed to update department.'], 500);
        }
    }

    /**
     * Remove the specified department from API request.
     */
    public function apiDestroy(Department $department)
    {
        // (اختياري) التحقق من السجلات المرتبطة
        if ($department->instructors()->exists() || $department->subjects()->exists() || $department->plans()->exists()) {
            return response()->json([
                'success' => false,
                'message' => 'Cannot delete department due to associated records.'
            ], 409); // 409 Conflict
        }

        // 1. Delete from Database
        try {
            $department->delete();
            // 2. Return Success JSON Response (200 OK or 204 No Content)
            return response()->json([
                'success' => true,
                'message' => 'Department deleted successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API Department Deletion Failed: ' . $e->getMessage());
            // 2. Return Error JSON Response
            return response()->json(['success' => false, 'message' => 'Failed to delete department.'], 500);
        }
    }

    /**
     * Handle bulk upload of departments from Excel file via API.
     */
    public function apiBulkUpload(Request $request)
    {
        // 1. التحقق من الملف المرفوع
        $validator = Validator::make($request->all(), [
            'department_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:2048',
        ], [], ['department_excel_file' => 'Excel file']);

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed.',
                'errors' => $validator->errors()
            ], 422); // Unprocessable Entity
        }

        try {
            $rows = Excel::toCollection(collect(), $request->file('department_excel_file'))->first();

            if ($rows->isEmpty() || $rows->count() <= 1) { // أقل من أو يساوي 1 للتحقق من وجود صف بيانات واحد على الأقل بعد الهيدر
                return response()->json([
                    'success' => false,
                    'message' => 'The uploaded Excel file is empty or contains no data rows after the header.'
                ], 400); // Bad Request
            }

            $createdCount = 0;
            $updatedCount = 0;
            $skippedCount = 0; // لتعداد الصفوف المتجاهلة
            $skippedDetails = []; // لتخزين تفاصيل الصفوف المتجاهلة
            $processedRows = collect();

            $header = $rows->first()->map(fn($item) => strtolower(str_replace(' ', '_', $item ?? '')));
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? ''))); // Trim values

                $departmentNo = $row->get('department_no', '');
                $departmentName = $row->get('department_name', '');
                $currentRowNumber = $rowKey + 2; // رقم الصف الفعلي في الإكسل (مع الهيدر)

                if (empty($departmentNo) && empty($departmentName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped because both department_no and department_name are empty.";
                    continue;
                }
                if (empty($departmentNo) || empty($departmentName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped due to missing department_no or department_name.";
                    continue;
                }
                if ($processedRows->contains('department_no', $departmentNo)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped duplicate department_no '{$departmentNo}' from within this file.";
                    continue;
                }
                if ($processedRows->contains('department_name', $departmentName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped duplicate department_name '{$departmentName}' from within this file.";
                    continue;
                }

                $department = Department::where('department_no', $departmentNo)->first();
                $updatedThisRow = false;

                if ($department) {
                    if ($department->department_name !== $departmentName) {
                        $department->department_name = $departmentName;
                        $department->save();
                        $updatedCount++;
                        $updatedThisRow = true;
                    }
                } else {
                    $departmentByName = Department::where('department_name', $departmentName)->first();
                    if ($departmentByName) {
                        if ($departmentByName->department_no !== $departmentNo) {
                            $departmentByName->department_no = $departmentNo;
                            $departmentByName->save();
                        }
                        $updatedCount++;
                        $updatedThisRow = true;
                        $department = $departmentByName;
                    } else {
                        Department::create([
                            'department_no' => $departmentNo,
                            'department_name' => $departmentName,
                        ]);
                        $createdCount++;
                    }
                }
                if (!$updatedThisRow && $department) { // لم يتم التحديث ولكنه موجود، يعتبر كأنه تمت معالجته
                    // No action needed, just mark as processed if it existed and wasn't updated
                }
                $processedRows->push(['department_no' => $departmentNo, 'department_name' => $departmentName]);
            }

            $summaryMessage = "Bulk upload processed.";
            $responseData = [
                'created_count' => $createdCount,
                'updated_count' => $updatedCount,
                'skipped_count' => $skippedCount,
                'skipped_details' => $skippedDetails,
            ];

            return response()->json([
                'success' => true,
                'message' => $summaryMessage,
                'data' => $responseData
            ], 200); // OK

        } catch (Exception $e) {
            Log::error('API Department Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return response()->json([
                'success' => false,
                'message' => 'An error occurred during bulk upload.',
                'error_details' => $e->getMessage() // إرسال تفاصيل الخطأ (للمطور)
            ], 500); // Internal Server Error
        }
    }
}
---------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\RoomTypeController.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Models\RoomType; // تم استيراده
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\Rule;
use Maatwebsite\Excel\Facades\Excel;
use Exception;
use Illuminate\Support\Facades\Validator;

class RoomTypeController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================

    /**
     * Display a listing of the room types.
     */
    public function index()
    {
        try {
            // تغيير اسم المتغير والموديل والـ view
            $roomTypes = RoomType::latest('id')->paginate(15);
            return view('dashboard.data-entry.room-types', compact('roomTypes'));
        } catch (Exception $e) {
            Log::error('Error fetching room types: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load room types.');
        }
    }

    /**
     * Store a newly created room type in storage.
     */
    public function store(Request $request)
    {
        // 1. Validation (تغيير اسم الحقل والجدول)
        $validatedData = $request->validate([
            'room_type_name' => 'required|string|max:100|unique:rooms_types,room_type_name',
        ]);

        // 2. Prepare Data
        $data = $validatedData;

        // 3. Add to Database
        try {
            RoomType::create($data);
            // 4. Redirect (تغيير الـ route والرسالة)
            return redirect()->route('data-entry.room-types.index')
                ->with('success', 'Room Type created successfully.');
        } catch (Exception $e) {
            Log::error('Room Type Creation Failed: ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to create room type.')
                ->withInput();
        }
    }

    /**
     * Update the specified room type in storage.
     */
    public function update(Request $request, RoomType $roomType) // تغيير المتغير
    {
        // 1. Validation (تغيير اسم الحقل والجدول والمتغير)
        $validatedData = $request->validate([
            'room_type_name' => [
                'required',
                'string',
                'max:100',
                Rule::unique('rooms_types')->ignore($roomType->id),
            ],
        ]);

        // 2. Prepare Data
        $data = $validatedData;

        // 3. Update Database
        try {
            $roomType->update($data);
            // 4. Redirect (تغيير الـ route والرسالة)
            return redirect()->route('data-entry.room-types.index')
                ->with('success', 'Room Type updated successfully.');
        } catch (Exception $e) {
            Log::error('Room Type Update Failed: ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to update room type.')
                ->withInput();
        }
    }

    /**
     * Remove the specified room type from storage.
     */
    public function destroy(RoomType $roomType) // تغيير المتغير
    {
        // التحقق من القاعات المرتبطة
        if ($roomType->rooms()->exists()) {
            return redirect()->route('data-entry.room-types.index')
                ->with('error', 'Cannot delete room type. It is assigned to rooms.');
        }

        // 1. Delete
        try {
            $roomType->delete();
            // 2. Redirect (تغيير الـ route والرسالة)
            return redirect()->route('data-entry.room-types.index')
                ->with('success', 'Room Type deleted successfully.');
        } catch (Exception $e) {
            Log::error('Room Type Deletion Failed: ' . $e->getMessage());
            return redirect()->route('data-entry.room-types.index')
                ->with('error', 'Failed to delete room type.');
        }
    }

    /**
     * Handle bulk upload of room types from Excel file.
     */
    public function bulkUpload(Request $request)
    {
        $request->validate([
            'room_type_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:2048',
        ], [], ['room_type_excel_file' => 'Excel file']);

        try {
            $rows = Excel::toCollection(collect(), $request->file('room_type_excel_file'))->first();

            if ($rows->isEmpty() || $rows->count() <= 1) {
                return redirect()->route('data-entry.room-types.index')
                    ->with('error', 'Uploaded Excel file is empty or has no data rows.');
            }

            $createdCount = 0;
            $skippedCount = 0;
            $skippedDetails = [];
            $processedNames = collect(); // لتتبع الأسماء التي تمت معالجتها من الملف

            $header = $rows->first()->map(fn($item) => strtolower(str_replace(' ', '_', $item ?? '')));
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
                $currentRowNumber = $rowKey + 2;

                $roomTypeName = $row->get('room_type_name', ''); // القيمة من عمود B (أو اسم العمود بعد تحويله لـ snake_case)

                // 1. تجاهل الأسطر الفارغة
                if (empty($roomTypeName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped because room_type_name is empty.";
                    continue;
                }

                // 2. فحص التكرار داخل الملف نفسه
                if ($processedNames->contains($roomTypeName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped duplicate room_type_name '{$roomTypeName}' from within this file.";
                    continue;
                }

                // 3. التحقق من وجود الاسم في قاعدة البيانات (RoomType names should be unique)
                $existingRoomType = RoomType::where('room_type_name', $roomTypeName)->first();

                if ($existingRoomType) {
                    // النوع موجود بالفعل، تجاهله (لا نقوم بالتحديث هنا عادةً، فقط إضافة جديد)
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Room type '{$roomTypeName}' already exists in the system.";
                    $processedNames->push($roomTypeName); // اعتبره معالجاً لتجنب إضافته مرة أخرى من نفس الملف
                    continue;
                }

                // 4. إنشاء نوع قاعة جديد
                RoomType::create([
                    'room_type_name' => $roomTypeName,
                ]);
                $createdCount++;
                $processedNames->push($roomTypeName);
            }

            $message = "Room Types bulk upload processed. ";
            if ($createdCount > 0) $message .= "{$createdCount} new room types created. ";
            if ($skippedCount > 0) $message .= "{$skippedCount} rows skipped. ";

            if (!empty($skippedDetails)) {
                session()->flash('skipped_details', $skippedDetails);
            }

            return redirect()->route('data-entry.room-types.index')->with('success', trim($message));
        } catch (Exception $e) {
            Log::error('Room Type Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return redirect()->route('data-entry.room-types.index')
                ->with('error', 'An error occurred during bulk upload: ' . $e->getMessage());
        }
    }

    // =============================================
    //             API Controller Methods
    // =============================================
    // (قم بإنشاء دوال API بنفس الطريقة إذا احتجتها)

    public function apiIndex()
    {
        try {
            // $types = RoomType::latest('id')->get(['id', 'room_type_name']);
            $types = RoomType::latest()->get();
            return response()->json(['success' => true, 'data' => $types], 200);
        } catch (Exception $e) {
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }
    public function apiStore(Request $request)
    {
        $validatedData = $request->validate(['room_type_name' => 'required|string|max:100|unique:rooms_types,room_type_name']);
        try {
            $type = RoomType::create($validatedData);
            return response()->json(['success' => true, 'data' => $type, 'message' => 'Room Type created.'], 201);
        } catch (Exception $e) { /* ... */
            return response()->json(['success' => false, 'message' => 'Failed to create.'], 500);
        }
    }
    public function apiShow(RoomType $roomType)
    {
        return response()->json(['success' => true, 'data' => $roomType], 200);
    }
    public function apiUpdate(Request $request, RoomType $roomType)
    {
        $validatedData = $request->validate(['room_type_name' => ['required', 'string', 'max:100', Rule::unique('rooms_types')->ignore($roomType->id)]]);
        try {
            $roomType->update($validatedData);
            return response()->json(['success' => true, 'data' => $roomType, 'message' => 'Room Type updated.'], 200);
        } catch (Exception $e) { /* ... */
            return response()->json(['success' => false, 'message' => 'Failed to update.'], 500);
        }
    }
    public function apiDestroy(RoomType $roomType)
    {
        if ($roomType->rooms()->exists()) {
            return response()->json(['success' => false, 'message' => 'Cannot delete: assigned to rooms.'], 409);
        }
        try {
            $roomType->delete();
            return response()->json(['success' => true, 'message' => 'Room Type deleted.'], 200);
        } catch (Exception $e) { /* ... */
            return response()->json(['success' => false, 'message' => 'Failed to delete.'], 500);
        }
    }

    /**
     * Handle bulk upload of room types from Excel file via API.
     */
    public function apiBulkUpload(Request $request)
    {
        // 1. التحقق من الملف المرفوع
        $validator = Validator::make($request->all(), [
            'room_type_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:2048',
        ], [], ['room_type_excel_file' => 'Excel file']);

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed.',
                'errors' => $validator->errors()
            ], 422); // Unprocessable Entity
        }

        try {
            $rows = Excel::toCollection(collect(), $request->file('room_type_excel_file'))->first();

            if ($rows->isEmpty() || $rows->count() <= 1) {
                return response()->json([
                    'success' => false,
                    'message' => 'The uploaded Excel file is empty or contains no data rows after the header.'
                ], 400); // Bad Request
            }

            $createdCount = 0;
            $skippedCount = 0;
            $skippedDetails = [];
            $processedNames = collect();

            $header = $rows->first()->map(fn($item) => strtolower(str_replace(' ', '_', $item ?? '')));
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
                $currentRowNumber = $rowKey + 2;
                $roomTypeName = $row->get('room_type_name', '');

                if (empty($roomTypeName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped because room_type_name is empty.";
                    continue;
                }
                if ($processedNames->contains($roomTypeName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped duplicate room_type_name '{$roomTypeName}' from within this file.";
                    continue;
                }

                $existingRoomType = RoomType::where('room_type_name', $roomTypeName)->first();
                if ($existingRoomType) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Room type '{$roomTypeName}' already exists in the system.";
                    $processedNames->push($roomTypeName);
                    continue;
                }

                RoomType::create(['room_type_name' => $roomTypeName]);
                $createdCount++;
                $processedNames->push($roomTypeName);
            }

            $summaryMessage = "Room Types bulk upload processed.";
            $responseData = [
                'created_count' => $createdCount,
                'skipped_count' => $skippedCount,
                'skipped_details' => $skippedDetails,
            ];

            return response()->json([
                'success' => true,
                'message' => $summaryMessage,
                'data' => $responseData
            ], 200); // OK

        } catch (Exception $e) {
            Log::error('API Room Type Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return response()->json([
                'success' => false,
                'message' => 'An error occurred during bulk upload.',
                'error_details' => $e->getMessage() // للمطور
            ], 500); // Internal Server Error
        }
    }
}
----------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\RoomController.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Models\Room;
use App\Models\RoomType;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\Rule;
use Maatwebsite\Excel\Facades\Excel;
use Exception;
use Illuminate\Support\Facades\Validator;

class RoomController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================

    /**
     * Display a listing of the rooms (Web View) with Pagination.
     */
    public function index()
    {
        try {
            // جلب القاعات مرتبة بالأحدث مع نوعها وتقسيم الصفحات
            $rooms = Room::with('roomType')->latest()->paginate(15);

            // جلب أنواع القاعات للـ dropdown في نموذج الإضافة/التعديل
            $roomTypes = RoomType::orderBy('room_type_name')->get();

            return view('dashboard.data-entry.rooms', compact('rooms', 'roomTypes'));
        } catch (Exception $e) {
            Log::error('Error fetching rooms for web view: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load rooms.');
        }
    }

    /**
     * Store a newly created room from web request.
     */
    public function store(Request $request)
    {
        // 1. Validation
        $data = $request->validate([
            'room_no' => 'required|string|max:20|unique:rooms,room_no',
            'room_name' => 'nullable|string|max:255',
            'room_type_id' => 'required|integer|exists:rooms_types,id',
            'room_size' => 'required|integer|min:1',
            'room_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed'])],
            'room_branch' => 'nullable|string|max:100',
            // 'equipment' => 'nullable|array', // يجب أن يكون مصفوفة إذا تم إرساله
            // 'equipment.*' => 'nullable|string|max:50', // التحقق من كل عنصر
        ]);

        // 2. Prepare Data (تحويل equipment إلى JSON)
        // نستخدم validated() لجلب البيانات التي تم التحقق منها فقط
        // $data = $request->validated();
        // $data['equipment'] = isset($data['equipment']) ? json_encode($data['equipment']) : null;


        // 3. Add to Database
        try {
            Room::create($data);
            // 4. Redirect
            return redirect()->route('data-entry.rooms.index') // تأكد من اسم الروت
                ->with('success', 'Classroom created successfully.');
        } catch (Exception $e) {
            Log::error('Room Creation Failed (Web): ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to create classroom.')
                ->withInput();
        }
    }

    /**
     * Update the specified room from web request.
     */
    public function update(Request $request, Room $room)
    {
        // 1. Validation
        $data = $request->validate([
            'room_no' => 'required|string|max:20|unique:rooms,room_no,' . $room->id,
            'room_name' => 'nullable|string|max:255',
            'room_type_id' => 'required|integer|exists:rooms_types,id',
            'room_size' => 'required|integer|min:1',
            'room_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed'])],
            'room_branch' => 'nullable|string|max:100',
            // 'equipment' => 'nullable|array', // السماح بإرسال مصفوفة فارغة أو null
            // 'equipment.*' => 'nullable|string|max:50',
        ]);

        // 2. Prepare Data for Update (تحويل equipment)
        // $data = $request->validated();
        // التحويل إلى JSON فقط إذا كان equipment موجوداً في الطلب
        // إذا لم يتم إرسال equipment، لن يتم تحديثه في $data
        // if ($request->has('equipment')) {
        //      $data['equipment'] = isset($data['equipment']) ? json_encode($data['equipment']) : null; // null إذا كانت المصفوفة فارغة أو لم يتم إرسالها
        // }


        // 3. Update Database
        try {
            $room->update($data);
            // 4. Redirect
            return redirect()->route('data-entry.rooms.index') // تأكد من اسم الروت
                ->with('success', 'Classroom updated successfully.');
        } catch (Exception $e) {
            Log::error('Room Update Failed (Web): ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to update classroom.')
                ->withInput();
        }
    }

    /**
     * Remove the specified room from web request.
     */
    public function destroy(Room $room)
    {
        // (اختياري) التحقق من السجلات المرتبطة
        // if ($room->scheduleEntries()->exists()) { ... }

        // 1. Delete from Database
        try {
            $room->delete();
            // 2. Redirect
            return redirect()->route('data-entry.rooms.index') // تأكد من اسم الروت
                ->with('success', 'Classroom deleted successfully.');
        } catch (Exception $e) {
            Log::error('Room Deletion Failed (Web): ' . $e->getMessage());
            return redirect()->route('data-entry.rooms.index') // تأكد من اسم الروت
                ->with('error', 'Failed to delete classroom.');
        }
    }


    /**
     * Handle bulk upload of rooms from Excel file.
     */
    // public function bulkUpload(Request $request)
    // {
    //     $request->validate([
    //         'room_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:2048',
    //     ], [], ['room_excel_file' => 'Excel file']);

    //     try {
    //         $rows = Excel::toCollection(collect(), $request->file('room_excel_file'))->first();

    //         if ($rows->isEmpty() || $rows->count() <= 1) {
    //             return redirect()->route('data-entry.rooms.index')
    //                 ->with('error', 'Uploaded Excel file is empty or has no data rows.');
    //         }

    //         $createdCount = 0;
    //         $updatedCount = 0;
    //         $skippedCount = 0;
    //         $skippedDetails = [];
    //         $processedRoomNos = collect(); // لتتبع room_no داخل الملف

    //         $header = $rows->first()->map(fn($item) => strtolower(str_replace(' ', '_', $item ?? '')));
    //         $dataRows = $rows->slice(1);

    //         // القيم المسموحة لـ room_gender (لتطابق الـ enum في قاعدة البيانات)
    //         $allowedGenders = ['Male', 'Female', 'Mixed', 'مختلط', 'ذكور', 'إناث'];
    //         $genderMap = [ // لتوحيد القيم العربية للإنجليزية إذا لزم الأمر
    //             'مختلط' => 'Mixed',
    //             'ذكور' => 'Male',
    //             'إناث' => 'Female',
    //         ];


    //         foreach ($dataRows as $rowKey => $rowArray) {
    //             $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
    //             $currentRowNumber = $rowKey + 2;

    //             $roomNo = $row->get('room_no');
    //             $roomName = $row->get('room_name');
    //             $roomSize = $row->get('room_size');
    //             $roomGenderExcel = $row->get('room_gender');
    //             $roomBranch = $row->get('room_branch');
    //             $roomTypeId = $row->get('room_type_id');
    //             // $equipmentExcel = $row->get('equipment'); // معطل حالياً

    //             // 1. تجاهل الأسطر الفارغة تماماً
    //             if (empty($roomNo) && empty($roomName)) {
    //                 $skippedCount++;
    //                 $skippedDetails[] = "Row {$currentRowNumber}: Skipped (empty room_no and room_name).";
    //                 continue;
    //             }

    //             // 2. التحقق من الحقول المطلوبة مبدئياً
    //             if (empty($roomNo) || empty($roomName) || !isset($roomSize) || empty($roomGenderExcel) || !isset($roomTypeId)) {
    //                 $skippedCount++;
    //                 $skippedDetails[] = "Row {$currentRowNumber}: Skipped due to missing required data (No, Name, Size, Gender, or Type ID).";
    //                 continue;
    //             }

    //             // التحقق من القيم العددية
    //             if (!is_numeric($roomSize) || (int)$roomSize <= 0) {
    //                 $skippedCount++;
    //                 $skippedDetails[] = "Row {$currentRowNumber}: Skipped due to invalid room_size '{$roomSize}'. Must be a positive number.";
    //                 continue;
    //             }
    //             if (!is_numeric($roomTypeId) || !RoomType::find((int)$roomTypeId)) {
    //                 $skippedCount++;
    //                 $skippedDetails[] = "Row {$currentRowNumber}: Skipped due to invalid or non-existent room_type_id '{$roomTypeId}'.";
    //                 continue;
    //             }

    //             // توحيد قيم room_gender
    //             $roomGenderDB = $genderMap[trim($roomGenderExcel)] ?? trim($roomGenderExcel);
    //             if (!in_array($roomGenderDB, ['Male', 'Female', 'Mixed'])) {
    //                 $skippedCount++;
    //                 $skippedDetails[] = "Row {$currentRowNumber}: Skipped due to invalid room_gender '{$roomGenderExcel}'. Allowed: Male, Female, Mixed.";
    //                 continue;
    //             }


    //             // 4. فحص التكرار داخل الملف نفسه (بناءً على room_no)
    //             if ($processedRoomNos->contains($roomNo)) {
    //                 $skippedCount++;
    //                 $skippedDetails[] = "Row {$currentRowNumber}: Skipped duplicate room_no '{$roomNo}' from within this file.";
    //                 continue;
    //             }

    //             // بيانات القاعة للتخزين/التحديث
    //             $roomData = [
    //                 'room_name' => $roomName,
    //                 'room_size' => (int)$roomSize,
    //                 'room_gender' => $roomGenderDB,
    //                 'room_branch' => empty($roomBranch) ? null : $roomBranch,
    //                 'room_type_id' => (int)$roomTypeId,
    //                 // 'equipment' => $equipmentExcel ? json_encode(explode(',', $equipmentExcel)) : null, // معطل
    //             ];

    //             // 3. البحث عن القاعة في قاعدة البيانات وتحديثها أو إنشاؤها
    //             $room = Room::where('room_no', $roomNo)->first();

    //             if ($room) {
    //                 // القاعة موجودة، قم بالتحديث
    //                 $room->update($roomData);
    //                 $updatedCount++;
    //             } else {
    //                 // القاعة غير موجودة، قم بإنشاء جديد
    //                 $roomData['room_no'] = $roomNo; // إضافة room_no للإنشاء
    //                 Room::create($roomData);
    //                 $createdCount++;
    //             }
    //             $processedRoomNos->push($roomNo);
    //         }

    //         $message = "Rooms bulk upload processed. ";
    //         if ($createdCount > 0) $message .= "{$createdCount} new rooms created. ";
    //         if ($updatedCount > 0) $message .= "{$updatedCount} rooms updated. ";
    //         if ($skippedCount > 0) $message .= "{$skippedCount} rows skipped. ";

    //         if (!empty($skippedDetails)) {
    //             session()->flash('skipped_details', $skippedDetails);
    //         }

    //         return redirect()->route('data-entry.rooms.index')->with('success', trim($message));
    //     } catch (Exception $e) {
    //         Log::error('Room Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
    //         return redirect()->route('data-entry.rooms.index')
    //             ->with('error', 'An error occurred during bulk upload: ' . $e->getMessage());
    //     }
    // }
    /**
     * Handle bulk upload of rooms from Excel file.
     */
    public function bulkUpload(Request $request)
    {
        $request->validate([
            'room_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:2048',
        ], [], ['room_excel_file' => 'Excel file']);

        try {
            $rows = Excel::toCollection(collect(), $request->file('room_excel_file'))->first();

            if ($rows->isEmpty() || $rows->count() <= 1) {
                return redirect()->route('data-entry.rooms.index')
                    ->with('error', 'Uploaded Excel file is empty or has no data rows.');
            }

            $createdCount = 0;
            $updatedCount = 0;
            $skippedCount = 0;
            $skippedDetails = [];
            $processedRoomNos = collect(); // لتتبع room_no التي تمت معالجتها من الملف

            $header = $rows->first()->map(fn($item) => strtolower(str_replace(' ', '_', $item ?? '')));
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
                $currentRowNumber = $rowKey + 2;

                $roomNo = $row->get('room_no');
                $roomName = $row->get('room_name');
                $roomSize = $row->get('room_size');
                $roomGender = $row->get('room_gender'); // سيتم التحقق منه
                $roomBranch = $row->get('room_branch');
                $roomTypeId = $row->get('room_type_id');
                // $equipment = $row->get('equipment'); // معطل حالياً

                // 1. تجاهل الأسطر الفارغة (إذا كان room_no فارغاً)
                if (empty($roomNo)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped because room_no is empty.";
                    continue;
                }

                // 2. (اختياري) تجاهل الأسطر المدمجة (نفس منطق الفارغة إذا لم تكن البيانات الأساسية موجودة)

                // 4. فحص التكرار داخل الملف نفسه بناءً على room_no
                if ($processedRoomNos->contains($roomNo)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped duplicate room_no '{$roomNo}' from within this file.";
                    continue;
                }

                // التحقق من صحة البيانات المدخلة للسطر الحالي
                $rowData = [
                    'room_no' => $roomNo,
                    'room_name' => $roomName,
                    'room_size' => $roomSize,
                    'room_gender' => $roomGender,
                    'room_branch' => $roomBranch,
                    'room_type_id' => $roomTypeId,
                    // 'equipment' => $equipment, // معطل
                ];

                $rowValidator = Validator::make($rowData, [
                    'room_no' => 'required|string|max:20', // لا نتحقق من unique هنا لأننا سنقوم بـ updateOrCreate
                    'room_name' => 'nullable|string|max:255',
                    'room_size' => 'required|integer|min:1',
                    'room_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed', 'مختلط', 'ذكور', 'إناث'])], // إضافة القيم العربية المحتملة
                    'room_branch' => 'nullable|string|max:100',
                    'room_type_id' => 'required|integer|exists:rooms_types,id',
                    // 'equipment' => 'nullable|string', // إذا كان نصاً مفصولاً بفواصل، أو array إذا كان Excel يدعم
                ]);

                if ($rowValidator->fails()) {
                    $skippedCount++;
                    $errors = implode(', ', $rowValidator->errors()->all());
                    $skippedDetails[] = "Row {$currentRowNumber} (RoomNo: {$roomNo}): Skipped due to validation errors - {$errors}";
                    continue;
                }

                // تحويل القيم العربية لـ room_gender إلى الإنجليزية
                $genderMapping = ['مختلط' => 'Mixed', 'ذكور' => 'Male', 'إناث' => 'Female'];
                $englishGender = $genderMapping[strtolower($roomGender)] ?? ucfirst(strtolower($roomGender)); // تحويل + قيمة افتراضية
                if (!in_array($englishGender, ['Male', 'Female', 'Mixed'])) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber} (RoomNo: {$roomNo}): Skipped due to invalid room_gender value '{$roomGender}'.";
                    continue;
                }
                $validatedRowData = $rowValidator->validated();
                $validatedRowData['room_gender'] = $englishGender;

                // إذا كان equipment مفعلاً ويأتي كنص مفصول بفواصل
                // if (isset($validatedRowData['equipment']) && is_string($validatedRowData['equipment'])) {
                //     $validatedRowData['equipment'] = json_encode(array_map('trim', explode(',', $validatedRowData['equipment'])));
                // } else {
                //     $validatedRowData['equipment'] = null;
                // }


                // 3. البحث عن القاعة في قاعدة البيانات وتحديثها أو إنشاؤها
                // updateOrCreate تبحث عن سجل بالـ room_no، إذا وجدته تحدثه، وإلا تنشئ جديداً
                $room = Room::updateOrCreate(
                    ['room_no' => $validatedRowData['room_no']], // الشرط للبحث
                    [ // البيانات للتحديث أو الإنشاء
                        'room_name' => $validatedRowData['room_name'],
                        'room_size' => $validatedRowData['room_size'],
                        'room_gender' => $validatedRowData['room_gender'],
                        'room_branch' => $validatedRowData['room_branch'],
                        'room_type_id' => $validatedRowData['room_type_id'],
                        // 'equipment' => $validatedRowData['equipment'], // معطل
                    ]
                );

                if ($room->wasRecentlyCreated) {
                    $createdCount++;
                } elseif ($room->wasChanged()) { // للتحقق إذا تم تحديث أي حقل فعلاً
                    $updatedCount++;
                } else {
                    // لم يتم إنشاؤه ولم يتغير (موجود بنفس البيانات)
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber} (RoomNo: {$roomNo}): Data already up-to-date.";
                }
                $processedRoomNos->push($roomNo);
            }

            $message = "Classrooms bulk upload processed. ";
            if ($createdCount > 0) $message .= "{$createdCount} new classrooms created. ";
            if ($updatedCount > 0) $message .= "{$updatedCount} classrooms updated. ";
            if ($skippedCount > 0) $message .= "{$skippedCount} rows skipped. ";

            if (!empty($skippedDetails)) {
                session()->flash('skipped_details', $skippedDetails);
            }

            return redirect()->route('data-entry.rooms.index')->with('success', trim($message));
        } catch (Exception $e) {
            Log::error('Room Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return redirect()->route('data-entry.rooms.index')
                ->with('error', 'An error occurred during bulk upload: ' . $e->getMessage());
        }
    }


    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * Display a listing of the rooms (API).
     */
    public function apiIndex(Request $request)
    {
        try {
            $query = Room::with('roomType:id,room_type_name');

            $rooms = $query->latest()->get(); // الترتيب بالأحدث

            // Pagination للـ API (معطل حالياً)
            /*
            $perPage = $request->query('per_page', 15);
            $roomsPaginated = $query->latest('id')->paginate($perPage);

            return response()->json([
                'success' => true,
                'data' => $roomsPaginated->items(),
                'pagination' => [
                    'total' => $roomsPaginated->total(),
                    'per_page' => $roomsPaginated->perPage(),
                    'current_page' => $roomsPaginated->currentPage(),
                    'last_page' => $roomsPaginated->lastPage(),
                ]
            ], 200);
            */
            // --- نهاية كود الـ Pagination المعطل ---


            return response()->json(['success' => true, 'data' => $rooms], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching rooms: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }

    /**
     * Store a newly created room from API request.
     */
    public function apiStore(Request $request)
    {
        // 1. Validation
        $validatedData = $request->validate([
            'room_no' => 'required|string|max:20|unique:rooms,room_no',
            'room_name' => 'nullable|string|max:255',
            'room_type_id' => 'required|integer|exists:rooms_types,id',
            'room_size' => 'required|integer|min:1',
            'room_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed'])],
            'room_branch' => 'nullable|string|max:100',
            // 'equipment' => 'nullable|array',
            // 'equipment.*' => 'nullable|string|max:50',
        ]);

        // 2. Prepare Data (تحويل equipment)
        $data = $validatedData;
        // $data['equipment'] = isset($data['equipment']) ? json_encode($data['equipment']) : null;

        // 3. Add to Database
        try {
            $room = Room::create($data);
            $room->load('roomType:id,room_type_name'); // تحميل العلاقة للـ response
            return response()->json([
                'success' => true,
                'data' => $room,
                'message' => 'Classroom created successfully.'
            ], 201);
        } catch (Exception $e) {
            Log::error('API Room Creation Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to create classroom.'], 500);
        }
    }

    /**
     * Display the specified room (API).
     */
    public function apiShow(Room $room)
    {
        $room->load('roomType');
        // $room->load('roomType:id,room_type_name');
        return response()->json(['success' => true, 'data' => $room], 200);
    }

    /**
     * Update the specified room from API request.
     */
    public function apiUpdate(Request $request, Room $room)
    {
        // 1. Validation
        $data = $request->validate([
            'room_no' => [
                'sometimes',
                'required',
                'string',
                'max:20',
                'unique:rooms,room_no,' . $room->id,
            ],
            'room_name' => 'sometimes|nullable|string|max:255',
            'room_type_id' => 'sometimes|required|integer|exists:rooms_types,id',
            'room_size' => 'sometimes|required|integer|min:1',
            'room_gender' => ['sometimes', 'required', Rule::in(['Male', 'Female', 'Mixed'])],
            'room_branch' => 'sometimes|nullable|string|max:100',
            // 'equipment' => 'sometimes|nullable|array', // السماح بإرسال null أو مصفوفة فارغة
            // 'equipment.*' => 'nullable|string|max:50',
        ]);

        // 2. Prepare Data for Update
        // $data = $validatedData;
        // التحديث الشرطي للـ equipment
        // if ($request->has('equipment')) {
        //      $data['equipment'] = isset($validatedData['equipment']) ? json_encode($validatedData['equipment']) : null;
        // }

        // 3. Update Database
        try {
            $room->update($data);
            $room->load('roomType:id,room_type_name'); // تحميل العلاقة بعد التحديث

            return response()->json([
                'success' => true,
                'data' => $room,
                'message' => 'Classroom updated successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API Room Update Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to update classroom.'], 500);
        }
    }

    /**
     * Remove the specified room from API request.
     */
    public function apiDestroy(Room $room)
    {
        // (اختياري) التحقق من السجلات المرتبطة
        // if ($room->scheduleEntries()->exists()) { ... }

        // 1. Delete from Database
        try {
            $room->delete();
            // 2. Return Success JSON Response
            return response()->json([
                'success' => true,
                'message' => 'Classroom deleted successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API Room Deletion Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to delete classroom.'], 500);
        }
    }

    /**
     * Handle bulk upload of rooms from Excel file via API.
     */
    public function apiBulkUpload(Request $request)
    {
        // 1. التحقق من الملف المرفوع (نفس الويب)
        $validator = Validator::make($request->all(), [
            'room_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:2048', // اسم الحقل كما في Postman
        ], [], ['room_excel_file' => 'Excel file']);

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed for uploaded file.',
                'errors' => $validator->errors()
            ], 422); // Unprocessable Entity
        }

        try {
            // 2. قراءة البيانات من ملف الإكسل (نفس الويب)
            $rows = Excel::toCollection(collect(), $request->file('room_excel_file'))->first();

            if ($rows->isEmpty() || $rows->count() <= 1) {
                return response()->json([
                    'success' => false,
                    'message' => 'The uploaded Excel file is empty or contains no data rows after the header.'
                ], 400); // Bad Request
            }

            $createdCount = 0;
            $updatedCount = 0;
            $skippedCount = 0;
            $skippedDetails = [];
            $processedRoomNos = collect();

            $header = $rows->first()->map(fn($item) => strtolower(str_replace(' ', '_', $item ?? '')));
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
                $currentRowNumber = $rowKey + 2;

                $roomNo = $row->get('room_no'); // يجب أن يكون اسم العمود في الإكسل room_no
                // ... (جلب باقي الحقول بنفس الطريقة)
                $roomName = $row->get('room_name');
                $roomSize = $row->get('room_size');
                $roomGender = $row->get('room_gender');
                $roomBranch = $row->get('room_branch');
                $roomTypeId = $row->get('room_type_id');

                // 1. تجاهل الأسطر الفارغة (إذا كان room_no فارغاً)
                if (empty($roomNo)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped because room_no is empty.";
                    continue;
                }
                // 2. فحص التكرار داخل الملف نفسه
                if ($processedRoomNos->contains($roomNo)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped duplicate room_no '{$roomNo}' from within this file.";
                    continue;
                }

                // التحقق من صحة بيانات السطر
                $rowDataForValidation = [
                    'room_no' => $roomNo,
                    'room_name' => $roomName,
                    'room_size' => $roomSize,
                    'room_gender' => $roomGender,
                    'room_branch' => $roomBranch,
                    'room_type_id' => $roomTypeId,
                ];
                $rowValidator = Validator::make($rowDataForValidation, [
                    'room_no' => 'required|string|max:20',
                    'room_name' => 'nullable|string|max:255',
                    'room_size' => 'required|integer|min:1',
                    'room_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed', 'مختلط', 'ذكور', 'إناث'])],
                    'room_branch' => 'nullable|string|max:100',
                    'room_type_id' => 'required|integer|exists:rooms_types,id',
                ]);

                if ($rowValidator->fails()) {
                    $skippedCount++;
                    $errors = implode(', ', $rowValidator->errors()->all());
                    $skippedDetails[] = "Row {$currentRowNumber} (RoomNo: {$roomNo}): Skipped - {$errors}";
                    continue;
                }
                $validatedRowData = $rowValidator->validated();
                $genderMapping = ['مختلط' => 'Mixed', 'ذكور' => 'Male', 'إناث' => 'Female'];
                $validatedRowData['room_gender'] = $genderMapping[strtolower($validatedRowData['room_gender'])] ?? ucfirst(strtolower($validatedRowData['room_gender']));
                if (!in_array($validatedRowData['room_gender'], ['Male', 'Female', 'Mixed'])) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Invalid gender value '{$roomGender}'.";
                    continue;
                }

                // 3. البحث والتحديث/الإنشاء
                $room = Room::updateOrCreate(
                    ['room_no' => $validatedRowData['room_no']],
                    [
                        'room_name' => $validatedRowData['room_name'],
                        'room_size' => $validatedRowData['room_size'],
                        'room_gender' => $validatedRowData['room_gender'],
                        'room_branch' => $validatedRowData['room_branch'],
                        'room_type_id' => $validatedRowData['room_type_id'],
                        // 'equipment' => null, // إذا كنت ستضيفه لاحقاً
                    ]
                );

                if ($room->wasRecentlyCreated) {
                    $createdCount++;
                } elseif ($room->wasChanged()) {
                    $updatedCount++;
                } else {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber} (RoomNo: {$roomNo}): Data already up-to-date.";
                }
                $processedRoomNos->push($roomNo);
            }

            // 4. بناء الاستجابة
            $summaryMessage = "Classrooms bulk upload processed via API.";
            $responseData = [
                'created_count' => $createdCount,
                'updated_count' => $updatedCount,
                'skipped_count' => $skippedCount,
                'skipped_details' => $skippedDetails,
            ];

            return response()->json([
                'success' => true,
                'message' => $summaryMessage,
                'data' => $responseData
            ], 200); // OK

        } catch (Exception $e) {
            Log::error('API Room Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return response()->json([
                'success' => false,
                'message' => 'An error occurred during API bulk upload.',
                'error_details' => $e->getMessage() // للمطور
            ], 500); // Internal Server Error
        }
    }
}
-----------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\SubjectTypeController.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Models\SubjectType;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\Rule;
use Exception;
use Illuminate\Support\Facades\Validator;
use Maatwebsite\Excel\Facades\Excel;

class SubjectTypeController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================

    /**
     * Display a listing of the subject types (Web View) with Pagination.
     */
    public function index()
    {
        try {
            // استخدام latest('id') و paginate
            $subjectTypes = SubjectType::latest('id')->paginate(15);
            // توجيه للـ view الجديد
            return view('dashboard.data-entry.subject-types', compact('subjectTypes'));
        } catch (Exception $e) {
            Log::error('Error fetching subject types: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load subject types.');
        }
    }

    /**
     * Store a newly created subject type in storage.
     */
    public function store(Request $request)
    {
        // 1. Validation
        $validatedData = $request->validate([ // استخدام validatedData
            'subject_type_name' => 'required|string|max:100|unique:subjects_types,subject_type_name',
        ]);

        // 2. Prepare Data (validatedData جاهزة)
        $data = $validatedData;

        // 3. Add to Database
        try {
            SubjectType::create($data);
            // 4. Redirect to the new index route
            return redirect()->route('data-entry.subject-types.index') // توجيه للـ index
                ->with('success', 'Subject Type created successfully.');
        } catch (Exception $e) {
            Log::error('Subject Type Creation Failed: ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to create subject type.')
                ->withInput();
        }
    }

    /**
     * Update the specified subject type in storage.
     */
    public function update(Request $request, SubjectType $subjectType)
    {
        // 1. Validation
        $validatedData = $request->validate([ // استخدام validatedData
            'subject_type_name' => [
                'required',
                'string',
                'max:100',
                Rule::unique('subjects_types')->ignore($subjectType->id),
            ],
        ]);

        // 2. Prepare Data (validatedData جاهزة)
        $data = $validatedData;

        // 3. Update Database
        try {
            $subjectType->update($data);
            // 4. Redirect
            return redirect()->route('data-entry.subject-types.index') // توجيه للـ index
                ->with('success', 'Subject Type updated successfully.');
        } catch (Exception $e) {
            Log::error('Subject Type Update Failed: ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to update subject type.')
                ->withInput();
        }
    }

    /**
     * Remove the specified subject type from storage.
     */
    public function destroy(SubjectType $subjectType)
    {
        // التحقق من وجود مواد مرتبطة
        if ($subjectType->subjects()->exists()) {
            return redirect()->route('data-entry.subject-types.index') // توجيه للـ index
                ->with('error', 'Cannot delete: assigned to subjects.');
        }

        // 1. Delete from Database
        try {
            $subjectType->delete();
            // 2. Redirect
            return redirect()->route('data-entry.subject-types.index') // توجيه للـ index
                ->with('success', 'Subject Type deleted successfully.');
        } catch (Exception $e) {
            Log::error('Subject Type Deletion Failed: ' . $e->getMessage());
            return redirect()->route('data-entry.subject-types.index') // توجيه للـ index
                ->with('error', 'Failed to delete subject type.');
        }
    }


    /**
     * Handle bulk upload of subject types from Excel file.
     */
    public function bulkUpload(Request $request)
    {
        $request->validate([
            'subject_type_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:2048',
        ], [], ['subject_type_excel_file' => 'Excel file']);

        try {
            $rows = Excel::toCollection(collect(), $request->file('subject_type_excel_file'))->first();

            if ($rows->isEmpty() || $rows->count() <= 1) {
                return redirect()->route('data-entry.subject-types.index')
                                 ->with('error', 'Uploaded Excel file is empty or has no data rows.');
            }

            $createdCount = 0;
            $skippedCount = 0;
            $skippedDetails = [];
            $processedNames = collect();

            $header = $rows->first()->map(fn ($item) => strtolower(str_replace(' ', '_', $item ?? '')));
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
                $currentRowNumber = $rowKey + 2;

                $subjectTypeName = $row->get('subject_type_name', '');

                // 1. تجاهل الأسطر الفارغة
                if (empty($subjectTypeName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped because subject_type_name is empty.";
                    continue;
                }

                // 2. فحص التكرار داخل الملف نفسه
                if ($processedNames->contains($subjectTypeName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped duplicate name '{$subjectTypeName}' from within this file.";
                    continue;
                }

                // 3. التحقق من وجود الاسم في قاعدة البيانات
                // بما أن أسماء أنواع المواد يجب أن تكون فريدة، إذا وجد، نتجاهله
                $existingType = SubjectType::where('subject_type_name', $subjectTypeName)->first();

                if ($existingType) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Subject type '{$subjectTypeName}' already exists in the system.";
                    $processedNames->push($subjectTypeName);
                    continue;
                }

                // 4. إنشاء نوع مادة جديد
                SubjectType::create([
                    'subject_type_name' => $subjectTypeName,
                ]);
                $createdCount++;
                $processedNames->push($subjectTypeName);
            }

            $message = "Subject Types bulk upload processed. ";
            if ($createdCount > 0) $message .= "{$createdCount} new types created. ";
            if ($skippedCount > 0) $message .= "{$skippedCount} rows skipped. ";

            if (!empty($skippedDetails)) {
                session()->flash('skipped_details', $skippedDetails);
            }

            return redirect()->route('data-entry.subject-types.index')->with('success', trim($message));

        } catch (Exception $e) {
            Log::error('Subject Type Bulk Upload Failed: ' . $e->getMessage());
            return redirect()->route('data-entry.subject-types.index')
                             ->with('error', 'An error occurred during bulk upload: ' . $e->getMessage());
        }
    }

    // =============================================
    //             API Controller Methods
    // =============================================
    public function apiIndex()
    {
        try {
            $types = SubjectType::latest('id')->get(['id', 'subject_type_name']);
            return response()->json(['success' => true, 'data' => $types], 200);
        } catch (Exception $e) { /* ... error handling ... */
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }

    public function apiStore(Request $request)
    {
        $validatedData = $request->validate(['subject_type_name' => 'required|string|max:100|unique:subjects_types,subject_type_name']);
        try {
            $type = SubjectType::create($validatedData);
            return response()->json(['success' => true, 'data' => $type, 'message' => 'Subject Type created.'], 201);
        } catch (Exception $e) { /* ... error handling ... */
            return response()->json(['success' => false, 'message' => 'Failed to create.'], 500);
        }
    }

    public function apiShow(SubjectType $subjectType)
    { // Route Model Binding
        return response()->json(['success' => true, 'data' => $subjectType], 200);
    }

    public function apiUpdate(Request $request, SubjectType $subjectType)
    {
        $validatedData = $request->validate(['subject_type_name' => ['required', 'string', 'max:100', Rule::unique('subjects_types')->ignore($subjectType->id)]]);
        try {
            $subjectType->update($validatedData);
            return response()->json(['success' => true, 'data' => $subjectType, 'message' => 'Subject Type updated.'], 200);
        } catch (Exception $e) { /* ... error handling ... */
            return response()->json(['success' => false, 'message' => 'Failed to update.'], 500);
        }
    }

    public function apiDestroy(SubjectType $subjectType)
    {
        if ($subjectType->subjects()->exists()) {
            return response()->json(['success' => false, 'message' => 'Cannot delete: assigned to subjects.'], 409);
        }
        try {
            $subjectType->delete();
            return response()->json(['success' => true, 'message' => 'Subject Type deleted.'], 200);
        } catch (Exception $e) { /* ... error handling ... */
            return response()->json(['success' => false, 'message' => 'Failed to delete.'], 500);
        }
    }

    /**
     * Handle bulk upload of subject types from Excel file via API.
     */
    public function apiBulkUpload(Request $request)
    {
        // 1. التحقق من الملف المرفوع
        $validator = Validator::make($request->all(), [
            'subject_type_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:2048',
        ], [], ['subject_type_excel_file' => 'Excel file']); // اسم مخصص للحقل في رسائل الخطأ

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed for uploaded file.',
                'errors' => $validator->errors()
            ], 422); // Unprocessable Entity
        }

        try {
            // 2. قراءة البيانات من ملف الإكسل
            $rows = Excel::toCollection(collect(), $request->file('subject_type_excel_file'))->first();

            if ($rows->isEmpty() || $rows->count() <= 1) { // <= 1 للتحقق من وجود صف بيانات واحد على الأقل بعد الهيدر
                return response()->json([
                    'success' => false,
                    'message' => 'The uploaded Excel file is empty or contains no data rows after the header.'
                ], 400); // Bad Request
            }

            $createdCount = 0;
            $skippedCount = 0;
            $skippedDetails = [];
            $processedNames = collect(); // لتتبع الأسماء التي تمت معالجتها من الملف

            // الحصول على الصف الأول كعناوين (بتحويلها لـ snake_case)
            $header = $rows->first()->map(fn ($item) => strtolower(str_replace(' ', '_', $item ?? '')));
            // إزالة صف العناوين من البيانات
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                // تحويل الصف الحالي لمصفوفة باستخدام العناوين كمفاتيح
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
                $currentRowNumber = $rowKey + 2; // رقم الصف الفعلي في الإكسل (مع الهيدر)

                // العمود B هو 'subject_type_name' (بافتراض تطابق اسم الهيدر بعد تحويله)
                $subjectTypeName = $row->get('subject_type_name', '');

                // 1. تجاهل الأسطر الفارغة (إذا كان subject_type_name فارغاً)
                if (empty($subjectTypeName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped because subject_type_name is empty.";
                    continue;
                }

                // 2. فحص التكرار داخل الملف نفسه
                if ($processedNames->contains($subjectTypeName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped duplicate name '{$subjectTypeName}' from within this file.";
                    continue;
                }

                // 3. التحقق من وجود الاسم في قاعدة البيانات
                // بما أن أسماء أنواع المواد يجب أن تكون فريدة، إذا وجد، نتجاهله
                $existingType = SubjectType::where('subject_type_name', $subjectTypeName)->first();

                if ($existingType) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Subject type '{$subjectTypeName}' already exists in the system.";
                    $processedNames->push($subjectTypeName); // اعتبره معالجاً
                    continue;
                }

                // 4. إنشاء نوع مادة جديد (التحقق من الصحة تم ضمنياً)
                SubjectType::create([
                    'subject_type_name' => $subjectTypeName,
                ]);
                $createdCount++;
                $processedNames->push($subjectTypeName);
            }

            // 5. بناء الاستجابة
            $summaryMessage = "Subject Types bulk upload processed via API.";
            $responseData = [
                'created_count' => $createdCount,
                'skipped_count' => $skippedCount,
                'skipped_details' => $skippedDetails,
            ];

            return response()->json([
                'success' => true,
                'message' => $summaryMessage,
                'data' => $responseData
            ], 200); // OK

        } catch (Exception $e) {
            Log::error('API Subject Type Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return response()->json([
                'success' => false,
                'message' => 'An error occurred during API bulk upload.',
                'error_details' => $e->getMessage() // للمطور
            ], 500); // Internal Server Error
        }
    }
}
-----------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\SubjectCategoryController.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Models\SubjectCategory; // تم استيراده
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\Rule;
use Exception;
use Illuminate\Support\Facades\Validator;
use Maatwebsite\Excel\Facades\Excel;

class SubjectCategoryController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================

    /**
     * Display a listing of the subject categories.
     */
    public function index()
    {
        try {
            // تغيير اسم المتغير والموديل والـ view
            $subjectCategories = SubjectCategory::latest('id')->paginate(15);
            return view('dashboard.data-entry.subject-categories', compact('subjectCategories'));
        } catch (Exception $e) {
            Log::error('Error fetching subject categories: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load subject categories.');
        }
    }

    /**
     * Store a newly created subject category in storage.
     */
    public function store(Request $request)
    {
        // 1. Validation (تغيير اسم الحقل والجدول)
        $validatedData = $request->validate([
            'subject_category_name' => 'required|string|max:100|unique:subjects_categories,subject_category_name',
        ]);

        // 2. Prepare Data
        $data = $validatedData;

        // 3. Add to Database
        try {
            SubjectCategory::create($data);
            // 4. Redirect (تغيير الـ route والرسالة)
            return redirect()->route('data-entry.subject-categories.index')
                ->with('success', 'Subject Category created successfully.');
        } catch (Exception $e) {
            Log::error('Subject Category Creation Failed: ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to create subject category.')
                ->withInput();
        }
    }

    /**
     * Update the specified subject category in storage.
     */
    public function update(Request $request, SubjectCategory $subjectCategory) // تغيير المتغير
    {
        // 1. Validation (تغيير اسم الحقل والجدول والمتغير)
        $validatedData = $request->validate([
            'subject_category_name' => [
                'required',
                'string',
                'max:100',
                Rule::unique('subjects_categories')->ignore($subjectCategory->id),
            ],
        ]);

        // 2. Prepare Data
        $data = $validatedData;

        // 3. Update Database
        try {
            $subjectCategory->update($data);
            // 4. Redirect (تغيير الـ route والرسالة)
            return redirect()->route('data-entry.subject-categories.index')
                ->with('success', 'Subject Category updated successfully.');
        } catch (Exception $e) {
            Log::error('Subject Category Update Failed: ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to update subject category.')
                ->withInput();
        }
    }

    /**
     * Remove the specified subject category from storage.
     */
    public function destroy(SubjectCategory $subjectCategory) // تغيير المتغير
    {
        // التحقق من المواد المرتبطة
        if ($subjectCategory->subjects()->exists()) {
            return redirect()->route('data-entry.subject-categories.index')
                ->with('error', 'Cannot delete category. It is assigned to subjects.');
        }

        // 1. Delete
        try {
            $subjectCategory->delete();
            // 2. Redirect (تغيير الـ route والرسالة)
            return redirect()->route('data-entry.subject-categories.index')
                ->with('success', 'Subject Category deleted successfully.');
        } catch (Exception $e) {
            Log::error('Subject Category Deletion Failed: ' . $e->getMessage());
            return redirect()->route('data-entry.subject-categories.index')
                ->with('error', 'Failed to delete subject category.');
        }
    }


    /**
     * Handle bulk upload of subject categories from Excel file for Web.
     */
    public function bulkUpload(Request $request)
    {
        $request->validate([
            'subject_category_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:2048',
        ], [], ['subject_category_excel_file' => 'Excel file']);

        try {
            $rows = Excel::toCollection(collect(), $request->file('subject_category_excel_file'))->first();

            if ($rows->isEmpty() || $rows->count() <= 1) {
                return redirect()->route('data-entry.subject-categories.index')
                                 ->with('error', 'Uploaded Excel file is empty or has no data rows after the header.');
            }

            $createdCount = 0;
            $skippedCount = 0;
            $skippedDetails = [];
            $processedNames = collect(); // لتتبع الأسماء التي تمت معالجتها من الملف الحالي

            // الحصول على الصف الأول كعناوين (بتحويلها لـ snake_case)
            // هذا يفترض أن اسم العمود في الإكسل هو "subject_category_name" أو ما يشبهه
            $header = $rows->first()->map(fn ($item) => strtolower(str_replace([' ', '-'], '_', $item ?? '')));
            $dataRows = $rows->slice(1); // إزالة صف العناوين

            foreach ($dataRows as $rowKey => $rowArray) {
                // تحويل الصف الحالي لمصفوفة باستخدام العناوين كمفاتيح
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
                $currentRowNumber = $rowKey + 2; // رقم الصف الفعلي في الإكسل

                $categoryName = $row->get('subject_category_name', ''); // جلب القيمة

                // 1. تجاهل الأسطر الفارغة
                if (empty($categoryName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped because subject_category_name is empty.";
                    continue;
                }

                // 2. فحص التكرار داخل الملف نفسه
                if ($processedNames->contains($categoryName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped duplicate category name '{$categoryName}' from within this file.";
                    continue;
                }

                // 3. التحقق من وجود الاسم في قاعدة البيانات (أسماء الفئات يجب أن تكون فريدة)
                $existingCategory = SubjectCategory::where('subject_category_name', $categoryName)->first();

                if ($existingCategory) {
                    // الفئة موجودة بالفعل، تجاهلها (لا نقوم بالتحديث هنا عادةً)
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Subject category '{$categoryName}' already exists in the system.";
                    $processedNames->push($categoryName); // اعتبره معالجاً
                    continue;
                }

                // 4. إنشاء فئة مادة جديدة
                SubjectCategory::create([
                    'subject_category_name' => $categoryName,
                ]);
                $createdCount++;
                $processedNames->push($categoryName);
            }

            $message = "Subject Categories bulk upload processed. ";
            if ($createdCount > 0) $message .= "{$createdCount} new categories created. ";
            if ($skippedCount > 0) $message .= "{$skippedCount} rows skipped. ";

            if (!empty($skippedDetails)) {
                // استخدام session flash لتمرير تفاصيل الصفوف المتجاهلة
                session()->flash('skipped_details', $skippedDetails);
            }

            return redirect()->route('data-entry.subject-categories.index')->with('success', trim($message));

        } catch (Exception $e) {
            Log::error('Subject Category Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return redirect()->route('data-entry.subject-categories.index')
                             ->with('error', 'An error occurred during bulk upload: ' . $e->getMessage());
        }
    }

    // =============================================
    //             API Controller Methods
    // =============================================
    public function apiIndex()
    {
        try {
            $categories = SubjectCategory::latest('id')->get(['id', 'subject_category_name']);
            return response()->json(['success' => true, 'data' => $categories], 200);
        } catch (Exception $e) { /* ... */
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }
    public function apiStore(Request $request)
    {
        $validatedData = $request->validate(['subject_category_name' => 'required|string|max:100|unique:subjects_categories,subject_category_name']);
        try {
            $category = SubjectCategory::create($validatedData);
            return response()->json(['success' => true, 'data' => $category, 'message' => 'Category created.'], 201);
        } catch (Exception $e) { /* ... */
            return response()->json(['success' => false, 'message' => 'Failed to create.'], 500);
        }
    }
    public function apiShow(SubjectCategory $subjectCategory)
    {
        return response()->json(['success' => true, 'data' => $subjectCategory], 200);
    }
    public function apiUpdate(Request $request, SubjectCategory $subjectCategory)
    {
        $validatedData = $request->validate(['subject_category_name' => ['required', 'string', 'max:100', Rule::unique('subjects_categories')->ignore($subjectCategory->id)]]);
        try {
            $subjectCategory->update($validatedData);
            return response()->json(['success' => true, 'data' => $subjectCategory, 'message' => 'Category updated.'], 200);
        } catch (Exception $e) { /* ... */
            return response()->json(['success' => false, 'message' => 'Failed to update.'], 500);
        }
    }
    public function apiDestroy(SubjectCategory $subjectCategory)
    {
        if ($subjectCategory->subjects()->exists()) {
            return response()->json(['success' => false, 'message' => 'Cannot delete: assigned.'], 409);
        }
        try {
            $subjectCategory->delete();
            return response()->json(['success' => true, 'message' => 'Category deleted.'], 200);
        } catch (Exception $e) { /* ... */
            return response()->json(['success' => false, 'message' => 'Failed to delete.'], 500);
        }
    }

    /**
     * Handle bulk upload of subject categories from Excel file via API.
     */
    public function apiBulkUpload(Request $request)
    {
        // 1. التحقق من الملف المرفوع
        $validator = Validator::make($request->all(), [
            'subject_category_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:2048',
        ], [], ['subject_category_excel_file' => 'Excel file']);

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed for uploaded file.',
                'errors' => $validator->errors()
            ], 422); // Unprocessable Entity
        }

        try {
            // 2. قراءة البيانات من ملف الإكسل
            $rows = Excel::toCollection(collect(), $request->file('subject_category_excel_file'))->first();

            if ($rows->isEmpty() || $rows->count() <= 1) {
                return response()->json([
                    'success' => false,
                    'message' => 'The uploaded Excel file is empty or contains no data rows after the header.'
                ], 400); // Bad Request
            }

            $createdCount = 0;
            $skippedCount = 0;
            $skippedDetails = [];
            $processedNames = collect();

            $header = $rows->first()->map(fn ($item) => strtolower(str_replace([' ', '-'], '_', $item ?? '')));
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
                $currentRowNumber = $rowKey + 2;
                $categoryName = $row->get('subject_category_name', '');

                if (empty($categoryName)) {
                    $skippedCount++; $skippedDetails[] = "Row {$currentRowNumber}: Skipped (empty name)."; continue;
                }
                if ($processedNames->contains($categoryName)) {
                    $skippedCount++; $skippedDetails[] = "Row {$currentRowNumber}: Skipped (duplicate '{$categoryName}' in file)."; continue;
                }
                if (SubjectCategory::where('subject_category_name', $categoryName)->exists()) {
                    $skippedCount++; $skippedDetails[] = "Row {$currentRowNumber}: Category '{$categoryName}' already exists.";
                    $processedNames->push($categoryName); continue;
                }

                SubjectCategory::create(['subject_category_name' => $categoryName]);
                $createdCount++; $processedNames->push($categoryName);
            }

            // 3. بناء الاستجابة
            $summaryMessage = "Subject Categories bulk upload processed via API.";
            $responseData = [
                'created_count' => $createdCount,
                'skipped_count' => $skippedCount,
                'skipped_details' => $skippedDetails,
            ];

            return response()->json([
                'success' => true,
                'message' => $summaryMessage,
                'data' => $responseData
            ], 200); // OK

        } catch (Exception $e) {
            Log::error('API Subject Category Bulk Upload Failed: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'An error occurred during API bulk upload.',
                'error_details' => $e->getMessage() // للمطور
            ], 500); // Internal Server Error
        }
    }
}
-------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\SubjectController.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Imports\SubjectsImport; // *** تفعيل هذا ***
use Maatwebsite\Excel\Facades\Excel; // *** تفعيل هذا ***
use Maatwebsite\Excel\Validators\ValidationException; // *** لاستقبال أخطاء التحقق من Excel ***
use App\Models\Department;
use App\Models\Subject;
use App\Models\SubjectCategory;
use App\Models\SubjectType;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log; // اختياري
use Illuminate\Validation\Rule;
use Exception;
use Illuminate\Support\Facades\Validator;

class SubjectController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================

    /**
     * Display a listing of the subjects (Web View) with Pagination.
     * عرض قائمة المواد لصفحة الويب مع تقسيم الصفحات (الأحدث أولاً)
     */
    public function index()
    {
        try {
            // جلب المواد مرتبة بالأحدث مع العلاقات وتقسيم الصفحات
            $subjects = Subject::with(['subjectType', 'subjectCategory', 'department'])
                ->latest('id') // Order by newest first based on ID
                ->paginate(15); // Paginate results

            // جلب البيانات للقوائم المنسدلة
            $subjectTypes = SubjectType::orderBy('subject_type_name')->get();
            $subjectCategories = SubjectCategory::orderBy('subject_category_name')->get();
            $departments = Department::orderBy('department_name')->get();

            return view('dashboard.data-entry.subjects', compact('subjects', 'subjectTypes', 'subjectCategories', 'departments'));
        } catch (Exception $e) {
            Log::error('Error fetching subjects for web view: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load subjects.');
        }
    }

    /**
     * Store a newly created subject from web request.
     * تخزين مادة جديدة قادمة من طلب ويب
     */
    public function store(Request $request)
    {
        // 1. Validation
        $validatedData = $request->validate([
            'subject_no' => 'required|string|max:20|unique:subjects,subject_no',
            'subject_name' => 'required|string|max:255',
            'subject_load' => 'required|integer|min:0',
            'theoretical_hours' => 'required|integer|min:0',
            'practical_hours' => 'required|integer|min:0',
            'load_theoretical_section' => 'nullable|integer|min:1', // nullable للسماح بالقيمة الافتراضية
            'load_practical_section' => 'nullable|integer|min:1',
            'subject_type_id' => 'required|integer|exists:subjects_types,id',
            'subject_category_id' => 'required|integer|exists:subjects_categories,id',
            'department_id' => 'required|integer|exists:departments,id',
        ]);

        // 2. Prepare Data (validatedData جاهزة)
        $data = $validatedData;
        if (!isset($validatedData['load_theoretical_section']) || is_null($validatedData['load_theoretical_section'])) {
            // القيمة الافتراضية من قاعدة البيانات ستُستخدم إذا كان الحقل nullable
            // أو يمكنك تعيينها هنا صراحة إذا أردت:
            $dataToCreate['load_theoretical_section'] = 50;
        }
        if (!isset($validatedData['load_practical_section']) || is_null($validatedData['load_practical_section'])) {
            $dataToCreate['load_practical_section'] = 25;
        }
        // 3. Add to Database
        try {
            Subject::create($data);
            // 4. Redirect
            return redirect()->route('data-entry.subjects.index') // تأكد من اسم الروت
                ->with('success', 'Subject created successfully.');
        } catch (Exception $e) {
            Log::error('Subject Creation Failed (Web): ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to create subject.')
                ->withInput();
        }
    }

    /**
     * Update the specified subject from web request.
     * تحديث مادة محددة قادمة من طلب ويب
     */
    public function update(Request $request, Subject $subject)
    {
        // 1. Validation
        $validatedData = $request->validate([
            'subject_no' => 'required|string|max:20|unique:subjects,subject_no,' . $subject->id,
            'subject_name' => 'required|string|max:255',
            'subject_load' => 'required|integer|min:0',
            'theoretical_hours' => 'required|integer|min:0',
            'practical_hours' => 'required|integer|min:0',
            'load_theoretical_section' => 'nullable|integer|min:1',
            'load_practical_section' => 'nullable|integer|min:1',
            'subject_type_id' => 'required|integer|exists:subjects_types,id',
            'subject_category_id' => 'required|integer|exists:subjects_categories,id',
            'department_id' => 'required|integer|exists:departments,id',
        ]);

        // 2. Prepare Data (validatedData جاهزة)
        $data = $validatedData;
        // إذا أرسل المستخدم قيمة فارغة، يجب أن نخزن NULL وليس string فارغ (إذا كان الحقل يقبل NULL)
        $dataToUpdate['load_theoretical_section'] = $request->filled('load_theoretical_section') ? $request->input('load_theoretical_section') : null;
        $dataToUpdate['load_practical_section'] = $request->filled('load_practical_section') ? $request->input('load_practical_section') : null;

        // 3. Update Database
        try {
            $subject->update($data);
            // 4. Redirect
            return redirect()->route('data-entry.subjects.index') // تأكد من اسم الروت
                ->with('success', 'Subject updated successfully.');
        } catch (Exception $e) {
            Log::error('Subject Update Failed (Web): ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to update subject.')
                ->withInput();
        }
    }

    /**
     * Remove the specified subject from web request.
     * حذف مادة محددة قادمة من طلب ويب
     */
    public function destroy(Subject $subject)
    {
        // (اختياري) التحقق من الارتباطات
        if ($subject->planSubjectEntries()->exists()) {
            return redirect()->route('data-entry.subjects.index') // تأكد من اسم الروت
                ->with('error', 'Cannot delete subject. It is included in academic plans.');
        }

        // 1. Delete from Database
        try {
            $subject->delete();
            // 2. Redirect
            return redirect()->route('data-entry.subjects.index') // تأكد من اسم الروت
                ->with('success', 'Subject deleted successfully.');
        } catch (Exception $e) {
            Log::error('Subject Deletion Failed (Web): ' . $e->getMessage());
            return redirect()->route('data-entry.subjects.index') // تأكد من اسم الروت
                ->with('error', 'Failed to delete subject.');
        }
    }

    /**
     * Handle bulk upload (Web).
     * معالجة الرفع بالجملة (معطل مؤقتاً)
     */
    // public function bulkUpload(Request $request)
    // {
    //     //  Log::info('Bulk upload endpoint hit (Web) - Feature disabled.'); // تسجيل معلومة
    //     //  return redirect()->route('data-entry.subjects.index')
    //     //                   ->with('info', 'Bulk upload feature is currently disabled.');

    //      // 1. التحقق من وجود الملف وصيغته
    //      $request->validate([
    //         'subject_file' => 'required|file|mimes:xlsx,xls,csv|max:5120', // زيادة الحد الأقصى للحجم إلى 5MB مثلاً
    //     ]);

    //     // 2. محاولة استيراد الملف باستخدام كلاس Import
    //     try {
    //         Excel::import(new SubjectsImport, $request->file('subject_file'));

    //         // 3. إعادة التوجيه مع رسالة نجاح
    //         return redirect()->route('data-entry.subjects.index')
    //                          ->with('success', 'Subjects imported successfully!');

    //     } catch (ValidationException $e) {
    //         // 3. التعامل مع أخطاء التحقق داخل الملف (التي تم تعريفها في SubjectsImport)
    //          $failures = $e->failures(); // الحصول على مصفوفة الأخطاء
    //          $errorMessages = [];
    //          foreach ($failures as $failure) {
    //              // بناء رسالة خطأ لكل صف خاطئ
    //              $errorMessages[] = "Row " . $failure->row() . ": " . implode(', ', $failure->errors()) . " (Value: '" . $failure->values()[$failure->attribute()] . "')";
    //          }
    //          Log::warning('Subject Bulk Upload Validation Failures: ', $failures);
    //          // إعادة التوجيه مع رسالة خطأ عامة وعرض الأخطاء التفصيلية
    //          return redirect()->back()
    //                           ->with('error', 'Import failed due to validation errors in the file. Please check the details below.')
    //                           ->with('import_errors', $errorMessages); // إرسال مصفوفة الأخطاء للـ view

    //     } catch (Exception $e) {
    //         // 3. التعامل مع أخطاء أخرى (مثل مشكلة في قراءة الملف)
    //         Log::error('Subject Bulk Upload Failed (General): ' . $e->getMessage());
    //         return redirect()->back()
    //                          ->with('error', 'An error occurred during the upload process. Please ensure the file format is correct and try again.');
    //     }
    // }
    // public function bulkUpload(Request $request)
    // {
    //     $request->validate([
    //         'subject_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
    //     ]);

    //     $importer = new SubjectsImport(); // إنشاء instance من الـ Importer

    //     try {
    //         Excel::import($importer, $request->file('subject_file'));

    //         // الحصول على الأخطاء (إن وجدت) من الـ Importer
    //         $errors = $importer->getErrors();
    //         $importedCount = $importer->getImportedRowCount();

    //         if (!empty($errors)) {
    //             // إذا كان هناك أخطاء validation
    //             $errorMessages = [];
    //             foreach ($errors as $rowIndex => $rowErrors) {
    //                 $errorMessages[] = "Row " . $rowIndex . ": " . implode(', ', $rowErrors);
    //             }
    //             return redirect()->back()
    //                 ->with('error', "Import completed with errors. {$importedCount} rows imported successfully. Please check the details below.")
    //                 ->with('import_errors', $errorMessages);
    //         }

    //         // إذا لم يكن هناك أخطاء
    //         return redirect()->route('data-entry.subjects.index')
    //             ->with('success', "Subjects imported successfully! ({$importedCount} rows added).");
    //     } catch (Exception $e) {
    //         // التعامل مع أخطاء قراءة الملف أو أخطاء فادحة أخرى
    //         Log::error('Subject Bulk Upload Failed (General): ' . $e->getMessage());
    //         return redirect()->back()
    //             ->with('error', 'An critical error occurred during the upload process. Please check the file or contact support. Error: ' . $e->getMessage());
    //     }
    // }

    /**
     * Helper function to normalize Arabic text.
     */
    private function normalizeArabicString($string)
    {
        if (is_null($string)) return null;
        $search = array('أ', 'إ', 'آ', 'ى', 'ة');
        $replace = array('ا', 'ا', 'ا', 'ي', 'ه'); // تطبيع بسيط
        return str_replace($search, $replace, $string);
    }

    /**
     * Helper function to find related ID by name or use ID if numeric.
     */
    private function findRelatedId($modelClass, $nameColumn, $valueFromExcel, &$skippedDetails, $rowNum, $attributeFriendlyName, $searchByIdColumn = 'id')
    {
        if (is_numeric($valueFromExcel)) {
            if ($modelClass::where($searchByIdColumn, $valueFromExcel)->exists()) {
                return (int)$valueFromExcel;
            } else {
                $skippedDetails[] = "Row {$rowNum}: Invalid {$attributeFriendlyName} ID '{$valueFromExcel}'. Record skipped.";
                return null;
            }
        } elseif (!empty($valueFromExcel)) {
            $normalizedValue = $this->normalizeArabicString(strtolower(trim($valueFromExcel)));
            $record = $modelClass::all()->first(function ($item) use ($nameColumn, $normalizedValue) {
                return $this->normalizeArabicString(strtolower(trim($item->$nameColumn))) === $normalizedValue;
            });
            if ($record) {
                return $record->id;
            } else {
                $skippedDetails[] = "Row {$rowNum}: {$attributeFriendlyName} '{$valueFromExcel}' not found. Record skipped.";
                return null;
            }
        }
        // إذا كانت القيمة فارغة ولم تكن مطلوبة، قد نرجع null بدون تسجيل خطأ، أو نسجل خطأ إذا كانت مطلوبة
        // $skippedDetails[] = "Row {$rowNum}: {$attributeFriendlyName} is empty. Record skipped."; // إذا كان الحقل مطلوباً
        return null; // إذا كان الحقل اختيارياً والقيمة فارغة
    }


    /**
     * Handle bulk upload of subjects from Excel file for Web.
     */
    public function bulkUpload(Request $request)
    {
        $request->validate([
            'subject_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
        ], [], ['subject_excel_file' => 'Excel file']);

        try {
            $rows = Excel::toCollection(collect(), $request->file('subject_excel_file'))->first();

            if ($rows->isEmpty() || $rows->count() <= 1) {
                return redirect()->route('data-entry.subjects.index')->with('error', 'Uploaded Excel file is empty or has no data rows.');
            }

            $createdCount = 0;
            $updatedCount = 0;
            $skippedCount = 0;
            $skippedDetails = [];
            $processedSubjectNos = collect();

            $header = $rows->first()->map(fn($item) => strtolower(str_replace([' ', '-'], '_', $item ?? '')));
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
                $currentRowNumber = $rowKey + 2;

                $subjectNo = $row->get('subject_no');
                $subjectName = $row->get('subject_name');

                if (empty($subjectNo) && empty($subjectName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped (empty subject_no & name).";
                    continue;
                }
                if (empty($subjectNo) || empty($subjectName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped (missing subject_no or name).";
                    continue;
                }
                if ($processedSubjectNos->contains($subjectNo)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped (duplicate subject_no '{$subjectNo}' in file).";
                    continue;
                }

                $subjectTypeId = $this->findRelatedId(SubjectType::class, 'subject_type_name', $row->get('subject_type_id'), $skippedDetails, $currentRowNumber, 'Subject Type');
                if (is_null($subjectTypeId) && !empty($row->get('subject_type_id'))) {
                    $skippedCount++;
                    continue;
                } // إذا كان هناك قيمة ولم يتم العثور عليها

                $subjectCategoryId = $this->findRelatedId(SubjectCategory::class, 'subject_category_name', $row->get('subject_category_id'), $skippedDetails, $currentRowNumber, 'Subject Category');
                if (is_null($subjectCategoryId) && !empty($row->get('subject_category_id'))) {
                    $skippedCount++;
                    continue;
                }

                $departmentId = $this->findRelatedId(Department::class, 'department_name', $row->get('department_id'), $skippedDetails, $currentRowNumber, 'Department');
                if (is_null($departmentId) && !empty($row->get('department_id'))) {
                    $skippedCount++;
                    continue;
                }


                $dataToValidate = [
                    'subject_no' => $subjectNo,
                    'subject_name' => $subjectName,
                    'subject_load' => $row->get('subject_load'),
                    'theoretical_hours' => $row->get('theoretical_hours'),
                    'practical_hours' => $row->get('practical_hours'),
                    'capacity_theoretical_section' => $row->get('capacity_theoretical_section'),
                    'capacity_practical_section' => $row->get('capacity_practical_section'),
                    'subject_type_id' => $subjectTypeId,
                    'subject_category_id' => $subjectCategoryId,
                    'department_id' => $departmentId,
                ];

                $validator = Validator::make($dataToValidate, [
                    'subject_no' => 'required|string|max:20',
                    'subject_name' => 'required|string|max:255',
                    'subject_load' => 'required|integer|min:0',
                    'theoretical_hours' => 'required|integer|min:0',
                    'practical_hours' => 'required|integer|min:0',
                    'capacity_theoretical_section' => 'nullable|integer|min:1',
                    'capacity_practical_section' => 'nullable|integer|min:1',
                    'subject_type_id' => 'required|integer|exists:subjects_types,id',
                    'subject_category_id' => 'required|integer|exists:subjects_categories,id',
                    'department_id' => 'required|integer|exists:departments,id',
                ]);

                if ($validator->fails()) {
                    $skippedCount++;
                    $errors = implode(', ', $validator->errors()->all());
                    $skippedDetails[] = "Row {$currentRowNumber} (SubjectNo: {$subjectNo}): Skipped - Validation: {$errors}";
                    continue;
                }
                $validatedData = $validator->validated();
                // استخدام القيم الافتراضية إذا كانت السعات null بعد التحقق
                $validatedData['capacity_theoretical_section'] = $validatedData['capacity_theoretical_section'] ?? 50;
                $validatedData['capacity_practical_section'] = $validatedData['capacity_practical_section'] ?? 25;


                $subject = Subject::where('subject_no', $validatedData['subject_no'])->first();
                if ($subject) {
                    $subject->update($validatedData);
                    $updatedCount++;
                } else {
                    Subject::create($validatedData);
                    $createdCount++;
                }
                $processedSubjectNos->push($subjectNo);
            }

            $message = "Subjects bulk upload processed. ";
            if ($createdCount > 0) $message .= "{$createdCount} new created. ";
            if ($updatedCount > 0) $message .= "{$updatedCount} updated. ";
            if ($skippedCount > 0) $message .= "{$skippedCount} skipped. ";
            if (!empty($skippedDetails)) {
                session()->flash('skipped_details', $skippedDetails);
            }
            return redirect()->route('data-entry.subjects.index')->with('success', trim($message));
        } catch (Exception $e) {
            Log::error('Subject Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return redirect()->route('data-entry.subjects.index')->with('error', 'Upload error: ' . $e->getMessage());
        }
    }


    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * Display a listing of the subjects (API).
     * عرض قائمة المواد للـ API (بدون Pagination أو فلترة حالياً)
     */
    public function apiIndex(Request $request) // أبقينا على Request إذا احتجناها لاحقاً
    {
        try {
            $query = Subject::with([
                'subjectType:id,subject_type_name',
                'subjectCategory:id,subject_category_name',
                'department:id,department_name'
            ]);

            // --- إزالة كود الفلترة ---

            // --- الخيار 1: جلب كل المواد (الحالة الحالية) ---
            $subjects = $query->latest('id') // الترتيب بالأحدث
                ->get();

            // --- الخيار 2: كود الـ Pagination للـ API (معطل حالياً) ---
            /*
            $perPage = $request->query('per_page', 15);
            $subjectsPaginated = $query->latest('id')
                                       ->paginate($perPage);

            return response()->json([
                'success' => true,
                'data' => $subjectsPaginated->items(),
                'pagination' => [
                    'total' => $subjectsPaginated->total(),
                    'per_page' => $subjectsPaginated->perPage(),
                    'current_page' => $subjectsPaginated->currentPage(),
                    'last_page' => $subjectsPaginated->lastPage(),
                ]
            ], 200);
            */
            // --- نهاية كود الـ Pagination المعطل ---


            return response()->json(['success' => true, 'data' => $subjects], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching subjects: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }

    /**
     * Store a newly created subject from API request.
     * تخزين مادة جديدة قادمة من طلب API
     */
    public function apiStore(Request $request)
    {
        // 1. Validation
        $validatedData = $request->validate([
            'subject_no' => 'required|string|max:20|unique:subjects,subject_no',
            'subject_name' => 'required|string|max:255',
            'subject_load' => 'required|integer|min:0',
            'theoretical_hours' => 'required|integer|min:0',
            'practical_hours' => 'required|integer|min:0',
            'subject_type_id' => 'required|integer|exists:subjects_types,id',
            'subject_category_id' => 'required|integer|exists:subjects_categories,id',
            'department_id' => 'required|integer|exists:departments,id',
        ]);

        // 2. Add to Database
        try {
            $subject = Subject::create($validatedData);
            $subject->load(['subjectType:id,subject_type_name', 'subjectCategory:id,subject_category_name', 'department:id,department_name']);
            // 3. Return Success JSON Response
            return response()->json([
                'success' => true,
                'data' => $subject,
                'message' => 'Subject created successfully.'
            ], 201);
        } catch (Exception $e) {
            Log::error('API Subject Creation Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to create subject.'], 500);
        }
    }

    /**
     * Display the specified subject (API).
     * عرض مادة محددة للـ API
     */
    public function apiShow(Subject $subject)
    {
        $subject->load(['subjectType:id,subject_type_name', 'subjectCategory:id,subject_category_name', 'department:id,department_name']);
        return response()->json(['success' => true, 'data' => $subject], 200);
    }

    /**
     * Update the specified subject from API request.
     * تحديث مادة محددة قادمة من طلب API
     */
    public function apiUpdate(Request $request, Subject $subject)
    {
        // 1. Validation
        $validatedData = $request->validate([
            'subject_no' => [
                'sometimes',
                'required',
                'string',
                'max:20',
                'unique:subjects,subject_no,' . $subject->id,
            ],
            'subject_name' => 'sometimes|required|string|max:255',
            'subject_load' => 'sometimes|required|integer|min:0',
            'theoretical_hours' => 'sometimes|required|integer|min:0',
            'practical_hours' => 'sometimes|required|integer|min:0',
            'subject_type_id' => 'sometimes|required|integer|exists:subjects_types,id',
            'subject_category_id' => 'sometimes|required|integer|exists:subjects_categories,id',
            'department_id' => 'sometimes|required|integer|exists:departments,id',
        ]);

        // 2. Update Database
        try {
            $subject->update($validatedData);
            $subject->load(['subjectType:id,subject_type_name', 'subjectCategory:id,subject_category_name', 'department:id,department_name']);
            // 3. Return Success JSON Response
            return response()->json([
                'success' => true,
                'data' => $subject,
                'message' => 'Subject updated successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API Subject Update Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to update subject.'], 500);
        }
    }

    /**
     * Remove the specified subject from API request.
     * حذف مادة محددة قادمة من طلب API
     */
    public function apiDestroy(Subject $subject)
    {
        // (اختياري) التحقق من الارتباطات
        if ($subject->planSubjectEntries()->exists()) {
            return response()->json([
                'success' => false,
                'message' => 'Cannot delete subject. It is included in academic plans.'
            ], 409);
        }

        // 1. Delete from Database
        try {
            $subject->delete();
            // 2. Return Success JSON Response
            return response()->json([
                'success' => true,
                'message' => 'Subject deleted successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API Subject Deletion Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to delete subject.'], 500);
        }
    }

    /**
     * Handle bulk upload (API).
     */
    // public function apiBulkUpload(Request $request)
    // {
    //     Log::info('Bulk upload endpoint hit (API) - Feature disabled.');
    //     return response()->json([
    //         'success' => false,
    //         'message' => 'Bulk upload feature is not yet available for the API.'
    //     ], 501); // 501 Not Implemented

    //     /* // كود تفعيلها لاحقاً
    //     $validator = Validator::make($request->all(), [
    //         'subject_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
    //     ]);

    //     if ($validator->fails()) {
    //         return response()->json(['success' => false, 'errors' => $validator->errors()], 422);
    //     }

    //     try {
    //         Excel::import(new SubjectsImport, $request->file('subject_file'));
    //         return response()->json(['success' => true, 'message' => 'Subjects imported successfully!'], 200);
    //     } catch (ValidationException $e) {
    //         $failures = $e->failures();
    //         $errorDetails = [];
    //          foreach ($failures as $failure) {
    //              $errorDetails[] = [
    //                  'row' => $failure->row(),
    //                  'attribute' => $failure->attribute(),
    //                  'errors' => $failure->errors(),
    //                  'value' => $failure->values()[$failure->attribute()] ?? null
    //              ];
    //          }
    //          Log::warning('API Subject Bulk Upload Validation Failures: ', $failures);
    //          return response()->json([
    //             'success' => false,
    //             'message' => 'Import failed due to validation errors.',
    //             'errors' => $errorDetails
    //         ], 422);
    //     } catch (Exception $e) {
    //          Log::error('API Subject Bulk Upload Failed (General): ' . $e->getMessage());
    //          return response()->json(['success' => false, 'message' => 'An error occurred during the upload process.'], 500);
    //     }*/
    // }


    /**
     * Handle bulk upload of subjects from Excel file via API.
     */
    public function apiBulkUpload(Request $request)
    {
        $validator = Validator::make($request->all(), ['subject_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120']);
        if ($validator->fails()) {
            return response()->json(['success' => false, 'message' => 'File validation failed.', 'errors' => $validator->errors()], 422);
        }

        try {
            $rows = Excel::toCollection(collect(), $request->file('subject_excel_file'))->first();
            if ($rows->isEmpty() || $rows->count() <= 1) {
                return response()->json(['success' => false, 'message' => 'File empty or no data rows.'], 400);
            }

            $createdCount = 0;
            $updatedCount = 0;
            $skippedCount = 0;
            $skippedDetails = [];
            $processedSubjectNos = collect();
            $header = $rows->first()->map(fn($item) => strtolower(str_replace([' ', '-'], '_', $item ?? '')));
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
                $currentRowNumber = $rowKey + 2;
                $subjectNo = $row->get('subject_no');
                $subjectName = $row->get('subject_name');

                if (empty($subjectNo) && empty($subjectName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped (empty).";
                    continue;
                }
                if (empty($subjectNo) || empty($subjectName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped (missing no or name).";
                    continue;
                }
                if ($processedSubjectNos->contains($subjectNo)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped (duplicate no '{$subjectNo}' in file).";
                    continue;
                }

                $subjectTypeId = $this->findRelatedId(SubjectType::class, 'subject_type_name', $row->get('subject_type_id'), $skippedDetails, $currentRowNumber, 'Type');
                if (is_null($subjectTypeId) && !empty($row->get('subject_type_id'))) {
                    $skippedCount++;
                    continue;
                }
                $subjectCategoryId = $this->findRelatedId(SubjectCategory::class, 'subject_category_name', $row->get('subject_category_id'), $skippedDetails, $currentRowNumber, 'Category');
                if (is_null($subjectCategoryId) && !empty($row->get('subject_category_id'))) {
                    $skippedCount++;
                    continue;
                }
                $departmentId = $this->findRelatedId(Department::class, 'department_name', $row->get('department_id'), $skippedDetails, $currentRowNumber, 'Department');
                if (is_null($departmentId) && !empty($row->get('department_id'))) {
                    $skippedCount++;
                    continue;
                }

                // $dataToValidate = [ /* ... نفس مصفوفة dataToValidate من دالة الويب ... */ ];
                $dataToValidate = [
                    'subject_no' => $subjectNo,
                    'subject_name' => $subjectName,
                    'subject_load' => $row->get('subject_load'),
                    'theoretical_hours' => $row->get('theoretical_hours'),
                    'practical_hours' => $row->get('practical_hours'),
                    'capacity_theoretical_section' => $row->get('capacity_theoretical_section'),
                    'capacity_practical_section' => $row->get('capacity_practical_section'),
                    'subject_type_id' => $subjectTypeId,
                    'subject_category_id' => $subjectCategoryId,
                    'department_id' => $departmentId,
                ];

                $validator = Validator::make($dataToValidate, [
                    'subject_no' => 'required|string|max:20',
                    'subject_name' => 'required|string|max:255',
                    'subject_load' => 'required|integer|min:0',
                    'theoretical_hours' => 'required|integer|min:0',
                    'practical_hours' => 'required|integer|min:0',
                    'capacity_theoretical_section' => 'nullable|integer|min:1',
                    'capacity_practical_section' => 'nullable|integer|min:1',
                    'subject_type_id' => 'required|integer|exists:subjects_types,id',
                    'subject_category_id' => 'required|integer|exists:subjects_categories,id',
                    'department_id' => 'required|integer|exists:departments,id',
                ]);
                // $validator = Validator::make($dataToValidate, [ /* ... نفس قواعد الـ validation ... */ ]);
                // if ($validator->fails()) { /* ... تجاهل وتسجيل ... */ continue; }
                if ($validator->fails()) {
                    $skippedCount++;
                    $errors = implode(', ', $validator->errors()->all());
                    $skippedDetails[] = "Row {$currentRowNumber} (SubjectNo: {$subjectNo}): Skipped - Validation: {$errors}";
                    continue;
                }
                $validatedData = $validator->validated();
                $validatedData['capacity_theoretical_section'] = $validatedData['capacity_theoretical_section'] ?? 50;
                $validatedData['capacity_practical_section'] = $validatedData['capacity_practical_section'] ?? 25;

                $subject = Subject::updateOrCreate(['subject_no' => $validatedData['subject_no']], $validatedData);
                if ($subject->wasRecentlyCreated) {
                    $createdCount++;
                } elseif ($subject->wasChanged()) {
                    $updatedCount++;
                } else {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber} (No: {$subjectNo}): Data already up-to-date.";
                }
                $processedSubjectNos->push($subjectNo);
            }

            return response()->json(['success' => true, 'message' => "Subjects uploaded.", 'data' => compact('createdCount', 'updatedCount', 'skippedCount', 'skippedDetails')], 200);
        } catch (Exception $e) {
            Log::error('API Subject Bulk Upload Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Upload error.', 'error' => $e->getMessage()], 500);
        }
    }
}
-------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\PlanController.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Imports\PlanSubjectsImport;
use App\Models\Plan;
use App\Models\Department;
use App\Models\PlanSubject;
use App\Models\Subject;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\Rule;
use Exception;
use Illuminate\Support\Facades\Validator;
use Maatwebsite\Excel\Facades\Excel;
use Maatwebsite\Excel\Validators\ValidationException as ExcelValidationException;

class PlanController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================
    // الدوال (index, store, update, destroy, manageSubjects, addSubject, removeSubject)
    // تبقى كما هي في الكود السابق الذي أرسلته - تأكد أنها موجودة وصحيحة.

    public function index()
    { /* ... كود index للويب مع pagination ... */
        try {
            $plans = Plan::with('department:id,department_name') // تحديد حقول القسم
                ->latest('id')
                ->paginate(15);
            $departments = Department::orderBy('department_name')->get(['id', 'department_name']); // تحديد الحقول
            return view('dashboard.data-entry.plans', compact('plans', 'departments'));
        } catch (Exception $e) {
            Log::error('Error fetching academic plans: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load academic plans.');
        }
    }
    public function store(Request $request)
    { /* ... كود store للويب ... */
        $validatedData = $request->validate(['plan_no' => 'required|string|max:50|unique:plans,plan_no', 'plan_name' => 'required|string|max:255', 'year' => 'required|integer|digits:4|min:2000', 'plan_hours' => 'required|integer|min:1', 'department_id' => 'required|integer|exists:departments,id', 'is_active' => 'sometimes|boolean',]);
        $data = $validatedData;
        $data['is_active'] = $request->has('is_active');
        try {
            Plan::create($data);
            return redirect()->route('data-entry.plans.index')->with('success', 'Academic Plan created successfully.');
        } catch (Exception $e) {
            Log::error('Plan Creation Failed: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Failed to create academic plan.')->withInput();
        }
    }
    public function update(Request $request, Plan $plan)
    { /* ... كود update للويب ... */
        $validatedData = $request->validate(['plan_no' => 'required|string|max:50|unique:plans,plan_no,' . $plan->id, 'plan_name' => 'required|string|max:255', 'year' => 'required|integer|digits:4|min:2000', 'plan_hours' => 'required|integer|min:1', 'department_id' => 'required|integer|exists:departments,id', 'is_active' => 'sometimes|boolean',]);
        $data = $validatedData;
        $data['is_active'] = $request->has('is_active');
        try {
            $plan->update($data);
            return redirect()->route('data-entry.plans.index')->with('success', 'Academic Plan updated successfully.');
        } catch (Exception $e) {
            Log::error('Plan Update Failed: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Failed to update academic plan.')->withInput();
        }
    }
    public function destroy(Plan $plan)
    { /* ... كود destroy للويب ... */
        // if ($plan->planSubjectEntries()->exists()) {
        //     return redirect()->route('data-entry.plans.index')->with('error', 'Cannot delete plan. It has subjects assigned.');
        // }
        try {
            Log::warning("Force deleting plan ID: {$plan->id} and its subjects.");
            // استخدام delete() على العلاقة لحذف كل سجلات plan_subjects المرتبطة
            $plan->planSubjectEntries()->delete();
            Log::info("Associated subjects for plan ID: {$plan->id} deleted.");
            $plan->delete();
            return redirect()->route('data-entry.plans.index')->with('success', 'Academic Plan deleted successfully.');
        } catch (Exception $e) {
            Log::error('Plan Deletion Failed: ' . $e->getMessage());
            return redirect()->route('data-entry.plans.index')->with('error', 'Failed to delete academic plan.');
        }
    }

    // --- الدوال المساعدة للرفع بالجملة ---
    private function normalizeArabicString($string)
    {
        if (is_null($string)) return null;
        $search = array('أ', 'إ', 'آ', 'ى', 'ة');
        $replace = array('ا', 'ا', 'ا', 'ي', 'ه');
        return str_replace($search, $replace, $string);
    }

    private function findRelatedId($modelClass, $nameColumn, $valueFromExcel, &$skippedDetails, $rowNum, $attributeFriendlyName, $searchByIdColumn = 'id', $searchByNoColumn = null, $noValueFromExcel = null)
    {
        if (is_numeric($valueFromExcel)) {
            $recordById = $modelClass::where($searchByIdColumn, $valueFromExcel)->first();
            if ($recordById) {
                return $recordById->id;
            }
        }
        if (!empty($valueFromExcel)) {
            $normalizedValue = $this->normalizeArabicString(strtolower(trim($valueFromExcel)));
            $recordByName = $modelClass::all()->first(function ($item) use ($nameColumn, $normalizedValue) {
                return $this->normalizeArabicString(strtolower(trim($item->$nameColumn))) === $normalizedValue;
            });
            if ($recordByName) {
                return $recordByName->id;
            }
        }
        if ($searchByNoColumn && !empty($noValueFromExcel)) {
            $recordByNo = $modelClass::where($searchByNoColumn, $noValueFromExcel)->first();
            if ($recordByNo) return $recordByNo->id;
        }
        $skippedDetails[] = "Row {$rowNum}: {$attributeFriendlyName} '{$valueFromExcel}' (or No: '{$noValueFromExcel}') not found or invalid. This row will be skipped.";
        return null;
    }

    /**
     * Handle bulk upload of academic plans from Excel file for Web.
     */
    public function bulkUpload(Request $request)
    {
        $request->validate([
            'plan_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
        ], [], ['plan_excel_file' => 'Excel file']);

        try {
            $rows = Excel::toCollection(collect(), $request->file('plan_excel_file'))->first();
            if ($rows->isEmpty() || $rows->count() <= 1) {
                return redirect()->route('data-entry.plans.index')->with('error', 'Uploaded Excel file is empty or has no data rows.');
            }

            $createdCount = 0;
            $updatedCount = 0;
            $skippedCount = 0;
            $skippedDetails = [];
            $processedPlanNos = collect();
            $header = $rows->first()->map(fn($item) => strtolower(str_replace([' ', '-'], '_', $item ?? '')));
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
                $currentRowNumber = $rowKey + 2;

                $planNo = $row->get('plan_no');
                $planName = $row->get('plan_name');

                if (empty($planNo) && empty($planName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped (empty plan_no & name).";
                    continue;
                }
                if (empty($planNo)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber} (Name: {$planName}): Skipped (missing plan_no).";
                    continue;
                }
                if (empty($planName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber} (No: {$planNo}): Skipped (missing plan_name).";
                    continue;
                }

                if ($processedPlanNos->contains($planNo)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped (duplicate plan_no '{$planNo}' in this file).";
                    continue;
                }

                $departmentValueFromExcel = $row->get('department_id'); // Could be ID, Name, or department_no
                $departmentNoFromExcelIfText = (!is_numeric($departmentValueFromExcel) && !empty($departmentValueFromExcel)) ? $departmentValueFromExcel : null;

                $departmentId = $this->findRelatedId(
                    Department::class,
                    'department_name',
                    $departmentValueFromExcel,
                    $skippedDetails,
                    $currentRowNumber,
                    'Department',
                    'id',
                    'department_no',
                    $departmentNoFromExcelIfText
                );

                if (is_null($departmentId) && !empty($departmentValueFromExcel)) {
                    $skippedCount++;
                    continue;
                }
                if (is_null($departmentId) && empty($departmentValueFromExcel)) { // Department is required
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber} (PlanNo: {$planNo}): Skipped - Department is required.";
                    continue;
                }

                $isActiveValue = $row->get('is_active', '1');
                $isActive = filter_var($isActiveValue, FILTER_VALIDATE_BOOLEAN, FILTER_NULL_ON_FAILURE);
                if (is_null($isActive)) {
                    $isActive = (strtolower(trim($isActiveValue)) === 'active' || $isActiveValue === '1' || strtolower(trim($isActiveValue)) === 'yes');
                }

                $dataToValidate = [
                    'plan_no' => $planNo,
                    'plan_name' => $planName,
                    'year' => $row->get('year'),
                    'plan_hours' => $row->get('plan_hours'),
                    'department_id' => $departmentId,
                    'is_active' => $isActive,
                ];

                $validator = Validator::make($dataToValidate, [
                    'plan_no' => 'required|string|max:50',
                    'plan_name' => 'required|string|max:255',
                    'year' => 'required|integer|digits:4|min:2000|max:' . (date('Y') + 10),
                    'plan_hours' => 'required|integer|min:1|max:300',
                    'department_id' => 'required|integer|exists:departments,id',
                    'is_active' => 'required|boolean',
                ]);

                if ($validator->fails()) {
                    $skippedCount++;
                    $errors = implode('; ', $validator->errors()->all());
                    $skippedDetails[] = "Row {$currentRowNumber} (PlanNo: {$planNo}): Skipped - Validation: {$errors}";
                    continue;
                }
                $validatedData = $validator->validated();

                $plan = Plan::updateOrCreate(['plan_no' => $validatedData['plan_no']], $validatedData);
                if ($plan->wasRecentlyCreated) {
                    $createdCount++;
                } elseif ($plan->wasChanged()) {
                    $updatedCount++;
                } else {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber} (PlanNo: {$planNo}): Data already up-to-date.";
                }
                $processedPlanNos->push($planNo);
            }

            $message = "Academic Plans bulk upload processed. ";
            if ($createdCount > 0) $message .= "{$createdCount} new created. ";
            if ($updatedCount > 0) $message .= "{$updatedCount} updated. ";
            if ($skippedCount > 0) $message .= "{$skippedCount} skipped. ";
            if (!empty($skippedDetails)) {
                session()->flash('skipped_details', $skippedDetails);
            }
            return redirect()->route('data-entry.plans.index')->with('success', trim($message));
        } catch (Exception $e) {
            Log::error('Plan Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return redirect()->route('data-entry.plans.index')->with('error', 'Upload error: ' . $e->getMessage());
        }
    }

    public function manageSubjects(Plan $plan)
    { /* ... كود manageSubjects للويب ... */
        try {
            $allSubjects = Subject::orderBy('subject_name')->get(['id', 'subject_no', 'subject_name']);
            $addedSubjectIds = $plan->planSubjectEntries()->pluck('subject_id')->toArray();
            return view('dashboard.data-entry.plan-subjects-manage', compact('plan', 'allSubjects', 'addedSubjectIds'));
        } catch (Exception $e) {
            Log::error("Error loading manage subjects view for Plan ID {$plan->id}: " . $e->getMessage());
            return redirect()->route('data-entry.plans.index')->with('error', 'Could not load plan subject management page.');
        }
    }

    public function addSubject(Request $request, Plan $plan, $level, $semester)
    { /* ... كود addSubject للويب ... */
        $validatedData = $request->validate(['subject_id' => ['required', 'integer', 'exists:subjects,id', Rule::unique('plan_subjects')->where(fn($q) => $q->where('plan_id', $plan->id)->where('plan_level', $level)->where('plan_semester', $semester))],], ['subject_id.unique' => 'Subject already added.', 'subject_id.*' => 'Invalid subject selected.']);
        try {
            PlanSubject::create(['plan_id' => $plan->id, 'subject_id' => $validatedData['subject_id'], 'plan_level' => $level, 'plan_semester' => $semester]);
            return redirect()->route('data-entry.plans.manageSubjects', $plan->id)->with('success', 'Subject added successfully.');
        } catch (Exception $e) {
            Log::error("Error adding subject {$request->subject_id} to plan {$plan->id} (L{$level}S{$semester}): " . $e->getMessage());
            return redirect()->route('data-entry.plans.manageSubjects', $plan->id)->with('error', 'Failed to add subject.')->withInput(['subject_id' => $request->subject_id]);
        }
    }

    public function removeSubject(Plan $plan, PlanSubject $planSubject)
    { /* ... كود removeSubject للويب ... */
        if ($planSubject->plan_id !== $plan->id) {
            abort(404);
        }
        try {
            $subjectName = optional($planSubject->subject)->subject_name ?? 'N/A';
            $planSubject->delete();
            return redirect()->route('data-entry.plans.manageSubjects', $plan->id)->with('success', "Subject '{$subjectName}' removed.");
        } catch (Exception $e) {
            Log::error("Error removing plan subject ID {$planSubject->id}: " . $e->getMessage());
            return redirect()->back()->with('error', 'Failed to remove subject.');
        }
    }

    // **************************************** الرفع بالاكسل ****************************************************

    // /**
    //  * Helper function to find Plan ID by various identifiers.
    //  */
    // private function findPlanIdSmart($identifier, &$skippedDetails, $rowNum)
    // {
    //     if (empty($identifier)) {
    //         // إذا كان عمود الخطة فارغاً، سنفترض أنه يقصد الخطة الحالية التي يعمل عليها المستخدم (plan_id_context)
    //         // ولكن هذا المنطق يجب أن يكون خارج هذه الدالة المساعدة. هنا، إذا كان فارغاً، لا يوجد تطابق.
    //         // $skippedDetails[] = "Row {$rowNum}: Plan identifier is empty."; // لا نسجل خطأ هنا إذا كان اختيارياً
    //         return null; // أو نرجع قيمة خاصة للإشارة أنه فارغ
    //     }
    //     // 1. Try as ID
    //     if (is_numeric($identifier)) {
    //         $plan = Plan::find($identifier);
    //         if ($plan) return $plan->id;
    //     }
    //     // 2. Try as plan_no
    //     $plan = Plan::where('plan_no', $identifier)->first();
    //     if ($plan) return $plan->id;

    //     // 3. Try as plan_name (case-insensitive, hamza-insensitive)
    //     $normalizedIdentifier = $this->normalizeArabicString(strtolower(trim($identifier)));
    //     $plan = Plan::all()->first(function ($item) use ($normalizedIdentifier) {
    //         return $this->normalizeArabicString(strtolower(trim($item->plan_name))) === $normalizedIdentifier;
    //     });
    //     if ($plan) return $plan->id;

    //     $skippedDetails[] = "Row {$rowNum}: Plan '{$identifier}' not found by ID, No, or Name. This subject entry will be skipped.";
    //     return null;
    // }

    // /**
    //  * Helper function to find Subject ID by various identifiers.
    //  */

    // private function findSubjectIdSmart($identifier, &$skippedDetails, $rowNum)
    // {
    //     if (empty($identifier)) {
    //         $skippedDetails[] = "Row {$rowNum}: Subject identifier is empty. Record skipped.";
    //         return null;
    //     }
    //     // 1. Try as ID
    //     if (is_numeric($identifier)) {
    //         $subject = Subject::find($identifier);
    //         if ($subject) return $subject->id;
    //     }
    //     // 2. Try as subject_no
    //     $subject = Subject::where('subject_no', $identifier)->first();
    //     if ($subject) return $subject->id;

    //     // 3. Try as subject_name (case-insensitive, hamza-insensitive)
    //     $normalizedIdentifier = $this->normalizeArabicString(strtolower(trim($identifier)));
    //     $subject = Subject::all()->first(function ($item) use ($normalizedIdentifier) {
    //         return $this->normalizeArabicString(strtolower(trim($item->subject_name))) === $normalizedIdentifier;
    //     });
    //     if ($subject) return $subject->id;

    //     $skippedDetails[] = "Row {$rowNum}: Subject '{$identifier}' not found by ID, No, or Name. Record skipped.";
    //     return null;
    // }

    // /**
    //  * Helper function to parse plan_level.
    //  */
    // private function parsePlanLevel($value, &$skippedDetails, $rowNum)
    // {
    //     if (is_numeric($value) && $value >= 1 && $value <= 6) return (int)$value; // Max 6 levels
    //     $normalized = $this->normalizeArabicString(strtolower(trim($value)));
    //     $mapping = ['اولى' => 1, 'ثانية' => 2, 'ثالثة' => 3, 'رابعة' => 4, 'خامسة' => 5, 'سادسة' => 6, 'first' => 1, 'second' => 2, 'third' => 3, 'fourth' => 4, 'fifth' => 5, 'sixth' => 6, 'سنة اولى' => 1, 'سنه اولى' => 1];
    //     if (isset($mapping[$normalized])) return $mapping[$normalized];
    //     $skippedDetails[] = "Row {$rowNum}: Invalid Plan Level '{$value}'. Skipped."; return null;
    // }

    // /**
    //  * Helper function to parse plan_semester.
    //  */
    // private function parsePlanSemester($value, &$skippedDetails, $rowNum)
    // {
    //     if (is_numeric($value) && in_array((int)$value, [1, 2, 3])) return (int)$value;
    //     $normalized = $this->normalizeArabicString(strtolower(trim($value)));
    //     $mapping = ['اول' => 1, 'ثاني' => 2, 'ثالث' => 3, 'صيفي' => 3, 'first' => 1, 'second' => 2, 'summer' => 3, 'فصل اول' => 1, 'فصل ثاني' => 2];
    //     if (isset($mapping[$normalized])) return $mapping[$normalized];
    //     $skippedDetails[] = "Row {$rowNum}: Invalid Plan Semester '{$value}'. Skipped."; return null;
    // }

    // /**
    //  * Handle bulk upload of subjects to a specific plan from Excel file for Web.
    //  */
    // public function bulkUploadPlanSubjects(Request $request, Plan $plan_context) // Route Model Binding للخطة الحالية
    // {
    //     $request->validate([
    //         'plan_subjects_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
    //     ]);

    //     try {
    //         $rows = Excel::toCollection(collect(), $request->file('plan_subjects_excel_file'))->first();
    //         if ($rows->isEmpty() || $rows->count() <= 1) { /* ... error handling ... */ }

    //         $createdCount = 0; $updatedCount = 0; $skippedCount = 0;
    //         $skippedDetails = []; $processedEntriesInFile = collect();

    //         $header = $rows->first()->map(fn ($item) => strtolower(str_replace([' ', '-'], '_', $item ?? '')));
    //         $dataRows = $rows->slice(1);

    //         foreach ($dataRows as $rowKey => $rowArray) {
    //             $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
    //             $currentRowNumber = $rowKey + 2;

    //             // 1. تجاهل الأسطر الفارغة (نحتاج على الأقل معرّف مادة ومستوى وفصل)
    //             $subjectIdentifierExcel = $row->get('subject_id'); // اسم العمود من الإكسل
    //             $planLevelExcel = $row->get('plan_level');
    //             $planSemesterExcel = $row->get('plan_semester');

    //             if (empty($subjectIdentifierExcel) || empty($planLevelExcel) || empty($planSemesterExcel)) {
    //                 $skippedCount++; $skippedDetails[] = "Row {$currentRowNumber}: Skipped (missing subject, level, or semester)."; continue;
    //             }

    //             // 2. (اختياري) التحقق من الخطة إذا كان عمود plan_id موجوداً في الإكسل
    //             $planIdentifierExcel = $row->get('plan_id'); // اسم العمود من الإكسل
    //             if (!empty($planIdentifierExcel)) {
    //                 $planIdFromFile = $this->findPlanIdSmart($planIdentifierExcel, $skippedDetails, $currentRowNumber);
    //                 if (is_null($planIdFromFile)) { $skippedCount++; continue; } // تم تسجيل الخطأ
    //                 if ($planIdFromFile !== $plan_context->id) {
    //                     $skippedCount++; $skippedDetails[] = "Row {$currentRowNumber}: Subject '{$subjectIdentifierExcel}' belongs to plan '{$planIdentifierExcel}', but you are managing plan '{$plan_context->plan_no}'. Skipped."; continue;
    //                 }
    //             }
    //             // إذا لم يكن عمود plan_id موجوداً أو كان فارغاً، نفترض أن الإدخال للخطة الحالية $plan_context

    //             // 3. تحويل معرّف المادة إلى ID
    //             $subjectId = $this->findSubjectIdSmart($subjectIdentifierExcel, $skippedDetails, $currentRowNumber);
    //             if (is_null($subjectId)) { $skippedCount++; continue; }

    //             // 4. تحويل المستوى والفصل
    //             $validPlanLevel = $this->parsePlanLevel($planLevelExcel, $skippedDetails, $currentRowNumber);
    //             if (is_null($validPlanLevel)) { $skippedCount++; continue; }
    //             $validPlanSemester = $this->parsePlanSemester($planSemesterExcel, $skippedDetails, $currentRowNumber);
    //             if (is_null($validPlanSemester)) { $skippedCount++; continue; }

    //             // 5. التحقق من التكرار داخل الملف
    //             $fileEntryKey = "{$plan_context->id}-{$subjectId}-{$validPlanLevel}-{$validPlanSemester}";
    //             if ($processedEntriesInFile->contains($fileEntryKey)) {
    //                 $skippedCount++; $skippedDetails[] = "Row {$currentRowNumber} (SubjID:{$subjectId}): Skipped (duplicate entry in this file for this plan/level/semester)."; continue;
    //             }

    //             // 6. البحث عن المادة في الخطة الحالية
    //             $existingPlanSubject = PlanSubject::where('plan_id', $plan_context->id)
    //                                              ->where('subject_id', $subjectId)
    //                                              ->first();
    //             if ($existingPlanSubject) {
    //                 // المادة موجودة بالفعل في الخطة، تحقق إذا كان المستوى/الفصل مختلفاً
    //                 if ($existingPlanSubject->plan_level != $validPlanLevel || $existingPlanSubject->plan_semester != $validPlanSemester) {
    //                     // تحديث المستوى والفصل
    //                     $existingPlanSubject->update([
    //                         'plan_level' => $validPlanLevel,
    //                         'plan_semester' => $validPlanSemester,
    //                     ]);
    //                     $updatedCount++;
    //                     $skippedDetails[] = "Row {$currentRowNumber} (SubjID:{$subjectId}): Updated level/semester in plan '{$plan_context->plan_no}'.";
    //                 } else {
    //                     // نفس المادة ونفس المستوى والفصل، لا تغيير
    //                     $skippedCount++; $skippedDetails[] = "Row {$currentRowNumber} (SubjID:{$subjectId}): Already exists in plan '{$plan_context->plan_no}' at this level/semester.";
    //                 }
    //             } else {
    //                 // المادة غير موجودة في الخطة، قم بإضافتها
    //                 PlanSubject::create([
    //                     'plan_id' => $plan_context->id,
    //                     'subject_id' => $subjectId,
    //                     'plan_level' => $validPlanLevel,
    //                     'plan_semester' => $validPlanSemester,
    //                 ]);
    //                 $createdCount++;
    //             }
    //             $processedEntriesInFile->push($fileEntryKey);
    //         }

    //         $message = "Plan Subjects bulk upload for plan '{$plan_context->plan_no}' processed. ";
    //         if ($createdCount > 0) $message .= "{$createdCount} new subjects added. ";
    //         if ($updatedCount > 0) $message .= "{$updatedCount} subjects' level/semester updated. ";
    //         if ($skippedCount > 0) $message .= "{$skippedCount} rows skipped/no change. ";
    //         if (!empty($skippedDetails)) { session()->flash('skipped_details', $skippedDetails); }
    //         return redirect()->route('data-entry.plans.manageSubjects', $plan_context->id)->with('success', trim($message));

    //     } catch (Exception $e) {
    //         Log::error('Plan Subjects Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
    //         return redirect()->route('data-entry.plans.manageSubjects', ['plan' => $plan_context])->with('error', 'Upload error: ' . $e->getMessage());
    //         // return redirect()->route('data-entry.plans.manageSubjects', $plan_context->id)->with('error', 'Upload error: ' . $e->getMessage());
    //         // return redirect()->route('data-entry.plans.manageSubjects', $plan->id)->with('error', 'Upload error: ' . $e->getMessage());
    //     }
    // }


    /**
     * Handle the import of plan subjects from an Excel file for a specific plan.
     */
    public function importSubjectsExcel(Request $request, Plan $plan) // Route Model Binding للخطة
    {
        $request->validate([
            'plan_subjects_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120', // 5MB max
        ]);

        try {
            // تمرير كائن الخطة الحالية للـ Importer
            $import = new PlanSubjectsImport($plan);

            Excel::import($import, $request->file('plan_subjects_excel_file'));

            $createdCount = $import->getCreatedCount();
            $updatedCount = $import->getUpdatedCount(); // سنستخدمه إذا كان هناك تحديث لحقول أخرى في plan_subjects
            $skippedCount = $import->getSkippedCount();
            $alreadyExistedCount = $import->getAlreadyExistedCount(); // عدد المواد التي كانت موجودة ولم تتغير
            $invalidPlanCount = $import->getInvalidPlanCount(); // عدد الصفوف التي لم تتطابق مع الخطة الحالية

            $messages = [];
            if ($createdCount > 0) $messages[] = "{$createdCount} new subject(s) added to the plan.";
            if ($updatedCount > 0) $messages[] = "{$updatedCount} existing subject assignment(s) updated."; // (إذا كان هناك تحديث)
            if ($alreadyExistedCount > 0) $messages[] = "{$alreadyExistedCount} subject(s) were already assigned and unchanged.";
            if ($invalidPlanCount > 0) $messages[] = "{$invalidPlanCount} row(s) were skipped as they did not match the current plan or had other critical errors.";
            if ($skippedCount > 0) $messages[] = "{$skippedCount} additional row(s) were skipped (e.g., empty or header).";


            if (empty($messages)) {
                $flashMessage = 'Excel file processed, but no changes were made or no valid data found.';
                return redirect()->route('data-entry.plans.manageSubjects', $plan->id)
                                 ->with('info', $flashMessage);
            } else {
                $flashMessage = "Plan subjects import processed: " . implode(' ', $messages);
                 return redirect()->route('data-entry.plans.manageSubjects', $plan->id)
                                  ->with('success', $flashMessage);
            }


        } catch (ExcelValidationException $e) {
             $failures = $e->failures();
             $errorMessages = [];
             foreach ($failures as $failure) {
                 $errorMessages[] = "Row " . $failure->row() . ": " . implode(', ', $failure->errors()) . " (Value: '" . ($failure->values()[$failure->attribute()] ?? 'N/A') . "')";
             }
             Log::warning('Plan Subjects Excel Import Validation Failures for Plan ID ' . $plan->id .': ', $failures);
             return redirect()->route('data-entry.plans.manageSubjects', $plan->id)
                              ->with('error', 'Import failed due to validation errors in the file. Please check details below.')
                              ->with('import_excel_errors', $errorMessages);

        } catch (Exception $e) {
            Log::error('Plan Subjects Excel Import Failed for Plan ID ' . $plan->id . ': ' . $e->getMessage());
            return redirect()->route('data-entry.plans.manageSubjects', $plan->id)
                             ->with('error', 'An error occurred during the Excel import: ' . $e->getMessage());
        }
    }

    /**
     * Handle bulk upload of subjects to a specific plan from Excel file for Web.
     */
    // public function bulkUploadPlanSubjects(Request $request, Plan $plan) // Route Model Binding للـ Plan
    // {
    //     $request->validate([
    //         'plan_subjects_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
    //     ], [], ['plan_subjects_excel_file' => 'Excel file for plan subjects']);

    //     try {
    //         $rows = Excel::toCollection(collect(), $request->file('plan_subjects_excel_file'))->first();
    //         if ($rows->isEmpty() || $rows->count() <= 1) {
    //             return redirect()->route('data-entry.plans.manageSubjects', $plan->id)->with('error', 'Uploaded file is empty or has no data rows.');
    //         }

    //         $createdCount = 0; $skippedCount = 0;
    //         $skippedDetails = []; $processedEntries = collect(); // لتتبع الإدخالات (plan_id, subject_id, level, semester)

    //         $header = $rows->first()->map(fn ($item) => strtolower(str_replace([' ', '-'], '_', $item ?? '')));
    //         $dataRows = $rows->slice(1);

    //         foreach ($dataRows as $rowKey => $rowArray) {
    //             $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
    //             $currentRowNumber = $rowKey + 2;

    //             $subjectIdentifier = $row->get('subject_id'); // اسم العمود المتوقع للمادة
    //             $planLevel = $row->get('plan_level');
    //             $planSemester = $row->get('plan_semester');

    //             // dd($subjectIdentifier);
    //             if (empty($subjectIdentifier) || empty($planLevel) || empty($planSemester)) {
    //                 $skippedCount++; $skippedDetails[] = "Row {$currentRowNumber}: Skipped (missing subject, level, or semester)."; continue;
    //             }

    //             // تحويل معرّف المادة إلى ID
    //             $subjectId = $this->findSubjectIdSmart($subjectIdentifier, $skippedDetails, $currentRowNumber);
    //             if (is_null($subjectId)) { $skippedCount++; continue; } // تم تسجيل الخطأ في findSubjectIdSmart

    //             // التحقق من صحة المستوى والفصل
    //             $levelSemesterValidator = Validator::make(
    //                 ['plan_level' => $planLevel, 'plan_semester' => $planSemester],
    //                 ['plan_level' => 'required|integer|min:1|max:6', 'plan_semester' => 'required|integer|min:1|max:3']
    //             );
    //             if ($levelSemesterValidator->fails()) {
    //                 $skippedCount++; $errors = implode('; ', $levelSemesterValidator->errors()->all());
    //                 $skippedDetails[] = "Row {$currentRowNumber} (Subject ID: {$subjectId}): Skipped - Invalid level/semester: {$errors}"; continue;
    //             }
    //             $validPlanLevel = $levelSemesterValidator->validated()['plan_level'];
    //             $validPlanSemester = $levelSemesterValidator->validated()['plan_semester'];


    //             // بناء مفتاح فريد للتحقق من التكرار داخل الملف أو في قاعدة البيانات
    //             $uniqueKeyInFile = "{$plan->id}-{$subjectId}-{$validPlanLevel}-{$validPlanSemester}";
    //             $uniqueKeyInDB = [
    //                 'plan_id' => $plan->id,
    //                 'subject_id' => $subjectId,
    //                 'plan_level' => $validPlanLevel,
    //                 'plan_semester' => $validPlanSemester,
    //             ];

    //             if ($processedEntries->contains($uniqueKeyInFile)) {
    //                 $skippedCount++; $skippedDetails[] = "Row {$currentRowNumber}: Skipped (duplicate entry in this file)."; continue;
    //             }

    //             // بما أننا لا نحدث، فقط نضيف إذا لم يكن موجوداً
    //             $existingEntry = PlanSubject::where($uniqueKeyInDB)->first();
    //             if ($existingEntry) {
    //                 $skippedCount++; $skippedDetails[] = "Row {$currentRowNumber} (Subject ID: {$subjectId}): Entry already exists in this plan/level/semester.";
    //                 $processedEntries->push($uniqueKeyInFile); // اعتبره معالجاً
    //                 continue;
    //             }

    //             PlanSubject::create($uniqueKeyInDB);
    //             $createdCount++;
    //             $processedEntries->push($uniqueKeyInFile);
    //         }

    //         $message = "Plan Subjects bulk upload processed. ";
    //         if ($createdCount > 0) $message .= "{$createdCount} new subject assignments created for this plan. ";
    //         if ($skippedCount > 0) $message .= "{$skippedCount} rows skipped. ";
    //         if (!empty($skippedDetails)) { session()->flash('skipped_details', $skippedDetails); }
    //         return redirect()->route('data-entry.plans.manageSubjects', $plan->id)->with('success', trim($message));

    //     } catch (Exception $e) {
    //         Log::error('Plan Subjects Bulk Upload Failed for Plan ID '.$plan->id.': ' . $e->getMessage());
    //         return redirect()->route('data-entry.plans.manageSubjects', $plan->id)->with('error', 'Upload error: ' . $e->getMessage());
    //     }
    // }




    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * Display a listing of the academic plans (API).
     * عرض قائمة الخطط للـ API (بدون Pagination حالياً)
     */
    public function apiIndex(Request $request)
    {
        try {
            $query = Plan::with('department:id,department_name'); // تحميل القسم مع حقول محددة

            // (اختياري) فلترة بسيطة
            if ($request->has('department_id')) {
                $query->where('department_id', $request->department_id);
            }
            if ($request->boolean('active')) { // للبحث عن الخطط الفعالة فقط ?active=true
                $query->where('is_active', true);
            }
            if ($request->boolean('inactive')) { // للبحث عن غير الفعالة ?inactive=true
                $query->where('is_active', false);
            }
            if ($request->has('year')) {
                $query->where('year', $request->year);
            }
            if ($request->has('q')) { // بحث بالرقم أو الاسم
                $searchTerm = $request->q;
                $query->where(function ($q) use ($searchTerm) {
                    $q->where('plan_no', 'like', "%{$searchTerm}%")
                        ->orWhere('plan_name', 'like', "%{$searchTerm}%");
                });
            }

            // --- جلب كل الخطط (الحالة الحالية) ---
            $plans = $query->latest('id') // الترتيب بالأحدث
                ->get();

            // --- كود الـ Pagination (معطل) ---
            /*
            $perPage = $request->query('per_page', 15);
            $plansPaginated = $query->latest('id')->paginate($perPage);
            return response()->json([
                'success' => true,
                'data' => $plansPaginated->items(),
                'pagination' => [ 'total' => $plansPaginated->total(), ... ]
            ], 200);
            */

            return response()->json(['success' => true, 'data' => $plans], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching plans: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }

    /**
     * Store a newly created academic plan from API request.
     * تخزين خطة جديدة قادمة من طلب API
     */
    public function apiStore(Request $request)
    {
        // 1. Validation
        $validatedData = $request->validate([
            'plan_no' => 'required|string|max:50|unique:plans,plan_no',
            'plan_name' => 'required|string|max:255',
            'year' => 'required|integer|digits:4|min:2000',
            'plan_hours' => 'required|integer|min:1',
            'department_id' => 'required|integer|exists:departments,id',
            'is_active' => 'sometimes|boolean', // API يمكنه إرسال true/false مباشرة
        ]);

        // 2. Prepare Data (Handle is_active default if not sent)
        $data = $validatedData;
        $data['is_active'] = $request->boolean('is_active'); // استخدام boolean() للتعامل مع true/false/'1'/'0'

        // 3. Add to Database
        try {
            $plan = Plan::create($data);
            $plan->load('department:id,department_name'); // تحميل القسم لعرضه
            // 4. Return Success JSON Response
            return response()->json([
                'success' => true,
                'data' => $plan,
                'message' => 'Academic Plan created successfully.'
            ], 201);
        } catch (Exception $e) {
            Log::error('API Plan Creation Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to create plan.'], 500);
        }
    }

    /**
     * Display the specified academic plan (API).
     * عرض خطة محددة للـ API
     */
    public function apiShow(Plan $plan)
    {
        try {
            // تحميل القسم والمواد المرتبطة (مع تحديد الحقول)
            $plan->load([
                'department:id,department_name',
                // جلب مواد الخطة مرتبة حسب المستوى ثم الفصل
                'planSubjectEntries' => function ($query) {
                    $query->orderBy('plan_level')->orderBy('plan_semester');
                },
                'planSubjectEntries.subject:id,subject_no,subject_name' // تحميل تفاصيل المادة
            ]);
            return response()->json(['success' => true, 'data' => $plan], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching plan details: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Could not load plan details.'], 500);
        }
    }

    /**
     * Update the specified academic plan from API request.
     * تحديث خطة محددة قادمة من طلب API
     */
    public function apiUpdate(Request $request, Plan $plan)
    {
        // 1. Validation
        $validatedData = $request->validate([
            'plan_no' => ['sometimes', 'required', 'string', 'max:50', 'unique:plans,plan_no,' . $plan->id],
            'plan_name' => 'sometimes|required|string|max:255',
            'year' => 'sometimes|required|integer|digits:4|min:2000',
            'plan_hours' => 'sometimes|required|integer|min:1',
            'department_id' => 'sometimes|required|integer|exists:departments,id',
            'is_active' => 'sometimes|boolean',
        ]);

        // 2. Prepare Data for Update
        $data = $validatedData;
        // تحديث is_active فقط إذا تم إرسالها
        if ($request->has('is_active')) {
            $data['is_active'] = $request->boolean('is_active');
        }

        // 3. Update Database
        try {
            $plan->update($data);
            $plan->load('department:id,department_name'); // تحميل القسم بعد التحديث
            // 4. Return Success JSON Response
            return response()->json([
                'success' => true,
                'data' => $plan,
                'message' => 'Academic Plan updated successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API Plan Update Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to update plan.'], 500);
        }
    }

    /**
     * Remove the specified academic plan from API request.
     * حذف خطة محددة قادمة من طلب API
     */
    public function apiDestroy(Plan $plan)
    {
        // التحقق من وجود مواد مرتبطة
        if ($plan->planSubjectEntries()->exists()) {
            return response()->json(['success' => false, 'message' => 'Cannot delete plan. It has subjects assigned.'], 409);
        }

        // 1. Delete
        try {
            $plan->delete();
            // 2. Return Success JSON Response
            return response()->json(['success' => true, 'message' => 'Academic Plan deleted successfully.'], 200);
        } catch (Exception $e) {
            Log::error('API Plan Deletion Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to delete plan.'], 500);
        }
    }

    // --- API Methods for Plan Subjects (Add/Remove) ---

    /**
     * Add a subject to a plan via API.
     * (Note: Level and semester come from the request body here)
     */
    public function apiAddSubject(Request $request, Plan $plan)
    {
        $validatedData = $request->validate([
            'subject_id' => [
                'required',
                'integer',
                'exists:subjects,id',
                Rule::unique('plan_subjects')->where(function ($query) use ($plan, $request) {
                    return $query->where('plan_id', $plan->id)
                        ->where('plan_level', $request->input('plan_level'))
                        ->where('plan_semester', $request->input('plan_semester'));
                }),
            ],
            'plan_level' => 'required|integer|min:1',
            'plan_semester' => 'required|integer|min:1',
        ], ['subject_id.unique' => 'Subject already added to this level/semester.']);

        try {
            $planSubject = PlanSubject::create([
                'plan_id' => $plan->id,
                'subject_id' => $validatedData['subject_id'],
                'plan_level' => $validatedData['plan_level'],
                'plan_semester' => $validatedData['plan_semester'],
            ]);
            $planSubject->load('subject:id,subject_no,subject_name'); // Load subject details
            return response()->json(['success' => true, 'data' => $planSubject, 'message' => 'Subject added to plan.'], 201);
        } catch (Exception $e) {
            Log::error("API Error adding subject {$request->subject_id} to plan {$plan->id}: " . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to add subject.'], 500);
        }
    }

    /**
     * Remove a subject from a plan via API.
     * (Uses Route Model Binding for PlanSubject)
     */
    public function apiRemoveSubject(Plan $plan, PlanSubject $planSubject)
    {
        if ($planSubject->plan_id !== $plan->id) {
            return response()->json(['success' => false, 'message' => 'Subject association not found in this plan.'], 404);
        }

        try {
            $planSubject->delete();
            return response()->json(['success' => true, 'message' => 'Subject removed from plan.'], 200);
        } catch (Exception $e) {
            Log::error("API Error removing plan subject ID {$planSubject->id} from plan {$plan->id}: " . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to remove subject.'], 500);
        }
    }


    /**
     * Handle bulk upload of academic plans from Excel file via API.
     */
    public function apiBulkUpload(Request $request)
    {
        // 1. التحقق من الملف المرفوع
        $validator = Validator::make($request->all(), [
            'plan_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120', // 5MB max
        ], [], ['plan_excel_file' => 'Excel file']);

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'File validation failed.',
                'errors' => $validator->errors()
            ], 422); // Unprocessable Entity
        }

        try {
            // 2. قراءة البيانات من ملف الإكسل
            $rows = Excel::toCollection(collect(), $request->file('plan_excel_file'))->first();

            if ($rows->isEmpty() || $rows->count() <= 1) { // يجب أن يحتوي على صف عناوين وصف بيانات واحد على الأقل
                return response()->json([
                    'success' => false,
                    'message' => 'The uploaded Excel file is empty or contains no data rows after the header.'
                ], 400); // Bad Request
            }

            $createdCount = 0;
            $updatedCount = 0;
            $skippedCount = 0;
            $skippedDetails = [];
            $processedPlanNos = collect(); // لتتبع أرقام الخطط التي تمت معالجتها من الملف الحالي

            // الحصول على الصف الأول كعناوين (بتحويلها لـ snake_case)
            $header = $rows->first()->map(fn($item) => strtolower(str_replace([' ', '-'], '_', $item ?? '')));
            // إزالة صف العناوين من البيانات
            $dataRows = $rows->slice(1);

            foreach ($dataRows as $rowKey => $rowArray) {
                // تحويل الصف الحالي لمصفوفة باستخدام العناوين كمفاتيح مع trim للقيم
                $row = $header->combine($rowArray->map(fn($val) => trim($val ?? '')));
                $currentRowNumber = $rowKey + 2; // رقم الصف الفعلي في الإكسل (يبدأ من 1، والهيدر هو الصف 1)

                $planNo = $row->get('plan_no');
                $planName = $row->get('plan_name');

                // 1. تجاهل الأسطر الفارغة تماماً (إذا كان رقم الخطة واسمها فارغين)
                if (empty($planNo) && empty($planName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped because both plan_no and plan_name are empty.";
                    continue;
                }
                // تجاهل إذا كان رقم الخطة أو اسم الخطة مفقوداً (اعتبارهم حقولاً أساسية)
                if (empty($planNo)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber} (Plan Name: {$planName}): Skipped because plan_no is missing.";
                    continue;
                }
                if (empty($planName)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber} (Plan No: {$planNo}): Skipped because plan_name is missing.";
                    continue;
                }

                // 4. فحص التكرار داخل الملف نفسه بناءً على plan_no
                if ($processedPlanNos->contains($planNo)) {
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped duplicate plan_no '{$planNo}' from within this file.";
                    continue;
                }

                // جلب department_id (قد يكون ID أو اسم أو رقم قسم من الإكسل)
                $departmentValueFromExcel = $row->get('department_id'); // اسم العمود كما هو في الإكسل (بعد التحويل لـ snake_case)
                $departmentNoFromExcelIfText = (!is_numeric($departmentValueFromExcel) && !empty($departmentValueFromExcel)) ? $departmentValueFromExcel : null;

                $departmentId = $this->findRelatedId(
                    Department::class,
                    'department_name', // العمود للبحث بالاسم في جدول departments
                    $departmentValueFromExcel,
                    $skippedDetails, // مصفوفة لتمرير تفاصيل التجاهل
                    $currentRowNumber,
                    'Department', // اسم ودي للخاصية
                    'id', // عمود الـ ID في جدول departments
                    'department_no', // عمود الرقم في جدول departments للبحث به كخيار ثانٍ
                    $departmentNoFromExcelIfText // قيمة رقم القسم إذا كانت القيمة من الإكسل نصية
                );

                // إذا كان القسم مطلوباً ولم يتم العثور عليه، تجاهل الصف
                if (is_null($departmentId) && !empty($departmentValueFromExcel)) { // كان هناك قيمة ولكن لم يتم العثور على تطابق
                    $skippedCount++;
                    // findRelatedId ستكون قد أضافت التفاصيل لـ skippedDetails
                    continue;
                }
                if (is_null($departmentId) && empty($departmentValueFromExcel)) { // حقل القسم فارغ في الإكسل (وهو مطلوب)
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber} (PlanNo: {$planNo}): Skipped - Department information is required and was not found or is missing in the Excel file.";
                    continue;
                }

                // معالجة is_active
                $isActiveValue = $row->get('is_active', '1'); // قيمة افتراضية '1' إذا لم يكن العمود موجوداً أو فارغاً
                $isActive = filter_var($isActiveValue, FILTER_VALIDATE_BOOLEAN, FILTER_NULL_ON_FAILURE);
                if (is_null($isActive)) { // إذا لم تكن القيمة true/false/1/0/on/off
                    $isActive = (strtolower(trim($isActiveValue)) === 'active' || $isActiveValue === '1' || strtolower(trim($isActiveValue)) === 'yes');
                }


                // تجهيز البيانات للتحقق والحفظ
                $dataToValidateAndSave = [
                    'plan_no' => $planNo,
                    'plan_name' => $planName,
                    'year' => $row->get('year'),
                    'plan_hours' => $row->get('plan_hours'),
                    'department_id' => $departmentId, // الـ ID الرقمي للقسم
                    'is_active' => $isActive,
                ];

                // التحقق من صحة البيانات الرقمية الأخرى
                $rowValidator = Validator::make($dataToValidateAndSave, [
                    'plan_no' => 'required|string|max:50', // لا نتحقق من unique هنا لأننا سنستخدم updateOrCreate
                    'plan_name' => 'required|string|max:255',
                    'year' => 'required|integer|digits:4|min:2000|max:' . (date('Y') + 10), // سنة منطقية
                    'plan_hours' => 'required|integer|min:1|max:300', // ساعات منطقية
                    'department_id' => 'required|integer|exists:departments,id',
                    'is_active' => 'required|boolean',
                ]);

                if ($rowValidator->fails()) {
                    $skippedCount++;
                    $errors = implode('; ', $rowValidator->errors()->all());
                    $skippedDetails[] = "Row {$currentRowNumber} (PlanNo: {$planNo}): Skipped - Validation errors: {$errors}";
                    continue;
                }
                $validatedData = $rowValidator->validated(); // البيانات النظيفة

                // 3. البحث عن الخطة في قاعدة البيانات وتحديثها أو إنشاؤها
                $plan = Plan::updateOrCreate(
                    ['plan_no' => $validatedData['plan_no']], // الشرط للبحث (أو الإنشاء إذا لم يوجد)
                    $validatedData // البيانات للتحديث أو الإنشاء
                );

                if ($plan->wasRecentlyCreated) {
                    $createdCount++;
                } elseif ($plan->wasChanged()) { // للتحقق إذا تم تحديث أي حقل فعلاً
                    $updatedCount++;
                } else {
                    // لم يتم إنشاؤه ولم يتغير (موجود بنفس البيانات)
                    $skippedCount++;
                    $skippedDetails[] = "Row {$currentRowNumber} (PlanNo: {$planNo}): Data already up-to-date in the system.";
                }
                $processedPlanNos->push($planNo);
            }

            // 4. بناء الاستجابة
            $summaryMessage = "Academic Plans bulk upload processed via API.";
            $responseData = [
                'created_count' => $createdCount,
                'updated_count' => $updatedCount,
                'skipped_count' => $skippedCount,
                'skipped_details' => $skippedDetails,
            ];

            return response()->json([
                'success' => true,
                'message' => $summaryMessage,
                'data' => $responseData
            ], 200); // OK

        } catch (Exception $e) {
            Log::error('API Plan Bulk Upload Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return response()->json([
                'success' => false,
                'message' => 'An error occurred during API bulk upload.',
                'error_details' => $e->getMessage() // للمطور
            ], 500); // Internal Server Error
        }
    }
}
----------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\PlanExpectedCountController.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Models\PlanExpectedCount; // تم استيراده
use App\Models\Plan; // نحتاج الخطط للـ dropdown
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\Rule;
use Illuminate\Support\Facades\Validator;
use Exception;

class PlanExpectedCountController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================

    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        try {
            // جلب الأعداد مع الخطط، مرتبة بالسنة ثم الخطة ثم المستوى ثم الفصل
            $expectedCounts = PlanExpectedCount::with('plan:id,plan_no,plan_name')
                ->orderBy('academic_year', 'desc')
                ->orderBy('plan_id') // أو حسب اسم الخطة إذا أردت
                ->orderBy('plan_level')
                ->orderBy('plan_semester')
                ->paginate(20); // عدد أكبر في الصفحة

            // جلب الخطط للـ dropdown في المودال
            $plans = Plan::where('is_active', true)->orderBy('plan_name')->get(['id', 'plan_no', 'plan_name']);

            return view('dashboard.data-entry.plan-expected-counts', compact('expectedCounts', 'plans'));
        } catch (Exception $e) {
            Log::error('Error fetching expected counts: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load expected counts.');
        }
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        // 1. Validation مع التحقق من التفرد
        $validator = Validator::make($request->all(), [
            'academic_year' => 'required|integer|digits:4|min:2020',
            'plan_id' => 'required|integer|exists:plans,id',
            'plan_level' => 'required|integer|min:1|max:6',
            'plan_semester' => 'required|integer|min:1|max:3',
            'male_count' => 'required|integer|min:0',
            'female_count' => 'required|integer|min:0',
            'branch' => 'nullable|string|max:100',
        ]);

        // التحقق من التفرد يدوياً (لنفس الخطة، المستوى، الفصل، السنة، والفرع)
        $validator->after(function ($validator) use ($request) {
            if (!$validator->errors()->hasAny(['academic_year', 'plan_id', 'plan_level', 'plan_semester'])) {
                $exists = PlanExpectedCount::where('academic_year', $request->input('academic_year'))
                    ->where('plan_id', $request->input('plan_id'))
                    ->where('plan_level', $request->input('plan_level'))
                    ->where('plan_semester', $request->input('plan_semester'))
                    // التعامل مع الفرع - إذا كان فارغاً، نعتبره NULL
                    ->where(function ($query) use ($request) {
                        if (empty($request->input('branch'))) {
                            $query->whereNull('branch');
                        } else {
                            $query->where('branch', $request->input('branch'));
                        }
                    })
                    ->exists();
                if ($exists) {
                    $validator->errors()->add('count_unique', 'An expected count entry already exists for this specific plan, year, level, semester, and branch.');
                }
            }
        });

        if ($validator->fails()) {
            return redirect()->back()
                ->withErrors($validator, 'store') // استخدام error bag
                ->withInput();
        }

        // 2. Prepare Data
        $data = $validator->validated();
        // تعيين branch إلى null إذا كان فارغاً
        $data['branch'] = empty($data['branch']) ? null : $data['branch'];

        // 3. Add to Database
        try {
            PlanExpectedCount::create($data);
            return redirect()->route('data-entry.plan-expected-counts.index')
                ->with('success', 'Expected count created successfully.');
        } catch (Exception $e) {
            Log::error('Expected Count Creation Failed: ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to create expected count.')
                ->withInput();
        }
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, PlanExpectedCount $planExpectedCount) // استخدام Route Model Binding
    {
        // 1. Validation
        $validator = Validator::make($request->all(), [
            'academic_year' => 'required|integer|digits:4|min:2020',
            'plan_id' => 'required|integer|exists:plans,id',
            'plan_level' => 'required|integer|min:1|max:6',
            'plan_semester' => 'required|integer|min:1|max:3',
            'male_count' => 'required|integer|min:0',
            'female_count' => 'required|integer|min:0',
            'branch' => 'nullable|string|max:100',
        ]);

        // 2. التحقق من التفرد يدوياً (مع تجاهل الصف الحالي)
        $validator->after(function ($validator) use ($request, $planExpectedCount) {
            if (!$validator->errors()->hasAny(['academic_year', 'plan_id', 'plan_level', 'plan_semester'])) {
                $exists = PlanExpectedCount::where('academic_year', $request->input('academic_year'))
                    ->where('plan_id', $request->input('plan_id'))
                    ->where('plan_level', $request->input('plan_level'))
                    ->where('plan_semester', $request->input('plan_semester'))
                    ->where(function ($query) use ($request) {
                        if (empty($request->input('branch'))) {
                            $query->whereNull('branch');
                        } else {
                            $query->where('branch', $request->input('branch'));
                        }
                    })
                    ->where('id', '!=', $planExpectedCount->id) // استثناء السجل الحالي
                    ->exists();
                if ($exists) {
                    $validator->errors()->add('count_unique', 'Another expected count entry already exists for this specific combination.');
                }
            }
        });

        if ($validator->fails()) {
            return redirect()->back()
                ->withErrors($validator, 'update_' . $planExpectedCount->id) // error bag للتحديث
                ->withInput();
        }

        // 3. Prepare Data
        $data = $validator->validated();
        $data['branch'] = empty($data['branch']) ? null : $data['branch'];

        // 4. Update Database
        try {
            $planExpectedCount->update($data);
            return redirect()->route('data-entry.plan-expected-counts.index')
                ->with('success', 'Expected count updated successfully.');
        } catch (Exception $e) {
            Log::error('Expected Count Update Failed: ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to update expected count.')
                ->withInput();
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(PlanExpectedCount $planExpectedCount)
    {
        // لا يوجد عادةً ارتباطات تمنع حذف هذا السجل
        try {
            $planExpectedCount->delete();
            return redirect()->route('data-entry.plan-expected-counts.index')
                ->with('success', 'Expected count deleted successfully.');
        } catch (Exception $e) {
            Log::error('Expected Count Deletion Failed: ' . $e->getMessage());
            return redirect()->route('data-entry.plan-expected-counts.index')
                ->with('error', 'Failed to delete expected count.');
        }
    }

    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * Display a listing of the expected counts (API).
     * عرض قائمة الأعداد المتوقعة للـ API (بدون Pagination حالياً)
     */
    public function apiIndex(Request $request)
    {
        try {
            $query = PlanExpectedCount::with('plan:id,plan_no,plan_name'); // تحميل الخطة

            // (اختياري) فلترة
            if ($request->has('academic_year')) {
                $query->where('academic_year', $request->academic_year);
            }
            if ($request->has('plan_id')) {
                $query->where('plan_id', $request->plan_id);
            }
            if ($request->has('level')) {
                $query->where('plan_level', $request->level);
            }
            if ($request->has('semester')) {
                $query->where('plan_semester', $request->semester);
            }
            if ($request->has('branch')) {
                if (strtolower($request->branch) == 'null' || $request->branch == '') {
                    $query->whereNull('branch');
                } else {
                    $query->where('branch', $request->branch);
                }
            }

            // --- جلب كل النتائج (الحالة الحالية) ---
            $expectedCounts = $query->orderBy('academic_year', 'desc')
                ->orderBy('plan_id')
                ->orderBy('plan_level')
                ->orderBy('plan_semester')
                ->get();

            // --- كود الـ Pagination للـ API (معطل) ---
            /*
            $perPage = $request->query('per_page', 25); // عدد أكبر في الصفحة
            $expectedCountsPaginated = $query->orderBy('academic_year', 'desc')
                                             ->orderBy('plan_id')
                                             ->orderBy('plan_level')
                                             ->orderBy('plan_semester')
                                             ->paginate($perPage);

            return response()->json([
                'success' => true,
                'data' => $expectedCountsPaginated->items(),
                'pagination' => [ 'total' => $expectedCountsPaginated->total(), ... ]
            ], 200);
            */

            return response()->json(['success' => true, 'data' => $expectedCounts], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching expected counts: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }

    /**
     * Store a newly created expected count from API request.
     * تخزين عدد متوقع جديد قادم من طلب API
     */
    public function apiStore(Request $request)
    {
        // 1. Validation (نفس قواعد الويب ولكن بدون after للتبسيط الأولي للـ API)
        // التحقق من التفرد يمكن إضافته كقاعدة Rule::unique مركبة إذا لزم الأمر
        $validator = Validator::make($request->all(), [
            'academic_year' => 'required|integer|digits:4|min:2020',
            'plan_id' => 'required|integer|exists:plans,id',
            'plan_level' => 'required|integer|min:1|max:6',
            'plan_semester' => 'required|integer|min:1|max:3',
            'male_count' => 'required|integer|min:0',
            'female_count' => 'required|integer|min:0',
            'branch' => 'nullable|string|max:100',
            // يمكنك إضافة قاعدة unique مركبة هنا إذا أردت
        ]);

        // التحقق من التفرد يدوياً (لضمان الدقة كما في الويب)
        $validator->after(function ($validator) use ($request) {
            if (!$validator->errors()->hasAny()) { // تحقق فقط إذا لم يكن هناك أخطاء أخرى
                $exists = PlanExpectedCount::where('academic_year', $request->input('academic_year'))
                    ->where('plan_id', $request->input('plan_id'))
                    ->where('plan_level', $request->input('plan_level'))
                    ->where('plan_semester', $request->input('plan_semester'))
                    ->where(function ($query) use ($request) {
                        if (empty($request->input('branch'))) {
                            $query->whereNull('branch');
                        } else {
                            $query->where('branch', $request->input('branch'));
                        }
                    })->exists();
                if ($exists) {
                    $validator->errors()->add('count_unique', 'Entry already exists for this combination.');
                }
            }
        });


        if ($validator->fails()) {
            return response()->json(['success' => false, 'errors' => $validator->errors()], 422);
        }

        // 2. Prepare Data
        $data = $validator->validated();
        $data['branch'] = empty($data['branch']) ? null : $data['branch'];

        // 3. Add to Database
        try {
            $count = PlanExpectedCount::create($data);
            $count->load('plan:id,plan_no,plan_name'); // تحميل الخطة للاستجابة
            // 4. Return Success JSON Response
            return response()->json([
                'success' => true,
                'data' => $count,
                'message' => 'Expected count created successfully.'
            ], 201);
        } catch (Exception $e) {
            Log::error('API Expected Count Creation Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to create expected count.'], 500);
        }
    }

    /**
     * Display the specified expected count (API).
     * عرض عدد متوقع محدد للـ API
     */
    public function apiShow(PlanExpectedCount $planExpectedCount) // Route Model Binding
    {
        try {
            $planExpectedCount->load('plan:id,plan_no,plan_name'); // تحميل الخطة المرتبطة
            return response()->json(['success' => true, 'data' => $planExpectedCount], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching expected count details: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Could not load details.'], 500);
        }
    }

    /**
     * Update the specified expected count from API request.
     * تحديث عدد متوقع محدد قادم من طلب API
     */
    public function apiUpdate(Request $request, PlanExpectedCount $planExpectedCount)
    {
        // 1. Validation (استخدام sometimes)
        $validator = Validator::make($request->all(), [
            'academic_year' => 'sometimes|required|integer|digits:4|min:2020',
            'plan_id' => 'sometimes|required|integer|exists:plans,id',
            'plan_level' => 'sometimes|required|integer|min:1|max:6',
            'plan_semester' => 'sometimes|required|integer|min:1|max:3',
            'male_count' => 'sometimes|required|integer|min:0',
            'female_count' => 'sometimes|required|integer|min:0',
            'branch' => 'sometimes|nullable|string|max:100',
        ]);

        // التحقق من التفرد يدوياً (مع تجاهل الصف الحالي)
        $validator->after(function ($validator) use ($request, $planExpectedCount) {
            if (!$validator->errors()->hasAny()) {
                $exists = PlanExpectedCount::where('academic_year', $request->input('academic_year', $planExpectedCount->academic_year)) // استخدام القيمة الحالية كافتراضي
                    ->where('plan_id', $request->input('plan_id', $planExpectedCount->plan_id))
                    ->where('plan_level', $request->input('plan_level', $planExpectedCount->plan_level))
                    ->where('plan_semester', $request->input('plan_semester', $planExpectedCount->plan_semester))
                    ->where(function ($query) use ($request, $planExpectedCount) {
                        $branch = $request->input('branch', $planExpectedCount->branch); // التعامل مع القيمة الافتراضية للفرع
                        if (is_null($branch) || $branch === '') {
                            $query->whereNull('branch');
                        } else {
                            $query->where('branch', $branch);
                        }
                    })
                    ->where('id', '!=', $planExpectedCount->id)
                    ->exists();
                if ($exists) {
                    $validator->errors()->add('count_unique', 'Another entry already exists for this combination.');
                }
            }
        });


        if ($validator->fails()) {
            return response()->json(['success' => false, 'errors' => $validator->errors()], 422);
        }

        // 2. Prepare Data for Update
        $data = $validator->validated();
        // التعامل مع branch إذا تم إرساله
        if ($request->has('branch')) {
            $data['branch'] = empty($data['branch']) ? null : $data['branch'];
        }

        // 3. Update Database
        try {
            $planExpectedCount->update($data);
            $planExpectedCount->load('plan:id,plan_no,plan_name'); // تحميل الخطة بعد التحديث
            // 4. Return Success JSON Response
            return response()->json([
                'success' => true,
                'data' => $planExpectedCount,
                'message' => 'Expected count updated successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API Expected Count Update Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to update expected count.'], 500);
        }
    }

    /**
     * Remove the specified expected count from API request.
     * حذف عدد متوقع محدد قادم من طلب API
     */
    public function apiDestroy(PlanExpectedCount $planExpectedCount)
    {
        // لا يوجد قيود عادةً
        try {
            $planExpectedCount->delete();
            return response()->json([
                'success' => true,
                'message' => 'Expected count deleted successfully.'
            ], 200);
        } catch (Exception $e) {
            Log::error('API Expected Count Deletion Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to delete expected count.'], 500);
        }
    }
}
-----------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\PlanSubjectImportController.php
<?php

namespace App\Http\Controllers\DataEntry;

use Exception;
use App\Models\Plan;
use App\Models\Subject;
use App\Models\PlanSubject;
use Illuminate\Support\Str;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Validator;
use Maatwebsite\Excel\Facades\Excel; // لاستخدام Excel مباشرة
use Illuminate\Validation\Rule; // قد لا نحتاجه هنا إذا التحقق داخل اللوب

class PlanSubjectImportController extends Controller
{
    private $createdCount = 0;
    private $updatedCount = 0; // إذا احتجنا للتحديث لاحقاً
    private $skippedCount = 0;
    private $alreadyExistedCount = 0;
    private $invalidPlanCount = 0;
    private $processedPlanSubjectKeys = [];
    private $skippedDetails = []; // لتخزين تفاصيل الأسطر المتجاهلة

    /**
     * Handle the import of plan subjects from an Excel file for a specific plan.
     */
    public function handleImport(Request $request, Plan $plan) // Route Model Binding للخطة
    {
        $request->validate([
            'plan_subjects_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
        ]);

        // إعادة تعيين العدادات لكل عملية رفع
        $this->resetCounters();

        try {
            // قراءة الملف مباشرة (بدون كلاس Import منفصل)
            $rows = Excel::toArray(new \stdClass(), $request->file('plan_subjects_excel_file'))[0]; // الحصول على أول شيت

            if (empty($rows)) {
                return redirect()->route('data-entry.plans.manageSubjects', $plan->id)
                    ->with('error', 'The uploaded Excel file is empty or could not be read.');
            }

            // افترض أن الصف الأول هو العناوين
            $header = array_map('strtolower', array_map('trim', array_shift($rows))); // قراءة العناوين وتحويلها لحروف صغيرة وإزالة الفراغات

            // تحديد أسماء الأعمدة المتوقعة (بحروف صغيرة وبدون فراغات لتسهيل المطابقة)
            $expectedPlanKey = 'plan_id'; // أو 'planname' أو 'planid' (سنتعامل مع هذا)
            $expectedLevelKey = 'plan_level';
            $expectedSemesterKey = 'plan_semester';
            $expectedSubjectKey = 'subject_id'; // أو 'subjectno', 'subjectname'

            // البحث عن مواقع الأعمدة بناءً على العناوين
            $planCol = $this->getColumnIndex($header, ['plan_id', 'planid', 'plan name', 'planname', 'plan_name', 'plan_no', 'planno']);
            $levelCol = $this->getColumnIndex($header, ['plan_level', 'planlevel', 'level']);
            $semesterCol = $this->getColumnIndex($header, ['plan_semester', 'plansemester', 'semester']);
            $subjectCol = $this->getColumnIndex($header, ['subject_id', 'subjectid', 'subject_no', 'subjectno', 'subject_name', 'subjectname']);

            // التحقق من وجود الأعمدة الأساسية
            if (is_null($planCol) || is_null($levelCol) || is_null($semesterCol) || is_null($subjectCol)) {
                $missing = [];
                if (is_null($planCol)) $missing[] = "'plan_id' or 'plan_name' or 'plan_no'";
                if (is_null($levelCol)) $missing[] = "'plan_level' or 'planlevel' or 'level'";
                if (is_null($semesterCol)) $missing[] = "'plan_semester' or 'plansemester' or 'semester'";
                if (is_null($subjectCol)) $missing[] = "'subject_id' or 'subject_no' or 'subject_name'";
                return redirect()->route('data-entry.plans.manageSubjects', $plan->id)
                    ->with('error', 'Excel file is missing required columns: ' . implode(', ', $missing) . '. Please check the header row.');
            }

            $currentRowNumber = 1; // لبدء العد من الصف الثاني (بعد العناوين)

            foreach ($rows as $row) {
                $currentRowNumber++; // رقم الصف الفعلي في الإكسل

                // تحويل الصف لمصفوفة بأسماء العناوين الأصلية (للتوافق مع findSubject)
                $rowData = [];
                foreach ($header as $index => $colName) {
                    $rowData[$colName] = $row[$index] ?? null;
                }
                // dd($rowData);

                // 1. تجاهل الصفوف الفارغة تماماً
                if (count(array_filter($row)) == 0) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (completely empty row).";
                    $this->skippedCount++;
                    continue;
                }

                $planIdentifier = trim($rowData[$header[$planCol]] ?? null);
                $levelInput = trim($rowData[$header[$levelCol]] ?? null);
                $semesterInput = trim($rowData[$header[$semesterCol]] ?? null);
                $subjectIdentifier = trim($rowData[$header[$subjectCol]] ?? null);


                // تجاهل إذا كانت البيانات الأساسية فارغة
                if (empty($planIdentifier) || empty($subjectIdentifier) || empty($levelInput) || empty($semesterInput)) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (missing plan, subject, level, or semester identifier).";
                    $this->skippedCount++;
                    continue;
                }

                // 2. التحقق من تطابق الخطة
                $planIdInFile = null;
                if (is_numeric($planIdentifier)) {
                    $planIdInFile = (int) $planIdentifier;
                } else { /* ... (نفس منطق البحث عن الخطة بالاسم من كلاس Import السابق) ... */
                    // محاولة البحث بالاسم (مع تجاهل حالة الأحرف والسنة إذا كانت مدمجة)
                    // نفترض أن اسم الخطة في الملف قد يكون "Plan Name Only" أو "Plan Name - YYYY"
                    $planNameFromFile = preg_replace('/-\s*\d{4}$/', '', $planIdentifier); // إزالة "- YYYY"
                    $foundPlan = Plan::whereRaw('LOWER(REPLACE(plan_name, " ", "")) LIKE ?', ['%' . strtolower(str_replace(' ', '', $planNameFromFile)) . '%'])
                        ->orWhereRaw('LOWER(REPLACE(plan_no, " ", "")) LIKE ?', ['%' . strtolower(str_replace(' ', '', $planIdentifier)) . '%'])
                        ->first();
                    if ($foundPlan) {
                        $planIdInFile = $foundPlan->id;
                    }
                }

                if (is_null($planIdInFile) || $planIdInFile !== $plan->id) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (Plan '{$planIdentifier}' does not match current plan '{$plan->plan_no}').";
                    $this->invalidPlanCount++;
                    continue;
                }

                // 3. معالجة المستوى والفصل
                $level = $this->normalizeLevelOrSemester($levelInput);
                $semester = $this->normalizeLevelOrSemester($semesterInput);

                if (is_null($level) || is_null($semester) || $level < 1 || $semester < 1) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (Invalid level '{$levelInput}' or semester '{$semesterInput}').";
                    $this->skippedCount++;
                    continue;
                }

                // 4. معالجة معرّف المادة
                $subject = $this->findSubject($subjectIdentifier);
                if (!$subject) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (Subject '{$subjectIdentifier}' not found).";
                    $this->skippedCount++;
                    continue;
                }

                // 5. التحقق من التكرار داخل الملف
                $uniqueKey = $plan->id . '-' . $subject->id . '-' . $level . '-' . $semester;
                if (isset($this->processedPlanSubjectKeys[$uniqueKey])) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (Duplicate entry for subject '{$subject->subject_no}' in this level/semester within the file).";
                    $this->skippedCount++;
                    continue;
                }
                $this->processedPlanSubjectKeys[$uniqueKey] = true;

                // 6. التحقق من وجود الربط مسبقاً في قاعدة البيانات
                $existingPlanSubject = PlanSubject::where('plan_id', $plan->id)
                    ->where('subject_id', $subject->id)
                    // ->where('plan_level', $level)
                    // ->where('plan_semester', $semester)
                    ->first();


                if ($existingPlanSubject) {

                    // *************************************************************************
                    if ($existingPlanSubject->plan_level != $level || $existingPlanSubject->plan_semester != $semester) {
                        // dd([
                        //     'planIdentifier' => $planIdentifier,
                        //     'levelInput' => $levelInput,
                        //     'semesterInput' => $semesterInput,
                        //     'subjectIdentifier' => $subjectIdentifier,
                        //     'existingPlanSubject' => $existingPlanSubject,
                        // ]);
                        // تحديث المستوى والفصل
                        $existingPlanSubject->update([
                            'plan_level' => $level,
                            'plan_semester' => $semester,
                        ]);
                        $this->updatedCount++;
                        $skippedDetails[] = "Row {$currentRowNumber} (SubjID:{$subject->id}): Updated level/semester in plan '{$plan->plan_no}'.";
                    } else {
                        // dd($existingPlanSubject);
                        // نفس المادة ونفس المستوى والفصل، لا تغيير
                        $this->skippedCount++;
                        $skippedDetails[] = "Row {$currentRowNumber} (SubjID:{$subject->id}): Already exists in plan '{$plan->plan_no}' at this level/semester.";
                    }
                    // *************************************************************************

                    $this->alreadyExistedCount++;
                    // لا نسجلها في skippedDetails إلا إذا أردت
                } else {
                    PlanSubject::create([
                        'plan_id'       => $plan->id,
                        'subject_id'    => $subject->id,
                        'plan_level'    => $level,
                        'plan_semester' => $semester,
                    ]);
                    $this->createdCount++;
                }
            } // نهاية حلقة الصفوف

            // بناء رسالة النجاح
            $messages = [];
            if ($this->createdCount > 0) $messages[] = "{$this->createdCount} new subject(s) added to plan '{$plan->plan_no}'.";
            if ($this->alreadyExistedCount > 0) $messages[] = "{$this->alreadyExistedCount} subject(s) were already assigned and unchanged.";
            if ($this->invalidPlanCount > 0) $messages[] = "{$this->invalidPlanCount} row(s) were skipped (did not match current plan).";
            if ($this->skippedCount > 0) $messages[] = "{$this->skippedCount} other row(s) were skipped (empty or invalid data).";

            if (empty($messages)) {
                return redirect()->route('data-entry.plans.manageSubjects', $plan->id)->with('info', 'Excel file processed. No changes made or no valid data found.');
            } else {
                return redirect()->route('data-entry.plans.manageSubjects', $plan->id)->with('success', implode(' ', $messages))->with('skipped_details', $this->skippedDetails);
            }
        } catch (Exception $e) {
            Log::error('Plan Subjects Excel Import Failed for Plan ID ' . $plan->id . ': ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return redirect()->route('data-entry.plans.manageSubjects', $plan->id)
                ->with('error', 'An error occurred during Excel import: ' . $e->getMessage());
        }
    }

    /**
     * Helper function to get column index by trying multiple possible header names.
     */
    private function getColumnIndex(array $header, array $possibleNames)
    {
        foreach ($possibleNames as $name) {
            $name = strtolower(str_replace(' ', '', $name)); // تطبيع الاسم للبحث
            $index = array_search($name, array_map(fn($h) => strtolower(str_replace(' ', '', $h)), $header));
            if ($index !== false) {
                return $index;
            }
        }
        return null;
    }

    /**
     * Helper function to normalize level/semester input.
     */
    private function normalizeLevelOrSemester($input)
    {
        if (is_numeric($input)) {
            return (int) $input;
        }
        $inputLower = strtolower(trim($input));
        $map = [
            'أولى' => 1,
            'سنة أولى' => 1,
            'سنه أولى' => 1,
            'سنة اولى' => 1,
            'سنه اولى' => 1,
            'اولى' => 1,
            'first' => 1,
            'First' => 1,
            '1st' => 1,
            'one' => 1,
            '1' => 1,
            'ثانية' => 2,
            'ثانيه' => 2,
            'second' => 2,
            '2nd' => 2,
            'two' => 2,
            '2' => 2,
            'ثانية' => 2,
            'سنة ثانية' => 2,
            'سنه ثانية' => 2,
            'سنة ثانيه' => 2,
            'سنه ثانيه' => 2,
            'ثانيه' => 2,
            'second' => 2,
            'Second' => 2,
            '2nd' => 2,
            'two' => 2,
            '2' => 2,
            'ثالثة' => 3,
            'ثالثه' => 3,
            'third' => 3,
            '3rd' => 3,
            'three' => 3,
            '3' => 3,
            'ثالثة' => 3,
            'سنة ثانية' => 3,
            'سنه ثالثة' => 3,
            'سنة ثالثه' => 3,
            'سنه ثالثه' => 3,
            'ثانيه' => 3,
            'third' => 3,
            'Third' => 3,
            '3rd' => 3,
            'three' => 3,
            '3' => 3,
            'رابعة' => 4,
            'رابعه' => 4,
            'fourth' => 4,
            '4th' => 4,
            'four' => 4,
            '4' => 4,
            'رابعة' => 4,
            'سنة رابعة' => 4,
            'سنه رابعة' => 4,
            'سنة رابعه' => 4,
            'سنه رابعه' => 4,
            'رابعه' => 4,
            'fourth' => 4,
            'Fourth' => 4,
            '4th' => 4,
            'four' => 4,
            '4' => 4,
            // أضف المزيد حسب الحاجة للفصول والمستويات
            'فصل أول' => 1,
            'فصل اول' => 1,
            'أول' => 1,
            'اول' => 1,
            'first' => 1,
            'First' => 1,
            '1' => 1,
            'فصل ثاني' => 2,
            'فصل ثانى' => 2,
            'ثاني' => 2,
            'ثانى' => 2,
            'second' => 2,
            'Second' => 2,
            '2' => 2,
            'فصل ثالث' => 3,
            'ثالث' => 3,
            'صيفي' => 3,
            'summer' => 3,
            'third' => 3,
            'Third' => 3,
            '3' => 3,
        ];
        return $map[$inputLower] ?? (is_numeric($inputLower) ? (int)$inputLower : null);
    }

    /**
     * Helper function to find subject by ID, No, or Name.
     */
    private function findSubject($identifier)
    {
        if (is_numeric($identifier)) {
            return Subject::find($identifier);
        }
        // البحث بالكود (رقم المادة) - تجاهل حالة الأحرف
        $subject = Subject::whereRaw('LOWER(subject_no) = ?', [strtolower($identifier)])->first();
        if ($subject) {
            return $subject;
        }
        // البحث بالاسم - تجاهل حالة الأحرف والهمزات والفراغات الزائدة
        $normalizedIdentifier = $this->normalizeArabicString($identifier);
        return Subject::whereRaw('REPLACE(LOWER(subject_name), " ", "") LIKE ?', ['%' . str_replace(' ', '', $normalizedIdentifier) . '%'])
            ->orWhereRaw('LOWER(subject_name) LIKE ?', ['%' . $normalizedIdentifier . '%']) // بحث أوسع قليلاً
            ->first(); // قد تحتاج لمنطق أدق إذا كان هناك أسماء متشابهة جداً
    }

    /**
     * Helper function to normalize Arabic string (remove Alif variants, normalize spaces).
     */
    private function normalizeArabicString($string)
    {
        $string = preg_replace('/[أإآ]/u', 'ا', $string); // توحيد الألفات
        $string = preg_replace('/\s+/u', ' ', trim($string)); // إزالة الفراغات الزائدة
        return strtolower($string);
    }

    private function resetCounters()
    {
        $this->createdCount = 0;
        $this->updatedCount = 0;
        $this->skippedCount = 0;
        $this->alreadyExistedCount = 0;
        $this->invalidPlanCount = 0;
        $this->processedPlanSubjectKeys = [];
        $this->skippedDetails = [];
    }

        // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * API: Handle the import of plan subjects from an Excel file for a specific plan.
     */
    public function handleApiImport(Request $request, Plan $plan) // Route Model Binding للخطة
    {
        // 1. التحقق من وجود الملف وصيغته (باستخدام Validator لـ API)
        $validator = Validator::make($request->all(), [
            'plan_subjects_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
        ]);

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed.',
                'errors' => $validator->errors()
            ], 422); // Unprocessable Entity
        }

        $this->resetCounters(); // إعادة تعيين العدادات

        try {
            $rows = Excel::toArray(new \stdClass(), $request->file('plan_subjects_excel_file'))[0];

            if (count($rows) <= 1) { // إذا كان الملف فارغاً أو يحتوي على العناوين فقط
                return response()->json(['success' => false, 'message' => 'Uploaded Excel file is empty or contains only a header row.'], 400);
            }

            $header = array_map('strtolower', array_map('trim', array_shift($rows)));
            $planCol = $this->getColumnIndex($header, ['plan_id', 'planid', 'plan name', 'planname', 'plan_name', 'plan_no', 'planno']);
            $levelCol = $this->getColumnIndex($header, ['plan_level', 'planlevel', 'level']);
            $semesterCol = $this->getColumnIndex($header, ['plan_semester', 'plansemester', 'semester']);
            $subjectCol = $this->getColumnIndex($header, ['subject_id', 'subjectid', 'subject_no', 'subjectno', 'subject_name', 'subjectname']);

            if (is_null($planCol) || is_null($levelCol) || is_null($semesterCol) || is_null($subjectCol)) {
                $missing = [];
                if (is_null($planCol)) $missing[] = "'plan_id' or 'plan_name' or 'plan_no'";
                if (is_null($levelCol)) $missing[] = "'plan_level' or 'planlevel' or 'level'";
                if (is_null($semesterCol)) $missing[] = "'plan_semester' or 'plansemester' or 'semester'";
                if (is_null($subjectCol)) $missing[] = "'subject_id' or 'subject_no' or 'subject_name'";
                return response()->json(['success' => false, 'message' => 'Excel file is missing required columns: ' . implode(', ', $missing)], 400);
            }

            $currentRowNumber = 1;
            foreach ($rows as $row) {
                $currentRowNumber++;
                $rowData = [];
                foreach ($header as $index => $colName) {
                    $rowData[$colName] = $row[$index] ?? null;
                }

                if (count(array_filter($row)) == 0) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (empty).";
                    $this->skippedCount++;
                    continue;
                }

                $planIdentifier = trim($rowData[$header[$planCol]] ?? null);
                $levelInput = trim($rowData[$header[$levelCol]] ?? null);
                $semesterInput = trim($rowData[$header[$semesterCol]] ?? null);
                $subjectIdentifier = trim($rowData[$header[$subjectCol]] ?? null);

                if (empty($planIdentifier) || empty($subjectIdentifier) || empty($levelInput) || empty($semesterInput)) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (missing core identifiers).";
                    $this->skippedCount++;
                    continue;
                }

                $planIdInFile = null;
                if (is_numeric($planIdentifier)) {
                    $planIdInFile = (int) $planIdentifier;
                } else {
                    $planNameFromFile = preg_replace('/-\s*\d{4}$/', '', $planIdentifier);
                    $foundPlan = Plan::whereRaw('LOWER(REPLACE(plan_name, " ", "")) LIKE ?', ['%' . strtolower(str_replace(' ', '', $planNameFromFile)) . '%'])
                        ->orWhereRaw('LOWER(REPLACE(plan_no, " ", "")) LIKE ?', ['%' . strtolower(str_replace(' ', '', $planIdentifier)) . '%'])
                        ->first();
                    if ($foundPlan) {
                        $planIdInFile = $foundPlan->id;
                    }
                }
                if (is_null($planIdInFile) || $planIdInFile !== $plan->id) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (Plan '{$planIdentifier}' in file does not match current plan '{$plan->plan_no}').";
                    $this->invalidPlanCount++;
                    continue;
                }

                $level = $this->normalizeLevelOrSemester($levelInput);
                $semester = $this->normalizeLevelOrSemester($semesterInput);
                if (is_null($level) || is_null($semester) || $level < 1 || $semester < 1) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (Invalid level '{$levelInput}' or semester '{$semesterInput}').";
                    $this->skippedCount++;
                    continue;
                }

                $subject = $this->findSubject($subjectIdentifier);
                if (!$subject) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (Subject '{$subjectIdentifier}' not found).";
                    $this->skippedCount++;
                    continue;
                }

                $uniqueKey = $plan->id . '-' . $subject->id . '-' . $level . '-' . $semester;
                if (isset($this->processedPlanSubjectKeys[$uniqueKey])) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (Duplicate entry for subject '{$subject->subject_no}' in this L/S within the file).";
                    $this->skippedCount++;
                    continue;
                }
                $this->processedPlanSubjectKeys[$uniqueKey] = true;

                $existingPlanSubject = PlanSubject::where('plan_id', $plan->id)
                    ->where('subject_id', $subject->id)
                    // ->where('plan_level', $level) // ** التحقق من المستوى والفصل للربط الموجود **
                    // ->where('plan_semester', $semester)
                    ->first();
                if ($existingPlanSubject) {

                    // *************************************************************************
                    if ($existingPlanSubject->plan_level != $level || $existingPlanSubject->plan_semester != $semester) {
                        // dd([
                        //     'planIdentifier' => $planIdentifier,
                        //     'levelInput' => $levelInput,
                        //     'semesterInput' => $semesterInput,
                        //     'subjectIdentifier' => $subjectIdentifier,
                        //     'existingPlanSubject' => $existingPlanSubject,
                        // ]);
                        // تحديث المستوى والفصل
                        $existingPlanSubject->update([
                            'plan_level' => $level,
                            'plan_semester' => $semester,
                        ]);
                        $this->updatedCount++;
                        $skippedDetails[] = "Row {$currentRowNumber} (SubjID:{$subject->id}): Updated level/semester in plan '{$plan->plan_no}'.";
                    } else {
                        // dd($existingPlanSubject);
                        // نفس المادة ونفس المستوى والفصل، لا تغيير
                        $this->skippedCount++;
                        $skippedDetails[] = "Row {$currentRowNumber} (SubjID:{$subject->id}): Already exists in plan '{$plan->plan_no}' at this level/semester.";
                    }
                    // *************************************************************************

                    $this->alreadyExistedCount++;
                    // لا نسجلها في skippedDetails إلا إذا أردت، لأنها ليست خطأ بالضرورة
                    // $this->skippedDetails[] = "Row {$currentRowNumber}: Subject ID {$subject->id} already exists in Plan ID {$plan->id} at L{$level}S{$semester}.";
                } else {
                    PlanSubject::create([
                        'plan_id'       => $plan->id,
                        'subject_id'    => $subject->id,
                        'plan_level'    => $level,
                        'plan_semester' => $semester,
                    ]);
                    $this->createdCount++;
                }
            }

            $summary = [];
            if ($this->createdCount > 0) $summary['new_subjects_added_to_plan'] = $this->createdCount;
            if ($this->alreadyExistedCount > 0) $summary['subjects_already_assigned_and_unchanged'] = $this->alreadyExistedCount;
            if ($this->invalidPlanCount > 0) $summary['rows_skipped_due_to_plan_mismatch'] = $this->invalidPlanCount;
            if ($this->skippedCount > 0) $summary['other_rows_skipped_or_duplicate_in_file'] = $this->skippedCount;

            if (empty($summary) && empty(array_filter($this->skippedDetails, fn($detail) => !Str::contains($detail, 'already exists')))) {
                return response()->json([
                    'success' => true,
                    'message' => 'Excel file processed. No new subjects added or all data already matched/skipped.',
                    'summary' => $summary,
                    'skipped_details' => $this->skippedDetails
                ], 200);
            }

            return response()->json([
                'success' => true,
                'message' => "Plan subjects import processed for plan '{$plan->plan_no}'.",
                'summary' => $summary,
                'skipped_details' => $this->skippedDetails
            ], 200);
        } catch (Exception $e) {
            Log::error('API Plan Subjects Excel Import Failed for Plan ID ' . $plan->id . ': ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'An error occurred during Excel import: ' . $e->getMessage()
            ], 500);
        }
    }
}
---------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\SectionController.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Models\Section;
use App\Models\Plan;
use App\Models\Department;
use App\Models\PlanSubject;
use App\Models\PlanExpectedCount;
use App\Models\Subject;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\Rule;
use Illuminate\Support\Facades\Validator;
use Exception;
use Illuminate\Support\Str;

class SectionController extends Controller
{
    const DEFAULT_THEORY_CAPACITY_FALLBACK = 50;
    const DEFAULT_PRACTICAL_CAPACITY_FALLBACK = 25;
    const MIN_STUDENTS_FOR_NEW_SECTION = 10;

    /**
     * Display a listing of all sections with filtering.
     */
    public function index(Request $request)
    {
        try {
            $query = Section::with([
                'planSubject.plan.department:id,department_name',
                'planSubject.subject:id,subject_no,subject_name'
            ]);

            if ($request->filled('academic_year')) {
                $query->where('academic_year', $request->academic_year);
            }
            if ($request->filled('semester')) {
                $query->where('semester', $request->semester);
            }
            if ($request->filled('department_id')) {
                $query->whereHas('planSubject.plan.department', fn($q) => $q->where('id', $request->department_id));
            }
            if ($request->filled('plan_id')) {
                $query->whereHas('planSubject.plan', fn($q) => $q->where('id', $request->plan_id));
            }
            if ($request->filled('plan_level')) {
                $query->whereHas('planSubject', fn($q) => $q->where('plan_level', $request->plan_level));
            }
            if ($request->filled('subject_id')) {
                $query->whereHas('planSubject.subject', fn($q) => $q->where('id', $request->subject_id));
            }
            if ($request->filled('branch')) {
                $query->where('branch', $request->branch == 'none' ? null : $request->branch);
            }

            $sections = $query->orderBy('academic_year', 'desc')->orderBy('semester')
                ->orderBy(fn($q) => $q->from('plan_subjects')->whereColumn('plan_subjects.id', 'sections.plan_subject_id')->join('plans', 'plan_subjects.plan_id', '=', 'plans.id')->selectRaw('plans.plan_no'))
                ->orderBy(fn($q) => $q->from('plan_subjects')->whereColumn('plan_subjects.id', 'sections.plan_subject_id')->selectRaw('plan_level'))
                ->orderBy(fn($q) => $q->from('plan_subjects')->whereColumn('plan_subjects.id', 'sections.plan_subject_id')->join('subjects', 'plan_subjects.subject_id', '=', 'subjects.id')->selectRaw('subjects.subject_no'))
                ->orderBy('activity_type')->orderBy('section_number')
                ->paginate(20);

            $academicYears = Section::query()->orWhereNotNull('academic_year')->distinct()->orderBy('academic_year', 'desc')->pluck('academic_year');
            $departments = Department::orderBy('department_name')->get(['id', 'department_name']);
            $plans = Plan::where('is_active', true)->orderBy('plan_name')->get(['id', 'plan_no', 'plan_name']);
            $subjectsForFilter = Subject::orderBy('subject_no')->get(['id', 'subject_no', 'subject_name']);
            $levels = PlanSubject::query()->orWhereNotNull('plan_level')->distinct()->orderBy('plan_level')->pluck('plan_level');
            $semesters = [1 => 'First', 2 => 'Second', 3 => 'Summer'];

            return view('dashboard.data-entry.sections.index', compact(
                'sections',
                'academicYears',
                'departments',
                'plans',
                'subjectsForFilter',
                'levels',
                'semesters',
                'request'
            ));
        } catch (Exception $e) {
            Log::error('Error fetching sections: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load sections list.');
        }
    }

    /**
     * Show the page for managing ALL sections of a specific SUBJECT within a specific CONTEXT.
     */
    public function manageSubjectContext(Request $request)
    {
        $request->validate([
            'plan_subject_id' => 'required|integer|exists:plan_subjects,id',
            'academic_year' => 'required|integer|digits:4',
            'semester_of_sections' => 'required|integer|in:1,2,3',
            'branch' => 'nullable|string|max:100',
        ]);

        $planSubjectId = $request->plan_subject_id;
        $academicYear = $request->academic_year;
        $semesterOfSections = $request->semester_of_sections;
        $branch = $request->filled('branch') ? $request->branch : null;

        try {
            $planSubject = PlanSubject::with(['plan.department', 'subject.subjectCategory'])->findOrFail($planSubjectId);

            $expectedCount = PlanExpectedCount::where('plan_id', $planSubject->plan_id)
                ->where('plan_level', $planSubject->plan_level)
                ->where('plan_semester', $planSubject->plan_semester)
                ->where('academic_year', $academicYear)
                ->where(fn($q) => is_null($branch) ? $q->whereNull('branch') : $q->where('branch', $branch))
                ->first();

            $currentSections = Section::where('plan_subject_id', $planSubjectId)
                ->where('academic_year', $academicYear)
                ->where('semester', $semesterOfSections)
                ->where(fn($q) => is_null($branch) ? $q->whereNull('branch') : $q->where('branch', $branch))
                ->orderBy('activity_type')->orderBy('section_number')->get();

            return view('dashboard.data-entry.sections.manage', compact(
                'planSubject',
                'academicYear',
                'semesterOfSections',
                'branch',
                'expectedCount',
                'currentSections',
                'request'
            ));
        } catch (Exception $e) {
            Log::error('Error loading manage sections for subject context: ' . $e->getMessage());
            return redirect()->route('data-entry.sections.index')->with('error', 'Could not load section management page.');
        }
    }

    /**
     * Trigger section generation for a specific SUBJECT within a context from a button.
     */
    public function generateForSubject(Request $request)
    {
        $request->validate([
            'plan_subject_id' => 'required|integer|exists:plan_subjects,id',
            'expected_count_id' => 'required|integer|exists:plan_expected_counts,id',
        ]);

        $planSubject = PlanSubject::find($request->plan_subject_id);
        $expectedCount = PlanExpectedCount::find($request->expected_count_id);

        if (!$planSubject || !$expectedCount) {
            return redirect()->back()->with('error', 'Invalid context for generating sections.');
        }

        try {
            $this->generateSectionsLogic($planSubject, $expectedCount);
            return redirect()->route('data-entry.sections.manageSubjectContext', [
                'plan_subject_id' => $planSubject->id,
                'academic_year' => $expectedCount->academic_year,
                'semester_of_sections' => $expectedCount->plan_semester,
                'branch' => $expectedCount->branch,
            ])->with('success', 'Sections for subject generated/updated successfully.');
        } catch (Exception $e) {
            Log::error('Manual Section Generation for Subject Failed: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Failed to generate sections: ' . $e->getMessage());
        }
    }

    /**
     * Core logic to generate/update sections for a SINGLE PlanSubject.
     */
    private function generateSectionsLogic(PlanSubject $planSubject, PlanExpectedCount $expectedCount)
    {
        Log::info("Generating sections for PS ID: {$planSubject->id} within ExpectedCount ID: {$expectedCount->id}");

        $subject = $planSubject->subject()->with('subjectCategory')->first();
        if (!$subject || !$subject->subjectCategory) {
            $errorMessage = "Subject or its category is missing for PlanSubject ID: {$planSubject->id}. Cannot generate sections.";
            Log::error($errorMessage);
            throw new Exception($errorMessage);
        }

        $totalExpected = $expectedCount->male_count + $expectedCount->female_count;

        Section::where('plan_subject_id', $planSubject->id)
            ->where('academic_year', $expectedCount->academic_year)
            ->where('semester', $expectedCount->plan_semester)
            ->where(function ($q) use ($expectedCount) {
                is_null($expectedCount->branch) ? $q->whereNull('branch') : $q->where('branch', $expectedCount->branch);
            })
            ->delete();
        Log::info("Deleted old sections for PS ID {$planSubject->id} in context of ExpectedCount ID: {$expectedCount->id}.");

        if ($totalExpected <= 0) {
            Log::info("Total expected students is zero for PS ID {$planSubject->id}. No new sections will be created.");
            return;
        }

        $subjectCategoryName = strtolower($subject->subjectCategory->subject_category_name);
        $nextSectionNumber = 1;

        // --- تحديد السعات المستخدمة ---
        $capacityTheoreticalToUse = self::DEFAULT_THEORY_CAPACITY_FALLBACK;
        if (isset($subject->load_theoretical_section) && $subject->load_theoretical_section > 0) {
            $capacityTheoreticalToUse = $subject->load_theoretical_section;
        }
        // dd(isset($subject->load_theoretical_section));
        Log::info("Subject ID {$subject->id}: Theoretical Capacity to Use = {$capacityTheoreticalToUse} (Subject defined: {$subject->capacity_theoretical_section})");

        $capacityPracticalToUse = self::DEFAULT_PRACTICAL_CAPACITY_FALLBACK;
        if (isset($subject->load_practical_section) && $subject->load_practical_section > 0) {
            $capacityPracticalToUse = $subject->load_practical_section;
        }
        Log::info("Subject ID {$subject->id}: Practical Capacity to Use = {$capacityPracticalToUse} (Subject defined: {$subject->capacity_practical_section})");
        // --- نهاية تحديد السعات ---

        // --- 1. الجزء النظري ---
        if (($subject->theoretical_hours ?? 0) > 0) {
            // لا ننشئ جزء نظري إذا كانت المادة "عملية فقط"
            if (
                !($subjectCategoryName == 'practical' || Str::contains($subjectCategoryName, 'عملي')) ||
                (Str::contains($subjectCategoryName, ['combined', 'مشترك', 'نظري وعملي']))
            ) {

                if ($totalExpected > 0 && $capacityTheoreticalToUse > 0) {
                    $numSections = ceil($totalExpected / $capacityTheoreticalToUse);
                    if ($numSections > 1) {
                        $studentsInLastSection = $totalExpected % $capacityTheoreticalToUse;
                        if ($studentsInLastSection == 0) $studentsInLastSection = $capacityTheoreticalToUse;
                        if ($studentsInLastSection < self::MIN_STUDENTS_FOR_NEW_SECTION && $numSections > 1) {
                            $numSections = floor($totalExpected / $capacityTheoreticalToUse);
                            if ($numSections == 0 && $totalExpected > 0) $numSections = 1;
                        }
                    }
                    if ($numSections == 0 && $totalExpected > 0) $numSections = 1;

                    if ($numSections > 0) {
                        $baseStudents = floor($totalExpected / $numSections);
                        $remainder = $totalExpected % $numSections;
                        for ($i = 0; $i < $numSections; $i++) {
                            $count = $baseStudents + ($remainder > 0 ? 1 : 0);
                            if ($remainder > 0) $remainder--;
                            if ($count > 0) {
                                Section::create(['plan_subject_id' => $planSubject->id, 'academic_year' => $expectedCount->academic_year, 'semester' => $expectedCount->plan_semester, 'activity_type' => 'Theory', 'section_number' => $nextSectionNumber++, 'student_count' => $count, 'section_gender' => 'Mixed', 'branch' => $expectedCount->branch]);
                            }
                        }
                        Log::info("Created {$numSections} Theory Sections for PS ID {$planSubject->id}");
                    }
                }
            }
        }

        // --- 2. الجزء العملي ---
        if (($subject->practical_hours ?? 0) > 0) {
            // لا ننشئ جزء عملي إذا كانت المادة "نظرية فقط" وليست "مشتركة"
            if (
                !($subjectCategoryName == 'theory' || Str::contains($subjectCategoryName, 'نظري')) ||
                (Str::contains($subjectCategoryName, ['combined', 'مشترك', 'نظري وعملي']))
            ) {

                if ($totalExpected > 0 && $capacityPracticalToUse > 0) {
                    $numSections = ceil($totalExpected / $capacityPracticalToUse);
                    if ($numSections > 1) {
                        $studentsInLastSection = $totalExpected % $capacityPracticalToUse;
                        if ($studentsInLastSection == 0) $studentsInLastSection = $capacityPracticalToUse;
                        if ($studentsInLastSection < self::MIN_STUDENTS_FOR_NEW_SECTION && $numSections > 1) {
                            $numSections = floor($totalExpected / $capacityPracticalToUse);
                            if ($numSections == 0 && $totalExpected > 0) $numSections = 1;
                        }
                    }
                    if ($numSections == 0 && $totalExpected > 0) $numSections = 1;

                    if ($numSections > 0) {
                        $baseStudents = floor($totalExpected / $numSections);
                        $remainder = $totalExpected % $numSections;
                        for ($i = 0; $i < $numSections; $i++) {
                            $count = $baseStudents + ($remainder > 0 ? 1 : 0);
                            if ($remainder > 0) $remainder--;
                            if ($count > 0) {
                                Section::create(['plan_subject_id' => $planSubject->id, 'academic_year' => $expectedCount->academic_year, 'semester' => $expectedCount->plan_semester, 'activity_type' => 'Practical', 'section_number' => $nextSectionNumber++, 'student_count' => $count, 'section_gender' => 'Mixed', 'branch' => $expectedCount->branch]);
                            }
                        }
                        Log::info("Created {$numSections} Practical Sections for PS ID {$planSubject->id}");
                    }
                }
            }
        }
        if ($nextSectionNumber == 1) {
            Log::warning("No sections created for PS ID {$planSubject->id}.");
        }
        Log::info("Finished generating sections for PS ID {$planSubject->id}.");
    }


    /**
     * Store a newly created section.
     */
    public function store(Request $request)
    {
        $errorBagName = 'addSectionModal';
        $validator = Validator::make($request->all(), [
            'plan_subject_id' => 'required|integer|exists:plan_subjects,id',
            'activity_type' => ['required', Rule::in(['Theory', 'Practical'])],
            'academic_year' => 'required|integer|digits:4',
            'semester' => 'required|integer|in:1,2,3',
            'branch' => 'nullable|string|max:100',
            'section_number' => 'required|integer|min:1',
            'student_count' => 'required|integer|min:0',
            'section_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed'])],
        ]);

        $planSubjectId = $request->input('plan_subject_id');
        $academicYear = $request->input('academic_year');
        $semester = $request->input('semester');
        $branch = $request->input('branch');
        $activityType = $request->input('activity_type');

        $validator->after(function ($validator) use ($request, $planSubjectId, $academicYear, $semester, $branch, $activityType) {
            if (!$validator->errors()->hasAny()) {
                $exists = Section::where('plan_subject_id', $planSubjectId)
                    ->where('academic_year', $academicYear)->where('semester', $semester)
                    ->where('activity_type', $activityType)
                    ->where('section_number', $request->input('section_number'))
                    ->where(fn($q) => is_null($branch) ? $q->whereNull('branch') : $q->where('branch', $branch))
                    ->exists();
                if ($exists) {
                    $validator->errors()->add('section_unique', 'This section (number & activity type) already exists.');
                }
            }
        });

        // التحقق من تجاوز العدد الإجمالي للطلاب
        $planSubjectForContext = PlanSubject::find($planSubjectId);
        if ($planSubjectForContext) {
            $expectedCount = PlanExpectedCount::where('plan_id', $planSubjectForContext->plan_id)
                ->where('academic_year', $academicYear)
                ->where('plan_level', $planSubjectForContext->plan_level)
                ->where('plan_semester', $planSubjectForContext->plan_semester)
                ->where(fn($q) => is_null($branch) ? $q->whereNull('branch') : $q->where('branch', $branch))
                ->first();

            if ($expectedCount) {
                $validator->after(function ($validator) use ($request, $expectedCount, $planSubjectId, $academicYear, $semester, $branch, $activityType) {
                    if (!$validator->errors()->has('student_count')) {
                        $newStudentCount = (int) $request->input('student_count');
                        $totalExpected = $expectedCount->male_count + $expectedCount->female_count;
                        $otherSectionsSum = Section::where('plan_subject_id', $planSubjectId)
                            ->where('academic_year', $academicYear)->where('semester', $semester)
                            ->where('activity_type', $activityType)->where('branch', $branch)
                            ->sum('student_count');
                        if (($otherSectionsSum + $newStudentCount) > $totalExpected) {
                            $validator->errors()->add('student_count_total', "Total students (" . ($otherSectionsSum + $newStudentCount) . ") exceeds expected ({$totalExpected}). Max remaining: " . max(0, $totalExpected - $otherSectionsSum));
                        }
                    }
                });
            }
        }


        $redirectParams = ['plan_subject_id' => $planSubjectId, 'academic_year' => $academicYear, 'semester_of_sections' => $semester, 'branch' => $branch];
        if ($validator->fails()) {
            return redirect()->route('data-entry.sections.manageSubjectContext', $redirectParams)->with('error', 'Failed to create section.')
                ->withErrors($validator, $errorBagName)->withInput();
        }

        try {
            $data = $validator->validated();
            $data['branch'] = empty($data['branch']) ? null : $data['branch'];
            Section::create($data);
            return redirect()->route('data-entry.sections.manageSubjectContext', $redirectParams)->with('success', 'Section added.');
        } catch (Exception $e) {
            Log::error('Section Store Failed: ' . $e->getMessage());
            return redirect()->route('data-entry.sections.manageSubjectContext', $redirectParams)->with('error', 'Failed to add section.')->withInput();
        }
    }

    /**
     * Update the specified section.
     */
    public function update(Request $request, Section $section)
    {
        $redirectParams = ['plan_subject_id' => $section->plan_subject_id, 'academic_year' => $section->academic_year, 'semester_of_sections' => $section->semester, 'branch' => $section->branch];
        $errorBagName = 'editSectionModal_' . $section->id; // اسم مميز للـ error bag
        $validator = Validator::make($request->all(), [
            'section_number' => 'required|integer|min:1',
            'student_count' => 'required|integer|min:0',
            'section_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed'])],
        ]);

        // التحقق من التفرد لرقم الشعبة إذا تغير
        $validator->after(function ($validator) use ($request, $section) {
            if (!$validator->errors()->has('section_number') && $request->input('section_number') != $section->section_number) {
                $exists = Section::where('plan_subject_id', $section->plan_subject_id)
                    ->where('academic_year', $section->academic_year)->where('semester', $section->semester)
                    ->where('activity_type', $section->activity_type)->where('section_number', $request->input('section_number'))
                    ->where('branch', $section->branch)->where('id', '!=', $section->id)->exists();
                if ($exists) {
                    $validator->errors()->add('section_unique', 'This section number already exists for this subject/context.');
                }
            }
        });

        // التحقق من عدم تجاوز العدد الكلي للطلاب
        $validator->after(function ($validator) use ($request, $section) {
            if (!$validator->errors()->has('student_count')) {
                $expectedCount = PlanExpectedCount::where('plan_id', $section->planSubject->plan_id)
                    ->where('academic_year', $section->academic_year)->where('plan_level', $section->planSubject->plan_level)
                    ->where('plan_semester', $section->planSubject->plan_semester)->where('branch', $section->branch)->first();
                if ($expectedCount) {
                    $newStudentCount = (int) $request->input('student_count');
                    $totalExpected = $expectedCount->male_count + $expectedCount->female_count;
                    $otherSectionsSum = Section::where('plan_subject_id', $section->plan_subject_id)
                        ->where('academic_year', $section->academic_year)->where('semester', $section->semester)
                        ->where('activity_type', $section->activity_type)->where('branch', $section->branch)
                        ->where('id', '!=', $section->id)->sum('student_count');
                    if (($otherSectionsSum + $newStudentCount) > $totalExpected) {
                        $validator->errors()->add('student_count_total', "Total students (" . ($otherSectionsSum + $newStudentCount) . ") exceeds expected ({$totalExpected}).");
                    }
                }
            }
        });

        if ($validator->fails()) {
            return redirect()->route('data-entry.sections.manageSubjectContext', $redirectParams)
                ->with('error', 'Failed to update section.')
                ->with('editSectionId', $section->id) // لإظهار المودال الصحيح
                ->with('sectionForModal', $section) // لتعيين القيم الافتراضية
                ->withErrors($validator, $errorBagName)
                ->withInput();
        }

        try {
            $dataToUpdate = $validator->safe()->only(['section_number', 'student_count', 'section_gender']);
            // الفرع ونوع النشاط لا يتم تعديلهما عادةً من هنا
            $section->update($dataToUpdate);
            return redirect()->route('data-entry.sections.manageSubjectContext', $redirectParams)->with('success', 'Section updated.');
        } catch (Exception $e) {
            Log::error('Section Update Failed for ID ' . $section->id . ': ' . $e->getMessage());
            return redirect()->route('data-entry.sections.manageSubjectContext', $redirectParams)->with('error', 'Failed to update section: ' . $e->getMessage())->withInput();
        }
    }

    /**
     * Remove the specified section.
     */
    public function destroy(Section $section)
    {
        $redirectParams = ['plan_subject_id' => $section->plan_subject_id, 'academic_year' => $section->academic_year, 'semester_of_sections' => $section->semester, 'branch' => $section->branch];
        try {
            $section->delete();
            return redirect()->route('data-entry.sections.manageSubjectContext', $redirectParams)->with('success', 'Section deleted.');
        } catch (Exception $e) {
            Log::error('Section Destroy Failed for ID ' . $section->id . ': ' . $e->getMessage());
            return redirect()->route('data-entry.sections.manageSubjectContext', $redirectParams)->with('error', 'Failed to delete section: ' . $e->getMessage());
        }
    }

    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * API: Display a listing of all sections with filtering.
     */
    public function apiIndex(Request $request)
    {
        try {
            $query = Section::with([
                'planSubject.plan:id,plan_no,plan_name',
                'planSubject.subject:id,subject_no,subject_name',
                'planSubject.plan.department:id,department_name'
            ]);

            if ($request->filled('academic_year')) {
                $query->where('academic_year', $request->academic_year);
            }
            if ($request->filled('semester')) {
                $query->where('semester', $request->semester);
            }
            if ($request->filled('plan_subject_id')) {
                $query->where('plan_subject_id', $request->plan_subject_id);
            }
            if ($request->filled('activity_type')) {
                $query->where('activity_type', $request->activity_type);
            }
            if ($request->filled('branch')) {
                if (strtolower($request->branch) === 'none' || $request->branch === '') {
                    $query->whereNull('branch');
                } else {
                    $query->where('branch', $request->branch);
                }
            }

            $sections = $query->orderBy('academic_year', 'desc')->orderBy('semester')
                ->orderBy('plan_subject_id')->orderBy('activity_type')->orderBy('section_number')
                ->get(); // *** جلب كل النتائج للـ API (بدون pagination حالياً) ***

            return response()->json(['success' => true, 'data' => $sections], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching sections: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error: Could not retrieve sections.'], 500);
        }
    }


    /**
     * API: Get sections for a specific subject context.
     */
    public function apiGetSectionsForSubjectContext(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'plan_subject_id' => 'required|integer|exists:plan_subjects,id',
            'academic_year' => 'required|integer|digits:4',
            'semester' => 'required|integer|in:1,2,3', // فصل الشعبة
            'branch' => 'nullable|string|max:100',
        ]);

        if ($validator->fails()) {
            return response()->json(['success' => false, 'errors' => $validator->errors()], 422);
        }

        try {
            $planSubject = PlanSubject::with(['subject:id,subject_no,subject_name', 'plan:id,plan_no'])->find($request->plan_subject_id);
            if (!$planSubject) {
                return response()->json(['success' => false, 'message' => 'PlanSubject context not found.'], 404);
            }

            $sections = Section::where('plan_subject_id', $request->plan_subject_id)
                ->where('academic_year', $request->academic_year)
                ->where('semester', $request->semester)
                ->where(fn($q) => is_null($request->branch) ? $q->whereNull('branch') : $q->where('branch', $request->branch))
                ->orderBy('activity_type')->orderBy('section_number')->get();

            return response()->json([
                'success' => true,
                'context' => ['plan_subject' => $planSubject, /* ... */],
                'data' => $sections
            ], 200);
        } catch (Exception $e) { /* ... */
        }
    }


    /**
     * API: Store a newly created section.
     */
    public function apiStore(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'plan_subject_id' => 'required|integer|exists:plan_subjects,id',
            'activity_type' => ['required', Rule::in(['Theory', 'Practical'])],
            'academic_year' => 'required|integer|digits:4',
            'semester' => 'required|integer|in:1,2,3',
            'branch' => 'nullable|string|max:100',
            'section_number' => 'required|integer|min:1',
            'student_count' => 'required|integer|min:0',
            'section_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed'])],
        ]);

        // التحقق من التفرد
        $validator->after(function ($validator) use ($request) {
            if (!$validator->errors()->hasAny()) {
                $exists = Section::where('plan_subject_id', $request->input('plan_subject_id'))
                    ->where('academic_year', $request->input('academic_year'))
                    ->where('semester', $request->input('semester'))
                    ->where('activity_type', $request->input('activity_type'))
                    ->where('section_number', $request->input('section_number'))
                    ->where(function ($query) use ($request) {
                        $branch = $request->input('branch');
                        is_null($branch) || $branch === '' ? $query->whereNull('branch') : $query->where('branch', $branch);
                    })->exists();
                if ($exists) {
                    $validator->errors()->add('section_unique', 'This section (number & activity type) already exists for this context.');
                }
            }
        });

        // التحقق من تجاوز العدد الكلي
        $planSubjectForContext = PlanSubject::find($request->input('plan_subject_id'));
        if ($planSubjectForContext) {
            $expectedCount = PlanExpectedCount::where('plan_id', $planSubjectForContext->plan_id)
                ->where('academic_year', $request->input('academic_year'))
                ->where('plan_level', $planSubjectForContext->plan_level)
                ->where('plan_semester', $planSubjectForContext->plan_semester)
                ->where(fn($q) => is_null($request->input('branch')) ? $q->whereNull('branch') : $q->where('branch', $request->input('branch')))
                ->first();

            if ($expectedCount) {
                $validator->after(function ($validator) use ($request, $expectedCount) {
                    if (!$validator->errors()->has('student_count')) {
                        $newStudentCount = (int) $request->input('student_count');
                        $totalExpected = $expectedCount->male_count + $expectedCount->female_count;
                        $otherSectionsSum = Section::where('plan_subject_id', $request->input('plan_subject_id'))
                            ->where('academic_year', $request->input('academic_year'))
                            ->where('semester', $request->input('semester'))
                            ->where('activity_type', $request->input('activity_type'))
                            ->where(fn($q) => is_null($request->input('branch')) ? $q->whereNull('branch') : $q->where('branch', $request->input('branch')))
                            ->sum('student_count');
                        if (($otherSectionsSum + $newStudentCount) > $totalExpected) {
                            $validator->errors()->add('student_count_total', "Total allocated students (" . ($otherSectionsSum + $newStudentCount) . ") would exceed expected ({$totalExpected}). Max remaining for new section: " . max(0, $totalExpected - $otherSectionsSum));
                        }
                    }
                });
            }
        }

        if ($validator->fails()) {
            return response()->json(['success' => false, 'message' => 'Validation failed.', 'errors' => $validator->errors()], 422);
        }

        try {
            $data = $validator->validated();
            $data['branch'] = empty($data['branch']) ? null : $data['branch'];
            $section = Section::create($data);
            $section->load(['planSubject.subject:id,subject_no,subject_name', 'planSubject.plan:id,plan_no']);
            return response()->json(['success' => true, 'data' => $section, 'message' => 'Section created successfully.'], 201);
        } catch (Exception $e) {
            Log::error('API Section Store Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to create section.'], 500);
        }
    }

    /**
     * API: Display the specified section.
     */
    public function apiShow(Section $section)
    {
        try {
            $section->load(['planSubject.plan:id,plan_no,plan_name', 'planSubject.subject:id,subject_no,subject_name']);
            return response()->json(['success' => true, 'data' => $section], 200);
        } catch (Exception $e) {
            Log::error("API Error fetching section ID {$section->id}: " . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Section not found or server error.'], 404);
        }
    }

    /**
     * API: Update the specified section.
     */
    public function apiUpdate(Request $request, Section $section)
    {
        $validator = Validator::make($request->all(), [
            'section_number' => 'sometimes|required|integer|min:1',
            'student_count' => 'sometimes|required|integer|min:0',
            'section_gender' => ['sometimes', 'required', Rule::in(['Male', 'Female', 'Mixed'])],
            // السياق (plan_subject_id, activity_type, academic_year, semester, branch) لا يتغير عادةً
        ]);

        // التحقق من التفرد إذا تم تعديل section_number
        $validator->after(function ($validator) use ($request, $section) {
            if ($request->has('section_number') && $request->input('section_number') != $section->section_number) {
                $exists = Section::where('plan_subject_id', $section->plan_subject_id)
                    ->where('academic_year', $section->academic_year)->where('semester', $section->semester)
                    ->where('activity_type', $section->activity_type)->where('section_number', $request->input('section_number'))
                    ->where('branch', $section->branch)->where('id', '!=', $section->id)->exists();
                if ($exists) {
                    $validator->errors()->add('section_unique', 'This section number already exists for this context.');
                }
            }
        });

        // التحقق من تجاوز العدد الكلي للطلاب إذا تم تعديل student_count
        $validator->after(function ($validator) use ($request, $section) {
            if ($request->has('student_count') && $request->input('student_count') != $section->student_count) {
                $expectedCount = PlanExpectedCount::where('plan_id', $section->planSubject->plan_id)
                    ->where('academic_year', $section->academic_year)->where('plan_level', $section->planSubject->plan_level)
                    ->where('plan_semester', $section->planSubject->plan_semester)->where('branch', $section->branch)->first();
                if ($expectedCount) {
                    $newStudentCount = (int) $request->input('student_count');
                    $totalExpected = $expectedCount->male_count + $expectedCount->female_count;
                    $otherSectionsSum = Section::where('plan_subject_id', $section->plan_subject_id)
                        ->where('academic_year', $section->academic_year)->where('semester', $section->semester)
                        ->where('activity_type', $section->activity_type)->where('branch', $section->branch)
                        ->where('id', '!=', $section->id)->sum('student_count');
                    if (($otherSectionsSum + $newStudentCount) > $totalExpected) {
                        $validator->errors()->add('student_count_total', "Total allocated students (" . ($otherSectionsSum + $newStudentCount) . ") would exceed expected ({$totalExpected}).");
                    }
                }
            }
        });

        if ($validator->fails()) {
            return response()->json(['success' => false, 'message' => 'Validation failed.', 'errors' => $validator->errors()], 422);
        }

        try {
            $dataToUpdate = $validator->safe()->only(['section_number', 'student_count', 'section_gender']);
            $section->update($dataToUpdate);
            $section->load(['planSubject.subject', 'planSubject.plan']);
            return response()->json(['success' => true, 'data' => $section, 'message' => 'Section updated successfully.'], 200);
        } catch (Exception $e) {
            Log::error('API Section Update Failed for ID ' . $section->id . ': ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to update section.'], 500);
        }
    }

    /**
     * API: Remove the specified section.
     */
    public function apiDestroy(Section $section)
    {
        try {
            $section->delete();
            return response()->json(['success' => true, 'message' => 'Section deleted successfully.'], 200);
        } catch (Exception $e) {
            Log::error('API Section Destroy Failed for ID ' . $section->id . ': ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to delete section.'], 500);
        }
    }

    /**
     * API: Trigger section generation for a specific SUBJECT and context.
     */
    public function apiGenerateForSubject(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'plan_subject_id' => 'required|integer|exists:plan_subjects,id',
            'expected_count_id' => 'required|integer|exists:plan_expected_counts,id',
        ]);

        if ($validator->fails()) {
            return response()->json(['success' => false, 'message' => 'Validation failed.', 'errors' => $validator->errors()], 422);
        }

        $planSubject = PlanSubject::find($request->plan_subject_id);
        $expectedCount = PlanExpectedCount::find($request->expected_count_id);

        if (!$planSubject || !$expectedCount) {
            return response()->json(['success' => false, 'message' => 'Invalid context for generating sections.'], 404);
        }

        try {
            $this->generateSectionsLogic($planSubject, $expectedCount);
            $newSections = Section::where('plan_subject_id', $planSubject->id)
                ->where('academic_year', $expectedCount->academic_year)
                ->where('semester', $expectedCount->plan_semester)
                ->where(fn($q) => is_null($expectedCount->branch) ? $q->whereNull('branch') : $q->where('branch', $expectedCount->branch))
                ->orderBy('activity_type')->orderBy('section_number')
                ->with(['planSubject.subject:id,subject_no,subject_name']) // تحميل تفاصيل المادة
                ->get();

            return response()->json([
                'success' => true,
                'message' => 'Sections generated/updated successfully for the subject.',
                'data' => $newSections
            ], 200);
        } catch (Exception $e) {
            Log::error('API Manual Section Generation for Subject Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to generate sections: ' . $e->getMessage()], 500);
        }
    }
}
----------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\SectionController22.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Models\Section;
use App\Models\Plan;
use App\Models\Department;
use App\Models\PlanSubject;
use App\Models\PlanExpectedCount;
use App\Models\Subject;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\Rule;
use Illuminate\Support\Facades\Validator;
use Exception;
use Illuminate\Support\Str;

class SectionController22 extends Controller
{
    // القيم الافتراضية إذا لم يحددها المستخدم للمادة
    const DEFAULT_THEORY_CAPACITY_FALLBACK = 50;
    const DEFAULT_PRACTICAL_CAPACITY_FALLBACK = 25;
    const MIN_STUDENTS_FOR_NEW_SECTION = 10;

    public function manageSectionsForContext(PlanExpectedCount $expectedCount) // Route Model Binding
    {
        try {
            $expectedCount->load('plan.department');

            $planSubjectsForContext = PlanSubject::with('subject.subjectCategory')
                ->where('plan_id', $expectedCount->plan_id)
                ->where('plan_level', $expectedCount->plan_level)
                ->where('plan_semester', $expectedCount->plan_semester)
                ->get();

            // جلب الشعب الحالية مجمعة حسب المادة ونوع النشاط
            $currentSectionsBySubjectAndActivity = $this->getCurrentSectionsGrouped($planSubjectsForContext, $expectedCount);
            // dd('ddd');

            return view('dashboard.data-entry.manage-sections-for-context', compact(
                'expectedCount',
                'planSubjectsForContext',
                'currentSectionsBySubjectAndActivity' // تم تغيير الاسم
            ));
        } catch (Exception $e) {
            Log::error('Error loading manage sections for context: ' . $e->getMessage());
            return redirect()->route('data-entry.plan-expected-counts.index')
                ->with('error', 'Could not load section management page for the selected context.');
        }
    }

    private function getCurrentSectionsGrouped($planSubjectsForContext, PlanExpectedCount $expectedCount)
    {
        $grouped = collect();
        foreach ($planSubjectsForContext as $ps) {
            $sections = Section::where('plan_subject_id', $ps->id)
                ->where('academic_year', $expectedCount->academic_year)
                ->where('semester', $expectedCount->plan_semester) // فصل الشعبة
                ->where(function ($q) use ($expectedCount) {
                    is_null($expectedCount->branch) ? $q->whereNull('branch') : $q->where('branch', $expectedCount->branch);
                })
                ->orderBy('activity_type')->orderBy('section_number') // ترتيب إضافي
                ->get();
            // تجميع إضافي حسب activity_type
            $grouped[$ps->subject_id] = $sections->groupBy('activity_type');
        }
        return $grouped;
    }

    public function generateSectionsForContextButton(Request $request, PlanExpectedCount $expectedCount)
    {
        try {
            $this->generateSectionsLogic22($expectedCount); // تمرير كائن العدد المتوقع مباشرة
            return redirect()->route('data-entry.sections.manageContext', $expectedCount->id)
                ->with('success', 'Sections generated/updated successfully.');
        } catch (Exception $e) {
            Log::error('Manual Section Generation Failed for ExpectedCount ID ' . $expectedCount->id . ': ' . $e->getMessage());
            return redirect()->back()->with('error', 'Failed to generate sections: ' . $e->getMessage());
        }
    }

    private function generateSectionsLogic22(PlanExpectedCount $expectedCount)
    {
        Log::info("Generating sections for ExpectedCount ID: {$expectedCount->id}");

        $planSubjects = PlanSubject::with('subject.subjectCategory')
            ->where('plan_id', $expectedCount->plan_id)
            ->where('plan_level', $expectedCount->plan_level)
            ->where('plan_semester', $expectedCount->plan_semester)
            ->get();

        if ($planSubjects->isEmpty()) {
            Log::info("No subjects for context.");
            return;
        }

        $totalExpected = $expectedCount->male_count + $expectedCount->female_count;

        // حذف الشعب القديمة
        Section::whereIn('plan_subject_id', $planSubjects->pluck('id'))
            ->where('academic_year', $expectedCount->academic_year)
            ->where('semester', $expectedCount->plan_semester)
            ->where(function ($q) use ($expectedCount) {
                is_null($expectedCount->branch) ? $q->whereNull('branch') : $q->where('branch', $expectedCount->branch);
            })
            ->delete();
        Log::info("Deleted old sections for context of ExpectedCount ID: {$expectedCount->id}");

        if ($totalExpected <= 0) {
            Log::info("Total expected is zero.");
            return;
        }

        foreach ($planSubjects as $ps) {
            $subject = $ps->subject;
            if (!$subject || !$subject->subjectCategory) {
                Log::warning("Skipping PS ID {$ps->id}, missing subject/category info.");
                continue;
            }

            $subjectCategoryName = strtolower($subject->subjectCategory->subject_category_name);
            $planSubjectId = $ps->id;
            $subjectIdForLog = $subject->id;
            $nextSectionNumberForThisPS = 1;

            Log::info("Processing Subject ID {$subjectIdForLog} (Category: {$subjectCategoryName}), PlanSubject ID: {$planSubjectId}");

            // تحديد سعة الشعب النظرية
            $capacityTheoreticalToUse = self::DEFAULT_THEORY_CAPACITY_FALLBACK;
            if (isset($subject->load_theoretical_section) && $subject->load_theoretical_section > 0) {
                $capacityTheoreticalToUse = $subject->load_theoretical_section;
            }
            Log::info("Subject ID {$subject->id}: Theoretical Capacity to Use = {$capacityTheoreticalToUse}");

            // تحديد سعة الشعب العملية
            $capacityPracticalToUse = self::DEFAULT_PRACTICAL_CAPACITY_FALLBACK;
            if (isset($subject->load_practical_section) && $subject->load_practical_section > 0) {
                $capacityPracticalToUse = $subject->load_practical_section;
            }
            Log::info("Subject ID {$subject->id}: Practical Capacity to Use = {$capacityPracticalToUse}");

            // 1. إنشاء الجزء النظري (إذا كانت المادة نظرية أو مشتركة وتحتوي على ساعات نظرية)
            if (($subject->theoretical_hours ?? 0) > 0 &&
                (Str::contains($subjectCategoryName, ['theory', 'نظري']) || Str::contains($subjectCategoryName, ['combined', 'مشترك', 'نظري وعملي']))
            ) {
                $numTheorySections = ceil($totalExpected / $capacityTheoreticalToUse);
                $baseStudentsPerSection = floor($totalExpected / $numTheorySections);
                $remainderStudents = $totalExpected % $numTheorySections;

                for ($i = 0; $i < $numTheorySections; $i++) {
                    $studentsInThisSection = $baseStudentsPerSection + ($remainderStudents > 0 ? 1 : 0);
                    if ($remainderStudents > 0) $remainderStudents--;

                    Section::create([
                        'plan_subject_id' => $planSubjectId,
                        'academic_year' => $expectedCount->academic_year,
                        'semester' => $expectedCount->plan_semester,
                        'activity_type' => 'Theory',
                        'section_number' => $nextSectionNumberForThisPS++,
                        'student_count' => $studentsInThisSection,
                        'section_gender' => 'Mixed',
                        'branch' => $expectedCount->branch,
                    ]);
                    Log::info("Created Theory Section #" . ($nextSectionNumberForThisPS - 1) .
                        " with {$studentsInThisSection} students for PS ID {$planSubjectId}");
                }
            }

            // 2. إنشاء الجزء العملي (إذا كانت المادة عملية أو مشتركة وتحتوي على ساعات عملية)
            if (($subject->practical_hours ?? 0) > 0 &&
                (Str::contains($subjectCategoryName, ['practical', 'عملي']) || Str::contains($subjectCategoryName, ['combined', 'مشترك', 'نظري وعملي']))
            ) {
                if ($totalExpected > 0 && $capacityPracticalToUse > 0) {
                    $numLabSections = ceil($totalExpected / $capacityPracticalToUse);
                    $baseStudentsPerSection = floor($totalExpected / $numLabSections);
                    $remainderStudents = $totalExpected % $numLabSections;

                    for ($i = 0; $i < $numLabSections; $i++) {
                        $studentsInThisSection = $baseStudentsPerSection + ($remainderStudents > 0 ? 1 : 0);
                        if ($remainderStudents > 0) $remainderStudents--;

                        if ($studentsInThisSection > 0) {
                            Section::create([
                                'plan_subject_id' => $planSubjectId,
                                'academic_year' => $expectedCount->academic_year,
                                'semester' => $expectedCount->plan_semester,
                                'activity_type' => 'Practical',
                                'section_number' => $nextSectionNumberForThisPS++,
                                'student_count' => $studentsInThisSection,
                                'section_gender' => 'Mixed',
                                'branch' => $expectedCount->branch,
                            ]);
                            Log::info("Created Practical Section #" . ($nextSectionNumberForThisPS - 1) .
                                " with {$studentsInThisSection} students for PS ID {$planSubjectId}");
                        }
                    }
                }
            }

            if ($nextSectionNumberForThisPS == 1) {
                Log::warning("No sections (Theory or Practical) were created for Subject ID {$subjectIdForLog} (PS ID {$planSubjectId}). Check hours and category.");
            }
        }
        Log::info("Finished generating sections for ExpectedCount ID: {$expectedCount->id}");
    }

    /**
     * Store the specified section in storage within its context.
     */
    public function storeSectionInContext(Request $request, PlanExpectedCount $expectedCount)
    {
        $errorBagName = 'addSectionModal';
        $validator = Validator::make($request->all(), [
            'plan_subject_id' => 'required|integer|exists:plan_subjects,id',
            'activity_type' => ['required', Rule::in(['Theory', 'Practical'])],
            'academic_year' => 'required|integer|digits:4',
            'semester' => 'required|integer|in:1,2,3',
            'branch' => 'nullable|string|max:100',
            'section_number' => 'required|integer|min:1',
            'student_count' => 'required|integer|min:0',
            'section_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed'])],
        ]);

        // dd($request->input('plan_subject_id_from_modal'));

        $planSubjectId = $request->input('plan_subject_id_from_modal');
        $academicYear = $request->input('academic_year');
        $semester = $request->input('semester');
        $branch = $request->input('branch');
        $activityType = $request->input('activity_type');

        $validator->after(function ($validator) use ($request, $planSubjectId, $academicYear, $semester, $branch, $activityType) {
            if (!$validator->errors()->hasAny()) {
                $exists = Section::where('plan_subject_id', $planSubjectId)
                    ->where('academic_year', $academicYear)->where('semester', $semester)
                    ->where('activity_type', $activityType)
                    ->where('section_number', $request->input('section_number'))
                    ->where(fn($q) => is_null($branch) ? $q->whereNull('branch') : $q->where('branch', $branch))
                    ->exists();
                if ($exists) {
                    // dd($request->all());
                    $validator->errors()->add('section_unique', 'This section (number & activity type) already exists.');
                }
            }
        });

        // التحقق من تجاوز العدد الإجمالي للطلاب
        $planSubjectForContext = PlanSubject::find($planSubjectId);
        if ($planSubjectForContext) {
            $expectedCount = PlanExpectedCount::where('plan_id', $planSubjectForContext->plan_id)
                ->where('academic_year', $academicYear)
                ->where('plan_level', $planSubjectForContext->plan_level)
                ->where('plan_semester', $planSubjectForContext->plan_semester)
                ->where(fn($q) => is_null($branch) ? $q->whereNull('branch') : $q->where('branch', $branch))
                ->first();

            if ($expectedCount) {
                $validator->after(function ($validator) use ($request, $expectedCount, $planSubjectId, $academicYear, $semester, $branch, $activityType) {
                    if (!$validator->errors()->has('student_count')) {
                        $newStudentCount = (int) $request->input('student_count');
                        $totalExpected = $expectedCount->male_count + $expectedCount->female_count;
                        $otherSectionsSum = Section::where('plan_subject_id', $planSubjectId)
                            ->where('academic_year', $academicYear)->where('semester', $semester)
                            ->where('activity_type', $activityType)->where('branch', $branch)
                            ->sum('student_count');
                        if (($otherSectionsSum + $newStudentCount) > $totalExpected) {
                            $validator->errors()->add('student_count_total', "Total students (" . ($otherSectionsSum + $newStudentCount) . ") exceeds expected ({$totalExpected}). Max remaining: " . max(0, $totalExpected - $otherSectionsSum));
                        }
                    }
                });
            }
        }


        $redirectParams = ['plan_subject_id' => $planSubjectId, 'academic_year' => $academicYear, 'semester_of_sections' => $semester, 'branch' => $branch];
        if ($validator->fails()) {
            return redirect()->route('data-entry.sections.manageSubjectContext', $redirectParams)->with('error', 'Failed to create section.')
                ->withErrors($validator, $errorBagName)->withInput();
        }

        try {
            $data = $validator->validated();
            $data['branch'] = empty($data['branch']) ? null : $data['branch'];
            Section::create($data);
            return redirect()->route('data-entry.sections.manageSubjectContext', $redirectParams)->with('success', 'Section added.');
        } catch (Exception $e) {
            Log::error('Section Store Failed: ' . $e->getMessage());
            return redirect()->route('data-entry.sections.manageSubjectContext', $redirectParams)->with('error', 'Failed to add section.')->withInput();
        }
    }


    /**
     * Update the specified section in storage within its context.
     */
    public function updateSectionInContext(Request $request, Section $section) // Route Model Binding للشعبة
    {
        // 1. جلب سياق العدد المتوقع لهذه الشعبة
        $expectedCountContext = PlanExpectedCount::where('plan_id', $section->planSubject->plan_id)
            ->where('academic_year', $section->academic_year)
            ->where('plan_level', $section->planSubject->plan_level)
            ->where('plan_semester', $section->planSubject->plan_semester) // فصل الخطة
            ->where('branch', $section->branch) // فرع الشعبة هو فرع السياق
            ->first();

        if (!$expectedCountContext) {
            Log::error("Context (ExpectedCount) not found for updating section ID: {$section->id}");
            // يمكنك إعادة توجيه مع خطأ عام، أو السماح بالتحديث بدون هذا التحقق إذا لم يكن العدد المتوقع إلزامياً
            return redirect()->back()->with('error', 'Could not determine the context for validation. Update aborted.');
        }

        $errorBagName = 'updateSectionModal_' . $section->id;

        // 2. Validation الأساسي للحقول
        $validator = Validator::make($request->all(), [
            'section_number' => 'required|integer|min:1',
            'student_count' => 'required|integer|min:0', // ** سنضيف التحقق من المجموع لاحقاً **
            'section_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed'])],
            // الفرع لا يتغير عادة من هنا
        ]);

        // 3. التحقق من تفرد رقم الشعبة (إذا تغير)
        $validator->after(function ($validator) use ($request, $section) {
            if (!$validator->errors()->has('section_number') && $request->input('section_number') != $section->section_number) {
                $exists = Section::where('plan_subject_id', $section->plan_subject_id)
                    ->where('academic_year', $section->academic_year)
                    ->where('semester', $section->semester)
                    ->where('activity_type', $section->activity_type)
                    ->where('section_number', $request->input('section_number'))
                    ->where('branch', $section->branch)
                    ->where('id', '!=', $section->id)
                    ->exists();
                if ($exists) {
                    $validator->errors()->add('section_unique', 'This section number already exists for this subject in this context.');
                }
            }
        });

        // *** 4. التحقق من عدم تجاوز العدد الإجمالي المتوقع للطلاب ***
        $validator->after(function ($validator) use ($request, $section, $expectedCountContext) {
            if (!$validator->errors()->has('student_count')) { // فقط إذا كان عدد الطلاب المدخل صحيحاً
                $newStudentCountForThisSection = (int) $request->input('student_count');
                $totalExpectedStudents = $expectedCountContext->male_count + $expectedCountContext->female_count;

                // جلب مجموع طلاب الشعب الأخرى لنفس المادة ونفس نوع النشاط ونفس السياق
                $otherSectionsStudentSum = Section::where('plan_subject_id', $section->plan_subject_id)
                    ->where('academic_year', $section->academic_year)
                    ->where('semester', $section->semester)
                    ->where('activity_type', $section->activity_type)
                    ->where('branch', $section->branch)
                    ->where('id', '!=', $section->id) // استثناء الشعبة الحالية
                    ->sum('student_count');

                $newTotalAllocated = $otherSectionsStudentSum + $newStudentCountForThisSection;

                if ($newTotalAllocated > $totalExpectedStudents) {
                    $validator->errors()->add(
                        'student_count', // ربط الخطأ بحقل عدد الطلاب
                        "The total number of students allocated to sections ({$newTotalAllocated}) cannot exceed the expected total ({$totalExpectedStudents}) for this subject/activity."
                    );
                }
            }
        });

        if ($validator->fails()) {
            return redirect()->route('data-entry.sections.manageContext', $expectedCountContext->id)
                ->withErrors($validator) // إرسال الأخطاء للـ error bag الافتراضي
                ->withInput();
        }

        // 5. Prepare Data (فقط الحقول المسموح بتعديلها)
        $dataToUpdate = $validator->safe()->only(['section_number', 'student_count', 'section_gender']);
        // الفرع لا يتم تعديله من هنا عادةً لأنه جزء من السياق

        // 6. Update Database
        try {
            $section->update($dataToUpdate);
            return redirect()->route('data-entry.sections.manageContext', $expectedCountContext->id)
                ->with('success', 'Section updated successfully.');
        } catch (Exception $e) {
            Log::error('Section Update (in context) Failed: ' . $e->getMessage());
            return redirect()->route('data-entry.sections.manageContext', $expectedCountContext->id)
                ->with('error', 'Failed to update section: ' . $e->getMessage())
                ->withInput();
        }
    }

    /**
     * Remove the specified section from storage within its context.
     */
    public function destroySectionInContext(Section $section)
    {
        // تحديد السياق للعودة إليه
        $expectedCountContext = PlanExpectedCount::where('plan_id', $section->planSubject->plan_id)
            ->where('academic_year', $section->academic_year)
            ->where('plan_level', $section->planSubject->plan_level)
            ->where('plan_semester', $section->planSubject->plan_semester)
            ->where('branch', $section->branch)
            ->first();
        try {
            $section->delete();

            if ($expectedCountContext) {
                return redirect()->route('data-entry.sections.manageContext', $expectedCountContext->id)
                    ->with('success', 'Section deleted successfully.');
            }
            // إذا لم يتم العثور على سياق العدد المتوقع ارجع لصفحة الشعب العامة
            return redirect()->route('data-entry.sections.index')
                ->with('success', 'Section deleted, but could not redirect to specific context.');
        } catch (Exception $e) {
            Log::error('Section Deletion (in context) Failed: ' . $e->getMessage());
            $redirectRoute = $expectedCountContext ? route('data-entry.sections.manageContext', $expectedCountContext->id) : route('data-entry.sections.index');
            return redirect($redirectRoute)->with('error', 'Failed to delete section: ' . $e->getMessage());
        }
    }


    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * عرض جميع الشعب لسياق محدد
     */
    public function APIGetSectionsForContext(PlanExpectedCount $expectedCount)
    {
        try {
            $sections = Section::where('academic_year', $expectedCount->academic_year)
                ->where('semester', $expectedCount->plan_semester)
                ->where('branch', $expectedCount->branch)
                ->with('planSubject.subject')
                ->get();

            return response()->json([
                'success' => true,
                'data' => $sections,
                'message' => 'Sections retrieved successfully'
            ]);
        } catch (Exception $e) {
            Log::error('API Get Sections Failed: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve sections'
            ], 500);
        }
    }

    /**
     * عرض شعب لمادة محددة في سياق معين
     */
    public function APIGetSectionsForSubject(PlanExpectedCount $expectedCount, PlanSubject $planSubject)
    {
        try {
            $sections = Section::where('plan_subject_id', $planSubject->id)
                ->where('academic_year', $expectedCount->academic_year)
                ->where('semester', $expectedCount->plan_semester)
                ->where('branch', $expectedCount->branch)
                ->get();

            return response()->json([
                'success' => true,
                'data' => [
                    'theory_sections' => $sections->where('activity_type', 'Theory'),
                    'practical_sections' => $sections->where('activity_type', 'Practical')
                ],
                'message' => 'Subject sections retrieved successfully'
            ]);
        } catch (Exception $e) {
            Log::error('API Get Subject Sections Failed: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve subject sections'
            ], 500);
        }
    }

    /**
     * إنشاء شعبة جديدة
     */
    public function APIStoreSectionInContext(Request $request, PlanExpectedCount $expectedCount)
    {
        $validator = Validator::make($request->all(), [
            'plan_subject_id' => 'required|integer|exists:plan_subjects,id',
            'activity_type' => ['required', Rule::in(['Theory', 'Practical'])],
            'section_number' => 'required|integer|min:1',
            'student_count' => 'required|integer|min:0',
            'section_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed'])],
        ]);

        // التحقق من تفرد الشعبة
        $validator->after(function ($validator) use ($request, $expectedCount) {
            $exists = Section::where('plan_subject_id', $request->plan_subject_id)
                ->where('academic_year', $expectedCount->academic_year)
                ->where('semester', $expectedCount->plan_semester)
                ->where('activity_type', $request->activity_type)
                ->where('section_number', $request->section_number)
                ->where('branch', $expectedCount->branch)
                ->exists();

            if ($exists) {
                $validator->errors()->add('section_unique', 'This section already exists in this context.');
            }
        });

        // التحقق من عدم تجاوز العدد المتوقع
        $validator->after(function ($validator) use ($request, $expectedCount) {
            $planSubject = PlanSubject::find($request->plan_subject_id);
            if ($planSubject) {
                $planSubjectId = $request->input('plan_subject_id_from_modal');
                $academicYear = $request->input('academic_year');
                $semester = $request->input('semester');
                $branch = $request->input('branch');
                $activityType = $request->input('activity_type');

                $totalExpected = $expectedCount->male_count + $expectedCount->female_count;
                $currentTotal = Section::where('plan_subject_id', $request->plan_subject_id)
                    ->where('academic_year', $expectedCount->academic_year)
                    ->where('semester', $expectedCount->plan_semester)
                    ->where('activity_type', $request->activity_type)
                    ->where('branch', $expectedCount->branch)
                    ->sum('student_count');

                $newStudentCount = (int) $request->input('student_count');
                $totalExpected = $expectedCount->male_count + $expectedCount->female_count;
                $otherSectionsSum = Section::where('plan_subject_id', $planSubjectId)
                    ->where('academic_year', $academicYear)->where('semester', $semester)
                    ->where('activity_type', $activityType)->where('branch', $branch)
                    ->sum('student_count');

                if (($currentTotal + $request->student_count) > $totalExpected) {
                    $validator->errors()->add('student_count_total', "Total students (" . ($otherSectionsSum + $newStudentCount) . ") exceeds expected ({$totalExpected}). Max remaining: " . max(0, $totalExpected - $otherSectionsSum));
                    // $validator->errors()->add('student_count', 'Total students exceed expected count.');

                }
            }
        });

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Validation errors',
                'errors' => $validator->errors()
            ], 422);
        }

        try {
            $section = Section::create([
                'plan_subject_id' => $request->plan_subject_id,
                'academic_year' => $expectedCount->academic_year,
                'semester' => $expectedCount->plan_semester,
                'activity_type' => $request->activity_type,
                'section_number' => $request->section_number,
                'student_count' => $request->student_count,
                'section_gender' => $request->section_gender,
                'branch' => $expectedCount->branch,
            ]);

            return response()->json([
                'success' => true,
                'data' => $section,
                'message' => 'Section created successfully'
            ], 201);
        } catch (Exception $e) {
            Log::error('API Section Creation Failed: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to create section'
            ], 500);
        }
    }

    /**
     * تحديث شعبة موجودة
     */
    public function APIUpdateSectionInContext(Request $request, Section $section)
    {
        $validator = Validator::make($request->all(), [
            'section_number' => 'required|integer|min:1',
            'student_count' => 'required|integer|min:0',
            'section_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed'])],
        ]);

        // التحقق من تفرد رقم الشعبة إذا تغير
        $validator->after(function ($validator) use ($request, $section) {
            if ($request->section_number != $section->section_number) {
                $exists = Section::where('plan_subject_id', $section->plan_subject_id)
                    ->where('academic_year', $section->academic_year)
                    ->where('semester', $section->semester)
                    ->where('activity_type', $section->activity_type)
                    ->where('section_number', $request->section_number)
                    ->where('branch', $section->branch)
                    ->where('id', '!=', $section->id)
                    ->exists();

                if ($exists) {
                    $validator->errors()->add('section_unique', 'This section number already exists.');
                }
            }
        });

        // التحقق من عدم تجاوز العدد المتوقع
        $validator->after(function ($validator) use ($request, $section) {
            $expectedCount = PlanExpectedCount::where('plan_id', $section->planSubject->plan_id)
                ->where('academic_year', $section->academic_year)
                ->where('plan_level', $section->planSubject->plan_level)
                ->where('plan_semester', $section->planSubject->plan_semester)
                ->where('branch', $section->branch)
                ->first();

            if ($expectedCount) {
                $totalExpected = $expectedCount->male_count + $expectedCount->female_count;
                $currentTotal = Section::where('plan_subject_id', $section->plan_subject_id)
                    ->where('academic_year', $section->academic_year)
                    ->where('semester', $section->semester)
                    ->where('activity_type', $section->activity_type)
                    ->where('branch', $section->branch)
                    ->where('id', '!=', $section->id)
                    ->sum('student_count');

                if (($currentTotal + $request->student_count) > $totalExpected) {
                    $validator->errors()->add('student_count', 'Total students exceed expected count.');
                }
            }
        });

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Validation errors',
                'errors' => $validator->errors()
            ], 422);
        }

        try {
            $section->update([
                'section_number' => $request->section_number,
                'student_count' => $request->student_count,
                'section_gender' => $request->section_gender,
            ]);

            return response()->json([
                'success' => true,
                'data' => $section,
                'message' => 'Section updated successfully'
            ]);
        } catch (Exception $e) {
            Log::error('API Section Update Failed: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to update section'
            ], 500);
        }
    }

    /**
     * حذف شعبة
     */
    public function APIDestroySectionInContext(Section $section)
    {
        try {
            $section->delete();
            return response()->json([
                'success' => true,
                'message' => 'Section deleted successfully'
            ]);
        } catch (Exception $e) {
            Log::error('API Section Deletion Failed: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to delete section'
            ], 500);
        }
    }

    /**
     * إنشاء شعب تلقائيًا
     */
    public function APIGenerateSectionsForContext(Request $request, PlanExpectedCount $expectedCount)
    {
        try {
            $this->generateSectionsLogic22($expectedCount);

            return response()->json([
                'success' => true,
                'message' => 'Sections generated successfully'
            ]);
        } catch (Exception $e) {
            Log::error('API Generate Sections Failed: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to generate sections'
            ], 500);
        }
    }



    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * API: Display a listing of all sections with optional filtering.
     * (Used if you need a general endpoint to list all sections, can be paginated)
     */
    // public function apiIndex(Request $request)
    // {
    //     try {
    //         $query = Section::with([
    //             'planSubject.plan:id,plan_no,plan_name',
    //             'planSubject.subject:id,subject_no,subject_name',
    //             'planSubject.plan.department:id,department_name'
    //         ]);

    //         if ($request->filled('academic_year')) {
    //             $query->where('academic_year', $request->academic_year);
    //         }
    //         if ($request->filled('semester')) {
    //             $query->where('semester', $request->semester);
    //         }
    //         if ($request->filled('plan_subject_id')) {
    //             $query->where('plan_subject_id', $request->plan_subject_id);
    //         }
    //         if ($request->filled('activity_type')) {
    //             $query->where('activity_type', $request->activity_type);
    //         }
    //         if ($request->filled('branch')) {
    //             $query->where('branch', $request->branch == 'none' ? null : $request->branch);
    //         }

    //         // --- Pagination for API (example, you can enable it) ---
    //         $perPage = $request->query('per_page', 15); // Default 15 items per page
    //         $sections = $query->orderBy('academic_year', 'desc')
    //             ->orderBy('semester')
    //             ->orderBy('plan_subject_id')
    //             ->orderBy('activity_type')
    //             ->orderBy('section_number')
    //             ->paginate($perPage);

    //         return response()->json([
    //             'success' => true,
    //             'data' => $sections->items(),
    //             'pagination' => [
    //                 'total' => $sections->total(),
    //                 'per_page' => $sections->perPage(),
    //                 'current_page' => $sections->currentPage(),
    //                 'last_page' => $sections->lastPage(),
    //                 'from' => $sections->firstItem(),
    //                 'to' => $sections->lastItem(),
    //             ]
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error('API Error fetching all sections: ' . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Server Error: Could not retrieve sections.'], 500);
    //     }
    // }

    // /**
    //  * API: Get sections for a specific subject context defined by PlanExpectedCount.
    //  */
    // public function apiManageSectionsForContext(PlanExpectedCount $expectedCount)
    // {
    //     try {
    //         // $expectedCount->load('plan:id,plan_no,plan_name', 'plan.department:id,department_name');
    //         $expectedCount->load('plan.department');
    //         $planSubjectsForContext = PlanSubject::with('subject:id,subject_no,subject_name,theoretical_hours,practical_hours,capacity_theoretical_section,capacity_practical_section', 'subject.subjectCategory:id,subject_category_name')
    //             ->where('plan_id', $expectedCount->plan_id)
    //             ->where('plan_level', $expectedCount->plan_level)
    //             ->where('plan_semester', $expectedCount->plan_semester)
    //             ->get();

    //         $currentSectionsBySubjectAndActivity = $this->getCurrentSectionsGrouped($planSubjectsForContext, $expectedCount);

    //         return response()->json([
    //             'success' => true,
    //             'data' => [
    //                 'expected_count_context' => $expectedCount,
    //                 'plan_subjects_in_context' => $planSubjectsForContext,
    //                 'current_sections_grouped' => $currentSectionsBySubjectAndActivity,
    //             ]
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error("API Error loading manage sections for ExpectedCount ID {$expectedCount->id}: " . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Server Error: Could not load section management data.'], 500);
    //     }
    // }

    // /**
    //  * API: Trigger section generation for ALL subjects within a specific ExpectedCount context.
    //  */
    // public function apiGenerateSectionsForContextButton(PlanExpectedCount $expectedCount)
    // {
    //     try {
    //         $this->generateSectionsLogicForAllSubjectsInContext($expectedCount); // نفس دالة الويب

    //         $planSubjectsForContext = PlanSubject::where('plan_id', $expectedCount->plan_id)
    //             ->where('plan_level', $expectedCount->plan_level)
    //             ->where('plan_semester', $expectedCount->plan_semester)
    //             ->get();
    //         $newSectionsGrouped = $this->getCurrentSectionsGrouped($planSubjectsForContext, $expectedCount);

    //         return response()->json([
    //             'success' => true,
    //             'message' => 'All sections for context generated/updated successfully.',
    //             'data' => $newSectionsGrouped
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error('API Manual Section Generation Failed for ExpectedCount ID ' . $expectedCount->id . ': ' . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Failed to generate sections: ' . $e->getMessage()], 500);
    //     }
    // }

    // /**
    //  * API: Store a newly created section within a specific ExpectedCount context.
    //  */
    // public function apiStoreSectionInContext(Request $request, PlanExpectedCount $expectedCount)
    // {
    //     $validator = Validator::make($request->all(), [
    //         'plan_subject_id' => 'required|integer|exists:plan_subjects,id',
    //         'activity_type' => ['required', Rule::in(['Theory', 'Practical'])],
    //         'section_number' => 'required|integer|min:1',
    //         'student_count' => 'required|integer|min:0',
    //         'section_gender' => ['required', Rule::in(['Male', 'Female', 'Mixed'])],
    //     ]);

    //     // التحقق من التفرد
    //     $validator->after(function ($validator) use ($request, $expectedCount) {
    //         if (!$validator->errors()->hasAny()) {
    //             $exists = Section::where('plan_subject_id', $request->input('plan_subject_id'))
    //                 ->where('academic_year', $expectedCount->academic_year)
    //                 ->where('semester', $expectedCount->plan_semester)
    //                 ->where('activity_type', $request->input('activity_type'))
    //                 ->where('section_number', $request->input('section_number'))
    //                 ->where('branch', $expectedCount->branch)
    //                 ->exists();
    //             if ($exists) {
    //                 $validator->errors()->add('section_unique', 'This section (number & activity type) already exists for this subject/context.');
    //             }
    //         }
    //     });

    //     // التحقق من تجاوز العدد الكلي
    //     if ($expectedCount) {
    //         $validator->after(function ($validator) use ($request, $expectedCount) {
    //             if (!$validator->errors()->has('student_count') && $request->filled('plan_subject_id')) {
    //                 $newStudentCount = (int) $request->input('student_count');
    //                 $totalExpected = $expectedCount->male_count + $expectedCount->female_count;
    //                 $otherSectionsSum = Section::where('plan_subject_id', $request->input('plan_subject_id'))
    //                     ->where('academic_year', $expectedCount->academic_year)
    //                     ->where('semester', $expectedCount->plan_semester)
    //                     ->where('activity_type', $request->input('activity_type'))
    //                     ->where('branch', $expectedCount->branch)
    //                     ->sum('student_count');
    //                 if (($otherSectionsSum + $newStudentCount) > $totalExpected) {
    //                     $validator->errors()->add('student_count_total', "Total allocated students (" . ($otherSectionsSum + $newStudentCount) . ") would exceed expected ({$totalExpected}). Max remaining for new section: " . max(0, $totalExpected - $otherSectionsSum));
    //                 }
    //             }
    //         });
    //     }

    //     if ($validator->fails()) {
    //         return response()->json(['success' => false, 'message' => 'Validation failed.', 'errors' => $validator->errors()], 422);
    //     }

    //     try {
    //         $section = Section::create([
    //             'plan_subject_id' => $request->input('plan_subject_id'),
    //             'academic_year' => $expectedCount->academic_year,
    //             'semester' => $expectedCount->plan_semester,
    //             'activity_type' => $request->input('activity_type'),
    //             'section_number' => $request->input('section_number'),
    //             'student_count' => $request->input('student_count'),
    //             'section_gender' => $request->input('section_gender'),
    //             'branch' => $expectedCount->branch,
    //         ]);
    //         $section->load('planSubject.subject:id,subject_no,subject_name');
    //         return response()->json(['success' => true, 'data' => $section, 'message' => 'Section added to context successfully.'], 201);
    //     } catch (Exception $e) {
    //         Log::error('API Section (in context) Store Failed: ' . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Failed to add section.'], 500);
    //     }
    // }

    // /**
    //  * API: Display the specified section details.
    //  */
    // public function apiShowSectionDetails(Section $section) // Route Model Binding
    // {
    //     try {
    //         $section->load(['planSubject.plan:id,plan_no,plan_name', 'planSubject.subject:id,subject_no,subject_name']);
    //         return response()->json(['success' => true, 'data' => $section], 200);
    //     } catch (Exception $e) {
    //         Log::error("API Error fetching section ID {$section->id}: " . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Section not found or server error.'], 404);
    //     }
    // }

    // /**
    //  * API: Update the specified section details.
    //  */
    // public function apiUpdateSectionDetails(Request $request, Section $section) // Route Model Binding
    // {
    //     $validator = Validator::make($request->all(), [
    //         'section_number' => 'sometimes|required|integer|min:1',
    //         'student_count' => 'sometimes|required|integer|min:0',
    //         'section_gender' => ['sometimes', 'required', Rule::in(['Male', 'Female', 'Mixed'])],
    //         // السياق لا يتم تعديله
    //     ]);

    //     // التحقق من التفرد إذا تم تعديل section_number
    //     $validator->after(function ($validator) use ($request, $section) {
    //         if ($request->has('section_number') && $request->input('section_number') != $section->section_number) {
    //             $exists = Section::where('plan_subject_id', $section->plan_subject_id)->where('academic_year', $section->academic_year)
    //                 ->where('semester', $section->semester)->where('activity_type', $section->activity_type)
    //                 ->where('section_number', $request->input('section_number'))->where('branch', $section->branch)
    //                 ->where('id', '!=', $section->id)->exists();
    //             if ($exists) {
    //                 $validator->errors()->add('section_unique', 'This section number already exists for this context.');
    //             }
    //         }
    //     });

    //     // التحقق من تجاوز العدد الكلي للطلاب إذا تم تعديل student_count
    //     $validator->after(function ($validator) use ($request, $section) {
    //         if ($request->has('student_count')) { // لا نتحقق من التغيير، دائماً نتحقق إذا أرسل
    //             $expectedCount = PlanExpectedCount::where('plan_id', $section->planSubject->plan_id)
    //                 ->where('academic_year', $section->academic_year)->where('plan_level', $section->planSubject->plan_level)
    //                 ->where('plan_semester', $section->planSubject->plan_semester)->where('branch', $section->branch)->first();
    //             if ($expectedCount) {
    //                 $newStudentCount = (int) $request->input('student_count');
    //                 $totalExpected = $expectedCount->male_count + $expectedCount->female_count;
    //                 $otherSectionsSum = Section::where('plan_subject_id', $section->plan_subject_id)
    //                     ->where('academic_year', $section->academic_year)->where('semester', $section->semester)
    //                     ->where('activity_type', $section->activity_type)->where('branch', $section->branch)
    //                     ->where('id', '!=', $section->id)->sum('student_count');
    //                 if (($otherSectionsSum + $newStudentCount) > $totalExpected) {
    //                     $validator->errors()->add('student_count_total', "Total allocated students (" . ($otherSectionsSum + $newStudentCount) . ") would exceed expected ({$totalExpected}). Max allowed for this section: " . max(0, $totalExpected - $otherSectionsSum + $section->student_count));
    //                 }
    //             }
    //         }
    //     });


    //     if ($validator->fails()) {
    //         return response()->json(['success' => false, 'message' => 'Validation failed.', 'errors' => $validator->errors()], 422);
    //     }

    //     try {
    //         $dataToUpdate = $validator->safe()->only(['section_number', 'student_count', 'section_gender']);
    //         $section->update($dataToUpdate);
    //         $section->load(['planSubject.subject', 'planSubject.plan']);
    //         return response()->json(['success' => true, 'data' => $section, 'message' => 'Section updated successfully.'], 200);
    //     } catch (Exception $e) {
    //         Log::error('API Section Update Failed for ID ' . $section->id . ': ' . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Failed to update section.'], 500);
    //     }
    // }

    // /**
    //  * API: Remove the specified section.
    //  */
    // public function apiDestroySectionDetails(Section $section) // Route Model Binding
    // {
    //     // يمكنك إضافة تحقق هنا إذا كانت الشعبة مستخدمة في generated_schedules
    //     if ($section->scheduleEntries()->exists()) {
    //         return response()->json(['success' => false, 'message' => 'Cannot delete section. It is used in schedules.'], 409);
    //     }
    //     try {
    //         $section->delete();
    //         return response()->json(['success' => true, 'message' => 'Section deleted successfully.'], 200);
    //     } catch (Exception $e) {
    //         Log::error('API Section Destroy Failed for ID ' . $section->id . ': ' . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Failed to delete section.'], 500);
    //     }
    // }
}
----------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\InstructorController.php
<?php

namespace App\Http\Controllers\DataEntry;

use Exception;
use App\Models\Role;
use App\Models\User;
use App\Models\Department;
use App\Models\Instructor;
use Illuminate\Support\Str;
use Illuminate\Http\Request;
use Illuminate\Validation\Rule;
use Illuminate\Support\Facades\DB;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Hash;
use Maatwebsite\Excel\Facades\Excel;
use Illuminate\Support\Facades\Password;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\Log; // اختياري

class InstructorController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================

    /**
     * Display a listing of the instructors (Web View) with Pagination.
     * عرض قائمة المدرسين لصفحة الويب مع تقسيم الصفحات (الأحدث أولاً)
     */
    // public function index()
    // {
    //     try {
    //         // جلب المدرسين مرتبين بالأحدث مع علاقات user و department وتقسيم الصفحات
    //         $instructors = Instructor::with(['user', 'department']) // Eager load relations
    //             ->latest('id')                // Order by newest first
    //             ->paginate(10);               // Paginate results

    //         // جلب المستخدمين المتاحين لربطهم
    //         $availableUsers = User::whereDoesntHave('instructor')
    //             ->whereHas('role', fn($q) => $q->whereIn('name', ['instructor', 'hod', 'admin']))
    //             ->orderBy('name')->get();

    //         // جلب الأقسام للقائمة المنسدلة
    //         $departments = Department::orderBy('department_name')->get();

    //         return view('dashboard.data-entry.instructors', compact('instructors', 'availableUsers', 'departments'));
    //     } catch (Exception $e) {
    //         Log::error('Error fetching instructors for web view: ' . $e->getMessage());
    //         return redirect()->back()->with('error', 'Could not load instructors.');
    //     }
    // }

    public function index(Request $request)
    {
        try {
            $instructors = Instructor::with(['user:id,name,email', 'department:id,department_name'])
                ->latest('id')
                ->paginate(15);
            // لجلب الأقسام لنموذج الإضافة/التعديل
            $departments = Department::orderBy('department_name')->get(['id', 'department_name']);
            // لجلب الأدوار المحتملة للمدرس (إذا أردت تحديدها في الفورم)
            $instructorRoles = Role::whereIn('name', ['instructor', 'hod'])->orderBy('display_name')->get(['id', 'display_name']);


            return view('dashboard.data-entry.instructors', compact('instructors', 'departments', 'instructorRoles'));
        } catch (Exception $e) {
            Log::error('Error fetching instructors: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load instructors list.');
        }
    }

    /**
     * Store a newly created instructor from web request.
     * تخزين مدرس جديد قادم من طلب ويب
     */
    // public function store(Request $request)
    // {
    //     // 1. Validation
    //     $validatedData = $request->validate([
    //         'user_id' => 'required|integer|exists:users,id|unique:instructors,user_id',
    //         'instructor_no' => 'required|string|max:20|unique:instructors,instructor_no',
    //         'instructor_name' => 'required|string|max:255',
    //         'academic_degree' => 'nullable|string|max:100',
    //         'department_id' => 'required|integer|exists:departments,id',
    //         'max_weekly_hours' => 'nullable|integer|min:0|max:100',
    //         // 'office_location' => 'nullable|string|max:255', // حقول المكتب
    //         // 'office_hours' => 'nullable|string|max:255',
    //         'availability_preferences' => 'nullable|string',
    //     ]);

    //     // التحقق الإضافي من دور المستخدم
    //     $user = User::find($request->user_id);
    //     if (!$user || !$user->hasRole(['instructor', 'hod', 'admin'])) {
    //         return redirect()->back()
    //             ->with('error', 'The selected user does not have a valid role to be an instructor.')
    //             ->withInput();
    //     }

    //     // 2. Prepare Data (validatedData جاهزة)
    //     $data = $validatedData;

    //     // 3. Add to Database
    //     try {
    //         Instructor::create($data);
    //         // 4. Redirect
    //         return redirect()->route('data-entry.instructors.index') // تأكد من اسم الروت
    //             ->with('success', 'Instructor created successfully.');
    //     } catch (Exception $e) {
    //         Log::error('Instructor Creation Failed (Web): ' . $e->getMessage());
    //         return redirect()->back()
    //             ->with('error', 'Failed to create instructor.')
    //             ->withInput();
    //     }
    // }

    public function store(Request $request)
    {
        $errorBagName = 'addInstructorModal';
        $validatedData = $request->validateWithBag($errorBagName, [
            // User fields
            'name' => 'required|string|max:255',
            'email' => 'required|string|email|max:255|unique:users,email',
            'password' => 'required|string|min:8|confirmed', // استخدام قاعدة أبسط
            // 'password' => ['required', 'confirmed', Password::min(8)], // استخدام قاعدة أبسط
            'role_id_for_instructor' => 'required|integer|exists:roles,id', // دور المستخدم الجديد (مدرس/رئيس قسم)

            // Instructor fields
            'instructor_no' => 'required|string|max:20|unique:instructors,instructor_no',
            'academic_degree' => 'nullable|string|max:100',
            'department_id' => 'required|integer|exists:departments,id',
            'max_weekly_hours' => 'nullable|integer|min:0|max:100',
            // 'office_location' => 'nullable|string|max:255',
            // 'office_hours' => 'nullable|string|max:255',
            'availability_preferences' => 'nullable|string',
        ]);

        DB::beginTransaction(); // بدء Transaction
        try {
            // 1. إنشاء المستخدم
            $user = User::create([
                'name' => $validatedData['name'],
                'email' => $validatedData['email'],
                'password' => Hash::make($validatedData['password']),
                'role_id' => $validatedData['role_id_for_instructor'], // استخدام الدور المحدد
                'email_verified_at' => now(), // تفعيل الإيميل مباشرة (اختياري)
            ]);

            // 2. إنشاء المدرس وربطه باليوزر
            Instructor::create([
                'user_id' => $user->id,
                'instructor_no' => $validatedData['instructor_no'],
                'instructor_name' => $user->name, // استخدام اسم اليوزر كاسم افتراضي للمدرس
                'academic_degree' => $validatedData['academic_degree'],
                'department_id' => $validatedData['department_id'],
                'max_weekly_hours' => $validatedData['max_weekly_hours'],
                // 'office_location' => $validatedData['office_location'],
                // 'office_hours' => $validatedData['office_hours'],
                'availability_preferences' => $validatedData['availability_preferences'],
            ]);

            DB::commit(); // تأكيد العمليات

            return redirect()->route('data-entry.instructors.index')
                ->with('success', 'Instructor and user account created successfully.');
        } catch (Exception $e) {
            DB::rollBack(); // التراجع عن العمليات في حالة الخطأ
            Log::error('Instructor & User Creation Failed: ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to create instructor: ' . $e->getMessage())
                ->withInput()
                ->withErrors($validatedData, $errorBagName); // إعادة أخطاء التحقق إذا فشل بعد التحقق (نادر)
        }
    }

    /**
     * Update the specified instructor from web request.
     * تحديث مدرس محدد قادم من طلب ويب
     */
    // public function update(Request $request, Instructor $instructor)
    // {
    //     // 1. Validation
    //     $validatedData = $request->validate([
    //         'instructor_no' => 'required|string|max:20|unique:instructors,instructor_no,' . $instructor->id,
    //         'instructor_name' => 'required|string|max:255',
    //         'academic_degree' => 'nullable|string|max:100',
    //         'department_id' => 'required|integer|exists:departments,id',
    //         'max_weekly_hours' => 'nullable|integer|min:0|max:100',
    //         // 'office_location' => 'nullable|string|max:255',
    //         // 'office_hours' => 'nullable|string|max:255',
    //         'availability_preferences' => 'nullable|string',
    //     ]);

    //     // 2. Prepare Data (validatedData جاهزة)
    //     $data = $validatedData;

    //     // 3. Update Database
    //     try {
    //         $instructor->update($data);
    //         // 4. Redirect
    //         return redirect()->route('data-entry.instructors.index') // تأكد من اسم الروت
    //             ->with('success', 'Instructor updated successfully.');
    //     } catch (Exception $e) {
    //         Log::error('Instructor Update Failed (Web): ' . $e->getMessage());
    //         return redirect()->back()
    //             ->with('error', 'Failed to update instructor.')
    //             ->withInput();
    //     }
    // }

    public function update(Request $request, Instructor $instructor)
    {
        $user = $instructor->user; // جلب المستخدم المرتبط
        if (!$user) {
            // معالجة حالة عدم وجود مستخدم مرتبط (نادر الحدوث إذا كان الإنشاء صحيحاً)
            return redirect()->route('data-entry.instructors.index')->with('error', 'User account for this instructor not found.');
        }

        $errorBagName = 'editInstructorModal_' . $instructor->id;
        $validatedData = $request->validate([
            // User fields
            'name' => 'required|string|max:255',
            'email' => ['required', 'string', 'email', 'max:255', Rule::unique('users')->ignore($user->id)],
            'password' => 'nullable|string|min:8|confirmed', // اختياري
            // 'password' => ['nullable', 'confirmed', Password::min(8)], // اختياري
            'role_id_for_instructor' => 'required|integer|exists:roles,id',

            // Instructor fields
            'instructor_no' => ['required', 'string', 'max:20', Rule::unique('instructors')->ignore($instructor->id)],
            'academic_degree' => 'nullable|string|max:100',
            'department_id' => 'required|integer|exists:departments,id',
            'max_weekly_hours' => 'nullable|integer|min:0|max:100',
            // 'office_location' => 'nullable|string|max:255',
            // 'office_hours' => 'nullable|string|max:255',
            'availability_preferences' => 'nullable|string',
        ]);

        // dd('dddd');
        DB::beginTransaction();
        try {
            // 1. تحديث بيانات المستخدم
            $userData = [
                'name' => $validatedData['name'],
                'email' => $validatedData['email'],
                'role_id' => $validatedData['role_id_for_instructor'],
            ];
            if (!empty($validatedData['password'])) {
                $userData['password'] = Hash::make($validatedData['password']);
            }
            $user->update($userData);

            // 2. تحديث بيانات المدرس
            $instructor->update([
                'instructor_no' => $validatedData['instructor_no'],
                'instructor_name' => $validatedData['name'], // تحديث اسم المدرس ليتطابق
                'academic_degree' => $validatedData['academic_degree'],
                'department_id' => $validatedData['department_id'],
                'max_weekly_hours' => $validatedData['max_weekly_hours'],
                // 'office_location' => $validatedData['office_location'],
                // 'office_hours' => $validatedData['office_hours'],
                'availability_preferences' => $validatedData['availability_preferences'],
            ]);

            DB::commit();
            return redirect()->route('data-entry.instructors.index')
                ->with('success', 'Instructor and user account updated successfully.');
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('Instructor & User Update Failed for Instructor ID ' . $instructor->id . ': ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to update instructor: ' . $e->getMessage())
                ->withInput()
                ->withErrors($validatedData, $errorBagName);
        }
    }

    /**
     * Remove the specified instructor from web request.
     * حذف مدرس محدد قادم من طلب ويب
     */
    // public function destroy(Instructor $instructor)
    // {
    //     // (اختياري) التحقق من السجلات المرتبطة
    //     // if ($instructor->scheduleEntries()->exists()) { ... }

    //     // 1. Delete from Database
    //     try {
    //         $instructor->delete();
    //         // 2. Redirect
    //         return redirect()->route('data-entry.instructors.index') // تأكد من اسم الروت
    //             ->with('success', 'Instructor record deleted successfully.');
    //     } catch (Exception $e) {
    //         Log::error('Instructor Deletion Failed (Web): ' . $e->getMessage());
    //         return redirect()->route('data-entry.instructors.index') // تأكد من اسم الروت
    //             ->with('error', 'Failed to delete instructor record.');
    //     }
    // }

    public function destroy(Instructor $instructor)
    {
        // (اختياري) التحقق من وجود ارتباطات أخرى للمدرس قبل الحذف (مثل شعب معينة له)
        // if ($instructor->sections()->exists() || $instructor->scheduleEntries()->exists()) {
        //     return redirect()->route('data-entry.instructors.index')
        //                      ->with('error', 'Cannot delete instructor. They are assigned to sections or schedules.');
        // }

        DB::beginTransaction();
        try {
            $user = $instructor->user; // جلب المستخدم المرتبط

            // حذف سجل المدرس أولاً (سيؤدي لتشغيل onDelete('set null') إذا كان user_id في instructors يقبله)
            // لكن بما أننا سنحذف اليوزر، ترتيب الحذف هنا ليس حرجاً جداً
            $instructor->delete();

            // ثم حذف المستخدم المرتبط (إذا وجد)
            if ($user) {
                // (اختياري) تحقق إذا كان هذا المستخدم له أدوار أخرى غير "instructor" أو "hod"
                // إذا كان له أدوار إدارية أخرى هامة، قد لا ترغب بحذفه تلقائياً
                // if ($user->role->name === 'admin' && User::where('role_id', $user->role_id)->count() <= 1) {
                //     DB::rollBack();
                //     return redirect()->route('data-entry.instructors.index')
                //                      ->with('error', 'Cannot delete the last admin user via instructor deletion.');
                // }
                $user->delete();
            }

            DB::commit();
            return redirect()->route('data-entry.instructors.index')
                ->with('success', 'Instructor and associated user account deleted successfully.');
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('Instructor & User Deletion Failed for Instructor ID ' . $instructor->id . ': ' . $e->getMessage());
            return redirect()->route('data-entry.instructors.index')
                ->with('error', 'Failed to delete instructor: ' . $e->getMessage());
        }
    }

    private $createdCount = 0;
    private $updatedCount = 0;
    private $skippedCount = 0;
    private $skippedDetails = [];
    private $processedInstructorNos = []; // لتتبع التكرار داخل الملف

    /**
     * Handle the import of instructors from an Excel file.
     */
    public function importExcel(Request $request)
    {
        $request->validate(['instructor_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120']);
        $this->resetCounters();

        try {
            $rows = Excel::toArray(new \stdClass(), $request->file('instructor_excel_file'))[0];
            if (count($rows) <= 1) {
                return redirect()->route('data-entry.instructors.index')->with('error', 'Uploaded Excel file is empty or contains only a header row.');
            }

            $header = array_map('strtolower', array_map('trim', array_shift($rows)));
            // البحث عن مواقع الأعمدة (مع مرونة في الأسماء)
            $instructorNoCol = $this->getColumnIndex($header, ['instructor_no', 'instructorno', 'رقم المدرس', 'الرقم الوظيفي']);
            $instructorNameCol = $this->getColumnIndex($header, ['instructor_name', 'instructorname', 'اسم المدرس', 'الاسم']);
            $departmentCol = $this->getColumnIndex($header, ['department_id', 'departmentid', 'department', 'القسم']);
            $emailCol = $this->getColumnIndex($header, ['email', 'البريد الالكتروني', 'الايميل']);
            $degreeCol = $this->getColumnIndex($header, ['academic_degree', 'academicdegree', 'degree', 'الدرجة العلمية']);
            $maxHoursCol = $this->getColumnIndex($header, ['max_weekly_hours', 'maxweeklyhours', 'ساعات الدوام']);

            if (is_null($instructorNoCol) || is_null($instructorNameCol) || is_null($departmentCol)) {
                $missing = [];
                if (is_null($instructorNoCol)) $missing[] = "'instructor_no'";
                if (is_null($instructorNameCol)) $missing[] = "'instructor_name'";
                if (is_null($departmentCol)) $missing[] = "'department_id' or 'department_name'";
                return redirect()->route('data-entry.instructors.index')->with('error', 'Excel file is missing required columns: ' . implode(', ', $missing));
            }

            $currentRowNumber = 1;
            DB::beginTransaction(); // بدء Transaction لضمان سلامة البيانات

            foreach ($rows as $row) {
                $currentRowNumber++;
                $rowData = [];
                foreach ($header as $index => $colName) {
                    $rowData[$colName] = $row[$index] ?? null;
                }

                if (count(array_filter($row)) == 0) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (empty).";
                    $this->skippedCount++;
                    continue;
                }

                $instructorNo = trim($rowData[$header[$instructorNoCol]] ?? null);
                if (empty($instructorNo)) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (missing instructor_no).";
                    $this->skippedCount++;
                    continue;
                }

                // منع تكرار معالجة نفس الرقم الوظيفي من الملف
                if (in_array($instructorNo, $this->processedInstructorNos)) {
                    $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (duplicate instructor_no '{$instructorNo}' within the file).";
                    $this->skippedCount++;
                    continue;
                }
                $this->processedInstructorNos[] = $instructorNo;

                $instructorNameInput = trim($rowData[$header[$instructorNameCol]] ?? null);
                $departmentIdentifier = trim($rowData[$header[$departmentCol]] ?? null);
                $emailInput = isset($emailCol) ? trim($rowData[$header[$emailCol]] ?? null) : null;
                $degreeInputFromFile = isset($degreeCol) ? trim($rowData[$header[$degreeCol]] ?? null) : null;
                $maxHoursInput = isset($maxHoursCol) ? trim($rowData[$header[$maxHoursCol]] ?? null) : null;

                if (empty($instructorNameInput) || empty($departmentIdentifier)) {
                    $this->skippedDetails[] = "Row {$currentRowNumber} (EmpNo:{$instructorNo}): Skipped (missing instructor_name or department).";
                    $this->skippedCount++;
                    continue;
                }

                // 1. استخراج الاسم والدرجة العلمية
                $name = $instructorNameInput;
                $degreeFromName = null;
                if (preg_match('/\(.+\)/u', $instructorNameInput, $matches)) {
                    $degreeFromName = trim($matches[0], '()');
                    $name = trim(str_replace($matches[0], '', $instructorNameInput));
                }
                $academicDegree = $degreeFromName ?: $degreeInputFromFile;

                // 2. البحث عن القسم
                $department = $this->findDepartment($departmentIdentifier);
                if (!$department) {
                    $this->skippedDetails[] = "Row {$currentRowNumber} (EmpNo:{$instructorNo}): Skipped (Department '{$departmentIdentifier}' not found).";
                    $this->skippedCount++;
                    continue;
                }

                // 3. تجهيز الإيميل
                $email = $emailInput;
                if (empty($email)) {
                    $baseEmailName = 'momen' . preg_replace('/[^A-Za-z0-9]/', '', $instructorNo); // إزالة أي رموز من رقم المدرس
                    $email = $this->generateUniqueEmail($baseEmailName, '@ptc.edu'); // افترض نطاق الكلية
                } else {
                    // التحقق من صحة الإيميل إذا تم إدخاله
                    $emailValidator = Validator::make(['email' => $email], ['email' => 'email']);
                    if ($emailValidator->fails()) {
                        $this->skippedDetails[] = "Row {$currentRowNumber} (EmpNo:{$instructorNo}): Skipped (Invalid email format '{$email}').";
                        $this->skippedCount++;
                        continue;
                    }
                }

                // 4. البحث عن المدرس أو إنشاء جديد (User و Instructor)
                $instructor = Instructor::where('instructor_no', $instructorNo)->first();
                $userToUpdateOrCreate = null;

                if ($instructor) { // تحديث مدرس موجود
                    $userToUpdateOrCreate = $instructor->user;
                    if (!$userToUpdateOrCreate) { // في حالة نادرة أن المدرس موجود بدون مستخدم
                        Log::warning("Instructor ID {$instructor->id} exists without a user. Creating a new user.");
                        $userToUpdateOrCreate = $this->createUserForInstructor($name, $email, 'instructor'); // افترض دور افتراضي
                        $instructor->user_id = $userToUpdateOrCreate->id;
                    }

                    // تحديث بيانات المستخدم
                    $userData = ['name' => $name, 'email' => $email];
                    // التحقق من تفرد الإيميل عند التحديث
                    if (User::where('email', $email)->where('id', '!=', $userToUpdateOrCreate->id)->exists()) {
                        $this->skippedDetails[] = "Row {$currentRowNumber} (EmpNo:{$instructorNo}): Skipped (Email '{$email}' already taken by another user).";
                        $this->skippedCount++;
                        continue;
                    }
                    $userToUpdateOrCreate->update($userData);

                    // تحديث بيانات المدرس
                    $instructor->instructor_name = $name;
                    $instructor->academic_degree = $academicDegree;
                    $instructor->department_id = $department->id;
                    if (!is_null($maxHoursInput) && is_numeric($maxHoursInput)) {
                        $instructor->max_weekly_hours = (int)$maxHoursInput;
                    }
                    // يمكن إضافة تحديث للحقول الأخرى المعلقة
                    $instructor->save();
                    $this->updatedCount++;
                } else { // إنشاء مدرس جديد ومستخدم جديد
                    // التحقق من تفرد الإيميل قبل إنشاء مستخدم جديد
                    if (User::where('email', $email)->exists()) {
                        $this->skippedDetails[] = "Row {$currentRowNumber} (EmpNo:{$instructorNo}): Skipped (Generated/Provided email '{$email}' already exists).";
                        $this->skippedCount++;
                        continue;
                    }
                    $userToUpdateOrCreate = $this->createUserForInstructor($name, $email, 'instructor'); // افترض دور افتراضي

                    Instructor::create([
                        'user_id' => $userToUpdateOrCreate->id,
                        'instructor_no' => $instructorNo,
                        'instructor_name' => $name,
                        'academic_degree' => $academicDegree,
                        'department_id' => $department->id,
                        'max_weekly_hours' => (!is_null($maxHoursInput) && is_numeric($maxHoursInput)) ? (int)$maxHoursInput : null,
                        // يمكن إضافة الحقول المعلقة
                    ]);
                    $this->createdCount++;
                }
            } // نهاية حلقة الصفوف

            DB::commit(); // تأكيد كل العمليات

            // بناء رسالة النجاح
            $messages = [];
            if ($this->createdCount > 0) $messages[] = "{$this->createdCount} new instructor(s) created.";
            if ($this->updatedCount > 0) $messages[] = "{$this->updatedCount} existing instructor(s) updated.";
            if ($this->skippedCount > 0) $messages[] = "{$this->skippedCount} row(s) were skipped.";
            if (empty($messages)) {
                return redirect()->route('data-entry.instructors.index')->with('info', 'Excel file processed. No changes made or no valid data found.');
            } else {
                return redirect()->route('data-entry.instructors.index')->with('success', implode(' ', $messages))->with('skipped_details', $this->skippedDetails);
            }
        } catch (Exception $e) {
            DB::rollBack(); // تراجع في حالة الخطأ
            Log::error('Instructors Excel Import Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return redirect()->route('data-entry.instructors.index')
                ->with('error', 'An error occurred during Excel import: ' . $e->getMessage())
                ->with('skipped_details', $this->skippedDetails); // إرجاع ما تم تخطيه حتى الآن
        }
    }

    // --- دوال مساعدة للـ Import ---
    private function resetCounters()
    {
        $this->createdCount = 0;
        $this->updatedCount = 0;
        $this->skippedCount = 0;
        $this->skippedDetails = [];
        $this->processedInstructorNos = [];
    }
    private function getColumnIndex(array $header, array $possibleNames)
    {
        $normalizedHeader = array_map(fn($h) => strtolower(str_replace([' ', '_', '-'], '', trim($h))), $header);

        foreach ($possibleNames as $name) {
            $normalizedName = strtolower(str_replace([' ', '_', '-'], '', trim($name)));
            $index = array_search($normalizedName, $normalizedHeader);
            if ($index !== false) {
                return $index; // Return the original index from the header
            }
        }
        return null;
    }

    private function findDepartment($identifier)
    {
        if (is_numeric($identifier)) return Department::find($identifier);
        $normalized = $this->normalizeArabicStringForSearch($identifier);
        return Department::whereRaw('REPLACE(LOWER(department_name), " ", "") LIKE ?', ["%{$normalized}%"])
            ->orWhereRaw('LOWER(department_no) LIKE ?', ["%{$normalized}%"])
            ->first();
    }

    private function normalizeArabicStringForSearch($string)
    {
        // Normalize Hamza (أ, إ, آ -> ا)
        $string = str_replace(['أ', 'إ', 'آ'], 'ا', $string);
        // Normalize Alef Maqsura (ى -> ي)
        $string = str_replace('ى', 'ي', $string);
        // Normalize Taa Marbuta (ة -> ه)
        $string = str_replace('ة', 'ه', $string);
        // Remove "ال" from the beginning of words
        $string = preg_replace('/\bال/u', '', $string);
        // Remove extra spaces and convert to lowercase
        $string = strtolower(preg_replace('/\s+/u', '', trim($string)));

        $string = preg_replace('/[أإآ]/u', 'ا', $string); // توحيد الألفات
        $string = preg_replace('/^ال/u', '', $string); // إزالة "ال" التعريف من البداية
        $string = preg_replace('/\s+/u', '', trim($string)); // إزالة كل الفراغات وتحويل لحروف صغيرة
        return strtolower($string);
    }

    private function generateUniqueEmail($baseName, $domain, $counter = 0) {
        $email = $baseName . ($counter > 0 ? str_pad($counter, 2, '0', STR_PAD_LEFT) : '') . $domain;
        if (User::where('email', $email)->exists()) {
            return $this->generateUniqueEmail($baseName, $domain, $counter + 1);
        }
        return $email;
    }

    // private function generateUniqueEmail($baseName, $domain = '@ptc.edu', $instructorNo = null, $counter = 0): string
    // {
    //     // بناء الجزء الأول من الإيميل (يفضل استخدام شيء فريد مثل الرقم الوظيفي إذا توفر)
    //     $prefix = Str::slug($baseName, ''); // إزالة الفراغات والرموز من الاسم
    //     if (empty($prefix) && $instructorNo) { // إذا كان الاسم عربياً بالكامل، استخدم الرقم الوظيفي
    //         $prefix = 'inst' . preg_replace('/[^A-Za-z0-9]/', '', $instructorNo);
    //     } elseif (empty($prefix) && empty($instructorNo)) {
    //         $prefix = 'instructor' . Str::random(4); // اسم عشوائي إذا فشل كل شيء
    //     }


    //     $emailTry = $prefix . ($counter > 0 ? str_pad($counter, 2, '0', STR_PAD_LEFT) : ($instructorNo ? preg_replace('/[^A-Za-z0-9]/', '', $instructorNo) : '')) . $domain;
    //     if (empty($emailTry)) { // في حالة نادرة جداً أن كل شيء فارغ
    //         $emailTry = 'user' . time() . $counter . $domain;
    //     }


    //     // ضمان أن الجزء المحلي لا يتجاوز 64 حرفاً (حد شائع)
    //     $localPart = explode('@', $emailTry)[0];
    //     if (strlen($localPart) > 60) { // ترك بعض الحروف للـ counter إذا لزم الأمر
    //         $localPart = substr($localPart, 0, 60);
    //         $emailTry = $localPart . $domain;
    //     }


    //     if (User::where('email', $emailTry)->exists()) {
    //         // إذا كان الإيميل موجوداً، حاول بإضافة/زيادة العداد
    //         // إذا لم يكن هناك رقم وظيفي، استخدم عداداً عشوائياً أكثر
    //         $newBaseForCounter = $instructorNo ? preg_replace('/[^A-Za-z0-9]/', '', $instructorNo) : Str::random(2);
    //         return $this->generateUniqueEmail($baseName, $domain, $newBaseForCounter . ($counter + 1)); // تغيير طريقة العداد
    //     }
    //     return $emailTry;
    // }

    private function createUserForInstructor($name, $email, $roleName = 'instructor')
    {
        $role = Role::where('name', $roleName)->first();
        if (!$role) { // دور افتراضي إذا لم يوجد
            $role = Role::firstOrCreate(['name' => 'instructor'], ['display_name' => 'Instructor']);
        }
        return User::create([
            'name' => $name,
            'email' => $email,
            'password' => Hash::make('123456789'), // كلمة مرور افتراضية
            'role_id' => $role->id,
            'email_verified_at' => now(),
        ]);
    }


    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * Display a listing of the instructors (API).
     */
    public function apiIndex(Request $request)
    {
        try {
            $query = Instructor::with([
                'user:id,name,email,role_id', // جلب دور المستخدم أيضاً
                'user.role:id,name,display_name', // تفاصيل الدور
                'department:id,department_name'
            ]);

            if ($request->has('department_id')) {
                $query->where('department_id', $request->department_id);
            }
            if ($request->has('q')) {
                $searchTerm = $request->q;
                $query->where(function ($q) use ($searchTerm) {
                    $q->where('instructor_no', 'like', "%{$searchTerm}%")
                        ->orWhere('instructor_name', 'like', "%{$searchTerm}%")
                        ->orWhereHas('user', fn($userQuery) => $userQuery->where('name', 'like', "%{$searchTerm}%")->orWhere('email', 'like', "%{$searchTerm}%"));
                });
            }

            // --- الـ Pagination للـ API (معطل حالياً، جلب الكل) ---
            $instructors = $query->latest('id')->get();
            /*
            $perPage = $request->query('per_page', 15);
            $instructorsPaginated = $query->latest('id')->paginate($perPage);
            return response()->json([
                'success' => true,
                'data' => $instructorsPaginated->items(),
                'pagination' => [ 'total' => $instructorsPaginated->total(), ... ]
            ], 200);
            */

            return response()->json(['success' => true, 'data' => $instructors], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching instructors: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }

    /**
     * Store a newly created instructor and associated user from API request.
     */
    public function apiStore(Request $request)
    {
        $validator = Validator::make($request->all(), [
            // User fields
            'name' => 'required|string|max:255',
            'email' => 'required|string|email|max:255|unique:users,email',
            'password' => 'required|string|min:8', // لا حاجة لـ confirmed في API عادةً
            'role_id_for_instructor' => 'required|integer|exists:roles,id',

            // Instructor fields
            'instructor_no' => 'required|string|max:20|unique:instructors,instructor_no',
            'academic_degree' => 'nullable|string|max:100',
            'department_id' => 'required|integer|exists:departments,id',
            'max_weekly_hours' => 'nullable|integer|min:0|max:100',
            // 'office_location' => 'nullable|string|max:255',
            // 'office_hours' => 'nullable|string|max:255',
            'availability_preferences' => 'nullable|string', // أو 'nullable|json'
        ]);

        if ($validator->fails()) {
            return response()->json(['success' => false, 'message' => 'Validation failed', 'errors' => $validator->errors()], 422);
        }

        $validatedData = $validator->validated(); // الحصول على البيانات المتحقق منها

        DB::beginTransaction();
        try {
            $user = User::create([
                'name' => $validatedData['name'],
                'email' => $validatedData['email'],
                'password' => Hash::make($validatedData['password']),
                'role_id' => $validatedData['role_id_for_instructor'],
                'email_verified_at' => now(), // افترض التفعيل المباشر للـ API
            ]);

            $instructor = Instructor::create([
                'user_id' => $user->id,
                'instructor_no' => $validatedData['instructor_no'],
                'instructor_name' => $user->name,
                'academic_degree' => $validatedData['academic_degree'] ?? null,
                'department_id' => $validatedData['department_id'],
                'max_weekly_hours' => $validatedData['max_weekly_hours'] ?? null,
                // 'office_location' => $validatedData['office_location'] ?? null,
                // 'office_hours' => $validatedData['office_hours'] ?? null,
                'availability_preferences' => $validatedData['availability_preferences'] ?? null,
            ]);

            DB::commit();
            // تحميل العلاقات لعرضها في الاستجابة
            $instructor->load(['user.role', 'department']);
            return response()->json([
                'success' => true,
                'data' => $instructor,
                'message' => 'Instructor and user account created successfully.'
            ], 201);
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('API Instructor & User Creation Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to create instructor: ' . $e->getMessage()], 500);
        }
    }

    /**
     * Display the specified instructor (API).
     */
    public function apiShow(Instructor $instructor) // Route Model Binding
    {
        try {
            $instructor->load(['user.role', 'department', 'subjects:subjects.id,subject_no,subject_name']); // تحميل المواد المعينة أيضاً
            return response()->json(['success' => true, 'data' => $instructor], 200);
        } catch (Exception $e) {
            Log::error("API Error fetching instructor ID {$instructor->id}: " . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Instructor not found or server error.'], 404); // أو 500
        }
    }

    /**
     * Update the specified instructor and associated user from API request.
     */
    public function apiUpdate(Request $request, Instructor $instructor)
    {
        $user = $instructor->user;
        if (!$user) {
            return response()->json(['success' => false, 'message' => 'User account for this instructor not found.'], 404);
        }

        $validator = Validator::make($request->all(), [
            // User fields (sometimes لأن الـ API قد يرسل جزءاً من البيانات)
            'name' => 'sometimes|required|string|max:255',
            'email' => ['sometimes', 'required', 'string', 'email', 'max:255', Rule::unique('users')->ignore($user->id)],
            'password' => 'required|string|min:8', // كلمة المرور اختيارية
            'role_id_for_instructor' => 'sometimes|required|integer|exists:roles,id',

            // Instructor fields
            'instructor_no' => ['sometimes', 'required', 'string', 'max:20', Rule::unique('instructors')->ignore($instructor->id)],
            'academic_degree' => 'sometimes|nullable|string|max:100',
            'department_id' => 'sometimes|required|integer|exists:departments,id',
            'max_weekly_hours' => 'sometimes|nullable|integer|min:0|max:100',
            // 'office_location' => 'sometimes|nullable|string|max:255',
            // 'office_hours' => 'sometimes|nullable|string|max:255',
            'availability_preferences' => 'sometimes|nullable|string',
        ]);

        if ($validator->fails()) {
            return response()->json(['success' => false, 'message' => 'Validation failed', 'errors' => $validator->errors()], 422);
        }

        $validatedData = $validator->validated(); // الحصول فقط على البيانات التي تم التحقق منها وتم إرسالها

        DB::beginTransaction();
        try {
            // 1. تحديث بيانات المستخدم (فقط إذا تم إرسالها)
            $userDataToUpdate = [];
            if (isset($validatedData['name'])) $userDataToUpdate['name'] = $validatedData['name'];
            if (isset($validatedData['email'])) $userDataToUpdate['email'] = $validatedData['email'];
            if (isset($validatedData['role_id_for_instructor'])) $userDataToUpdate['role_id'] = $validatedData['role_id_for_instructor'];
            if (!empty($validatedData['password'])) {
                $userDataToUpdate['password'] = Hash::make($validatedData['password']);
            }
            if (!empty($userDataToUpdate)) {
                $user->update($userDataToUpdate);
            }

            // 2. تحديث بيانات المدرس (فقط إذا تم إرسالها)
            $instructorDataToUpdate = [];
            if (isset($validatedData['instructor_no'])) $instructorDataToUpdate['instructor_no'] = $validatedData['instructor_no'];
            if (isset($validatedData['name'])) $instructorDataToUpdate['instructor_name'] = $validatedData['name']; // تحديث اسم المدرس
            if (array_key_exists('academic_degree', $validatedData)) $instructorDataToUpdate['academic_degree'] = $validatedData['academic_degree'];
            if (isset($validatedData['department_id'])) $instructorDataToUpdate['department_id'] = $validatedData['department_id'];
            if (array_key_exists('max_weekly_hours', $validatedData)) $instructorDataToUpdate['max_weekly_hours'] = $validatedData['max_weekly_hours'];
            // if (array_key_exists('office_location', $validatedData)) $instructorDataToUpdate['office_location'] = $validatedData['office_location'];
            // if (array_key_exists('office_hours', $validatedData)) $instructorDataToUpdate['office_hours'] = $validatedData['office_hours'];
            if (array_key_exists('availability_preferences', $validatedData)) $instructorDataToUpdate['availability_preferences'] = $validatedData['availability_preferences'];

            if (!empty($instructorDataToUpdate)) {
                $instructor->update($instructorDataToUpdate);
            }

            DB::commit();
            $instructor->load(['user.role', 'department']); // إعادة تحميل العلاقات
            return response()->json([
                'success' => true,
                'data' => $instructor,
                'message' => 'Instructor and user account updated successfully.'
            ], 200);
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('API Instructor & User Update Failed for Instructor ID ' . $instructor->id . ': ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to update instructor: ' . $e->getMessage()], 500);
        }
    }

    /**
     * Remove the specified instructor and their associated user account (API).
     */
    public function apiDestroy(Instructor $instructor)
    {
        // (اختياري) التحقق من الارتباطات قبل الحذف
        // if ($instructor->sections()->exists() || $instructor->scheduleEntries()->exists()) {
        //     return response()->json(['success' => false, 'message' => 'Cannot delete: Instructor has assignments.'], 409);
        // }

        DB::beginTransaction();
        try {
            $user = $instructor->user;
            $instructor->delete(); // حذف المدرس
            if ($user) {
                // (اختياري) التحقق من الأدوار الأخرى للمستخدم قبل حذفه
                $user->delete(); // حذف المستخدم
            }
            DB::commit();
            return response()->json(['success' => true, 'message' => 'Instructor and associated user deleted successfully.'], 200);
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('API Instructor & User Deletion Failed for Instructor ID ' . $instructor->id . ': ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to delete instructor: ' . $e->getMessage()], 500);
        }
    }

    /**
     * API: Handle the import of instructors from an Excel file.
     */
    public function apiImportExcel(Request $request)
    {
        // 1. التحقق من وجود الملف وصيغته (باستخدام Validator لـ API)
        $validator = Validator::make($request->all(), [
            'instructor_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
        ]);

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed for uploaded file.',
                'errors' => $validator->errors()
            ], 422); // Unprocessable Entity
        }

        $this->resetCounters(); // إعادة تعيين العدادات لكل عملية رفع

        try {
            $rows = Excel::toArray(new \stdClass(), $request->file('instructor_excel_file'))[0];

            if (count($rows) <= 1) { // إذا كان الملف فارغاً أو يحتوي على العناوين فقط
                return response()->json(['success' => false, 'message' => 'Uploaded Excel file is empty or contains only a header row.'], 400);
            }

            $header = array_map('strtolower', array_map('trim', array_shift($rows)));
            $instructorNoCol = $this->getColumnIndex($header, ['instructor_no', 'instructorno', 'رقم المدرس', 'الرقم الوظيفي']);
            $instructorNameCol = $this->getColumnIndex($header, ['instructor_name', 'instructorname', 'اسم المدرس', 'الاسم']);
            $departmentCol = $this->getColumnIndex($header, ['department_id', 'departmentid', 'department', 'القسم']);
            $emailCol = $this->getColumnIndex($header, ['email', 'البريد الالكتروني', 'الايميل']);
            $degreeCol = $this->getColumnIndex($header, ['academic_degree', 'academicdegree', 'degree', 'الدرجة العلمية']);
            $maxHoursCol = $this->getColumnIndex($header, ['max_weekly_hours', 'maxweeklyhours', 'ساعات النصاب']);

            if (is_null($instructorNoCol) || is_null($instructorNameCol) || is_null($departmentCol)) {
                $missing = []; /* ... (نفس منطق تحديد الأعمدة المفقودة) ... */
                if(is_null($instructorNoCol)) $missing[] = "'instructor_no'";
                if(is_null($instructorNameCol)) $missing[] = "'instructor_name'";
                if(is_null($departmentCol)) $missing[] = "'department_id' or 'department_name'";
                return response()->json(['success' => false, 'message' => 'Excel file is missing required columns: ' . implode(', ', $missing)], 400);
            }

            $currentRowNumber = 1;
            // لا نحتاج Transaction هنا لكل صف، يمكن عمل Transaction كبير حول الحلقة كلها إذا أردت
            // ولكن إذا فشل صف واحد، قد ترغب في تجاهله فقط ومتابعة الباقي

            foreach ($rows as $row) {
                $currentRowNumber++;
                $rowData = []; foreach ($header as $index => $colName) { $rowData[$colName] = $row[$index] ?? null; }

                if (count(array_filter($row)) == 0) { $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (empty)."; $this->skippedCount++; continue; }

                $instructorNo = trim($rowData[$header[$instructorNoCol]] ?? null);
                if (empty($instructorNo)) { $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (missing instructor_no)."; $this->skippedCount++; continue; }

                if (in_array($instructorNo, $this->processedInstructorNos)) { $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (duplicate instructor_no '{$instructorNo}' within file)."; $this->skippedCount++; continue; }
                $this->processedInstructorNos[] = $instructorNo;

                $instructorNameInput = trim($rowData[$header[$instructorNameCol]] ?? null);
                $departmentIdentifier = trim($rowData[$header[$departmentCol]] ?? null);
                $emailInput = isset($emailCol) ? trim($rowData[$header[$emailCol]] ?? null) : null;
                $degreeInputFromFile = isset($degreeCol) ? trim($rowData[$header[$degreeCol]] ?? null) : null;
                $maxHoursInput = isset($maxHoursCol) ? trim($rowData[$header[$maxHoursCol]] ?? null) : null;

                if (empty($instructorNameInput) || empty($departmentIdentifier)) { $this->skippedDetails[] = "Row {$currentRowNumber} (EmpNo:{$instructorNo}): Skipped (missing name or department)."; $this->skippedCount++; continue; }

                $name = $instructorNameInput; $degreeFromName = null;
                if (preg_match('/\(.+\)/u', $instructorNameInput, $matches)) { $degreeFromName = trim($matches[0], '()'); $name = trim(str_replace($matches[0], '', $instructorNameInput)); }
                $academicDegree = $degreeFromName ?: $degreeInputFromFile;

                $department = $this->findDepartment($departmentIdentifier);
                if (!$department) { $this->skippedDetails[] = "Row {$currentRowNumber} (EmpNo:{$instructorNo}): Skipped (Department '{$departmentIdentifier}' not found)."; $this->skippedCount++; continue; }

                $email = $emailInput;
                if (empty($email)) { $baseEmailName = 'momen' . preg_replace('/[^A-Za-z0-9]/', '', $instructorNo); $email = $this->generateUniqueEmail($baseEmailName, '@ptc.edu', $instructorNo); }
                else { $emailValidator = Validator::make(['email' => $email], ['email' => 'email']); if ($emailValidator->fails()) { $this->skippedDetails[] = "Row {$currentRowNumber} (EmpNo:{$instructorNo}): Skipped (Invalid email '{$email}')."; $this->skippedCount++; continue; } }

                // --- التحديث أو الإنشاء (داخل Transaction لكل مدرس لضمان سلامة User و Instructor معاً) ---
                DB::transaction(function () use ($instructorNo, $name, $email, $academicDegree, $department, $maxHoursInput, $currentRowNumber) {
                    $instructor = Instructor::where('instructor_no', $instructorNo)->first();
                    $defaultRoleName = 'instructor'; // الدور الافتراضي للمدرس الجديد

                    if ($instructor) { // تحديث
                        $user = $instructor->user;
                        if (!$user) {
                            Log::warning("Instructor ID {$instructor->id} (EmpNo: {$instructorNo}) exists without a user. Creating user for update.");
                            $user = $this->createUserForInstructor($name, $email, $defaultRoleName);
                            $instructor->user_id = $user->id; // ربط المستخدم الجديد
                        } else {
                            if (User::where('email', $email)->where('id', '!=', $user->id)->exists()) {
                                $this->skippedDetails[] = "Row {$currentRowNumber} (EmpNo:{$instructorNo}): Update Skipped (Email '{$email}' already taken).";
                                $this->skippedCount++;
                                DB::rollBack(); // التراجع عن أي تغييرات محتملة في هذا الـ transaction
                                return; // الخروج من الـ closure الخاص بالـ transaction
                            }
                            $user->name = $name;
                            $user->email = $email;
                            // لا نغير كلمة المرور أو الدور عند التحديث من الإكسل عادةً إلا إذا كان هناك عمود مخصص
                            $user->save();
                        }
                        $instructor->instructor_name = $name;
                        $instructor->academic_degree = $academicDegree;
                        $instructor->department_id = $department->id;
                        if (!is_null($maxHoursInput) && is_numeric($maxHoursInput)) $instructor->max_weekly_hours = (int)$maxHoursInput;
                        $instructor->save();
                        $this->updatedCount++;
                    } else { // إنشاء جديد
                        if (User::where('email', $email)->exists()) {
                            $this->skippedDetails[] = "Row {$currentRowNumber} (EmpNo:{$instructorNo}): Create Skipped (Email '{$email}' already exists for new user).";
                            $this->skippedCount++;
                            DB::rollBack(); return;
                        }
                        $user = $this->createUserForInstructor($name, $email, $defaultRoleName);
                        Instructor::create([
                            'user_id' => $user->id, 'instructor_no' => $instructorNo, 'instructor_name' => $name,
                            'academic_degree' => $academicDegree, 'department_id' => $department->id,
                            'max_weekly_hours' => (!is_null($maxHoursInput) && is_numeric($maxHoursInput)) ? (int)$maxHoursInput : null,
                        ]);
                        $this->createdCount++;
                    }
                }); // نهاية الـ Transaction لكل مدرس
                // -----------------------------------------------------------------------------------

            } // نهاية حلقة الصفوف

            $summary = [];
            if ($this->createdCount > 0) $summary['new_instructors_created'] = $this->createdCount;
            if ($this->updatedCount > 0) $summary['existing_instructors_updated'] = $this->updatedCount;
            if ($this->skippedCount > 0) $summary['rows_skipped'] = $this->skippedCount;

            if (empty($summary) && empty(array_filter($this->skippedDetails))) {
                 return response()->json(['success' => true, 'message' => 'Excel file processed. No new data imported or all data already matched/skipped.', 'summary' => $summary, 'skipped_details' => $this->skippedDetails], 200);
            }

            return response()->json([
                'success' => true,
                'message' => "Instructors import processed.",
                'summary' => $summary,
                'skipped_details' => $this->skippedDetails
            ], 200);

        } catch (Exception $e) {
            Log::error('API Instructors Excel Import Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            // إرجاع أي تفاصيل تم تجميعها حتى الآن
            return response()->json([
                'success' => false,
                'message' => 'An error occurred during Excel import: ' . $e->getMessage(),
                'skipped_details' => $this->skippedDetails
            ], 500);
        }
    }


    /**
     * Display a listing of the instructors (API).
     */
    // public function apiIndex(Request $request)
    // {
    //     try {
    //         $query = Instructor::with(['user:id,name,email', 'department:id,department_name']);

    //         // (اختياري) فلترة
    //         if ($request->has('department_id')) {
    //             $query->where('department_id', $request->department_id);
    //         }

    //         // --- الخيار 1: جلب كل المدرسين (الحالة الحالية) ---
    //         $instructors = $query->latest('id')->get();

    //         /*
    //         $perPage = $request->query('per_page', 15);
    //         $instructorsPaginated = $query->latest('id')
    //                                       ->paginate($perPage);

    //         return response()->json([
    //             'success' => true,
    //             'data' => $instructorsPaginated->items(),
    //             'pagination' => [
    //                 'total' => $instructorsPaginated->total(),
    //                 'per_page' => $instructorsPaginated->perPage(),
    //                 'current_page' => $instructorsPaginated->currentPage(),
    //                 'last_page' => $instructorsPaginated->lastPage(),
    //             ]
    //         ], 200);
    //         */

    //         return response()->json(['success' => true, 'data' => $instructors], 200);
    //     } catch (Exception $e) {
    //         Log::error('API Error fetching instructors: ' . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Server Error'], 500);
    //     }
    // }

    // /**
    //  * Store a newly created instructor from API request.
    //  */
    // public function apiStore(Request $request)
    // {
    //     // 1. Validation
    //     $validatedData = $request->validate([
    //         'user_id' => 'required|integer|exists:users,id|unique:instructors,user_id',
    //         'instructor_no' => 'required|string|max:20|unique:instructors,instructor_no',
    //         'instructor_name' => 'required|string|max:255',
    //         'academic_degree' => 'nullable|string|max:100',
    //         'department_id' => 'required|integer|exists:departments,id',
    //         'max_weekly_hours' => 'nullable|integer|min:0|max:100',
    //         // 'office_location' => 'nullable|string|max:255',
    //         // 'office_hours' => 'nullable|string|max:255',
    //         'availability_preferences' => 'nullable|string',
    //     ]);

    //     // التحقق من دور المستخدم
    //     $user = User::find($request->user_id);
    //     if (!$user || !$user->hasRole(['instructor', 'hod', 'admin'])) {
    //         return response()->json(['success' => false, 'message' => 'The selected user does not have a valid role.'], 422);
    //     }

    //     // 2. Add to Database
    //     try {
    //         $instructor = Instructor::create($validatedData);
    //         $instructor->load(['user:id,name,email', 'department:id,department_name']); // تحميل العلاقات
    //         // 3. Return Success JSON Response
    //         return response()->json([
    //             'success' => true,
    //             'data' => $instructor,
    //             'message' => 'Instructor created successfully.'
    //         ], 201);
    //     } catch (Exception $e) {
    //         Log::error('API Instructor Creation Failed: ' . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Failed to create instructor.'], 500);
    //     }
    // }

    // /**
    //  * Display the specified instructor (API).
    //  */
    // public function apiShow(Instructor $instructor)
    // {
    //     $instructor->load(['user:id,name,email', 'department:id,department_name']);
    //     return response()->json([
    //         'success' => true,
    //         'data' => $instructor,
    //     ], 200);
    // }

    // /**
    //  * Update the specified instructor from API request.
    //  */
    // public function apiUpdate(Request $request, Instructor $instructor)
    // {
    //     // 1. Validation
    //     $validatedData = $request->validate([
    //         'instructor_no' => [
    //             'sometimes',
    //             'required',
    //             'string',
    //             'max:20',
    //             'unique:instructors,instructor_no,' . $instructor->id,
    //         ],
    //         'instructor_name' => 'sometimes|required|string|max:255',
    //         'academic_degree' => 'sometimes|nullable|string|max:100',
    //         'department_id' => 'sometimes|required|integer|exists:departments,id',
    //         'max_weekly_hours' => 'sometimes|nullable|integer|min:0|max:100',
    //         // 'office_location' => 'sometimes|nullable|string|max:255',
    //         // 'office_hours' => 'sometimes|nullable|string|max:255',
    //         'availability_preferences' => 'sometimes|nullable|string',
    //     ]);

    //     // 2. Update Database
    //     try {
    //         $instructor->update($validatedData);
    //         $instructor->load(['user:id,name,email', 'department:id,department_name']); // تحميل العلاقات بعد التحديث
    //         // 3. Return Success JSON Response
    //         return response()->json([
    //             'success' => true,
    //             'data' => $instructor,
    //             'message' => 'Instructor updated successfully.'
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error('API Instructor Update Failed: ' . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Failed to update instructor.'], 500);
    //     }
    // }

    // /**
    //  * Remove the specified instructor from API request.
    //  * حذف مدرس محدد قادم من طلب API
    //  */
    // public function apiDestroy(Instructor $instructor)
    // {
    //     // (اختياري) التحقق من السجلات المرتبطة
    //     // if ($instructor->scheduleEntries()->exists()) { ... }

    //     // 1. Delete from Database
    //     try {
    //         $instructor->delete(); // حذف سجل المدرس فقط، المستخدم المرتبط يبقى
    //         // 2. Return Success JSON Response
    //         return response()->json([
    //             'success' => true,
    //             'message' => 'Instructor record deleted successfully.'
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error('API Instructor Deletion Failed: ' . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Failed to delete instructor record.'], 500);
    //     }
    // }
} // نهاية الكلاس
----------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\InstructorSectionController.php
<?php

namespace App\Http\Controllers\DataEntry;

use Exception;
use App\Models\Section;
use App\Models\Subject;
use App\Models\Instructor;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use App\Http\Controllers\Controller;

class InstructorSectionController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        try {
            // جلب المدرسين مع القسم وعدد المواد المعينة (لتجنب تحميل كل المواد)
            $instructors = Instructor::with(['user:id,name', 'department:id,department_name'])
                ->withCount('sections') // إضافة عمود subjects_count
                ->latest()
                ->paginate(10); // Pagination للصفحة الرئيسية

            return view('dashboard.data-entry.instructor-section', compact('instructors')); // View جديد للعرض
        } catch (Exception $e) {
            Log::error('Error fetching instructor-section index: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load instructor assignments.');
        }
    }

    /**
     * Show the form for editing the assigned subjects for a specific instructor.
     */

    public function editAssignments(Instructor $instructor) // Route Model Binding للمدرس
    {
        try {
            // جلب كل المواد مع شعبها (مع تحميل العلاقات اللازمة للشعبة)
            $allSubjectsWithSections = Subject::with([
                'subjectCategory:id,subject_category_name', // فئة المادة
                // جلب شعب المادة مع تحميل مدرسينها
                'planSubjectEntries.sections.instructors:id,instructor_name' // لمعرفة إذا كانت الشعبة مأخوذة
            ])
                ->orderBy('subject_no')
                ->get();

            // جلب IDs الشعب المعينة لهذا المدرس المحدد
            $assignedSectionIds = $instructor->sections()->pluck('sections.id')->toArray();

            return view('dashboard.data-entry.instructor-section-edit', compact(
                'instructor',
                'allSubjectsWithSections',
                'assignedSectionIds'
            ));
        } catch (Exception $e) {
            Log::error('Error loading edit assignments view for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
            return redirect()->route('data-entry.instructor-section.index')->with('error', 'Could not load assignment editing page.');
        }
    }


    /**
     * Update the sections assigned to the specified instructor.
     */
    public function syncAssignments(Request $request, Instructor $instructor)
    {
        // 1. Validation (فقط section_ids)
        $validatedData = $request->validate([
            'section_ids' => 'nullable|array', // قد تكون فارغة إذا أردنا إزالة كل التعيينات
            'section_ids.*' => 'integer|exists:sections,id',
        ]);

        try {
            // 2. استخدام sync() لتحديث الارتباطات في جدول instructor_section
            $instructor->sections()->sync($validatedData['section_ids'] ?? []);

            // 3. Redirect إلى صفحة العرض الرئيسية مع رسالة نجاح
            return redirect()->route('data-entry.instructor-section.index')
                ->with('success', 'Section assignments updated successfully for ' . ($instructor->instructor_name ?? optional($instructor->user)->name));
        } catch (Exception $e) {
            Log::error('Error syncing sections for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
            // العودة لصفحة التعديل نفسها مع رسالة خطأ
            return redirect()->route('data-entry.instructor-section.edit', $instructor->id)
                ->with('error', 'Failed to update section assignments.');
        }
    }

    // public function editAssignments(Instructor $instructor) // استخدام Route Model Binding
    // {
    //     try {
    //         // جلب كل المواد المتاحة
    //         $allSubjects = Subject::with('department:id,department_name')
    //             ->orderBy('subject_no')
    //             ->get(['id', 'subject_no', 'subject_name', 'department_id']);

    //         // جلب IDs المواد المعينة لهذا المدرس
    //         $assignedSubjectIds = $instructor->subjects()->pluck('subjects.id')->toArray();

    //         // توجيه لـ view التعديل
    //         return view('dashboard.data-entry.instructor-subject-edit', compact(
    //             'instructor',
    //             'allSubjects',
    //             'assignedSubjectIds'
    //         ));
    //     } catch (Exception $e) {
    //         Log::error('Error loading edit assignments view for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
    //         return redirect()->route('data-entry.instructor-subject.index')->with('error', 'Could not load assignment editing page.');
    //     }
    // }

    // /**
    //  * Update the subjects assigned to the specified instructor.
    //  */
    // public function syncAssignments(Request $request, Instructor $instructor) // استخدام Route Model Binding
    // {
    //     // 1. Validation (فقط للمواد المختارة)
    //     $validatedData = $request->validate([
    //         // instructor_id يأتي من الروت
    //         'subject_ids' => 'nullable|array',
    //         'subject_ids.*' => 'integer|exists:subjects,id',
    //     ]);

    //     try {
    //         // 2. استخدام sync() لتحديث الارتباطات
    //         $instructor->subjects()->sync($validatedData['subject_ids'] ?? []);

    //         // 3. Redirect إلى صفحة العرض الرئيسية مع رسالة نجاح
    //         return redirect()->route('data-entry.instructor-subject.index')
    //             ->with('success', 'Subject assignments updated successfully for ' . ($instructor->instructor_name ?? optional($instructor->user)->name));
    //     } catch (Exception $e) {
    //         Log::error('Error syncing subjects for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
    //         // العودة لصفحة التعديل نفسها مع رسالة خطأ
    //         return redirect()->route('data-entry.instructor-subject.edit', $instructor->id)
    //             ->with('error', 'Failed to update subject assignments.');
    //     }
    // }

    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * Display a listing of instructors with their assigned subject count (API).
     */
    public function apiIndex(Request $request) // إضافة Request للـ pagination المستقبلي
    {
        try {
            $query = Instructor::with(['user:id,name', 'department:id,department_name'])
                ->withCount('subjects'); // حساب عدد المواد

            // (اختياري) فلترة بسيطة
            if ($request->has('department_id')) {
                $query->where('department_id', $request->department_id);
            }

            // --- جلب كل النتائج (بدون pagination حالياً) ---
            $instructors = $query->latest('id')->get();

            // --- كود الـ Pagination (معطل) ---
            /*
            $perPage = $request->query('per_page', 20);
            $instructorsPaginated = $query->latest('id')->paginate($perPage);
            return response()->json([
                'success' => true,
                'data' => $instructorsPaginated->items(),
                'pagination' => [ 'total' => $instructorsPaginated->total(), ... ]
            ], 200);
            */

            return response()->json(['success' => true, 'data' => $instructors], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching instructor assignments index: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }

    /**
     * Get all subjects, indicating which are assigned to a specific instructor (API).
     */
    // public function apiShowAssignments(Instructor $instructor) // استخدام Route Model Binding
    // {
    //     try {
    //         // جلب IDs المواد المعينة لهذا المدرس
    //         $assignedSubjectIds = $instructor->subjects()->pluck('subjects.id')->toArray();

    //         // جلب كل المواد المتاحة
    //         $allSubjects = Subject::orderBy('subject_no')
    //             ->get(['id', 'subject_no', 'subject_name']) // جلب الحقول الأساسية
    //             ->map(function ($subject) use ($assignedSubjectIds) {
    //                 // إضافة حقل is_assigned لكل مادة
    //                 $subject->is_assigned = in_array($subject->id, $assignedSubjectIds);
    //                 return $subject;
    //             });

    //         return response()->json([
    //             'success' => true,
    //             'data' => [
    //                 'instructor' => $instructor->load('user:id,name'), // تحميل بيانات المدرس الأساسية
    //                 'subjects' => $allSubjects // قائمة كل المواد مع حقل is_assigned
    //             ]
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error("API Error fetching assignment details for instructor ID {$instructor->id}: " . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Server Error'], 500);
    //     }
    // }


    // /**
    //  * Sync subjects for a specific instructor (API).
    //  */
    // public function apiSyncAssignments(Request $request, Instructor $instructor)
    // {
    //     $validatedData = $request->validate([
    //         'subject_ids' => 'present|array',
    //         'subject_ids.*' => 'integer|exists:subjects,id',
    //     ]);

    //     try {
    //         $instructor->subjects()->sync($validatedData['subject_ids'] ?? []);

    //         // إرجاع قائمة المواد المعينة المحدثة
    //         $updatedAssignedSubjects = $instructor->subjects()
    //             ->orderBy('subject_no')
    //             ->get(['subjects.id', 'subject_no', 'subject_name']);

    //         return response()->json([
    //             'success' => true,
    //             'message' => 'Subject assignments updated successfully.',
    //             'data' => $updatedAssignedSubjects
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error('API Error syncing subjects for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Failed to update assignments.'], 500);
    //     }
    // }
    public function apiShowAssignments(Instructor $instructor) // Route Model Binding للمدرس
    {
        try {
            // جلب IDs الشعب المعينة لهذا المدرس المحدد
            $assignedSectionIdsForCurrentInstructor = $instructor->sections()->pluck('sections.id')->toArray();

            // جلب كل المواد مع شعبها، مع تحديد حالة كل شعبة
            $allSubjectsWithSections = Subject::with([
                'subjectCategory:id,subject_category_name',
                // جلب كل شعب المادة، مع تحميل المدرسين المعينين لكل شعبة
                'planSubjectEntries.sections' => function ($query) {
                    $query->with('instructors:instructors.id,instructors.instructor_name,instructors.user_id') // جلب معلومات المدرس المعين
                        ->select('sections.*'); // تأكد من جلب كل أعمدة sections
                },
                // تحميل علاقة user للمدرسين المعينين للشعبة (إذا أردت اسم اليوزر)
                'planSubjectEntries.sections.instructors.user:id,name'
            ])
                ->orderBy('subject_no')
                ->get();

            // معالجة البيانات لإضافة حالة التعيين لكل شعبة
            $subjectsFormatted = $allSubjectsWithSections->map(function ($subject) use ($assignedSectionIdsForCurrentInstructor, $instructor) {
                $processedSections = collect();
                $allSectionsTakenByOthersForThisSubject = true;

                if ($subject->planSubjectEntries->isNotEmpty()) {
                    foreach ($subject->planSubjectEntries as $planSubEntry) {
                        foreach ($planSubEntry->sections as $section) {
                            $isAssignedToCurrent = in_array($section->id, $assignedSectionIdsForCurrentInstructor);
                            $assignedToOtherInstructor = false;
                            $otherInstructorName = null;

                            if (!$section->instructors->isEmpty()) { // إذا كانت الشعبة معينة
                                if (!$isAssignedToCurrent) { // ولم تكن معينة للمدرس الحالي
                                    $assignedToOtherInstructor = true;
                                    $firstOtherInstructor = $section->instructors->first(fn($instr) => $instr->id !== $instructor->id);
                                    if ($firstOtherInstructor) {
                                        $otherInstructorName = $firstOtherInstructor->instructor_name ?? optional($firstOtherInstructor->user)->name;
                                    }
                                }
                            }

                            // اعرض الشعبة فقط إذا كانت متاحة أو معينة للمدرس الحالي
                            if (!$assignedToOtherInstructor || $isAssignedToCurrent) {
                                $allSectionsTakenByOthersForThisSubject = false; // على الأقل شعبة واحدة يمكن التفاعل معها
                            }

                            // إضافة معلومات مفيدة للـ API
                            $processedSections->push([
                                'id' => $section->id,
                                'section_number' => $section->section_number,
                                'activity_type' => $section->activity_type,
                                'student_count' => $section->student_count,
                                'academic_year' => $section->academic_year,
                                'semester' => $section->semester,
                                'branch' => $section->branch,
                                'is_assigned_to_current_instructor' => $isAssignedToCurrent,
                                'is_assigned_to_other_instructor' => $assignedToOtherInstructor,
                                'other_instructor_name' => $otherInstructorName,
                            ]);
                        }
                    }
                }

                // لا ترجع المادة إذا كانت كل شعبها مأخوذة من قبل مدرسين آخرين
                if ($allSectionsTakenByOthersForThisSubject && !$processedSections->contains('is_assigned_to_current_instructor', true) && $processedSections->isNotEmpty()) {
                    return null; // أو يمكنك إرجاع المادة مع مصفوفة شعب فارغة إذا أردت إظهارها
                }


                return [
                    'id' => $subject->id,
                    'subject_no' => $subject->subject_no,
                    'subject_name' => $subject->subject_name,
                    'subject_category' => optional($subject->subjectCategory)->subject_category_name,
                    'sections' => $processedSections->sortBy(['activity_type', 'section_number'])->values(), // values() لإعادة الفهرسة
                ];
            })->filter()->values(); // filter() لإزالة المواد التي أرجعت null, ثم values() لإعادة الفهرسة

            return response()->json([
                'success' => true,
                'data' => [
                    'instructor' => [ // بيانات المدرس الحالي
                        'id' => $instructor->id,
                        'name' => $instructor->instructor_name ?? optional($instructor->user)->name,
                        'instructor_no' => $instructor->instructor_no
                    ],
                    'assignable_subjects' => $subjectsFormatted // قائمة المواد مع شعبها وحالة التعيين
                ]
            ], 200);
        } catch (Exception $e) {
            Log::error("API Error fetching assignments for instructor ID {$instructor->id}: " . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error: ' . $e->getMessage()], 500);
        }
    }

    /**
     * API: Sync sections for a specific instructor.
     * (نفس دالة apiSyncAssignments السابقة، تعمل على علاقة sections)
     */
    public function apiSyncAssignments(Request $request, Instructor $instructor)
    {
        $validatedData = $request->validate([
            'section_ids' => 'present|array',
            'section_ids.*' => 'integer|exists:sections,id',
        ]);

        try {
            $instructor->sections()->sync($validatedData['section_ids'] ?? []);

            // إرجاع قائمة المواد المعينة المحدثة للمدرس
            $updatedAssignedSections = $instructor->sections()
                ->with(['planSubject.subject:id,subject_no,subject_name']) // جلب معلومات المادة
                ->orderBy('activity_type')->orderBy('section_number')
                ->get(['sections.id', 'plan_subject_id', 'activity_type', 'section_number', 'student_count']); // تحديد حقول الشعبة

            return response()->json([
                'success' => true,
                'message' => 'Section assignments updated successfully.',
                'data' => $updatedAssignedSections
            ], 200);
        } catch (Exception $e) {
            Log::error('API Error syncing sections for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to update assignments.'], 500);
        }
    }

    /**
     * API: Get sections currently assigned to a specific instructor.
     * جلب الشعب المعينة حالياً لمدرس محدد عبر API
     */
    public function apiGetAssignedSections(Instructor $instructor)
    {
        try {
            $assignedSections = $instructor->sections() // استدعاء علاقة sections الجديدة
                ->with([ // تحميل معلومات إضافية لكل شعبة
                    'planSubject.subject:id,subject_no,subject_name',
                    'planSubject.plan:id,plan_no'
                ])
                ->orderBy('academic_year')->orderBy('semester')
                ->orderBy('activity_type')->orderBy('section_number')
                ->get([ // تحديد الحقول المطلوبة من جدول sections وجداول الربط
                    'sections.id',
                    'sections.plan_subject_id',
                    'sections.academic_year',
                    'sections.semester',
                    'sections.activity_type',
                    'sections.section_number',
                    'sections.student_count',
                    'sections.section_gender',
                    'sections.branch'
                ]);

            return response()->json([
                'success' => true,
                'data' => $assignedSections
            ], 200);
        } catch (Exception $e) {
            Log::error("API Error fetching assigned sections for instructor ID {$instructor->id}: " . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error: ' . $e->getMessage()], 500);
        }
    }

    /**
     * API: Get available sections that can be assigned.
     * جلب الشعب المتاحة (التي لم يتم تعيينها لأي مدرس بعد) عبر API.
     * يمكن فلترتها اختيارياً حسب plan_subject_id, academic_year, semester, branch.
     */
    public function apiGetAvailableSections(Request $request)
    {
        try {
            // جلب كل IDs الشعب التي تم تعيينها بالفعل لأي مدرس
            $assignedSectionIdsGlobally = DB::table('instructor_section')->pluck('section_id')->toArray();

            $query = Section::whereNotIn('id', $assignedSectionIdsGlobally) // استبعاد الشعب المعينة
                ->with([
                    'planSubject.subject:id,subject_no,subject_name',
                    'planSubject.plan:id,plan_no'
                ]);

            // (اختياري) فلاتر إضافية
            if ($request->filled('plan_subject_id')) {
                $query->where('plan_subject_id', $request->plan_subject_id);
            }
            if ($request->filled('academic_year')) {
                $query->where('academic_year', $request->academic_year);
            }
            if ($request->filled('semester')) {
                $query->where('semester', $request->semester);
            }
            if ($request->filled('branch')) {
                $query->where(function ($q) use ($request) {
                    is_null($request->branch) || $request->branch === '' || strtolower($request->branch) === 'none' ?
                        $q->whereNull('branch') :
                        $q->where('branch', $request->branch);
                });
            }
            if ($request->has('activity_type')) {
                $query->where('activity_type', $request->activity_type);
            }


            $availableSections = $query->orderBy('academic_year')->orderBy('semester')
                ->orderBy('activity_type')->orderBy('section_number')
                ->get([
                    'sections.id',
                    'sections.plan_subject_id',
                    'sections.academic_year',
                    'sections.semester',
                    'sections.activity_type',
                    'sections.section_number',
                    'sections.student_count',
                    'sections.section_gender',
                    'sections.branch'
                ]);

            return response()->json([
                'success' => true,
                'data' => $availableSections
            ], 200);
        } catch (Exception $e) {
            Log::error("API Error fetching available sections: " . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error: ' . $e->getMessage()], 500);
        }
    }


    /**
     * Get subjects assigned to a specific instructor (API).
     */
    // public function apiGetAssignedSubjects(Instructor $instructor) // استخدام Route Model Binding
    // {
    //     try {
    //         // جلب المواد المعينة لهذا المدرس فقط مع تحديد الحقول المطلوبة
    //         $assignedSubjects = $instructor->subjects() // استدعاء علاقة subjects
    //             ->orderBy('subject_no')
    //             ->get(['subjects.id', 'subject_no', 'subject_name']); // تحديد الحقول من جدول subjects

    //         return response()->json([
    //             'success' => true,
    //             'data' => $assignedSubjects
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error("API Error fetching assigned subjects for instructor ID {$instructor->id}: " . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Server Error'], 500);
    //     }
    // }

    // /**
    //  * Get available subjects for a specific instructor (API).
    //  */
    // public function apiGetAvailableSubjects(Instructor $instructor)
    // {
    //     try {
    //         // جلب IDs المواد المعينة بالفعل لهذا المدرس
    //         $assignedSubjectIds = $instructor->subjects()->pluck('subjects.id')->toArray();

    //         // جلب كل المواد التي *ليست* ضمن قائمة المواد المعينة
    //         $availableSubjects = Subject::whereNotIn('id', $assignedSubjectIds)
    //             ->orderBy('subject_no')
    //             ->get(['id', 'subject_no', 'subject_name']);

    //         return response()->json([
    //             'success' => true,
    //             'data' => $availableSubjects
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error("API Error fetching available subjects for instructor ID {$instructor->id}: " . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Server Error'], 500);
    //     }
    // }
}
--------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\InstructorLoadAssignmentController.php
<?php

namespace App\Http\Controllers\DataEntry;

use Exception;
use App\Models\Section;
use App\Models\Instructor;
use App\Models\PlanSubject;
use Illuminate\Support\Str;
use Illuminate\Http\Request;
use Illuminate\Validation\Rule;
use App\Models\PlanExpectedCount;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use App\Http\Controllers\Controller;
use App\Models\Department;
use App\Models\Role;
use App\Models\Subject;
use App\Models\User;
use Illuminate\Support\Facades\Hash;
use Maatwebsite\Excel\Facades\Excel;

class InstructorLoadAssignmentController extends Controller
{
    //
    // --- ثوابت للتقسيم (يمكن نقلها لإعدادات لاحقاً) ---
    // const DEFAULT_THEORY_CAPACITY_FALLBACK = 50;
    // const DEFAULT_PRACTICAL_CAPACITY_FALLBACK = 25;
    // const DEFAULT_THEORY_SECTION_CAPACITY_FALLBACK = 50;
    // const DEFAULT_PRACTICAL_SECTION_CAPACITY_FALLBACK = 25;
    // const MIN_STUDENTS_FOR_NEW_SECTION = 10;

    // --- عدادات لعملية الـ Import ---
    private $sectionsCreatedByGenerate = 0;
    private $assignmentsCreated = 0;
    private $assignmentsUpdated = 0; // إذا سمحنا بتحديث تعيين موجود
    private $assignmentsSkipped = 0;
    private $skippedDetails = [];
    private $processedInstructorsInFile = []; // لتتبع معالجة المدرسين داخل الملف

    private function resetCounters()
    {
        $this->sectionsCreatedByGenerate = 0;
        $this->assignmentsCreated = 0;
        $this->assignmentsUpdated = 0;
        $this->assignmentsSkipped = 0;
        $this->skippedDetails = [];
        $this->processedInstructorsInFile = [];
    }
    // --- ثوابت للتقسيم ---
    const DEFAULT_THEORY_SECTION_CAPACITY_FALLBACK = 50;
    const DEFAULT_PRACTICAL_SECTION_CAPACITY_FALLBACK = 25;
    const MIN_STUDENTS_FOR_NEW_SECTION = 10;

    // --- عدادات لعملية توليد الشعب الناقصة ---
    // private $sectionsCreatedByGenerate = 0;
    private $subjectsProcessedForGeneration = 0;
    private $contextsProcessedForGeneration = 0;

    private function resetCountersForGenerate()
    {
        $this->sectionsCreatedByGenerate = 0;
        $this->subjectsProcessedForGeneration = 0;
        $this->contextsProcessedForGeneration = 0;
    }

    /**
     * Generate missing sections for all plan expected counts
     * where subjects are defined in the plan but no sections exist yet for that specific context.
     */
    public function generateMissingSections(Request $request) // أضفنا Request إذا أردت فلاتر لاحقاً
    {
        Log::info("User triggered 'Generate Missing Sections' process.");
        $this->resetCountersForGenerate();

        // يمكنك إضافة فلاتر هنا للسنة الأكاديمية أو الفصل إذا أردت
        // مثال: $academicYearFilter = $request->input('filter_year');
        // $semesterFilter = $request->input('filter_semester');

        $expectedCountsQuery = PlanExpectedCount::with('plan');

        // if ($academicYearFilter) {
        //     $expectedCountsQuery->where('academic_year', $academicYearFilter);
        // }
        // if ($semesterFilter) {
        //     // نفترض أن semester في expectedCount هو فصل الخطة
        //     $expectedCountsQuery->where('plan_semester', $semesterFilter);
        // }

        $expectedCounts = $expectedCountsQuery->get();

        if ($expectedCounts->isEmpty()) {
            return redirect()->route('data-entry.instructor-section.index') // افترض أن هذا هو اسم روت صفحة الأزرار
                ->with('info', 'No expected student counts found to process.');
        }

        DB::beginTransaction();
        try {
            foreach ($expectedCounts as $ec) {
                $this->contextsProcessedForGeneration++;
                Log::info("Processing ExpectedCount ID: {$ec->id} for Plan: {$ec->plan->plan_no}, Level: {$ec->plan_level}, PlanSem: {$ec->plan_semester}, Year: {$ec->academic_year}, Branch: {$ec->branch}");

                $planSubjects = PlanSubject::with('subject.subjectCategory')
                    ->where('plan_id', $ec->plan_id)
                    ->where('plan_level', $ec->plan_level)
                    ->where('plan_semester', $ec->plan_semester) // مواد هذا الفصل من الخطة
                    ->get();

                if ($planSubjects->isEmpty()) {
                    Log::info("No subjects in plan for EC ID {$ec->id}.");
                    continue;
                }

                foreach ($planSubjects as $ps) {
                    // التحقق إذا كانت هناك شعب منشأة بالفعل لهذه المادة (ps) في هذا السياق (ec)
                    $existingSectionsCount = Section::where('plan_subject_id', $ps->id)
                        ->where('academic_year', $ec->academic_year)
                        ->where('semester', $ec->plan_semester) // **فصل الشعبة يجب أن يطابق فصل الخطة هنا**
                        ->where(fn($q) => is_null($ec->branch) ? $q->whereNull('branch') : $q->where('branch', $ec->branch))
                        ->count();

                    if ($existingSectionsCount > 0) {
                        Log::info("Sections already exist for PS ID {$ps->id} (Subject: {$ps->subject->subject_no}) in context of EC ID {$ec->id}. Skipping automatic generation for this subject.");
                        continue; // تخطى هذه المادة إذا كانت شعبها موجودة بالفعل
                    }

                    // إذا لم تكن هناك شعب، قم بتوليدها
                    $this->generateSectionsLogicForSingleSubject($ps, $ec, true); // true لتحديث العداد
                    $this->subjectsProcessedForGeneration++;
                }
            }
            DB::commit();

            $message = "Missing sections generation process completed. ";
            if ($this->sectionsCreatedByGenerate > 0) {
                $message .= "{$this->sectionsCreatedByGenerate} new sections were created across {$this->subjectsProcessedForGeneration} subjects in {$this->contextsProcessedForGeneration} contexts. ";
            } elseif ($this->contextsProcessedForGeneration > 0) {
                $message .= "No new sections needed to be created (all relevant sections might already exist or no subjects to process in {$this->contextsProcessedForGeneration} contexts). ";
            } else {
                $message .= "No relevant contexts found to process for section generation.";
            }
            return redirect()->route('data-entry.instructor-section.index')->with('success', $message);
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('Error during generateMissingSections: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return redirect()->route('data-entry.instructor-section.index')->with('error', 'Failed to generate missing sections: ' . $e->getMessage());
        }
    }

    /**
     * Core logic to generate sections for a SINGLE PlanSubject within an ExpectedCount context.
     * (This function will now only create sections if they don't exist for a specific subject-context)
     */
    private function generateSectionsLogicForSingleSubject(PlanSubject $planSubject, PlanExpectedCount $expectedCount, bool $updateGlobalCounter = false)
    {
        Log::info("Logic: Generating sections for PS ID: {$planSubject->id} (Subject: {$planSubject->subject->subject_no}) within EC ID: {$expectedCount->id}");

        $subject = $planSubject->subject()->with('subjectCategory')->first();
        if (!$subject || !$subject->subjectCategory) {
            Log::error("Logic: Subject or its category is missing for PS ID: {$planSubject->id}. Cannot create sections.");
            // لا ترمي Exception هنا، فقط سجل الخطأ وتجاوز هذه المادة
            return;
        }

        $totalExpected = $expectedCount->male_count + $expectedCount->female_count;
        if ($totalExpected <= 0) {
            Log::info("Logic: Total expected is zero for PS ID {$planSubject->id}. No sections created.");
            return;
        }

        // لا نحتاج لحذف الشعب القديمة هنا لأن generateMissingSections تتحقق من عدم وجودها
        // وإذا كانت تُستدعى من زر "Regenerate" خاص بمادة، فذلك الزر سيقوم بالحذف أولاً

        $subjectCategoryName = strtolower($subject->subjectCategory->subject_category_name);
        $nextSectionNumberForThisSubject = 1; // عداد الشعب لهذه المادة (نظري ثم عملي)

        // --- 1. الجزء النظري ---
        if (($subject->theoretical_hours ?? 0) > 0) {
            // الشرط الآن أبسط: إذا كانت المادة نظرية أو مشتركة
            if (Str::contains($subjectCategoryName, ['theory', 'نظري']) || Str::contains($subjectCategoryName, ['combined', 'مشترك', 'نظري وعملي'])) {
                $capacity = ($subject->capacity_theoretical_section ?? 0) > 0 ? $subject->capacity_theoretical_section : self::DEFAULT_THEORY_SECTION_CAPACITY_FALLBACK;
                if ($capacity <= 0) $capacity = self::DEFAULT_THEORY_SECTION_CAPACITY_FALLBACK;

                $numSections = ceil($totalExpected / $capacity);
                if ($numSections > 1) { /* ... (نفس منطق MIN_STUDENTS_FOR_NEW_SECTION) ... */
                }
                if ($numSections == 0 && $totalExpected > 0) $numSections = 1;

                if ($numSections > 0) {
                    $baseStudents = floor($totalExpected / $numSections);
                    $remainder = $totalExpected % $numSections;
                    for ($i = 0; $i < $numSections; $i++) {
                        $count = $baseStudents + ($remainder > 0 ? 1 : 0);
                        if ($remainder > 0) $remainder--;
                        if ($count > 0) {
                            Section::create([
                                'plan_subject_id' => $planSubject->id,
                                'academic_year' => $expectedCount->academic_year,
                                'semester' => $expectedCount->plan_semester, // فصل الشعبة = فصل الخطة
                                'activity_type' => 'Theory',
                                'section_number' => $nextSectionNumberForThisSubject++,
                                'student_count' => $count,
                                'section_gender' => 'Mixed',
                                'branch' => $expectedCount->branch,
                            ]);
                            if ($updateGlobalCounter) $this->sectionsCreatedByGenerate++;
                        }
                    }
                    Log::info("Logic: Created {$numSections} Theory Sections for PS ID {$planSubject->id}");
                }
            }
        }

        // --- 2. الجزء العملي ---
        if (($subject->practical_hours ?? 0) > 0) {
            // الشرط الآن أبسط: إذا كانت المادة عملية أو مشتركة
            if (Str::contains($subjectCategoryName, ['practical', 'عملي']) || Str::contains($subjectCategoryName, ['combined', 'مشترك', 'نظري وعملي'])) {
                $capacity = ($subject->capacity_practical_section ?? 0) > 0 ? $subject->capacity_practical_section : self::DEFAULT_PRACTICAL_SECTION_CAPACITY_FALLBACK;
                if ($capacity <= 0) $capacity = self::DEFAULT_PRACTICAL_SECTION_CAPACITY_FALLBACK;

                if ($totalExpected > 0 && $capacity > 0) {
                    $numSections = ceil($totalExpected / $capacity);
                    if ($numSections > 1) { /* ... (نفس منطق MIN_STUDENTS_FOR_NEW_SECTION) ... */
                    }
                    if ($numSections == 0 && $totalExpected > 0) $numSections = 1;

                    if ($numSections > 0) {
                        $baseStudents = floor($totalExpected / $numSections);
                        $remainder = $totalExpected % $numSections;
                        for ($i = 0; $i < $numSections; $i++) {
                            $count = $baseStudents + ($remainder > 0 ? 1 : 0);
                            if ($remainder > 0) $remainder--;
                            if ($count > 0) {
                                Section::create([
                                    'plan_subject_id' => $planSubject->id,
                                    'academic_year' => $expectedCount->academic_year,
                                    'semester' => $expectedCount->plan_semester, // فصل الشعبة
                                    'activity_type' => 'Practical',
                                    'section_number' => $nextSectionNumberForThisSubject++,
                                    'student_count' => $count,
                                    'section_gender' => 'Mixed',
                                    'branch' => $expectedCount->branch,
                                ]);
                                if ($updateGlobalCounter) $this->sectionsCreatedByGenerate++;
                            }
                        }
                        Log::info("Logic: Created {$numSections} Practical Sections for PS ID {$planSubject->id}");
                    }
                }
            }
        }
        if ($nextSectionNumberForThisSubject == 1) {
            Log::warning("Logic: No sections (Theory or Practical) actually created for Subject ID {$subject->id} (PS ID {$planSubject->id}). Check hours, capacities, or category '{$subjectCategoryName}'.");
        }
    }

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////

    /**
     * Handle the import of instructor loads from an Excel file.
     */
    // public function importInstructorLoadsExcel(Request $request)
    // {
    //     $request->validate([
    //         'instructor_loads_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
    //         'target_semester' => ['required', 'integer', Rule::in([1, 2, 3])], // الفصل الدراسي المستهدف
    //         // (اختياري) يمكن إضافة target_academic_year إذا أردت أن يكون الملف مرناً لعدة سنوات
    //     ]);

    //     $this->resetCounters();
    //     $targetSemester = $request->input('target_semester');
    //     // $targetAcademicYear = $request->input('target_academic_year', date('Y')); // افترض السنة الحالية إذا لم تحدد

    //     Log::info("Starting Excel import for instructor loads for Semester: {$targetSemester}");

    //     // الخطوة الأولى: حذف التعيينات القديمة لهذا الفصل
    //     try {
    //         // نفترض أن جدول instructor_section يربط instructor_id بـ section_id
    //         // ونفترض أن جدول sections يحتوي على semester و academic_year
    //         DB::table('instructor_section')
    //             ->whereIn('section_id', function ($query) use ($targetSemester) {
    //                 $query->select('id')->from('sections')
    //                     ->where('semester', $targetSemester);
    //                 //   ->where('academic_year', $targetAcademicYear); // إذا أضفت فلتر السنة
    //             })
    //             ->delete();
    //         Log::info("Cleared old instructor assignments for Semester: {$targetSemester}");
    //     } catch (Exception $e) {
    //         Log::error("Failed to clear old assignments: " . $e->getMessage());
    //         return redirect()->route('data-entry.instructor-subject.index')
    //             ->with('error', 'Failed to clear old assignments before import: ' . $e->getMessage());
    //     }


    //     try {
    //         $rows = Excel::toArray(new \stdClass(), $request->file('instructor_loads_excel_file'))[0];
    //         if (count($rows) <= 1) { /* ... رسالة خطأ ... */
    //         }
    //         $header = array_map('strtolower', array_map('trim', array_shift($rows)));

    //         // البحث عن مواقع الأعمدة
    //         $instructorNameCol = $this->getColumnIndex($header, ['اسم المدرس', 'instructor_name', 'instructor']);
    //         $subjectNameCol = $this->getColumnIndex($header, ['اسم المساق', 'subject_name', 'subject']);
    //         $specializationLevelCol = $this->getColumnIndex($header, ['التخصص والمستوى', 'specialization_level', 'level_spec']);
    //         $theorySectionsCountCol = $this->getColumnIndex($header, ['عدد الشعب نظري', 'theory_sections']);
    //         $practicalSectionsCountCol = $this->getColumnIndex($header, ['عدد الشعب عملي', 'practical_sections']);
    //         $branchCol = $this->getColumnIndex($header, ['الفرع', 'branch']);

    //         if (is_null($instructorNameCol) || is_null($subjectNameCol) || is_null($specializationLevelCol)) {
    //             $missing = []; /* ... تحديد الأعمدة المفقودة ... */
    //             return redirect()->route('data-entry.instructor-subject.index')->with('error', 'Excel missing columns: ' . implode(', ', $missing));
    //         }

    //         $currentRowNumber = 1;
    //         $currentInstructorFromFile = null;
    //         $currentInstructorModel = null;

    //         foreach ($rows as $rowIndex => $row) {
    //             $currentRowNumber++;
    //             $rowData = [];
    //             foreach ($header as $index => $colName) {
    //                 $rowData[$colName] = $row[$index] ?? null;
    //             }

    //             if (count(array_filter($row)) == 0) {
    //                 $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (empty).";
    //                 $this->assignmentsSkipped++;
    //                 continue;
    //             }

    //             // معالجة اسم المدرس (قد يكون مدمجاً)
    //             $instructorNameInput = trim($rowData[$header[$instructorNameCol]] ?? null);
    //             if (!empty($instructorNameInput)) {
    //                 $currentInstructorFromFile = $instructorNameInput;
    //                 $currentInstructorModel = Instructor::where('instructor_name', 'LIKE', "%{$currentInstructorFromFile}%")
    //                     ->orWhere('instructor_no', $currentInstructorFromFile)->first(); // أو البحث بالرقم
    //                 if (!$currentInstructorModel) {
    //                     $this->skippedDetails[] = "Row {$currentRowNumber}: Instructor '{$currentInstructorFromFile}' not found. Skipping subsequent rows for this instructor until a new name is found.";
    //                     $currentInstructorFromFile = null; // لإيقاف معالجة أسطر هذا المدرس
    //                 }
    //             }
    //             if (!$currentInstructorModel) {
    //                 if (!empty($instructorNameInput)) $this->assignmentsSkipped++;
    //                 continue;
    //             } // إذا لم يتم العثور على مدرس وبدأنا بسطر جديد له

    //             // تجاهل أسطر "المجموع" أو الفواصل
    //             if (strtolower(trim($rowData[$header[$subjectNameCol]] ?? '')) === 'المجموع') {
    //                 $currentInstructorFromFile = null;
    //                 $currentInstructorModel = null;
    //                 continue;
    //             }

    //             $subjectIdentifier = trim($rowData[$header[$subjectNameCol]] ?? null);
    //             $specLevelInput = trim($rowData[$header[$specializationLevelCol]] ?? null);
    //             $numTheoryToAssign = isset($theorySectionsCountCol) ? (int)($rowData[$header[$theorySectionsCountCol]] ?? 0) : 0;
    //             $numPracticalToAssign = isset($practicalSectionsCountCol) ? (int)($rowData[$header[$practicalSectionsCountCol]] ?? 0) : 0;
    //             $branchFromFile = isset($branchCol) ? trim($rowData[$header[$branchCol]] ?? 'Default') : 'Default'; // Default to 'Default' or handle null
    //             if (strtolower($branchFromFile) === 'دمج' || strtolower($branchFromFile) === 'default' || empty($branchFromFile)) {
    //                 $branchFromFile = null; // التعامل مع "دمج" كفرع افتراضي (لا فرع)
    //             }


    //             if (empty($subjectIdentifier) || empty($specLevelInput)) {
    //                 $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (missing subject or spec/level for instructor {$currentInstructorModel->instructor_name}).";
    //                 $this->assignmentsSkipped++;
    //                 continue;
    //             }

    //             // استخراج رمز التخصص والمستوى
    //             preg_match('/([a-zA-Z]+)(\d+)/', strtoupper(str_replace(' ', '', $specLevelInput)), $matches);
    //             $planCodeFromFile = $matches[1] ?? null;
    //             $levelFromFile = $matches[2] ?? null;

    //             if (!$planCodeFromFile || !$levelFromFile) {
    //                 $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (Could not parse specialization/level '{$specLevelInput}').";
    //                 $this->assignmentsSkipped++;
    //                 continue;
    //             }

    //             $subjectModel = $this->findSubject($subjectIdentifier);
    //             if (!$subjectModel) {
    //                 $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (Subject '{$subjectIdentifier}' not found).";
    //                 $this->assignmentsSkipped++;
    //                 continue;
    //             }

    //             // البحث عن PlanSubject
    //             $planSubject = PlanSubject::where('subject_id', $subjectModel->id)
    //                 ->where('plan_level', $levelFromFile)
    //                 ->whereHas('plan', fn($q) => $q->where('plan_no', 'LIKE', "%{$planCodeFromFile}%")
    //                     ->orWhere('plan_name', 'LIKE', "%{$planCodeFromFile}%")) // بحث مرن عن الخطة
    //                 ->where('plan_semester', $targetSemester) // ** استخدام الفصل المستهدف من المودال **
    //                 ->first();

    //             if (!$planSubject) {
    //                 $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (Subject '{$subjectModel->subject_no}' not found in Plan like '{$planCodeFromFile}' Level {$levelFromFile} Semester {$targetSemester}).";
    //                 $this->assignmentsSkipped++;
    //                 continue;
    //             }

    //             // السنة الأكاديمية للشعب (نفترض أنها السنة الحالية أو سنة محددة للعملية)
    //             // يجب أن تكون الشعب منشأة لهذه السنة والفصل
    //             $targetAcademicYear = PlanExpectedCount::where('plan_id', $planSubject->plan_id)
    //                 ->where('plan_level', $planSubject->plan_level)
    //                 ->where('plan_semester', $planSubject->plan_semester)
    //                 ->max('academic_year'); // أو طريقة أخرى لتحديد السنة الأكاديمية للشعب
    //             if (!$targetAcademicYear) {
    //                 $this->skippedDetails[] = "Row {$currentRowNumber}: Skipped (Could not determine academic year for sections of PS ID {$planSubject->id}).";
    //                 $this->assignmentsSkipped++;
    //                 continue;
    //             }


    //             // تعيين الشعب النظرية
    //             if ($numTheoryToAssign > 0) {
    //                 $availableTheorySections = Section::where('plan_subject_id', $planSubject->id)
    //                     ->where('academic_year', $targetAcademicYear)->where('semester', $targetSemester)
    //                     ->where('activity_type', 'Theory')->where('branch', $branchFromFile)
    //                     ->whereDoesntHave('instructors') // التي لم تُعطَ لمدرس بعد
    //                     ->orderBy('section_number')->take($numTheoryToAssign)->pluck('id');

    //                 if ($availableTheorySections->count() < $numTheoryToAssign) {
    //                     $this->skippedDetails[] = "Row {$currentRowNumber}: Not enough available Theory sections for '{$subjectModel->subject_no}' for instructor '{$currentInstructorModel->instructor_name}'. Needed: {$numTheoryToAssign}, Found: {$availableTheorySections->count()}";
    //                 }
    //                 foreach ($availableTheorySections as $sectionId) {
    //                     // التحقق من النصاب قبل الإضافة
    //                     // ... (منطق التحقق من النصاب) ...
    //                     $currentInstructorModel->sections()->attach($sectionId); // استخدام جدول instructor_section
    //                     $this->assignmentsCreated++;
    //                 }
    //             }
    //             // تعيين الشعب العملية (بنفس الطريقة)
    //             if ($numPracticalToAssign > 0) { /* ... */
    //             }
    //         } // نهاية حلقة الصفوف

    //         DB::commit();
    //         // بناء رسالة النجاح
    //         $messages = []; /* ... */
    //         return redirect()->route('data-entry.instructor-subject.index')->with('success', implode(' ', $messages))->with('skipped_details', $this->skippedDetails);
    //     } catch (Exception $e) {
    //         DB::rollBack();
    //         Log::error('Instructor Loads Excel Import Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
    //         return redirect()->route('data-entry.instructor-subject.index')->with('error', 'Error during import: ' . $e->getMessage())->with('skipped_details', $this->skippedDetails);
    //     }
    // }
    // ... (generateSectionsLogicForSingleSubject من الرد السابق) ...

    // --- عدادات لعملية الـ Import لتوزيع الأحمال ---
    private $assignmentsCreatedCount = 0;
    private $assignmentsSkippedCount = 0;
    private $assignmentSkippedDetails = []; // لتخزين تفاصيل الأسطر المتجاهلة في توزيع الأحمال
    private $processedInstructorsForLoad = []; // لتتبع معالجة المدرسين داخل ملف توزيع الأحمال

    private function resetCountersForLoadAssignment()
    {
        $this->assignmentsCreatedCount = 0;
        $this->assignmentsSkippedCount = 0;
        $this->assignmentSkippedDetails = [];
        $this->processedInstructorsForLoad = [];
    }

    /**
     * Handle the import of instructor loads from an Excel file.
     */
    // public function importInstructorLoadsExcel(Request $request)
    // {
    //     $request->validate([
    //         'instructor_loads_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
    //         'target_semester' => ['required', 'integer', Rule::in([1, 2, 3])],
    //         // يمكنك إضافة target_academic_year هنا إذا أردت أن يكون الملف مرناً لسنوات مختلفة
    //         // 'target_academic_year' => 'required|integer|digits:4',
    //     ]);

    //     $this->resetCountersForLoadAssignment(); // *** إعادة تعيين العدادات الخاصة بهذه العملية ***
    //     $targetSemester = (int) $request->input('target_semester');
    //     // افترض أننا نعمل على السنة الأكاديمية "الحالية" أو الأكثر شيوعاً إذا لم يتم تحديدها
    //     // هذا الجزء يحتاج لتحديد أدق: هل ملف الإكسل دائماً للسنة الحالية؟
    //     // $targetAcademicYear = $request->input('target_academic_year', AcademicYear::getCurrent()->year); // مثال
    //     // للتبسيط الآن، سنبحث عن شعب تطابق الفصل بغض النظر عن السنة، ولكن هذا قد يسبب مشاكل
    //     // الأفضل هو تحديد السنة الأكاديمية أيضاً

    //     Log::info("Starting Excel import for instructor loads for Target Semester: {$targetSemester}");

    //     DB::beginTransaction();
    //     try {
    //         // الخطوة الأولى: حذف التعيينات القديمة لهذا الفصل (ولسنة محددة إذا تم تحديدها)
    //         // هذا يفترض أن جدول instructor_section يربط instructor_id بـ section_id
    //         $affectedRows = DB::table('instructor_section')
    //             ->whereIn('section_id', function ($query) use ($targetSemester) {
    //                 $query->select('id')->from('sections')
    //                     ->where('semester', $targetSemester);
    //                 //   ->where('academic_year', $targetAcademicYear); // إذا أضفت فلتر السنة
    //             })
    //             ->delete();
    //         Log::info("Cleared {$affectedRows} old instructor assignments for Target Semester: {$targetSemester}.");

    //         $rows = Excel::toArray(new \stdClass(), $request->file('instructor_loads_excel_file'))[0];
    //         if (count($rows) <= 1) {
    //             throw new Exception('Uploaded Excel file is empty or contains only a header row.');
    //         }

    //         $header = array_map('strtolower', array_map('trim', array_shift($rows)));
    //         // تحديد مواقع الأعمدة بناءً على الأسماء المحتملة
    //         $colMap = [
    //             'instructor' => $this->getColumnIndex($header, ['اسم المدرس', 'instructor_name', 'instructor', 'المدرس']),
    //             'subject' => $this->getColumnIndex($header, ['اسم المساق', 'subject_name', 'subject', 'المساق']),
    //             'spec_level' => $this->getColumnIndex($header, ['التخصص والمستوى', 'specialization_level', 'level_spec', 'التخصص']),
    //             'theory_count' => $this->getColumnIndex($header, ['عدد الشعب نظري', 'theory_sections', 'نظري']),
    //             'practical_count' => $this->getColumnIndex($header, ['عدد الشعب عملي', 'practical_sections', 'عملي']),
    //             'branch' => $this->getColumnIndex($header, ['الفرع', 'branch']),
    //         ];


    //         if (is_null($colMap['instructor']) || is_null($colMap['subject']) || is_null($colMap['spec_level'])) {
    //             throw new Exception("Excel file is missing critical columns (Instructor, Subject, or Specialization/Level). Please check header row.");
    //         }

    //         $currentRowNumber = 1; // للعد من الصف الثاني بعد العناوين

    //         $currentInstructorModel = null;
    //         $currentInstructorTotalHours = 0; // لتتبع نصاب المدرس الحالي في الملف
    //         // dd([
    //         //     'instructor' => $this->getColumnIndex($header, ['اسم المدرس', 'instructor_name', 'instructor', 'المدرس']),
    //         //     'subject' => $this->getColumnIndex($header, ['اسم المساق', 'subject_name', 'subject', 'المساق']),
    //         //     'spec_level' => $this->getColumnIndex($header, ['التخصص والمستوى', 'specialization_level', 'level_spec', 'التخصص']),
    //         //     'theory_count' => $this->getColumnIndex($header, ['عدد الشعب نظري', 'theory_sections', 'نظري']),
    //         //     'practical_count' => $this->getColumnIndex($header, ['عدد الشعب عملي', 'practical_sections', 'عملي']),
    //         //     'branch' => $this->getColumnIndex($header, ['الفرع', 'branch']),
    //         // ]);

    //         foreach ($rows as $rowIndex => $row) {
    //             $currentRowNumber++;
    //             $rowData = [];
    //             foreach ($header as $index => $colName) {
    //                 $rowData[$colName] = $row[$index] ?? null;
    //             }

    //             if (count(array_filter($row, fn($cell) => !is_null($cell) && $cell !== '')) == 0) {
    //                 $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (empty row).";
    //                 $this->assignmentsSkippedCount++;
    //                 continue;
    //             }

    //             // معالجة اسم المدرس (قد يكون مدمجاً)
    //             $instructorNameInput = trim($rowData[$header[$colMap['instructor']]] ?? null);
    //             if (!empty($instructorNameInput)) {
    //                 $currentInstructorModel = $this->findInstructor($instructorNameInput);
    //                 $currentInstructorTotalHours = 0; // إعادة تعيين الساعات للمدرس الجديد
    //                 $this->processedInstructorsForLoad[$currentInstructorModel->id ?? 'unknown'] = true; // لتتبع المدرسين المعالجين
    //                 if (!$currentInstructorModel) {
    //                     $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Instructor '{$instructorNameInput}' not found. Skipping subsequent rows for this instructor.";
    //                     $currentInstructorFromFile = null; // إيقاف معالجة هذا المدرس
    //                     $this->assignmentsSkippedCount++;
    //                     continue; // انتقل للصف التالي إذا كان اسم المدرس جديداً وغير موجود
    //                 }
    //             }
    //             if (!$currentInstructorModel) { // إذا كان اسم المدرس فارغاً وما زلنا لا نملك مدرس حالي
    //                 if (!empty(trim(implode("", $row)))) { // إذا لم يكن الصف فارغاً تماماً
    //                     $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (instructor name missing or not found previously).";
    //                     $this->assignmentsSkippedCount++;
    //                 }
    //                 continue;
    //             }

    //             if (strtolower(trim($rowData[$header[$colMap['subject']]] ?? '')) === 'المجموع') {
    //                 $currentInstructorModel = null;
    //                 continue;
    //             } // تجاهل أسطر المجموع

    //             $subjectIdentifier = trim($rowData[$header[$colMap['subject']]] ?? null);
    //             $specLevelInput = trim($rowData[$header[$colMap['spec_level']]] ?? null);
    //             $numTheoryToAssign = isset($colMap['theory_count']) ? (int)($rowData[$header[$colMap['theory_count']]] ?? 0) : 0;
    //             $numPracticalToAssign = isset($colMap['practical_count']) ? (int)($rowData[$header[$colMap['practical_count']]] ?? 0) : 0;
    //             $branchFromFile = isset($colMap['branch']) ? trim($rowData[$header[$colMap['branch']]] ?? 'Default') : 'Default';
    //             if (strtolower($branchFromFile) === 'دمج' || strtolower($branchFromFile) === 'default' || empty($branchFromFile)) $branchFromFile = null;

    //             if (empty($subjectIdentifier) || empty($specLevelInput) || ($numTheoryToAssign == 0 && $numPracticalToAssign == 0)) {
    //                 $this->assignmentSkippedDetails[] = "Row {$currentRowNumber} (Inst:{$currentInstructorModel->id}): Skipped (missing subject, spec/level, or section counts).";
    //                 $this->assignmentsSkippedCount++;
    //                 continue;
    //             }

    //             preg_match('/([a-zA-Z\s]+)(\d*)/u', preg_replace('/\s+/', '', $specLevelInput), $matches);
    //             $planCodeFromFile = trim($matches[1] ?? null);
    //             $levelFromFile = trim($matches[2] ?? null);


    //             if (!$planCodeFromFile || !$levelFromFile) {
    //                 $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (Could not parse '{$specLevelInput}' to SpecCode and Level).";
    //                 $this->assignmentsSkippedCount++;
    //                 continue;
    //             }

    //             $subjectModel = $this->findSubject($subjectIdentifier);
    //             if (!$subjectModel) {
    //                 $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (Subject '{$subjectIdentifier}' not found).";
    //                 $this->assignmentsSkippedCount++;
    //                 continue;
    //             }

    //             // البحث عن PlanSubject
    //             $planSubject = PlanSubject::where('subject_id', $subjectModel->id)
    //                 ->where('plan_level', $levelFromFile)
    //                 ->whereHas('plan', fn($q) => $q->where(DB::raw('REPLACE(LOWER(plan_no), " ", "")'), 'LIKE', "%" . strtolower(str_replace(' ', '', $planCodeFromFile)) . "%")
    //                     ->orWhere(DB::raw('REPLACE(LOWER(plan_name), " ", "")'), 'LIKE', "%" . strtolower(str_replace(' ', '', $planCodeFromFile)) . "%"))
    //                 ->where('plan_semester', $targetSemester) // الفصل المستهدف من المودال
    //                 ->first();

    //             if (!$planSubject) {
    //                 $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (Subject '{$subjectModel->subject_no}' not found in Plan like '{$planCodeFromFile}' Level {$levelFromFile} for Target Semester {$targetSemester}).";
    //                 $this->assignmentsSkippedCount++;
    //                 continue;
    //             }

    //             // تحديد السنة الأكاديمية للشعب التي سنبحث عنها (الأحدث أو المحددة)
    //             // هذا الجزء قد يحتاج لتحديد السنة الأكاديمية بشكل أدق
    //             $academicYearForSections = PlanExpectedCount::where('plan_id', $planSubject->plan_id)
    //                 ->where('plan_level', $planSubject->plan_level)
    //                 ->where('plan_semester', $planSubject->plan_semester) // فصل الخطة
    //                 ->max('academic_year'); // افترض أحدث سنة

    //             if (!$academicYearForSections) {
    //                 $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (No academic year context found for sections of PS ID {$planSubject->id}).";
    //                 $this->assignmentsSkippedCount++;
    //                 continue;
    //             }

    //             // تعيين الشعب النظرية
    //             if ($numTheoryToAssign > 0) {
    //                 $assignedCount = $this->assignSectionsToInstructor($currentInstructorModel, $planSubject, $academicYearForSections, $targetSemester, 'Theory', $numTheoryToAssign, $branchFromFile, $currentInstructorTotalHours, $currentRowNumber);
    //                 $currentInstructorTotalHours += ($assignedCount * ($subjectModel->theoretical_hours ?? 0)); // تقدير للساعات
    //             }
    //             // تعيين الشعب العملية
    //             if ($numPracticalToAssign > 0) {
    //                 $assignedCount = $this->assignSectionsToInstructor($currentInstructorModel, $planSubject, $academicYearForSections, $targetSemester, 'Practical', $numPracticalToAssign, $branchFromFile, $currentInstructorTotalHours, $currentRowNumber);
    //                 $currentInstructorTotalHours += ($assignedCount * ($subjectModel->practical_hours ?? 0)); // تقدير للساعات
    //             }
    //         } // نهاية حلقة الصفوف

    //         DB::commit();
    //         $messages = [];
    //         if ($this->assignmentsCreated > 0) $messages[] = "{$this->assignmentsCreated} section assignments created/updated.";
    //         if ($this->assignmentsSkippedCount > 0) $messages[] = "{$this->assignmentsSkippedCount} assignment rows were skipped.";
    //         if (empty($messages)) {
    //             return redirect()->route('data-entry.instructor-subject.index')->with('info', 'Excel processed. No new assignments or all rows skipped.');
    //         }
    //         return redirect()->route('data-entry.instructor-subject.index')->with('success', implode(' ', $messages))->with('skipped_details', $this->assignmentSkippedDetails);
    //     } catch (Exception $e) {
    //         DB::rollBack();
    //         Log::error('Instructor Loads Excel Import Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
    //         return redirect()->route('data-entry.instructor-subject.index')->with('error', 'Error during import: ' . $e->getMessage())->with('skipped_details', $this->assignmentSkippedDetails);
    //     }
    // }

    /**
     * Handle the import of instructor loads from an Excel file.
     * (هذه الدالة هي التي يتم استدعاؤها من الروت)
     */
    public function importInstructorLoadsExcel(Request $request)
    {
        $request->validate([
            'instructor_loads_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
            'target_semester' => ['required', 'integer', Rule::in([1, 2, 3])], // الفصل الدراسي المستهدف
            // 'target_academic_year' => 'required|integer|digits:4', // إذا أردت تحديد السنة
        ]);

        $this->resetCountersForLoadAssignment();
        $targetSemester = (int) $request->input('target_semester');
        // افترض أننا نعمل على السنة الأكاديمية "الحالية" أو الأكثر شيوعاً
        // $targetAcademicYear = $request->input('target_academic_year', date('Y')); // مثال

        Log::info("Starting Excel import for instructor loads for Target Semester: {$targetSemester}.");

        DB::beginTransaction();
        try {
            // 1. حذف التعيينات القديمة لهذا الفصل (ولسنة محددة إذا تم تحديدها)
            $sectionsToClearQuery = Section::where('semester', $targetSemester);
            // if (isset($targetAcademicYear)) {
            //     $sectionsToClearQuery->where('academic_year', $targetAcademicYear);
            // }
            $sectionIdsToClear = $sectionsToClearQuery->pluck('id');

            if ($sectionIdsToClear->isNotEmpty()) {
                DB::table('instructor_section')->whereIn('section_id', $sectionIdsToClear)->delete();
                Log::info("Cleared old instructor assignments for Target Semester: {$targetSemester}.");
            } else {
                Log::info("No sections found for Target Semester: {$targetSemester} to clear assignments from.");
            }


            // 2. قراءة ملف الإكسل
            $rows = Excel::toArray(new \stdClass(), $request->file('instructor_loads_excel_file'))[0]; // أول شيت
            if (count($rows) <= 1) { // تحقق من وجود بيانات بعد العناوين
                throw new Exception('Uploaded Excel file is empty or contains only a header row.');
            }

            $header = array_map('strtolower', array_map('trim', array_shift($rows))); // العناوين

            $sectionIdsToClear = $sectionsToClearQuery->pluck('id');

            // تحديد مواقع الأعمدة المتوقعة
            $colMap = [
                'instructor' => $this->getColumnIndex($header, ['اسم المدرس', 'instructor_name', 'instructor']),
                'subject' => $this->getColumnIndex($header, ['اسم المساق', 'subject_name', 'subject']),
                'spec_level' => $this->getColumnIndex($header, ['التخصص والمستوى', 'specialization_level']),
                'theory_sections_count' => $this->getColumnIndex($header, ['عدد الشعب نظري', 'theory_sections']),
                'practical_sections_count' => $this->getColumnIndex($header, ['عدد الشعب عملي', 'practical_sections']),
                'branch' => $this->getColumnIndex($header, ['الفرع', 'branch']),
            ];

            if (is_null($colMap['instructor']) || is_null($colMap['subject']) || is_null($colMap['spec_level'])) {
                $missing = [];
                if (is_null($colMap['instructor'])) $missing[] = "'اسم المدرس'";
                if (is_null($colMap['subject'])) $missing[] = "'اسم المساق'";
                if (is_null($colMap['spec_level'])) $missing[] = "'التخصص والمستوى'";
                throw new Exception("Excel file is missing critical columns: " . implode(', ', $missing) . ". Please check header row.");
            }

            $currentRowNumber = 1; // يبدأ من 2 فعلياً لأننا أزلنا العناوين
            $currentInstructorModel = null;
            $currentInstructorTotalHours = 0;

            foreach ($rows as $rowIndex => $rowArray) {
                $currentRowNumber++; // رقم الصف الفعلي في الإكسل

                // تحويل الصف لمصفوفة بأسماء العناوين الأصلية
                $rowData = [];
                foreach ($header as $index => $colName) {
                    $rowData[$colName] = $rowArray[$index] ?? null;
                }
                // تجاهل الصفوف الفارغة تماماً
                if (count(array_filter($rowArray, fn($cell) => !is_null($cell) && $cell !== '')) == 0) {
                    $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (empty row).";
                    $this->assignmentsSkippedCount++;
                    continue;
                }

                // 1. معالجة اسم المدرس (الخلايا المدمجة)
                $instructorNameInput = trim($rowData[$header[$colMap['instructor']]] ?? null);
                if (!empty($instructorNameInput)) {
                    $currentInstructorModel = $this->findInstructor($instructorNameInput);
                    $currentInstructorTotalHours = 0; // إعادة تعيين عند تغير المدرس
                    if (!$currentInstructorModel) {
                        $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Instructor '{$instructorNameInput}' not found. Skipping this and subsequent related rows until a new instructor name is found.";
                        $currentInstructorModel = null; // لمنع معالجة أسطر هذا المدرس
                        $this->assignmentsSkippedCount++;
                        continue;
                    }
                }
                if (!$currentInstructorModel) { // إذا كان اسم المدرس فارغاً وما زلنا لا نملك مدرس حالي
                    $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (instructor name missing for this subject assignment).";
                    $this->assignmentsSkippedCount++;
                    continue;
                }

                // تجاهل أسطر "المجموع" أو الفواصل إذا كانت تعتمد على عمود فارغ للمادة
                $subjectIdentifier = trim($rowData[$header[$colMap['subject']]] ?? null);
                if (empty($subjectIdentifier) || strtolower($subjectIdentifier) === 'المجموع') {
                    $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (assumed to be a separator or total row).";
                    $this->assignmentsSkippedCount++;
                    // لا نغير $currentInstructorModel هنا، قد يكون هناك المزيد من المواد لنفس المدرس
                    continue;
                }


                $specLevelInput = trim($rowData[$header[$colMap['spec_level']]] ?? null);
                $numTheoryToAssign = isset($colMap['theory_sections_count']) ? (int)($rowData[$header[$colMap['theory_sections_count']]] ?? 0) : 0;
                $numPracticalToAssign = isset($colMap['practical_sections_count']) ? (int)($rowData[$header[$colMap['practical_sections_count']]] ?? 0) : 0;
                $branchFromFile = isset($colMap['branch']) ? trim($rowData[$header[$colMap['branch']]] ?? null) : null;
                if (is_null($branchFromFile) || strtolower($branchFromFile) === 'دمج' || strtolower($branchFromFile) === 'default' || $branchFromFile === '') {
                    $branchFromFile = null;
                }

                if (empty($specLevelInput) || ($numTheoryToAssign == 0 && $numPracticalToAssign == 0)) {
                    $this->assignmentSkippedDetails[] = "Row {$currentRowNumber} (Inst:{$currentInstructorModel->instructor_no}, Subj:{$subjectIdentifier}): Skipped (missing specialization/level or no sections to assign).";
                    $this->assignmentsSkippedCount++;
                    continue;
                }

                // استخراج رمز الخطة والمستوى
                preg_match('/([a-zA-Z]+)(\d*)/u', preg_replace('/\s+/', '', $specLevelInput), $matches);
                $planCodeFromFile = !empty($matches[1]) ? trim($matches[1]) : null;
                $levelFromFile = !empty($matches[2]) ? trim($matches[2]) : null;

                if (!$planCodeFromFile || !$levelFromFile) {
                    $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (Could not parse '{$specLevelInput}' to Plan Code and Level).";
                    $this->assignmentsSkippedCount++;
                    continue;
                }

                $subjectModel = $this->findSubject($subjectIdentifier);
                if (!$subjectModel) {
                    $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (Subject '{$subjectIdentifier}' not found).";
                    $this->assignmentsSkippedCount++;
                    continue;
                }

                // البحث عن PlanSubject (المادة في الخطة والمستوى والفصل المستهدف)
                $planSubject = PlanSubject::where('subject_id', $subjectModel->id)
                    ->where('plan_level', $levelFromFile)
                    ->whereHas('plan', fn($q) => $q->where(DB::raw('REPLACE(LOWER(plan_no), " ", "")'), 'LIKE', "%" . strtolower(str_replace(' ', '', $planCodeFromFile)) . "%"))
                    ->where('plan_semester', $targetSemester) // الفصل المستهدف من المودال
                    ->first();

                if (!$planSubject) {
                    $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (Subject '{$subjectModel->subject_no}' not found in Plan like '{$planCodeFromFile}', Level {$levelFromFile} for Target Semester {$targetSemester}).";
                    $this->assignmentsSkippedCount++;
                    continue;
                }

                // dd(['PlanExpectedCount' =>PlanExpectedCount::where('plan_id', $planSubject->plan_id)
                //     ->where('plan_level', $planSubject->plan_level)
                //     ->where('plan_semester', $planSubject->plan_semester) // فصل الخطة
                //     ->where(fn($q) => is_null($branchFromFile) ? $q->whereNull('branch') : $q->where('branch', $branchFromFile))
                //     ->max('academic_year'),
                //     'plan_id' => $planSubject->plan_id,
                //     'plan_level' => $planSubject->plan_level,
                //     'plan_semester' => $planSubject->plan_semester,
                // ]);
                // تحديد السنة الأكاديمية للشعب التي نبحث عنها (الأحدث لهذا السياق)
                $academicYearForSections = PlanExpectedCount::where('plan_id', $planSubject->plan_id)
                    ->where('plan_level', $planSubject->plan_level)
                    ->where('plan_semester', $planSubject->plan_semester) // فصل الخطة
                    ->where(fn($q) => is_null($branchFromFile) ? $q->whereNull('branch') : $q->where('branch', $branchFromFile))
                    ->max('academic_year');

                if (!$academicYearForSections) {
                    $this->assignmentSkippedDetails[] = "Row {$currentRowNumber}: Skipped (Could not determine active Academic Year for sections of PS ID {$planSubject->id} and branch '{$branchFromFile}').";
                    $this->assignmentsSkippedCount++;
                    continue;
                }

                // dd([
                //     '$targetSemester' => $targetSemester,
                //     // '$sectionsToClearQuery' => $sectionsToClearQuery,
                //     // '$sectionIdsToClear' => $sectionIdsToClear,
                //     '$rows' => $rows,
                //     '$colMap' => $colMap,
                //     '$colMapinstructor' => $colMap['instructor'],
                //     '$rowData' => $rowData,
                //     '$instructorNameInput' => $instructorNameInput,
                //     '$currentInstructorModel' => $currentInstructorModel,
                //     '$subjectIdentifier' => $subjectIdentifier,
                //     '$specLevelInput' => $specLevelInput,
                //     '$numTheoryToAssign' => $numTheoryToAssign,
                //     '$numPracticalToAssign' => $numPracticalToAssign,
                //     '$branchFromFile' => $branchFromFile,
                //     '$planCodeFromFile' => $planCodeFromFile,
                //     '$levelFromFile' => $levelFromFile,
                //     '$colMapsubject' => $colMap['subject'],
                //     '$subjectModel' => $subjectModel,
                //     '$planSubject' => $planSubject,
                //     '$academicYearForSections' => $academicYearForSections,
                // ]);

                // تعيين الشعب النظرية
                if ($numTheoryToAssign > 0) {
                    $assignedTheory = $this->assignSectionsToInstructor($currentInstructorModel, $planSubject, $academicYearForSections, $targetSemester, 'Theory', $numTheoryToAssign, $branchFromFile, $currentInstructorTotalHours, $currentRowNumber);
                    $currentInstructorTotalHours += ($assignedTheory * ($subjectModel->theoretical_hours ?? 0));
                }
                // تعيين الشعب العملية
                if ($numPracticalToAssign > 0) {
                    $assignedPractical = $this->assignSectionsToInstructor($currentInstructorModel, $planSubject, $academicYearForSections, $targetSemester, 'Practical', $numPracticalToAssign, $branchFromFile, $currentInstructorTotalHours, $currentRowNumber);
                    $currentInstructorTotalHours += ($assignedPractical * ($subjectModel->practical_hours ?? 0));
                }
            } // نهاية حلقة الصفوف

            DB::commit();
            // بناء رسالة النجاح
            $messages = [];
            if ($this->assignmentsCreatedCount > 0) $messages[] = "{$this->assignmentsCreatedCount} section assignments created/updated.";
            if ($this->assignmentsSkippedCount > 0) $messages[] = "{$this->assignmentsSkippedCount} assignment rows were skipped (see details below if any).";
            if (empty($messages)) {
                return redirect()->route('data-entry.instructor-section.index')->with('info', 'Excel processed. No new assignments made or all rows skipped.');
            } // افترض أن هذا هو اسم الروت لصفحة الأزرار
            return redirect()->route('data-entry.instructor-section.index')->with('success', implode(' ', $messages))->with('skipped_details', $this->assignmentSkippedDetails);
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('Instructor Loads Excel Import Failed: ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return redirect()->route('data-entry.instructor-section.index')->with('error', 'Error during import: ' . $e->getMessage())->with('skipped_details', $this->assignmentSkippedDetails);
        }
    }

    // --- الدوال المساعدة (getColumnIndex, findInstructor, findSubject, normalizeArabicStringForSearch, assignSectionsToInstructor) ---
    // --- يجب نسخها بالكامل من الردود السابقة ووضعها هنا ---


    private function getColumnIndex(array $headerArray, array $possibleNames): ?int
    {
        // تطبيع الأسماء المحتملة التي نبحث عنها
        $normalizedPossibleNames = array_map(function ($name) {
            return strtolower(str_replace([' ', '_', '-'], '', trim($name)));
        }, $possibleNames);

        // المرور على العناوين الفعلية من الملف
        foreach ($headerArray as $index => $headerName) {
            // تطبيع العنوان الحالي من الملف
            $normalizedHeaderName = strtolower(str_replace([' ', '_', '-'], '', trim($headerName)));
            // التحقق إذا كان العنوان الحالي موجوداً في قائمة الأسماء المحتملة
            if (in_array($normalizedHeaderName, $normalizedPossibleNames)) {
                return $index; // إرجاع الموقع (index) للعمود
            }
        }
        return null; // لم يتم العثور على العمود
    }

    private function findInstructor($identifier)
    {
        if (empty(trim($identifier))) {
            return null;
        }

        // 1. محاولة البحث بالرقم الوظيفي (instructor_no) أولاً
        // نفترض أن الرقم الوظيفي قد يحتوي على حروف وأرقام
        $instructor = Instructor::where('instructor_no', trim($identifier))->first();
        if ($instructor) {
            return $instructor;
        }

        // 2. إذا لم يتم العثور عليه بالرقم، حاول البحث بالاسم
        // (مع تطبيع الاسم وتجاهل الدرجة العلمية المحتملة بين قوسين)
        $nameToSearch = trim($identifier);
        if (preg_match('/\(.+\)/u', $nameToSearch, $matches)) {
            $nameToSearch = trim(str_replace($matches[0], '', $nameToSearch));
        }
        $normalizedName = $this->normalizeArabicStringForSearch($nameToSearch);


        // البحث في instructor_name
        $instructor = Instructor::whereRaw('REPLACE(LOWER(instructor_name), "", "") LIKE ?', ["%{$normalizedName}%"])->first();
        // dd([
        //     'identifier' => $identifier,
        //     'instructor' => $instructor,
        //     'nameToSearch' => $nameToSearch,
        //     'normalizedName' => $normalizedName,
        // ]);
        if ($instructor) {
            return $instructor;
        }
        // dd('KKKK');

        // 3. (اختياري) البحث في اسم المستخدم المرتبط (user.name) إذا لم يتم العثور عليه في instructor_name
        // هذا يتطلب أن تكون علاقة user محملة أو تقوم بـ join
        // للتبسيط الآن، سنكتفي بالبحث في instructor_no و instructor_name
        /*
        $instructor = Instructor::whereHas('user', function ($query) use ($normalizedName) {
            $query->whereRaw('REPLACE(LOWER(name), " ", "") LIKE ?', ["%{$normalizedName}%"]);
        })->first();
        if ($instructor) {
            return $instructor;
        }
        */

        return null; // لم يتم العثور على المدرس
    }

    /**
     * Normalize Arabic string for searching (remove Hamza, Al, spaces, tolower).
     */
    private function normalizeArabicStringForSearch($string): string
    {
        if (is_null($string)) return '';
        // $string = str_replace(['أ', 'إ', 'آ'], 'ا', $string); // توحيد الهمزات إلى ألف
        // $string = str_replace('ى', 'ي', $string); // ألف مقصورة إلى ياء
        // $string = str_replace('ة', 'ه', $string); // تاء مربوطة إلى هاء
        // $string = preg_replace('/^ال/u', '', $string); // إزالة "ال" التعريف
        // $string = strtolower(preg_replace('/\s+/u', '', trim($string))); // إزالة كل الفراغات وتحويل لحروف صغيرة
        $string = strtolower($string); // إزالة كل الفراغات وتحويل لحروف صغيرة
        return $string;
    }

    /**
     * Find department by ID, Name, or Code.
     */
    private function findDepartment($identifier)
    {
        if (empty(trim($identifier))) return null;
        if (is_numeric($identifier)) return Department::find($identifier);

        $normalizedIdentifier = $this->normalizeArabicStringForSearch($identifier);
        // البحث بالاسم المطبع أو بالكود المطبع
        return Department::where(DB::raw('REPLACE(LOWER(department_name), " ", "")'), 'LIKE', "%{$normalizedIdentifier}%")
            ->orWhere(DB::raw('REPLACE(LOWER(department_no), " ", "")'), 'LIKE', "%{$normalizedIdentifier}%")
            ->first();
    }

    /**
     * Find subject by ID, No, or Name.
     */
    private function findSubject($identifier)
    {
        if (empty(trim($identifier))) return null;
        if (is_numeric($identifier)) return Subject::find($identifier);

        $normalizedIdentifier = $this->normalizeArabicStringForSearch($identifier);
        // البحث برقم المادة (الكود)
        $subject = Subject::where(DB::raw('REPLACE(LOWER(subject_no), "", "")'), $normalizedIdentifier)->first();
        if ($subject) return $subject;

        // البحث باسم المادة
        return Subject::where(DB::raw('REPLACE(LOWER(subject_name), "", "")'), 'LIKE', "%{$normalizedIdentifier}%")->first();
    }

    /**
     * Helper function to generate a unique email.
     */
    private function generateUniqueEmail($baseName, $domain = '@ptc.edu', $instructorNo = null, $counter = 0): string
    {
        $prefix = Str::slug($baseName, '');
        if (empty($prefix) && $instructorNo) {
            $prefix = 'inst' . preg_replace('/[^A-Za-z0-9]/', '', $instructorNo);
        } elseif (empty($prefix) && empty($instructorNo)) {
            $prefix = 'instructor' . Str::random(4);
        }

        $uniquePart = '';
        if ($counter > 0) {
            $uniquePart = str_pad($counter, 2, '0', STR_PAD_LEFT);
        } elseif ($instructorNo && $counter == 0) { // استخدام الرقم الوظيفي في المحاولة الأولى إذا كان العداد صفر
            $uniquePart = preg_replace('/[^A-Za-z0-9]/', '', $instructorNo);
        }

        $emailTry = $prefix . $uniquePart . $domain;
        if (strlen($emailTry) > 255 - strlen($domain) - 1) { // ضمان ألا يتجاوز الطول
            $prefix = substr($prefix, 0, 60); // تقصير
            $emailTry = $prefix . $uniquePart . $domain;
        }

        if (User::where('email', $emailTry)->exists()) {
            return $this->generateUniqueEmail($baseName, $domain, $instructorNo, $counter + 1); // زيادة العداد في المحاولة التالية
        }
        return $emailTry;
    }

    /**
     * Helper function to create a user for an instructor.
     */
    private function createUserForInstructor($name, $email, $roleName = 'instructor', $password = 'DefaultPass123!'): User // كلمة مرور افتراضية أقوى
    {
        $role = Role::where('name', $roleName)->first();
        if (!$role) {
            $role = Role::firstOrCreate(['name' => $roleName], ['display_name' => Str::studly($roleName)]);
        }
        return User::create([
            'name' => $name,
            'email' => $email,
            'password' => Hash::make($password),
            'role_id' => $role->id,
            'email_verified_at' => now(),
        ]);
    }

    /**
     * Helper to assign a number of available sections of a specific type to an instructor.
     */
    private function assignSectionsToInstructor(Instructor $instructor, PlanSubject $planSubject, $academicYear, $semester, $activityType, $numToAssign, $branch, &$currentTotalHours, $excelRowNumber)
    {
        $assignedCount = 0;
        if ($numToAssign <= 0) return $assignedCount;

        // جلب الشعب المتاحة (غير المعينة)
        $availableSections = Section::where('plan_subject_id', $planSubject->id)
            ->where('academic_year', $academicYear)->where('semester', $semester)
            ->where('activity_type', $activityType)
            ->where(fn($q) => is_null($branch) ? $q->whereNull('branch') : $q->where('branch', $branch))
            ->whereDoesntHave('instructors') // التي ليس لها مدرس معين في instructor_section
            ->orderBy('section_number')->take($numToAssign)->get();

        if ($availableSections->count() < $numToAssign) {
            $this->assignmentSkippedDetails[] = "Row {$excelRowNumber}: Not enough available {$activityType} sections for '{$planSubject->subject->subject_no}'. Needed: {$numToAssign}, Found: {$availableSections->count()} for Instructor '{$instructor->instructor_name}'.";
            // لا نوقف العملية، نحاول تعيين المتاح
        }

        foreach ($availableSections as $section) {
            // تقدير ساعات الشعبة (نحتاج عدد الساعات الأسبوعية للمادة)
            $sectionHours = ($activityType == 'Theory') ? ($planSubject->subject->theoretical_hours ?? 0) : ($planSubject->subject->practical_hours ?? 0);

            if (($currentTotalHours + $sectionHours) > ($instructor->max_weekly_hours ?? 18)) { // 18 كساعات افتراضية قصوى
                $this->assignmentSkippedDetails[] = "Row {$excelRowNumber}: Assignment of {$activityType} Section #{$section->section_number} for '{$planSubject->subject->subject_no}' to '{$instructor->instructor_name}' skipped (Exceeds max weekly hours: {$currentTotalHours} + {$sectionHours} > {$instructor->max_weekly_hours}).";
                continue; // تخطى هذه الشعبة
            }

            try {
                // استخدام attach إذا كانت العلاقة many-to-many معرفة في Instructor model
                // $instructor->sections()->attach($section->id);

                // أو إذا كان هناك عمود instructor_id في جدول sections
                // $section->update(['instructor_id' => $instructor->id]);

                // بما أننا استخدمنا جدول وسيط instructor_section، فالأفضل استخدام attach
                // تأكد أن علاقة sections() معرفة في موديل Instructor
                if (method_exists($instructor, 'sections')) {
                    $instructor->sections()->attach($section->id);
                    $currentTotalHours += $sectionHours;
                    $this->assignmentsCreatedCount++;
                    $assignedCount++;
                } else {
                    Log::error("Instructor model is missing 'sections' relationship for attach/sync.");
                    $this->assignmentSkippedDetails[] = "Row {$excelRowNumber}: System error - Instructor model missing 'sections' relationship.";
                }
            } catch (Exception $e) {
                Log::error("Failed to assign Section ID {$section->id} to Instructor ID {$instructor->id}: " . $e->getMessage());
                $this->assignmentSkippedDetails[] = "Row {$excelRowNumber}: Error assigning {$activityType} Section #{$section->section_number} for '{$planSubject->subject->subject_no}' to '{$instructor->instructor_name}'.";
            }
        }
        return $assignedCount;
    }
}
---------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\InstructorSubjectsController.php
<?php

namespace App\Http\Controllers\DataEntry;

use Exception;
use App\Models\Section;
use App\Models\Subject;
use App\Models\Instructor;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use App\Http\Controllers\Controller;
use Maatwebsite\Excel\Facades\Excel;

class InstructorSubjectsController extends Controller
{
    // =============================================
    //            Web Controller Methods
    // =============================================

    /**
     * Display a listing of instructors and their assigned subjects.
     */
    public function index()
    {
        try {
            // جلب المدرسين مع تحميل العلاقات اللازمة بكفاءة
            $instructors = Instructor::with([
                'user:id,name',
                'department:id,department_name',
                'subjects:subjects.id,subject_no,subject_name' // جلب المواد المعينة مع الحقول الأساسية
            ])
                ->withCount('subjects') // إضافة عمود subjects_count
                ->latest('id')
                ->paginate(15); // استخدام Pagination

            return view('dashboard.data-entry.instructor-subjects', compact('instructors'));
        } catch (Exception $e) {
            Log::error('Error fetching instructor-subject index: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load instructor-subject assignments page.');
        }
    }

    /**
     * Show the form for editing the assigned subjects for a specific instructor.
     */
    public function edit(Instructor $instructor)
    {
        try {
            // تحميل معلومات المدرس الأساسية
            $instructor->load('user:id,name', 'department:id,department_name');

            // جلب كل المواد المتاحة في النظام، مع تحميل قسم كل مادة
            $allSubjects = Subject::with('department:id,department_name')
                ->orderBy('subject_no')
                ->get(['id', 'subject_no', 'subject_name', 'department_id']);

            // جلب IDs المواد المعينة حالياً لهذا المدرس (الطريقة الأكثر أماناً)
            $assignedSubjectIds = $instructor->subjects()->pluck('subjects.id')->toArray();

            return view('dashboard.data-entry.instructor-subject-edit', compact(
                'instructor',
                'allSubjects',
                'assignedSubjectIds'
            ));
        } catch (Exception $e) {
            Log::error('Error loading edit assignments view for instructor ID ' . $instructor->id . ': ' . $e->getMessage() . ' at ' . $e->getFile() . ':' . $e->getLine());
            return redirect()->route('data-entry.instructor-subjects.index')->with('error', 'Could not load the assignment editing page. A server error occurred.');
        }
    }

    /**
     * Update the subjects assigned to the specified instructor.
     */
    public function sync(Request $request, Instructor $instructor)
    {
        $validatedData = $request->validate([
            'subject_ids' => 'nullable|array',
            'subject_ids.*' => 'integer|exists:subjects,id',
        ], [
            'subject_ids.array' => 'The selected subjects must be in a valid format.',
            'subject_ids.*.exists' => 'One or more of the selected subjects do not exist.',
        ]);

        try {
            // استخدام sync() لتحديث الارتباطات في الجدول الوسيط
            $instructor->subjects()->sync($validatedData['subject_ids'] ?? []);

            $instructorName = $instructor->instructor_name ?? optional($instructor->user)->name ?? "ID: {$instructor->id}";
            return redirect()->route('data-entry.instructor-subjects.index')
                ->with('success', 'Subject assignments updated successfully for ' . $instructorName);
        } catch (Exception $e) {
            Log::error('Error syncing subjects for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
            return redirect()->route('data-entry.instructor-subjects.edit', $instructor->id)
                ->with('error', 'Failed to update subject assignments due to a server error.');
        }
    }

    /**
     * Handle the import of instructor-subject assignments from an Excel file.
     */
    public function importExcel(Request $request)
    {
        $request->validate([
            'assignments_excel_file' => 'required|file|mimes:xlsx,xls,csv|max:5120',
        ]);

        // تعريف العدادات
        $createdCount = 0;
        $alreadyExistedCount = 0;
        $skippedDetails = [];
        $processedInstructors = []; // لتجنب معالجة نفس المدرس مرتين

        try {
            $rows = Excel::toArray(new \stdClass(), $request->file('assignments_excel_file'))[0];
            if (count($rows) <= 1) {
                return redirect()->back()->with('error', 'The uploaded Excel file is empty or contains only a header row.');
            }

            $header = array_map('strtolower', array_map('trim', array_shift($rows)));
            $instructorCol = $this->getColumnIndex($header, ['instructor_name', 'instructor_id', 'instructorid']);
            $subjectCol = $this->getColumnIndex($header, ['subject_no', 'subject_id', 'subjectid', 'subjectname', 'subject_name']);

            if (is_null($instructorCol) || is_null($subjectCol)) {
                return redirect()->back()->with('error', 'Excel file is missing required columns: instructor identifier and subject identifier.');
            }

            $currentRowNumber = 1;

            DB::beginTransaction(); // بدء Transaction

            foreach ($rows as $row) {
                $currentRowNumber++;
                if (count(array_filter($row)) == 0) {
                    continue;
                } // تجاهل الصفوف الفارغة

                $instructorIdentifier = trim($row[$instructorCol] ?? null);
                $subjectsString = trim($row[$subjectCol] ?? null);

                if (empty($instructorIdentifier) || empty($subjectsString)) {
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped (missing instructor or subject information).";
                    continue;
                }

                // 1. إيجاد المدرس
                $instructor = $this->findInstructor($instructorIdentifier);
                if (!$instructor) {
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped (Instructor '{$instructorIdentifier}' not found).";
                    continue;
                }

                // تجاهل إذا تم معالجة المدرس من قبل في نفس الملف
                if (in_array($instructor->id, $processedInstructors)) {
                    $skippedDetails[] = "Row {$currentRowNumber}: Skipped (Instructor '{$instructor->instructor_name}' is duplicated in the file, only first entry is processed).";
                    continue;
                }
                $processedInstructors[] = $instructor->id;


                // 2. معالجة المواد
                $subjectIdentifiers = array_map('trim', explode(',', $subjectsString)); // تقسيم المواد
                $subjectIdsToAssign = [];

                foreach ($subjectIdentifiers as $subjectIdentifier) {
                    if (empty($subjectIdentifier)) continue;

                    $subject = $this->findSubject($subjectIdentifier);
                    if ($subject) {
                        $subjectIdsToAssign[] = $subject->id;
                    } else {
                        $skippedDetails[] = "Row {$currentRowNumber}: Subject '{$subjectIdentifier}' for instructor '{$instructor->instructor_name}' not found and was skipped.";
                    }
                }

                // 3. تحديث التعيينات (إضافة الجديد فقط)
                if (!empty($subjectIdsToAssign)) {
                    // جلب IDs المواد المعينة حالياً للمدرس
                    $currentlyAssignedIds = $instructor->subjects()->pluck('subjects.id')->toArray();

                    // حساب IDs المواد الجديدة فقط التي سيتم إضافتها
                    $newIdsToAdd = array_diff($subjectIdsToAssign, $currentlyAssignedIds);

                    if (!empty($newIdsToAdd)) {
                        // استخدام attach() لإضافة الجديد فقط دون التأثير على القديم
                        $instructor->subjects()->attach($newIdsToAdd);
                        $createdCount += count($newIdsToAdd);
                    }

                    // حساب عدد المواد التي كانت موجودة بالفعل
                    $alreadyExistedCount += count(array_intersect($subjectIdsToAssign, $currentlyAssignedIds));
                }
            }

            DB::commit(); // تأكيد كل التغييرات إذا لم تحدث أخطاء

            // بناء رسالة النجاح
            $messages = [];
            if ($createdCount > 0) $messages[] = "{$createdCount} new assignments were added.";
            if ($alreadyExistedCount > 0) $messages[] = "{$alreadyExistedCount} assignments already existed and were unchanged.";
            if (!empty($skippedDetails)) $messages[] = count($skippedDetails) . " entries were skipped.";

            if (empty($messages)) {
                return redirect()->route('data-entry.instructor-subjects.index')->with('info', 'Excel file processed. No changes were made.');
            } else {
                return redirect()->route('data-entry.instructor-subjects.index')
                    ->with('success', implode(' ', $messages))
                    ->with('skipped_details', $skippedDetails);
            }
        } catch (Exception $e) {
            DB::rollBack(); // التراجع عن أي تغييرات في حال حدوث خطأ
            Log::error('Instructor-Subject Excel Import Failed: ' . $e->getMessage());
            return redirect()->route('data-entry.instructor-subjects.index')
                ->with('error', 'An error occurred during Excel import: ' . $e->getMessage());
        }
    }

    private function getColumnIndex(array $header, array $possibleNames): ?int
    {
        // تنظيف وتوحيد الأسماء المحتملة (حروف صغيرة وبدون فراغات)
        $normalizedPossibleNames = array_map(fn($name) => strtolower(str_replace([' ', '_'], '', $name)), $possibleNames);

        // تنظيف العناوين الفعلية من الملف
        $normalizedHeader = array_map(fn($h) => strtolower(str_replace([' ', '_'], '', $h)), $header);

        foreach ($normalizedPossibleNames as $name) {
            $index = array_search($name, $normalizedHeader);
            if ($index !== false) {
                return $index; // وجدنا تطابقاً، أرجع الفهرس
            }
        }

        return null; // لم يتم العثور على أي اسم مطابق
    }

    private function findInstructor($identifier)
    {
        if (is_numeric($identifier)) {
            return Instructor::find($identifier);
        }
        // البحث بالاسم (في instructor_name أو user->name)
        return Instructor::where('instructor_name', 'like', "%{$identifier}%")
            ->orWhereHas('user', fn($q) => $q->where('name', 'like', "%{$identifier}%"))
            ->first();
    }

    private function findSubject($identifier)
    {
        // إذا كان المعرّف فارغاً، لا تبحث
        if (empty($identifier)) {
            return null;
        }

        // 1. البحث بالـ ID إذا كان المعرّف رقمياً
        if (is_numeric($identifier)) {
            $subject = Subject::find($identifier);
            if ($subject) {
                return $subject;
            }
        }

        // 2. البحث برقم المادة (subject_no) - تجاهل حالة الأحرف والفراغات
        $normalizedIdentifier = strtolower(trim($identifier));
        $subject = Subject::whereRaw('LOWER(REPLACE(subject_no, " ", "")) = ?', [$normalizedIdentifier])->first();
        if ($subject) {
            return $subject;
        }

        // 3. البحث باسم المادة (subject_name) - تجاهل حالة الأحرف، الفراغات، والهمزات
        $normalizedArabicIdentifier = $this->normalizeArabicString($identifier);
        // البحث بتطابق شبه تام (بعد إزالة الفراغات)
        $subject = Subject::whereRaw('REPLACE(LOWER(subject_name), " ", "") = ?', [$normalizedArabicIdentifier])->first();
        if ($subject) {
            return $subject;
        }
        // إذا فشل، جرب بحثاً أوسع قليلاً (قد يكون أقل دقة إذا كانت الأسماء متشابهة)
        return Subject::whereRaw('LOWER(subject_name) LIKE ?', ["%{$normalizedArabicIdentifier}%"])->first();
    }

    /**

     **3. `normalizeArabicString($string)`**

     *   **وظيفتها:** تأخذ نصاً (غالباً باللغة العربية) وتقوم بتنظيفه لتوحيد صيغته قبل مقارنته مع ما هو موجود في قاعدة البيانات. تزيل الفراغات الزائدة وتوحد أشكال الهمزة.

     * Helper function to normalize a string for comparison.
     * It converts to lowercase, trims whitespace, and normalizes Arabic Alif variants.
     *
     * @param string $string The input string.
     * @return string The normalized string.
     */

    private function normalizeArabicString($string): string
    {
        // 1. إزالة الفراغات من البداية والنهاية وتحويل لحروف صغيرة
        $string = strtolower(trim($string));

        // 2. توحيد أشكال حرف الألف (أ, إ, آ) إلى ألف بدون همزة (ا)
        // هذا يجعل البحث عن "اساسيات" يجد "أساسيات" والعكس
        $string = str_replace(['أ', 'إ', 'آ'], 'ا', $string);

        // 3. (اختياري) توحيد الياء والتاء المربوطة
        // $string = str_replace(['ى'], 'ي', $string); // ياء مقصورة إلى ياء عادية
        // $string = str_replace(['ة'], 'ه', $string); // تاء مربوطة إلى هاء

        // 4. إزالة الفراغات المتعددة بين الكلمات واستبدالها بفراغ واحد
        $string = preg_replace('/\s+/u', ' ', $string);

        return $string;
    }



    /**
     * Display a listing of the resource.
     */
    // public function index()
    // {
    //     try {
    //         // جلب المدرسين مع القسم وعدد المواد المعينة (لتجنب تحميل كل المواد)
    //         $instructors = Instructor::with(['user:id,name', 'department:id,department_name'])
    //             ->withCount('sections') // إضافة عمود subjects_count
    //             ->latest()
    //             ->paginate(10); // Pagination للصفحة الرئيسية

    //         return view('dashboard.data-entry.instructor-subjects', compact('instructors')); // View جديد للعرض
    //     } catch (Exception $e) {
    //         Log::error('Error fetching instructor-subject index: ' . $e->getMessage());
    //         return redirect()->back()->with('error', 'Could not load instructor assignments.');
    //     }
    // }

    // /**
    //  * Show the form for editing the assigned subjects for a specific instructor.
    //  */

    // public function editAssignments(Instructor $instructor) // Route Model Binding للمدرس
    // {
    //     try {
    //         // جلب كل المواد مع شعبها (مع تحميل العلاقات اللازمة للشعبة)
    //         $allSubjectsWithSections = Subject::with([
    //             'subjectCategory:id,subject_category_name', // فئة المادة
    //             // جلب شعب المادة مع تحميل مدرسينها
    //             'planSubjectEntries.sections.instructors:id,instructor_name' // لمعرفة إذا كانت الشعبة مأخوذة
    //         ])
    //             ->orderBy('subject_no')
    //             ->get();

    //         // جلب IDs الشعب المعينة لهذا المدرس المحدد
    //         $assignedSectionIds = $instructor->sections()->pluck('sections.id')->toArray();

    //         return view('dashboard.data-entry.instructor-subject-edit', compact(
    //             'instructor',
    //             'allSubjectsWithSections',
    //             'assignedSectionIds'
    //         ));
    //     } catch (Exception $e) {
    //         Log::error('Error loading edit assignments view for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
    //         return redirect()->route('data-entry.instructor-subject.index')->with('error', 'Could not load assignment editing page.');
    //     }
    // }


    // /**
    //  * Update the sections assigned to the specified instructor.
    //  */
    // public function syncAssignments(Request $request, Instructor $instructor)
    // {
    //     // 1. Validation (فقط section_ids)
    //     $validatedData = $request->validate([
    //         'section_ids' => 'nullable|array', // قد تكون فارغة إذا أردنا إزالة كل التعيينات
    //         'section_ids.*' => 'integer|exists:sections,id',
    //     ]);

    //     try {
    //         // 2. استخدام sync() لتحديث الارتباطات في جدول instructor_section
    //         $instructor->sections()->sync($validatedData['section_ids'] ?? []);

    //         // 3. Redirect إلى صفحة العرض الرئيسية مع رسالة نجاح
    //         return redirect()->route('data-entry.instructor-subject.index')
    //             ->with('success', 'Section assignments updated successfully for ' . ($instructor->instructor_name ?? optional($instructor->user)->name));
    //     } catch (Exception $e) {
    //         Log::error('Error syncing sections for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
    //         // العودة لصفحة التعديل نفسها مع رسالة خطأ
    //         return redirect()->route('data-entry.instructor-subject.edit', $instructor->id)
    //             ->with('error', 'Failed to update section assignments.');
    //     }
    // }

    // public function editAssignments(Instructor $instructor) // استخدام Route Model Binding
    // {
    //     try {
    //         // جلب كل المواد المتاحة
    //         $allSubjects = Subject::with('department:id,department_name')
    //             ->orderBy('subject_no')
    //             ->get(['id', 'subject_no', 'subject_name', 'department_id']);

    //         // جلب IDs المواد المعينة لهذا المدرس
    //         $assignedSubjectIds = $instructor->subjects()->pluck('subjects.id')->toArray();

    //         // توجيه لـ view التعديل
    //         return view('dashboard.data-entry.instructor-subject-edit', compact(
    //             'instructor',
    //             'allSubjects',
    //             'assignedSubjectIds'
    //         ));
    //     } catch (Exception $e) {
    //         Log::error('Error loading edit assignments view for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
    //         return redirect()->route('data-entry.instructor-subject.index')->with('error', 'Could not load assignment editing page.');
    //     }
    // }

    // /**
    //  * Update the subjects assigned to the specified instructor.
    //  */
    // public function syncAssignments(Request $request, Instructor $instructor) // استخدام Route Model Binding
    // {
    //     // 1. Validation (فقط للمواد المختارة)
    //     $validatedData = $request->validate([
    //         // instructor_id يأتي من الروت
    //         'subject_ids' => 'nullable|array',
    //         'subject_ids.*' => 'integer|exists:subjects,id',
    //     ]);

    //     try {
    //         // 2. استخدام sync() لتحديث الارتباطات
    //         $instructor->subjects()->sync($validatedData['subject_ids'] ?? []);

    //         // 3. Redirect إلى صفحة العرض الرئيسية مع رسالة نجاح
    //         return redirect()->route('data-entry.instructor-subject.index')
    //             ->with('success', 'Subject assignments updated successfully for ' . ($instructor->instructor_name ?? optional($instructor->user)->name));
    //     } catch (Exception $e) {
    //         Log::error('Error syncing subjects for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
    //         // العودة لصفحة التعديل نفسها مع رسالة خطأ
    //         return redirect()->route('data-entry.instructor-subject.edit', $instructor->id)
    //             ->with('error', 'Failed to update subject assignments.');
    //     }
    // }

    // =============================================
    //             API Controller Methods
    // =============================================

    /**
     * Display a listing of instructors with their assigned subject count (API).
     */
    public function apiIndex(Request $request) // إضافة Request للـ pagination المستقبلي
    {
        try {
            $query = Instructor::with(['user:id,name', 'department:id,department_name'])
                ->withCount('subjects'); // حساب عدد المواد

            // (اختياري) فلترة بسيطة
            if ($request->has('department_id')) {
                $query->where('department_id', $request->department_id);
            }

            // --- جلب كل النتائج (بدون pagination حالياً) ---
            $instructors = $query->latest('id')->get();

            // --- كود الـ Pagination (معطل) ---
            /*
            $perPage = $request->query('per_page', 20);
            $instructorsPaginated = $query->latest('id')->paginate($perPage);
            return response()->json([
                'success' => true,
                'data' => $instructorsPaginated->items(),
                'pagination' => [ 'total' => $instructorsPaginated->total(), ... ]
            ], 200);
            */

            return response()->json(['success' => true, 'data' => $instructors], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching instructor assignments index: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }

    /**
     * Get all subjects, indicating which are assigned to a specific instructor (API).
     */
    // public function apiShowAssignments(Instructor $instructor) // استخدام Route Model Binding
    // {
    //     try {
    //         // جلب IDs المواد المعينة لهذا المدرس
    //         $assignedSubjectIds = $instructor->subjects()->pluck('subjects.id')->toArray();

    //         // جلب كل المواد المتاحة
    //         $allSubjects = Subject::orderBy('subject_no')
    //             ->get(['id', 'subject_no', 'subject_name']) // جلب الحقول الأساسية
    //             ->map(function ($subject) use ($assignedSubjectIds) {
    //                 // إضافة حقل is_assigned لكل مادة
    //                 $subject->is_assigned = in_array($subject->id, $assignedSubjectIds);
    //                 return $subject;
    //             });

    //         return response()->json([
    //             'success' => true,
    //             'data' => [
    //                 'instructor' => $instructor->load('user:id,name'), // تحميل بيانات المدرس الأساسية
    //                 'subjects' => $allSubjects // قائمة كل المواد مع حقل is_assigned
    //             ]
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error("API Error fetching assignment details for instructor ID {$instructor->id}: " . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Server Error'], 500);
    //     }
    // }


    // /**
    //  * Sync subjects for a specific instructor (API).
    //  */
    // public function apiSyncAssignments(Request $request, Instructor $instructor)
    // {
    //     $validatedData = $request->validate([
    //         'subject_ids' => 'present|array',
    //         'subject_ids.*' => 'integer|exists:subjects,id',
    //     ]);

    //     try {
    //         $instructor->subjects()->sync($validatedData['subject_ids'] ?? []);

    //         // إرجاع قائمة المواد المعينة المحدثة
    //         $updatedAssignedSubjects = $instructor->subjects()
    //             ->orderBy('subject_no')
    //             ->get(['subjects.id', 'subject_no', 'subject_name']);

    //         return response()->json([
    //             'success' => true,
    //             'message' => 'Subject assignments updated successfully.',
    //             'data' => $updatedAssignedSubjects
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error('API Error syncing subjects for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Failed to update assignments.'], 500);
    //     }
    // }
    public function apiShowAssignments(Instructor $instructor) // Route Model Binding للمدرس
    {
        try {
            // جلب IDs الشعب المعينة لهذا المدرس المحدد
            $assignedSectionIdsForCurrentInstructor = $instructor->sections()->pluck('sections.id')->toArray();

            // جلب كل المواد مع شعبها، مع تحديد حالة كل شعبة
            $allSubjectsWithSections = Subject::with([
                'subjectCategory:id,subject_category_name',
                // جلب كل شعب المادة، مع تحميل المدرسين المعينين لكل شعبة
                'planSubjectEntries.sections' => function ($query) {
                    $query->with('instructors:instructors.id,instructors.instructor_name,instructors.user_id') // جلب معلومات المدرس المعين
                        ->select('sections.*'); // تأكد من جلب كل أعمدة sections
                },
                // تحميل علاقة user للمدرسين المعينين للشعبة (إذا أردت اسم اليوزر)
                'planSubjectEntries.sections.instructors.user:id,name'
            ])
                ->orderBy('subject_no')
                ->get();

            // معالجة البيانات لإضافة حالة التعيين لكل شعبة
            $subjectsFormatted = $allSubjectsWithSections->map(function ($subject) use ($assignedSectionIdsForCurrentInstructor, $instructor) {
                $processedSections = collect();
                $allSectionsTakenByOthersForThisSubject = true;

                if ($subject->planSubjectEntries->isNotEmpty()) {
                    foreach ($subject->planSubjectEntries as $planSubEntry) {
                        foreach ($planSubEntry->sections as $section) {
                            $isAssignedToCurrent = in_array($section->id, $assignedSectionIdsForCurrentInstructor);
                            $assignedToOtherInstructor = false;
                            $otherInstructorName = null;

                            if (!$section->instructors->isEmpty()) { // إذا كانت الشعبة معينة
                                if (!$isAssignedToCurrent) { // ولم تكن معينة للمدرس الحالي
                                    $assignedToOtherInstructor = true;
                                    $firstOtherInstructor = $section->instructors->first(fn($instr) => $instr->id !== $instructor->id);
                                    if ($firstOtherInstructor) {
                                        $otherInstructorName = $firstOtherInstructor->instructor_name ?? optional($firstOtherInstructor->user)->name;
                                    }
                                }
                            }

                            // اعرض الشعبة فقط إذا كانت متاحة أو معينة للمدرس الحالي
                            if (!$assignedToOtherInstructor || $isAssignedToCurrent) {
                                $allSectionsTakenByOthersForThisSubject = false; // على الأقل شعبة واحدة يمكن التفاعل معها
                            }

                            // إضافة معلومات مفيدة للـ API
                            $processedSections->push([
                                'id' => $section->id,
                                'section_number' => $section->section_number,
                                'activity_type' => $section->activity_type,
                                'student_count' => $section->student_count,
                                'academic_year' => $section->academic_year,
                                'semester' => $section->semester,
                                'branch' => $section->branch,
                                'is_assigned_to_current_instructor' => $isAssignedToCurrent,
                                'is_assigned_to_other_instructor' => $assignedToOtherInstructor,
                                'other_instructor_name' => $otherInstructorName,
                            ]);
                        }
                    }
                }

                // لا ترجع المادة إذا كانت كل شعبها مأخوذة من قبل مدرسين آخرين
                if ($allSectionsTakenByOthersForThisSubject && !$processedSections->contains('is_assigned_to_current_instructor', true) && $processedSections->isNotEmpty()) {
                    return null; // أو يمكنك إرجاع المادة مع مصفوفة شعب فارغة إذا أردت إظهارها
                }


                return [
                    'id' => $subject->id,
                    'subject_no' => $subject->subject_no,
                    'subject_name' => $subject->subject_name,
                    'subject_category' => optional($subject->subjectCategory)->subject_category_name,
                    'sections' => $processedSections->sortBy(['activity_type', 'section_number'])->values(), // values() لإعادة الفهرسة
                ];
            })->filter()->values(); // filter() لإزالة المواد التي أرجعت null, ثم values() لإعادة الفهرسة

            return response()->json([
                'success' => true,
                'data' => [
                    'instructor' => [ // بيانات المدرس الحالي
                        'id' => $instructor->id,
                        'name' => $instructor->instructor_name ?? optional($instructor->user)->name,
                        'instructor_no' => $instructor->instructor_no
                    ],
                    'assignable_subjects' => $subjectsFormatted // قائمة المواد مع شعبها وحالة التعيين
                ]
            ], 200);
        } catch (Exception $e) {
            Log::error("API Error fetching assignments for instructor ID {$instructor->id}: " . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error: ' . $e->getMessage()], 500);
        }
    }

    /**
     * API: Sync sections for a specific instructor.
     * (نفس دالة apiSyncAssignments السابقة، تعمل على علاقة sections)
     */
    public function apiSyncAssignments(Request $request, Instructor $instructor)
    {
        $validatedData = $request->validate([
            'section_ids' => 'present|array',
            'section_ids.*' => 'integer|exists:sections,id',
        ]);

        try {
            $instructor->sections()->sync($validatedData['section_ids'] ?? []);

            // إرجاع قائمة المواد المعينة المحدثة للمدرس
            $updatedAssignedSections = $instructor->sections()
                ->with(['planSubject.subject:id,subject_no,subject_name']) // جلب معلومات المادة
                ->orderBy('activity_type')->orderBy('section_number')
                ->get(['sections.id', 'plan_subject_id', 'activity_type', 'section_number', 'student_count']); // تحديد حقول الشعبة

            return response()->json([
                'success' => true,
                'message' => 'Section assignments updated successfully.',
                'data' => $updatedAssignedSections
            ], 200);
        } catch (Exception $e) {
            Log::error('API Error syncing sections for instructor ID ' . $instructor->id . ': ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to update assignments.'], 500);
        }
    }

    /**
     * API: Get sections currently assigned to a specific instructor.
     * جلب الشعب المعينة حالياً لمدرس محدد عبر API
     */
    public function apiGetAssignedSections(Instructor $instructor)
    {
        try {
            $assignedSections = $instructor->sections() // استدعاء علاقة sections الجديدة
                ->with([ // تحميل معلومات إضافية لكل شعبة
                    'planSubject.subject:id,subject_no,subject_name',
                    'planSubject.plan:id,plan_no'
                ])
                ->orderBy('academic_year')->orderBy('semester')
                ->orderBy('activity_type')->orderBy('section_number')
                ->get([ // تحديد الحقول المطلوبة من جدول sections وجداول الربط
                    'sections.id',
                    'sections.plan_subject_id',
                    'sections.academic_year',
                    'sections.semester',
                    'sections.activity_type',
                    'sections.section_number',
                    'sections.student_count',
                    'sections.section_gender',
                    'sections.branch'
                ]);

            return response()->json([
                'success' => true,
                'data' => $assignedSections
            ], 200);
        } catch (Exception $e) {
            Log::error("API Error fetching assigned sections for instructor ID {$instructor->id}: " . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error: ' . $e->getMessage()], 500);
        }
    }

    /**
     * API: Get available sections that can be assigned.
     * جلب الشعب المتاحة (التي لم يتم تعيينها لأي مدرس بعد) عبر API.
     * يمكن فلترتها اختيارياً حسب plan_subject_id, academic_year, semester, branch.
     */
    public function apiGetAvailableSections(Request $request)
    {
        try {
            // جلب كل IDs الشعب التي تم تعيينها بالفعل لأي مدرس
            $assignedSectionIdsGlobally = DB::table('instructor_section')->pluck('section_id')->toArray();

            $query = Section::whereNotIn('id', $assignedSectionIdsGlobally) // استبعاد الشعب المعينة
                ->with([
                    'planSubject.subject:id,subject_no,subject_name',
                    'planSubject.plan:id,plan_no'
                ]);

            // (اختياري) فلاتر إضافية
            if ($request->filled('plan_subject_id')) {
                $query->where('plan_subject_id', $request->plan_subject_id);
            }
            if ($request->filled('academic_year')) {
                $query->where('academic_year', $request->academic_year);
            }
            if ($request->filled('semester')) {
                $query->where('semester', $request->semester);
            }
            if ($request->filled('branch')) {
                $query->where(function ($q) use ($request) {
                    is_null($request->branch) || $request->branch === '' || strtolower($request->branch) === 'none' ?
                        $q->whereNull('branch') :
                        $q->where('branch', $request->branch);
                });
            }
            if ($request->has('activity_type')) {
                $query->where('activity_type', $request->activity_type);
            }


            $availableSections = $query->orderBy('academic_year')->orderBy('semester')
                ->orderBy('activity_type')->orderBy('section_number')
                ->get([
                    'sections.id',
                    'sections.plan_subject_id',
                    'sections.academic_year',
                    'sections.semester',
                    'sections.activity_type',
                    'sections.section_number',
                    'sections.student_count',
                    'sections.section_gender',
                    'sections.branch'
                ]);

            return response()->json([
                'success' => true,
                'data' => $availableSections
            ], 200);
        } catch (Exception $e) {
            Log::error("API Error fetching available sections: " . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error: ' . $e->getMessage()], 500);
        }
    }


    /**
     * Get subjects assigned to a specific instructor (API).
     */
    // public function apiGetAssignedSubjects(Instructor $instructor) // استخدام Route Model Binding
    // {
    //     try {
    //         // جلب المواد المعينة لهذا المدرس فقط مع تحديد الحقول المطلوبة
    //         $assignedSubjects = $instructor->subjects() // استدعاء علاقة subjects
    //             ->orderBy('subject_no')
    //             ->get(['subjects.id', 'subject_no', 'subject_name']); // تحديد الحقول من جدول subjects

    //         return response()->json([
    //             'success' => true,
    //             'data' => $assignedSubjects
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error("API Error fetching assigned subjects for instructor ID {$instructor->id}: " . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Server Error'], 500);
    //     }
    // }

    // /**
    //  * Get available subjects for a specific instructor (API).
    //  */
    // public function apiGetAvailableSubjects(Instructor $instructor)
    // {
    //     try {
    //         // جلب IDs المواد المعينة بالفعل لهذا المدرس
    //         $assignedSubjectIds = $instructor->subjects()->pluck('subjects.id')->toArray();

    //         // جلب كل المواد التي *ليست* ضمن قائمة المواد المعينة
    //         $availableSubjects = Subject::whereNotIn('id', $assignedSubjectIds)
    //             ->orderBy('subject_no')
    //             ->get(['id', 'subject_no', 'subject_name']);

    //         return response()->json([
    //             'success' => true,
    //             'data' => $availableSubjects
    //         ], 200);
    //     } catch (Exception $e) {
    //         Log::error("API Error fetching available subjects for instructor ID {$instructor->id}: " . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => 'Server Error'], 500);
    //     }
    // }
}
-----------------------------------------------------------------------------------------------------------
app\Http\Controllers\DataEntry\TimeslotController.php
<?php

namespace App\Http\Controllers\DataEntry;

use App\Http\Controllers\Controller;
use App\Models\Timeslot;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\Rule;
use Illuminate\Support\Facades\Validator; // لاستخدام Validator يدوياً
use Exception;
use Illuminate\Support\Facades\DB;

class TimeslotController extends Controller
{
    // أيام الأسبوع المستخدمة في النظام
    const DAYS_OF_WEEK = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    // =============================================
    //            Web Controller Methods
    // =============================================

    /**
     * Display a listing of the timeslots.
     */
    public function index()
    {
        try {
            $timeslots = Timeslot::withCount('scheduleEntries')
                ->orderByRaw("FIELD(day, '" . implode("','", self::DAYS_OF_WEEK) . "')")
                ->orderBy('start_time')
                ->paginate(30); // عرض عدد أكبر للفترات

            return view('dashboard.data-entry.timeslots', compact('timeslots'));
        } catch (Exception $e) {
            Log::error('Error fetching timeslots: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Could not load timeslots.');
        }
    }

    /**
     * Generate standard weekly timeslots based on user input.
     */
    public function generateStandard(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'working_days' => 'required|array|min:1',
            'working_days.*' => ['required', Rule::in(self::DAYS_OF_WEEK)],
            'overall_start_time' => 'required|date_format:H:i',
            'overall_end_time' => 'required|date_format:H:i|after:overall_start_time',
            'lecture_duration' => 'required|integer|min:15', // أقل مدة محاضرة 15 دقيقة
            'break_duration' => 'required|integer|min:0',   // الاستراحة يمكن أن تكون 0
        ]);

        if ($validator->fails()) {
            return redirect()->route('data-entry.timeslots.index')
                ->withErrors($validator, 'generateStandardModal') // error bag مخصص
                ->withInput()
                ->with('open_generate_modal', true); // لإعادة فتح المودال
        }

        try {
            DB::transaction(function () use ($request) { // استخدام transaction لضمان سلامة البيانات
                // 1. حذف كل الفترات القديمة
                // Timeslot::truncate(); // يحذف كل السجلات ويُعيد الـ auto-increment (كن حذراً)
                Timeslot::query()->delete(); // إذا كنت لا تريد إعادة الـ auto-increment
                Log::info('Old timeslots deleted for standard generation.');

                // 2. إنشاء الفترات الجديدة
                $newTimeslots = [];
                $workingDays = $request->input('working_days');
                $startTime = Carbon::createFromTimeString($request->input('overall_start_time'));
                $endTime = Carbon::createFromTimeString($request->input('overall_end_time'));
                $lectureDurationMinutes = (int)$request->input('lecture_duration');
                $breakDurationMinutes = (int)$request->input('break_duration');

                foreach ($workingDays as $day) {
                    $currentTime = $startTime->copy();
                    while ($currentTime->copy()->addMinutes($lectureDurationMinutes)->lte($endTime)) {
                        $slotEndTime = $currentTime->copy()->addMinutes($lectureDurationMinutes);
                        $newTimeslots[] = [
                            'day' => $day,
                            'start_time' => $currentTime->format('H:i:s'),
                            'end_time' => $slotEndTime->format('H:i:s'),
                            'created_at' => now(),
                            'updated_at' => now(),
                        ];
                        $currentTime = $slotEndTime->copy()->addMinutes($breakDurationMinutes);
                    }
                }

                if (!empty($newTimeslots)) {
                    Timeslot::insert($newTimeslots); // إدخال جماعي
                    Log::info(count($newTimeslots) . ' new standard timeslots generated.');
                }
            });

            return redirect()->route('data-entry.timeslots.index')
                ->with('success', 'Standard weekly timeslots generated successfully.');
        } catch (Exception $e) {
            Log::error('Failed to generate standard timeslots: ' . $e->getMessage());
            return redirect()->route('data-entry.timeslots.index')
                ->with('error', 'Failed to generate timeslots: ' . $e->getMessage());
        }
    }


    /**
     * Store a newly created timeslot in storage.
     */
    public function store(Request $request)
    {
        $errorBagName = 'addTimeslotModal';
        $validator = Validator::make($request->all(), [
            'day' => ['required', Rule::in(self::DAYS_OF_WEEK)],
            'start_time' => 'required|date_format:H:i',
            'end_time' => 'required|date_format:H:i|after:start_time',
        ]);

        // التحقق من التفرد والتداخل
        $validator->after(function ($validator) use ($request) {
            if (!$validator->errors()->hasAny()) {
                $this->validateTimeslotUniquenessAndOverlap(
                    $validator,
                    $request->input('day'),
                    $request->input('start_time'),
                    $request->input('end_time')
                );
            }
        });

        if ($validator->fails()) {
            return redirect()->back()
                ->withErrors($validator, $errorBagName)
                ->withInput()
                ->with('open_modal_on_error', $errorBagName)
                ->with('error', 'This timeslot overlaps with an existing timeslot on the same day.');
        }

        try {
            Timeslot::create($validator->validated());
            return redirect()->route('data-entry.timeslots.index')
                ->with('success', 'Timeslot created successfully.');
        } catch (Exception $e) {
            Log::error('Timeslot Creation Failed: ' . $e->getMessage());
            return redirect()->back()
                ->with('error', 'Failed to create timeslot.')
                ->withInput();
        }
    }

    /**
     * Update the specified timeslot in storage.
     */
    public function update(Request $request, Timeslot $timeslot)
    {
        $errorBagName = 'editTimeslotModal_' . $timeslot->id;
        $validator = Validator::make($request->all(), [
            'day' => ['required', Rule::in(self::DAYS_OF_WEEK)],
            'start_time' => 'required|date_format:H:i',
            'end_time' => 'required|date_format:H:i|after:start_time',
        ]);

        // التحقق من التفرد والتداخل (مع تجاهل الفترة الحالية)
        $validator->after(function ($validator) use ($request, $timeslot) {
            if (!$validator->errors()->hasAny()) {
                $this->validateTimeslotUniquenessAndOverlap(
                    $validator,
                    $request->input('day'),
                    $request->input('start_time'),
                    $request->input('end_time'),
                    $timeslot->id // ID الفترة الحالية لاستثنائها
                );
            }
        });

        if ($validator->fails()) {
            return redirect()->back()->withErrors($validator, $errorBagName)->withInput()
                ->with('open_modal_on_error', $errorBagName)
                ->with('error_modal_id', $timeslot->id)
                ->with('error', 'This timeslot overlaps with an existing timeslot on the same day.');
        }
        try {
            $timeslot->update($validator->validated());
            return redirect()->route('data-entry.timeslots.index')->with('success', 'Timeslot updated successfully.');
        } catch (Exception $e) {
            Log::error('Timeslot Update Failed: ' . $e->getMessage());
            return redirect()->back()
                // إرجاع الأخطاء للـ error bag الصحيح
                ->withErrors(['update_error' => 'Failed to update timeslot.'], 'update_' . $timeslot->id)
                ->withInput();
        }
    }

    /**
     * Helper function to validate timeslot uniqueness and overlap.
     * دالة مساعدة للتحقق من تفرد الفترة وعدم تداخلها
     */
    private function validateTimeslotUniquenessAndOverlap($validator, $day, $startTime, $endTime, $excludeId = null)
    {
        $startTimeCarbon = Carbon::parse($startTime);
        $endTimeCarbon = Carbon::parse($endTime);

        // 1. التحقق من التفرد (نفس الفترة بالضبط)
        $query = Timeslot::where('day', $day)
            ->where('start_time', $startTimeCarbon->format('H:i:s')) // قارن بالتنسيق الكامل
            ->where('end_time', $endTimeCarbon->format('H:i:s'));
        if ($excludeId) {
            $query->where('id', '!=', $excludeId);
        }
        if ($query->exists()) {
            $validator->errors()->add('time_unique', 'This exact timeslot (day, start, end) already exists.');
            return; // لا داعي للتحقق من التداخل إذا كانت متطابقة
        }

        // 2. التحقق من التداخل
        // فترة جديدة: [S1, E1]
        // فترة موجودة: [S2, E2]
        // يحدث تداخل إذا: (S1 < E2) AND (E1 > S2)
        $overlapping = Timeslot::where('day', $day)
            ->where(function ($q) use ($startTimeCarbon, $endTimeCarbon) {
                $q->where(function ($subQ) use ($startTimeCarbon, $endTimeCarbon) { // Period 1 overlaps Period 2
                    $subQ->where('start_time', '<', $endTimeCarbon->format('H:i:s'))
                        ->where('end_time', '>', $startTimeCarbon->format('H:i:s'));
                });
                // يمكنك إضافة شروط أخرى إذا أردت أن تكون الفترات متلاصقة مسموحة أو ممنوعة
                // ->orWhere('start_time', '=', $endTimeCarbon->format('H:i:s')) // متلاصقة في النهاية
                // ->orWhere('end_time', '=', $startTimeCarbon->format('H:i:s')); // متلاصقة في البداية
            });

        if ($excludeId) {
            $overlapping->where('id', '!=', $excludeId);
        }

        if ($overlapping->exists()) {
            $validator->errors()->add('time_overlap', 'This timeslot overlaps with an existing timeslot on the same day.');
        }
    }

    /**
     * Remove the specified timeslot from storage.
     */
    public function destroy(Timeslot $timeslot)
    {
        // التحقق من وجود جداول مرتبطة
        if ($timeslot->scheduleEntries()->exists()) {
            return redirect()->route('data-entry.timeslots.index')
                ->with('error', 'Cannot delete timeslot. It is used in generated schedules.');
        }

        // 1. Delete
        try {
            $timeslot->delete();
            return redirect()->route('data-entry.timeslots.index')
                ->with('success', 'Timeslot deleted successfully.');
        } catch (Exception $e) {
            Log::error('Timeslot Deletion Failed: ' . $e->getMessage());
            return redirect()->route('data-entry.timeslots.index')
                ->with('error', 'Failed to delete timeslot.');
        }
    }

    // =============================================
    //             API Controller Methods
    // =============================================
    /**
     * Display a listing of the timeslots (API).
     */
    public function apiIndex(Request $request) // إضافة Request للفلترة المحتملة
    {
        try {
            $query = Timeslot::query(); // ابدأ بإنشاء query builder

            // (اختياري) فلترة بسيطة
            if ($request->has('day')) {
                $query->where('day', $request->day);
            }
            // يمكنك إضافة فلترة حسب الوقت هنا إذا احتجت

            // جلب الفترات مرتبة باليوم ثم الوقت
            // وتحديد الحقول المطلوبة
            $timeslots = $query->orderByRaw("FIELD(day, 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday')") // ترتيب مخصص للأيام
                ->orderBy('start_time')
                ->get(['id', 'day', 'start_time', 'end_time']);

            // --- كود الـ Pagination (معطل) ---
            /*
            $perPage = $request->query('per_page', 50); // عرض عدد أكبر في الصفحة للـ timeslots
            $timeslotsPaginated = $query->orderByRaw(...) // نفس الترتيب
                                         ->orderBy('start_time')
                                         ->paginate($perPage, ['id', 'day', 'start_time', 'end_time']);

            return response()->json([
                'success' => true,
                'data' => $timeslotsPaginated->items(),
                'pagination' => [ 'total' => $timeslotsPaginated->total(), ... ]
            ], 200);
            */

            return response()->json(['success' => true, 'data' => $timeslots], 200);
        } catch (Exception $e) {
            Log::error('API Error fetching timeslots: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Server Error'], 500);
        }
    }

    /**
     * Store a newly created timeslot from API request.
     */

    public function apiStore(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'day' => ['required', Rule::in(self::DAYS_OF_WEEK)],
            'start_time' => 'required|date_format:H:i', // H:i for 24-hour format
            'end_time' => 'required|date_format:H:i|after:start_time',
        ]);

        $validator->after(function ($validator) use ($request) {
            if (!$validator->errors()->hasAny()) {
                $this->validateTimeslotUniquenessAndOverlap(
                    $validator,
                    $request->input('day'),
                    $request->input('start_time'),
                    $request->input('end_time')
                );
            }
        });

        if ($validator->fails()) {
            return response()->json(['success' => false, 'errors' => $validator->errors()], 422);
        }

        try {
            $timeslot = Timeslot::create($validator->validated());
            return response()->json(['success' => true, 'data' => $timeslot, 'message' => 'Timeslot created successfully.'], 201);
        } catch (Exception $e) {
            Log::error('API Timeslot Creation Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to create timeslot.'], 500);
        }
    }

    /**
     * Generate standard weekly timeslots from API request.
     */
    public function apiGenerateStandard(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'working_days' => 'required|array|min:1',
            'working_days.*' => ['required', Rule::in(self::DAYS_OF_WEEK)],
            'overall_start_time' => 'required|date_format:H:i',
            'overall_end_time' => 'required|date_format:H:i|after:overall_start_time',
            'lecture_duration' => 'required|integer|min:15',
            'break_duration' => 'required|integer|min:0',
        ]);

        if ($validator->fails()) {
            return response()->json(['success' => false, 'errors' => $validator->errors()], 422);
        }

        try {
            DB::transaction(function () use ($request) {
                Timeslot::query()->delete();
                // Timeslot::truncate(); // أو
                Log::info('Old timeslots deleted for standard API generation.');

                $newTimeslots = [];
                $workingDays = $request->input('working_days');
                $startTime = Carbon::createFromTimeString($request->input('overall_start_time'));
                $endTime = Carbon::createFromTimeString($request->input('overall_end_time'));
                $lectureDurationMinutes = (int)$request->input('lecture_duration');
                $breakDurationMinutes = (int)$request->input('break_duration');

                foreach ($workingDays as $day) {
                    $currentTime = $startTime->copy();
                    while ($currentTime->copy()->addMinutes($lectureDurationMinutes)->lte($endTime)) {
                        $slotEndTime = $currentTime->copy()->addMinutes($lectureDurationMinutes);
                        $newTimeslots[] = [
                            'day' => $day,
                            'start_time' => $currentTime->format('H:i:s'),
                            'end_time' => $slotEndTime->format('H:i:s'),
                            'created_at' => now(),
                            'updated_at' => now(),
                        ];
                        $currentTime = $slotEndTime->copy()->addMinutes($breakDurationMinutes);
                    }
                }
                if (!empty($newTimeslots)) {
                    Timeslot::insert($newTimeslots);
                }
            });

            $generatedCount = Timeslot::count(); // عدد الفترات التي تم إنشاؤها
            return response()->json(['success' => true, 'message' => "{$generatedCount} standard timeslots generated successfully."], 200);
        } catch (Exception $e) {
            Log::error('API Failed to generate standard timeslots: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to generate timeslots: ' . $e->getMessage()], 500);
        }
    }


    /**
     * Display the specified timeslot (API).
     */
    public function apiShow(Timeslot $timeslot)
    {
        // يمكنك إضافة ->loadCount('scheduleEntries') هنا إذا أردت عرض عدد المحاضرات
        // $timeslot->loadCount('scheduleEntries');
        return response()->json(['success' => true, 'data' => $timeslot], 200);
    }

    /**
     * Update the specified timeslot from API request.
     */
    public function apiUpdate(Request $request, Timeslot $timeslot)
    {
        $validator = Validator::make($request->all(), [
            'day' => ['sometimes', 'required', Rule::in(self::DAYS_OF_WEEK)],
            'start_time' => 'sometimes|required|date_format:H:i',
            'end_time' => 'sometimes|required|date_format:H:i|after:start_time',
        ]);

        $validator->after(function ($validator) use ($request, $timeslot) {
            if (!$validator->errors()->hasAny()) {
                // جلب القيم للتأكد (إذا لم يتم إرسالها، استخدم القيمة الحالية)
                $day = $request->input('day', $timeslot->day);
                $startTime = $request->input('start_time', $timeslot->start_time);
                $endTime = $request->input('end_time', $timeslot->end_time);

                $this->validateTimeslotUniquenessAndOverlap(
                    $validator,
                    $day,
                    $startTime,
                    $endTime,
                    $timeslot->id
                );
            }
        });

        if ($validator->fails()) {
            return response()->json(['success' => false, 'errors' => $validator->errors()], 422);
        }
        try {
            $timeslot->update($validator->validated()); // استخدام البيانات التي تم التحقق منها فقط
            return response()->json(['success' => true, 'data' => $timeslot, 'message' => 'Timeslot updated successfully.'], 200);
        } catch (Exception $e) {
            Log::error('API Timeslot Update Failed: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => 'Failed to update timeslot.'], 500);
        }
    }

    /**
     * Remove the specified timeslot (API).
     */
    public function apiDestroy(Timeslot $timeslot)
    {
        // ... (نفس كود الحذف من الويب، ولكن يرجع JSON) ...
        if ($timeslot->scheduleEntries()->exists()) {
            return response()->json(['success' => false, 'message' => 'Cannot delete: used in schedules.'], 409);
        }
        try {
            $timeslot->delete();
            return response()->json(['success' => true, 'message' => 'Timeslot deleted.'], 200);
        } catch (Exception $e) {
            return response()->json(['success' => false, 'message' => 'Failed to delete.'], 500);
        }
    }
}
--------------------------------------------------------------------------------------------------------
app\Imports\PlanSubjectsImport.php
<?php

// namespace App\Imports;

// use App\Models\PlanSubject;
// use Maatwebsite\Excel\Concerns\ToModel;

// class PlanSubjectsImport implements ToModel
// {
//     /**
//     * @param array $row
//     *
//     * @return \Illuminate\Database\Eloquent\Model|null
//     */
//     public function model(array $row)
//     {
//         return new PlanSubject([
//             //
//         ]);
//     }
// }


namespace App\Imports;

use App\Models\Plan;
use App\Models\PlanSubject;
use App\Models\Subject;
use Maatwebsite\Excel\Concerns\ToModel;
use Maatwebsite\Excel\Concerns\WithHeadingRow;
use Maatwebsite\Excel\Concerns\WithValidation;
use Maatwebsite\Excel\Concerns\Importable;
use Maatwebsite\Excel\Concerns\SkipsEmptyRows;
use Maatwebsite\Excel\Concerns\SkipsOnError; // لتجاهل الأخطاء ومتابعة باقي الصفوف
use Maatwebsite\Excel\Concerns\SkipsErrors; // لتجميع الأخطاء
use Illuminate\Validation\Rule;
use Illuminate\Support\Facades\Log;
use Throwable; // لالتقاط كل أنواع الأخطاء

class PlanSubjectsImport implements ToModel, WithHeadingRow, WithValidation, SkipsEmptyRows, SkipsOnError
{
    use Importable, SkipsErrors; // استخدام SkipsErrors لتجميع الأخطاء

    private Plan $currentPlan; // الخطة الحالية التي نعمل عليها
    private $createdCount = 0;
    private $updatedCount = 0; // سنستخدمه إذا كان هناك حقول للتحديث في plan_subjects
    private $skippedCount = 0;
    private $alreadyExistedCount = 0;
    private $invalidPlanCount = 0;
    private $processedPlanSubjectKeys = []; // لتتبع التكرار داخل الملف

    // استقبال الخطة الحالية في الـ constructor
    public function __construct(Plan $plan)
    {
        $this->currentPlan = $plan;
    }

    /**
    * @param array $row
    *
    * @return \Illuminate\Database\Eloquent\Model|null
    */
    public function model(array $row)
    {
        // تحويل العناوين لـ snake_case (المكتبة تقوم بهذا) والبحث عن القيم
        $planIdentifier = trim($row['plan_id'] ?? $row['planid'] ?? $row['plan_name'] ?? $row['planname'] ?? null); // اسم الخطة أو رقمها
        $levelInput = trim($row['plan_level'] ?? $row['planlevel'] ?? $row['level'] ?? null);
        $semesterInput = trim($row['plan_semester'] ?? $row['plansemester'] ?? $row['semester'] ?? null);
        $subjectIdentifier = trim($row['subject_id'] ?? $row['subjectid'] ?? $row['subject_no'] ?? $row['subjectno'] ?? $row['subject_name'] ?? $row['subjectname'] ?? null);

        // 1. تجاهل الصفوف الفارغة تماماً
        if (empty($planIdentifier) || empty($subjectIdentifier) || empty($levelInput) || empty($semesterInput)) {
            Log::info('PlanSubjectsImport: Skipping row due to missing core data.', $row);
            $this->skippedCount++;
            return null;
        }

        // 2. التحقق من تطابق الخطة مع الخطة الحالية
        $planIdInFile = null;
        if (is_numeric($planIdentifier)) {
            $planIdInFile = (int) $planIdentifier;
        } else {
            // محاولة البحث بالاسم (مع تجاهل حالة الأحرف والسنة إذا كانت مدمجة)
            // نفترض أن اسم الخطة في الملف قد يكون "Plan Name Only" أو "Plan Name - YYYY"
            $planNameFromFile = preg_replace('/-\s*\d{4}$/', '', $planIdentifier); // إزالة "- YYYY"
            $foundPlan = Plan::whereRaw('LOWER(REPLACE(plan_name, " ", "")) LIKE ?', ['%' . strtolower(str_replace(' ', '', $planNameFromFile)) . '%'])
                            ->orWhereRaw('LOWER(REPLACE(plan_no, " ", "")) LIKE ?', ['%' . strtolower(str_replace(' ', '', $planIdentifier)) . '%'])
                            ->first();
            if ($foundPlan) {
                $planIdInFile = $foundPlan->id;
            }
        }

        if (is_null($planIdInFile) || $planIdInFile !== $this->currentPlan->id) {
            Log::warning("PlanSubjectsImport: Row skipped. Plan '{$planIdentifier}' in file does not match current plan ID {$this->currentPlan->id}.", $row);
            $this->invalidPlanCount++;
            return null;
        }

        // 3. معالجة وتحويل المستوى والفصل
        $level = $this->normalizeLevelOrSemester($levelInput);
        $semester = $this->normalizeLevelOrSemester($semesterInput);

        if (is_null($level) || is_null($semester)) {
            Log::warning("PlanSubjectsImport: Row skipped. Invalid level '{$levelInput}' or semester '{$semesterInput}'.", $row);
            $this->skippedCount++;
            return null;
        }

        // 4. معالجة وتحويل معرّف المادة
        $subject = $this->findSubject($subjectIdentifier);
        if (!$subject) {
            Log::warning("PlanSubjectsImport: Row skipped. Subject '{$subjectIdentifier}' not found.", $row);
            $this->skippedCount++;
            return null;
        }

        // 5. التحقق من التكرار داخل الملف نفسه لهذه الخطة والمادة والمستوى والفصل
        $uniqueKey = $this->currentPlan->id . '-' . $subject->id . '-' . $level . '-' . $semester;
        if (isset($this->processedPlanSubjectKeys[$uniqueKey])) {
            Log::info("PlanSubjectsImport: Skipping duplicate entry in file for key: {$uniqueKey}", $row);
            $this->skippedCount++;
            return null;
        }
        $this->processedPlanSubjectKeys[$uniqueKey] = true;


        // 6. التحقق من وجود الربط مسبقاً في قاعدة البيانات
        $existingPlanSubject = PlanSubject::where('plan_id', $this->currentPlan->id)
                                          ->where('subject_id', $subject->id)
                                          ->where('plan_level', $level)
                                          ->where('plan_semester', $semester)
                                          ->first();

        if ($existingPlanSubject) {
            // المادة مضافة بالفعل، لا نقوم بالتحديث لأن جدول الربط بسيط
            Log::info("PlanSubjectsImport: Subject ID {$subject->id} already exists in Plan ID {$this->currentPlan->id} for L{$level}S{$semester}. No update needed.");
            $this->alreadyExistedCount++;
            return null; // لا ترجع موديل إذا لم يكن هناك تحديث
        } else {
            // إنشاء سجل ربط جديد
            $this->createdCount++;
            Log::info("PlanSubjectsImport: Creating new PlanSubject for Plan ID {$this->currentPlan->id}, Subject ID {$subject->id}, L{$level}S{$semester}.");
            return new PlanSubject([
                'plan_id'       => $this->currentPlan->id,
                'subject_id'    => $subject->id,
                'plan_level'    => $level,
                'plan_semester' => $semester,
            ]);
        }
    }

    /**
     * Helper function to normalize level/semester input.
     */
    private function normalizeLevelOrSemester($input)
    {
        if (is_numeric($input)) {
            return (int) $input;
        }
        $inputLower = strtolower(trim($input));
        $map = [
            'أولى' => 1, 'اولى' => 1, 'first' => 1, '1st' => 1, 'one' => 1, '1' => 1,
            'ثانية' => 2, 'ثانيه' => 2, 'second' => 2, '2nd' => 2, 'two' => 2, '2' => 2,
            'ثالثة' => 3, 'ثالثه' => 3, 'third' => 3, '3rd' => 3, 'three' => 3, '3' => 3,
            'رابعة' => 4, 'رابعه' => 4, 'fourth' => 4, '4th' => 4, 'four' => 4, '4' => 4,
            // أضف المزيد حسب الحاجة للفصول والمستويات
            'فصل أول' => 1, 'فصل اول' => 1,
            'فصل ثاني' => 2, 'فصل ثاني' => 2,
            'صيفي' => 3, 'summer' => 3,
        ];
        return $map[$inputLower] ?? (is_numeric($inputLower) ? (int)$inputLower : null);
    }

    /**
     * Helper function to find subject by ID, No, or Name.
     */
    private function findSubject($identifier)
    {
        if (is_numeric($identifier)) {
            return Subject::find($identifier);
        }
        // البحث بالكود (رقم المادة) - تجاهل حالة الأحرف
        $subject = Subject::whereRaw('LOWER(subject_no) = ?', [strtolower($identifier)])->first();
        if ($subject) {
            return $subject;
        }
        // البحث بالاسم - تجاهل حالة الأحرف والهمزات والفراغات الزائدة
        $normalizedIdentifier = $this->normalizeArabicString($identifier);
        return Subject::whereRaw('REPLACE(LOWER(subject_name), " ", "") LIKE ?', ['%' . str_replace(' ', '', $normalizedIdentifier) . '%'])
                      ->orWhereRaw('LOWER(subject_name) LIKE ?', ['%' . $normalizedIdentifier . '%']) // بحث أوسع قليلاً
                      ->first(); // قد تحتاج لمنطق أدق إذا كان هناك أسماء متشابهة جداً
    }

    /**
     * Helper function to normalize Arabic string (remove Alif variants, normalize spaces).
     */
    private function normalizeArabicString($string)
    {
        $string = preg_replace('/[أإآ]/u', 'ا', $string); // توحيد الألفات
        $string = preg_replace('/\s+/u', ' ', trim($string)); // إزالة الفراغات الزائدة
        return strtolower($string);
    }


    /**
     * Validation rules for each row.
     */
    public function rules(): array
    {
        // المفاتيح يجب أن تطابق عناوين الأعمدة في ملف Excel (بعد تحويلها لـ snake_case بواسطة المكتبة)
        // هذه القواعد تطبق على البيانات الخام قبل أي تحويل في دالة model()
        return [
            'plan_id' => ['required'], // أو planid, plan_name, planname (حسب ما سيقرأه كـ heading)
            'plan_level' => ['required'],
            'plan_semester' => ['required'],
            'subject_id' => ['required'], // أو subjectid, subject_no, subject_name

            // يمكنك إضافة rules أكثر تفصيلاً هنا إذا أردت
            // '*.plan_level' => 'integer|min:1|max:6',
            // '*.plan_semester' => 'integer|min:1|max:3',
        ];
    }

    /**
     * Custom validation messages.
     */
    public function customValidationMessages(): array
    {
        return [
            'plan_id.required' => 'Plan identifier (ID or Name) is required in column B.',
            'plan_level.required' => 'Plan Level is required in column C.',
            'plan_semester.required' => 'Plan Semester is required in column D.',
            'subject_id.required' => 'Subject identifier (ID, Code, or Name) is required in column E.',
        ];
    }

    // Getters for counts
    public function getCreatedCount(): int { return $this->createdCount; }
    public function getUpdatedCount(): int { return $this->updatedCount; }
    public function getSkippedCount(): int { return $this->skippedCount; }
    public function getAlreadyExistedCount(): int { return $this->alreadyExistedCount; }
    public function getInvalidPlanCount(): int { return $this->invalidPlanCount; }
}
--------------------------------------------------------------------------------------------------
app\Imports\SubjectsImport.php
<?php

namespace App\Imports;

use App\Models\Subject;
use Exception;
use Maatwebsite\Excel\Concerns\ToModel;
use Maatwebsite\Excel\Concerns\WithHeadingRow; // للتعامل مع صف العناوين
use Maatwebsite\Excel\Concerns\WithValidation; // لتطبيق التحقق
use Maatwebsite\Excel\Concerns\Importable;     // لاستخدام trait
use Illuminate\Validation\Rule;             // لاستخدام rules متقدمة
use Illuminate\Support\Facades\Log;        // لتسجيل الأخطاء (اختياري)
use Maatwebsite\Excel\Concerns\SkipsEmptyRows; // *** لتجاهل الصفوف الفارغة ***
use Maatwebsite\Excel\Concerns\OnEachRow; // *** استخدام OnEachRow ***
use Illuminate\Support\Facades\Validator; // *** لاستخدام Validator يدوياً ***
use Maatwebsite\Excel\Row; // *** لاستخدام Row object ***


// class SubjectsImport implements ToModel, WithHeadingRow, WithValidation, SkipsEmptyRows
class SubjectsImport implements OnEachRow, WithHeadingRow
{
    use Importable;

    /**
     * @param array $row بيانات الصف الحالي (المفاتيح هي عناوين الأعمدة snake_case)
     *
     * @return \Illuminate\Database\Eloquent\Model|null
     */
    // public function model(array $row)
    // {
    //     // مكتبة Laravel Excel تحول العناوين تلقائياً لـ snake_case

    //     // التحقق الأساسي من وجود الأعمدة المطلوبة (قد يكون غير ضروري بسبب Validation)
    //     //     $requiredKeys = [
    //     //         'subject_no',
    //     //         'subject_name',
    //     //         'subject_load',
    //     //         'theoretical_hours',
    //     //         'practical_hours',
    //     //         'subject_type_id',
    //     //         'subject_category_id',
    //     //         'department_id'
    //     //     ];
    //     //     foreach ($requiredKeys as $key) {
    //     //         // التحقق إذا كان المفتاح موجوداً والقيمة ليست فارغة تماماً
    //     //         if (!isset($row[$key]) || $row[$key] === null || $row[$key] === '') {
    //     //             // هذا الشرط قد يساعد في تجاهل الصفوف التي تبدو شبه فارغة أو مدمجة
    //     //             // ولكن الاعتماد على Validation أفضل
    //     //             Log::warning("Skipping row in Subject import due to missing or empty required column: {$key}", $row);
    //     //             return null; // تجاهل الصف
    //     //         }
    //     //     }


    //     //     // إنشاء وحفظ موديل Subject جديد
    //     //     return new Subject([
    //     //         'subject_no' => $row['subject_no'],
    //     //         'subject_name' => $row['subject_name'],
    //     //         'subject_load' => $row['subject_load'],
    //     //         'theoretical_hours' => $row['theoretical_hours'],
    //     //         'practical_hours' => $row['practical_hours'],
    //     //         'subject_type_id' => $row['subject_type_id'],
    //     //         'subject_category_id' => $row['subject_category_id'],
    //     //         'department_id' => $row['department_id'],
    //     //     ]);
    //     // }

    //     // /**
    //     //  * قواعد التحقق لكل صف.
    //     //  *
    //     //  * @return array
    //     //  */
    //     // public function rules(): array
    //     // {
    //     //     // المفاتيح هنا يجب أن تكون snake_case لتطابق ما تقرأه المكتبة
    //     //     return [
    //     //         'subject_no' => ['required', 'string', 'max:20', Rule::unique('subjects', 'subject_no')],
    //     //         'subject_name' => ['required', 'string', 'max:255'],
    //     //         'subject_load' => ['required', 'integer', 'min:0'],
    //     //         'theoretical_hours' => ['required', 'integer', 'min:0'],
    //     //         'practical_hours' => ['required', 'integer', 'min:0'],
    //     //         'subject_type_id' => ['required', 'integer', 'exists:subjects_types,id'],
    //     //         'subject_category_id' => ['required', 'integer', 'exists:subjects_categories,id'],
    //     //         'department_id' => ['required', 'integer', 'exists:departments,id'],
    //     //     ];
    // }
        // عداد لتتبع الأخطاء (اختياري)
        public $errors = [];
        public $importedRowCount = 0;

        /**
         * يتم استدعاؤها لكل صف في الملف.
         * @param Row $row كائن يمثل الصف الحالي
         */
        public function onRow(Row $row)
        {
            // الحصول على بيانات الصف كمصفوفة (المفاتيح snake_case)
            $rowData = $row->toArray();
            $rowIndex = $row->getIndex(); // رقم الصف في الملف (يبدأ من 1)

            // --- خطوة 1: التحقق الأساسي لتجاهل الصفوف غير المرغوبة ---
            // تحقق إذا كان الصف فارغاً تماماً أو شبه فارغ (لا يحتوي على رقم مادة واسم)
            if (empty($rowData['subject_no']) && empty($rowData['subject_name'])) {
                // قد يكون صفاً فارغاً (فاصل فصول) أو صف عنوان تخصص مدمج
                 Log::info("Skipping empty or header row at index: {$rowIndex}");
                return; // تجاهل هذا الصف وانتقل للتالي
            }

            // تحقق إذا كانت الأعمدة الرقمية الأساسية مفقودة أو غير رقمية (قد يدل على صف عنوان)
            $numericColumns = ['subject_load', 'theoretical_hours', 'practical_hours', 'subject_type_id', 'subject_category_id', 'department_id'];
            $isLikelyHeaderOrEmpty = false;
            foreach ($numericColumns as $col) {
                if (!isset($rowData[$col]) || !is_numeric($rowData[$col])) {
                    $isLikelyHeaderOrEmpty = true;
                    break;
                }
            }
            if ($isLikelyHeaderOrEmpty) {
                Log::info("Skipping potentially invalid data or header row at index: {$rowIndex}", $rowData);
                 return; // تجاهل هذا الصف
            }

            // --- خطوة 2: التحقق اليدوي (Validation) للصف الحالي ---
            $validator = Validator::make($rowData, [
                'subject_no' => ['required', 'string', 'max:20', Rule::unique('subjects', 'subject_no')],
                'subject_name' => ['required', 'string', 'max:255'],
                'subject_load' => ['required', 'integer', 'min:0'],
                'theoretical_hours' => ['required', 'integer', 'min:0'],
                'practical_hours' => ['required', 'integer', 'min:0'],
                'subject_type_id' => ['required', 'integer', 'exists:subjects_types,id'],
                'subject_category_id' => ['required', 'integer', 'exists:subjects_categories,id'],
                'department_id' => ['required', 'integer', 'exists:departments,id'],
            ], $this->customValidationMessages(), $this->customValidationAttributes());

            if ($validator->fails()) {
                // تسجيل الخطأ مع رقم الصف
                $this->errors[$rowIndex] = $validator->errors()->all();
                Log::warning("Validation failed for row {$rowIndex}: ", $validator->errors()->toArray());
                return; // تجاهل الصف الذي فشل التحقق منه
            }

            // --- خطوة 3: إنشاء الموديل (إذا نجح التحقق) ---
            try {
                Subject::create([
                    'subject_no' => $rowData['subject_no'],
                    'subject_name' => $rowData['subject_name'],
                    'subject_load' => $rowData['subject_load'],
                    'theoretical_hours' => $rowData['theoretical_hours'],
                    'practical_hours' => $rowData['practical_hours'],
                    'subject_type_id' => $rowData['subject_type_id'],
                    'subject_category_id' => $rowData['subject_category_id'],
                    'department_id' => $rowData['department_id'],
                ]);
                $this->importedRowCount++; // زيادة عداد الصفوف المستوردة بنجاح
            } catch (Exception $e) {
                 // تسجيل خطأ في إنشاء الموديل (غير متوقع إذا نجح التحقق)
                 $this->errors[$rowIndex] = ['Database error: ' . $e->getMessage()];
                 Log::error("Failed to create Subject from row {$rowIndex}: " . $e->getMessage(), $rowData);
            }
        }

    /**
     * رسائل خطأ مخصصة (اختياري).
     *
     * @return array
     */
    public function customValidationMessages(): array
    {
        return [
            'subject_no.required' => 'Subject Code (subject_no) is required.',
            'subject_no.unique' => 'Subject Code (:input) already exists.',
            'subject_type_id.exists' => 'Subject Type ID (:input) not found.',
            'subject_category_id.exists' => 'Subject Category ID (:input) not found.',
            'department_id.exists' => 'Department ID (:input) not found.',
            '*.integer' => 'The :attribute must be a whole number.',
            '*.min' => 'The :attribute must be at least :min.',
            '*.required' => 'The :attribute field is required.', // رسالة عامة للحقول المطلوبة
        ];
    }

    /**
     * أسماء مخصصة للحقول في رسائل الخطأ (اختياري).
     *
     * @return array
     */
    public function customValidationAttributes(): array
    {
        // المفاتيح snake_case
        return [
            'subject_no' => 'Subject Code',
            'subject_name' => 'Subject Name',
            'subject_load' => 'Credit Hours',
            'theoretical_hours' => 'Theoretical Hours',
            'practical_hours' => 'Practical Hours',
            'subject_type_id' => 'Subject Type ID',
            'subject_category_id' => 'Subject Category ID',
            'department_id' => 'Department ID',
        ];
    }

    // يمكنك إضافة دالة للحصول على الأخطاء بعد الانتهاء من الـ import
    public function getErrors(): array
    {
        return $this->errors;
    }

    public function getImportedRowCount(): int
    {
        return $this->importedRowCount;
    }

    /**
     * يمكنك استخدام هذا لتحديد الصف الذي تبدأ منه القراءة (افتراضياً 1)
     * مفيد إذا كان لديك صفوف إضافية قبل العناوين
     */
    public function headingRow(): int
    {
        return 1; // افترض أن العناوين في الصف الأول
    }
}

